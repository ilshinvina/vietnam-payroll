# 베트남 급여 관리 시스템 (Vietnam Payroll Management System)

## 프로젝트 개요
베트남 현지 법인을 위한 급여 관리 웹 애플리케이션입니다. 직원별 근무시간, 수당, 보험료, 소득세를 계산하고 급여 명세서를 생성합니다.

**회사**: KHANH QUYNH
**버전**: 1.4.1
**마지막 업데이트**: 2025-12-10

---

## 주요 기능

### 1. 직원 관리
- ✅ 직원 등록/수정/삭제
- ✅ 기본급, 은행계좌, 세금코드 관리
- ✅ 직원별 근무 이력 추적
- ✅ **엑셀 템플릿 다운로드/업로드** (대량 직원 등록)
  - 템플릿 다운로드 (샘플 데이터 포함)
  - 엑셀 작성 후 일괄 업로드
  - 현재 직원 데이터 엑셀 내보내기

### 2. 급여 계산
- ✅ 정규시간 급여
- ✅ 연장근무 수당 (150%)
- ✅ 야간근무 수당 (130%)
- ✅ 주말/휴일 근무 수당 (200%)
- ✅ 식대 (점심, 저녁, 일요일)
- ✅ **동적 수당 시스템** (무제한 수당 추가 가능)
  - 개근수당, 교통비, 위험수당 등
  - 결근/사유결근/연차 시 차등 지급 설정
  - 활성화/비활성화 관리
  - 0원 수당 자동 숨김
- ✅ **특수수당** (v1.3 신규)
  - 월별 체크박스 방식 입력
  - 총급여 추가, 전액 과세 처리
  - 직원별/월별 독립 관리
- ✅ **선금 차감** (v1.3 신규)
  - 월별 체크박스 방식 입력
  - 실수령액에서 차감
  - 직원별/월별 독립 관리

### 3. 보험 및 세금
- ✅ BHXH (사회보험): 근로자 8%, 회사 17.5%
- ✅ BHYT (의료보험): 근로자 1.5%, 회사 3%
- ✅ BHTN (실업보험): 근로자 1%, 회사 1%
- ✅ 노조비: 1%
- ✅ 누진세율 소득세 계산

### 4. 급여 이력 관리
- ✅ 월별 급여 데이터 저장
- ✅ 직원별 확정 상태 관리
- ✅ 진행률 표시 (예: 3/16명 확정)
- ✅ 최초 등록일 추적

### 5. 리포트 출력
- ✅ PDF 급여 대장 (한글/베트남어)
- ✅ Excel 급여 대장 (동적 수당 컬럼 자동 생성)
- ✅ 개별 직원 PDF/Excel (동적 수당 포함)
- ✅ **모바일 급여명세서** (반응형 디자인, PDF 저장)
- ✅ 빈 양식 출력 (미등록 월)

### 6. 출퇴근 관리 (v1.4 신규)
- ✅ **출퇴근 현황 관리** (attendance.html)
  - 엑셀 스타일 월별 출퇴근 테이블
  - 4가지 근무 유형: 정상, 야간, 일요일, 공휴일
  - 스티키 헤더 (스크롤 시 날짜 고정)
- ✅ **휴가 관리 시스템**
  - 🏖️ 연차 (#4caf50 녹색)
  - 🖤 경조사/특별휴가 (#9c27b0 보라색)
  - 🏥 병가 (#ff9800 주황색)
  - 📝 사유결근 (#607d8b 회색)
  - ❌ 무단결근 (#000000 검정)
  - 🎌 공휴일 (#ff5252 빨강)
- ✅ **연차 현황 표시**
  - Phép (사용): 연간 누적 연차 사용일수
  - Còn (잔여): 남은 연차일수 자동 계산
  - 음수 연차 허용 (경고 표시 + 사유 입력)
- ✅ **급여계산기 연동**
  - 📥 급여계산기에서 들고오기
  - 📤 급여계산기로 보내기
  - 양방향 동기화 지원
- ✅ **롱프레스 메뉴**
  - 날짜 셀 길게 누르면 휴가 유형 선택 메뉴
  - 직관적인 아이콘 및 색상

### 7. 데이터 관리
- ✅ LocalStorage 기반 데이터 저장
- ✅ 전체 데이터 백업/복원 (JSON)
- ✅ 연도별 회사 설정 관리 (v1.3: localStorage 키 통일)
- ✅ **회사 정보 설정** (v1.3)
  - 회사명 설정 (모바일 급여명세서 표시용)
  - 회사 로고 URL 설정
  - 연도별 독립 관리
- ✅ **회사 로고 시스템**
  - 다중 회사 프로필 지원
  - 로고 이미지 업로드 (파일 또는 Base64)
  - 모든 문서/PDF에 자동 적용
- ✅ **진단 도구**
  - check_data.html: localStorage 전체 검사
  - quick_check.html: 빠른 상태 확인

---

## 파일 구조

```
MONEY/
├── start.html              # 언어 선택 페이지 (한국어/베트남어)
├── index.html              # 메인 대시보드 (한국어)
├── index_vn.html           # 메인 대시보드 (베트남어)
├── salary-input.html       # 급여 입력 페이지
├── settings.html           # 회사/직원 설정 페이지
├── payslip.html            # 모바일 급여명세서 (반응형)
├── company-setup.html      # 회사 프로필 설정 (한국어)
├── company-setup_vn.html   # 회사 프로필 설정 (베트남어)
├── attendance.html         # 출퇴근 관리 페이지 (v1.4 신규)
├── check_data.html         # localStorage 진단 도구
├── quick_check.html        # 빠른 상태 확인 도구
│
├── attendance.js           # 출퇴근 관리 로직 (v1.4 신규)
├── dashboard.js            # 대시보드 로직
├── data-manager.js         # 데이터 관리
├── salary-calculator.js    # 급여 계산 엔진
├── settings.js             # 설정 관리 (동적 수당 포함)
├── excel-handler.js        # 엑셀 처리 (구버전)
├── excel-template.js       # 엑셀 템플릿 다운로드/업로드
├── app.js                  # 앱 초기화
├── ui-calendar.js          # 달력 UI
├── styles.css              # 스타일시트
│
├── assets/
│   └── lgos/               # 회사 로고 이미지
│       ├── khanh-quynh-logo.png
│       └── khanh-quynh-logo1.png
│
├── create_backup.py        # 백업 스크립트
├── analyze_excel.py        # 엑셀 분석 도구
├── check_insurance.py      # 보험료 검증 도구
├── README.md               # 프로젝트 문서
└── 수정 보고서/
    ├── ALLOWANCE_SYSTEM_FIX_REPORT.md      # 수당 시스템 버그 수정
    ├── DYNAMIC_ALLOWANCE_FIX_STATUS.md     # 동적 수당 표시 수정
    ├── DATEKEY_COMPATIBILITY_FIX.md        # 날짜 키 호환성 수정
    └── MOBILE_PAYSLIP_DYNAMIC_FIX.md       # 모바일 급여명세서 수정
```

---

## 사용 방법

### 1. 초기 설정
1. `settings.html` 열기
2. 회사 정보 입력 (회사명, 주소, 세금코드, 로고)
3. 보험료율 확인/수정
4. 소득세 구간 확인
5. **동적 수당 설정** (v1.1 신규):
   - 기본 3개 수당(개근수당, 교통비, 위험수당) 자동 생성
   - "➕ 수당 추가" 클릭하여 새 수당 추가
   - 각 수당별 설정:
     - 수당 이름, 금액
     - 결근 시 지급 방식 (전액/비례/지급안함)
     - 사유결근 시 지급 방식
     - 연차 시 지급 방식
     - 활성화/비활성화 스위치
   - 저장 후 모든 화면에 자동 반영

### 2. 직원 등록

#### 방법 1: 개별 등록
1. `settings.html` 열기
2. "➕ 직원 추가" 클릭
3. 직원 정보 입력 (이름, 기본급, 입사일 등)
4. 저장

#### 방법 2: 엑셀 일괄 등록 (신규 v1.2)
1. `settings.html` 열기
2. "📥 템플릿 다운로드" 클릭
3. 다운로드된 엑셀 파일 열기
4. 샘플 데이터 참고하여 직원 정보 입력
   - 컬럼: 직원명, 입사일, 기본급, 부양가족수, 연차발생일수, 연차조정
   - 입사일 형식: YYYY-MM-DD (예: 2024-01-15)
5. 파일 저장
6. "📤 엑셀 불러오기" 클릭하여 업로드
7. ✅ 완료! 모든 직원이 자동 등록됨

### 3. 급여 입력
1. `salary-input.html`에서 년월 선택
2. 직원 선택
3. 근무시간 입력
   - 정규시간
   - 연장근무 시간
   - 야간근무 시간
   - 주말근무 시간
4. **동적 수당 자동 계산** (v1.1):
   - settings에서 설정한 수당이 자동으로 표시됨
   - 결근/사유결근/연차에 따라 자동 차등 계산
   - 비활성화된 수당은 화면에서 숨겨짐
   - 0원 수당도 자동으로 숨겨짐
5. **특수수당/선금 입력** (v1.3 신규):
   - 💎 특수수당: 체크박스 활성화 후 금액 입력 → 총급여 추가
   - 💰 선금: 체크박스 활성화 후 금액 입력 → 실수령액 차감
   - 실시간 계산 반영
   - 월별 독립 관리 (저장/불러오기 자동)
6. "✅ 확정" 클릭

### 4. 급여 현황 확인
1. `index.html` 열기
2. 월별 급여 현황 확인
3. 상태 표시:
   - **미등록**: 확정 인원 0명
   - **진행률**: "3/16" (일부 확정)
   - **등록완료**: 전체 확정

### 5. 급여 대장 출력
1. `index.html`에서 해당 월 찾기
2. "📋 상세" 버튼: 급여 대장 모달 보기
3. "📄 PDF" 버튼: PDF 다운로드
4. "📊 엑셀" 버튼: Excel 다운로드

### 6. 모바일 급여명세서 (신규 v1.1)
1. `salary-input.html`에서 직원 선택
2. 급여 계산 완료 후 "📱 모바일 급여명세서 보기" 클릭
3. 새 창에서 모바일 최적화된 급여명세서 표시
4. "💾 PDF 저장" 클릭하여 개별 PDF 다운로드
5. **특징**:
   - 반응형 디자인 (모바일/태블릿/PC)
   - settings에서 추가한 모든 수당 자동 표시
   - 0원 수당 자동 숨김
   - 베트남어 금액 표기 (예: "5 triệu 200 nghìn đồng")

---

## 최근 수정사항

### 🆕 v1.4.1 출퇴근 관리 UX 개선 및 데이터 검증 강화 (2025-12-10)

#### 1️⃣ 시각적 UI 개선
**기능**: 직원 그룹 시각적 구분 강화

**구현 내용**:
- ✅ **직원별 4행 그룹 테두리 추가**
  - 각 직원의 4줄(Giờ Chính, Tăng Ca, Ca Đêm, Holiday)을 검은 테두리로 묶음
  - 상단 테두리: 3px solid black
  - 하단 테두리: 3px solid black
  - 직원 간 명확한 시각적 구분

**효과**:
- 여러 직원 데이터 확인 시 혼동 방지
- 데이터 입력 오류 감소

---

#### 2️⃣ 입력 검증 강화 (경고 시스템)
**기능**: 실수로 잘못된 칸에 입력하는 것을 방지하는 노란색 경고 시스템

**구현 내용**:
- ✅ **4가지 경고 유형** (차단하지 않고 노란색 표시):
  1. **평일/토요일에 Holiday 칸 입력**: 일요일 특근은 일요일에만
  2. **무급휴가/결근일에 근무시간 입력**: 공휴일/결근에 시간 입력 불가
  3. **유급휴가일에 정규근무 외 시간 입력**: 연차/특별휴가에 잔업/야간 불가
  4. **일요일에 평일 칸 입력** (신규): 일요일은 Holiday 칸에 입력해야 함

- ✅ **경고 스타일**:
  - 배경색: #ffeb3b (진한 노란색)
  - 테두리: 2px solid #f44336 (빨간색)
  - 값 삭제 시 경고 자동 제거

**효과**:
- 입력 오류 즉시 인지 가능
- 차단하지 않아 유연성 유지
- 데이터 정확도 향상

---

#### 3️⃣ 연차/휴가 자동화 개선
**기능**: 연차 및 휴가 데이터 무결성 보장

**구현 내용**:
- ✅ **연차/특별휴가 8시간 고정**:
  - 입력 필드 readOnly 처리 (회색 배경)
  - 수정 시도 시 자동으로 8로 복원
  - 잔업/야간/일요특근 입력 불가 (자동 삭제)

- ✅ **병가 스마트 처리**:
  - **연차 잔여 있음** → 8시간 고정 (유급, annualLeaveDays)
  - **연차 잔여 없음** → 0시간 (무급, excusedAbsents)
  - 알림 메시지로 처리 결과 확인 가능

- ✅ **0시간 입력 시 사유결근 자동 제안**:
  - 조건: 휴가 미설정 + 모든 근무시간 0
  - 확인 창: "사유결근으로 처리하시겠습니까?"
  - 확인 시 → 회색 사유결근 자동 설정
  - 취소 시 → 0으로 유지

**효과**:
- 연차 데이터 일관성 보장
- 병가 처리 자동화 (수동 계산 불필요)
- 결근 입력 빠르고 정확하게

---

#### 4️⃣ 페이지 로드 시 자동 적용
**기능**: 기존 데이터에도 모든 규칙 자동 적용

**구현 내용**:
- ✅ `updateWarningCells()`: 경고 셀 자동 표시
- ✅ `updateReadonlyFields()`: 연차/특별휴가/병가 readonly 적용
- ✅ 페이지 로드 시 자동 실행

**효과**:
- 과거 데이터도 새 규칙 적용
- 일관된 데이터 표시

---

**영향 파일**:
- 수정: attendance.js (setWorkValue, setLeaveType, updateReadonlyFields 추가)
- 수정: attendance.html (CSS 테두리 스타일)

---

### 🆕 v1.4.0 출퇴근 관리 시스템 (2025-12-07)

#### 1️⃣ 출퇴근 관리 페이지 추가 (attendance.html)
**기능**: 직원별 월간 출퇴근 현황을 엑셀 스타일 테이블로 관리

**구현 내용**:
- ✅ **엑셀 스타일 테이블**
  - 4가지 근무 유형별 행: 정상, 야간, 일요일, 공휴일
  - 빠른 입력: 각 셀 클릭하여 시간 입력
  - 스티키 헤더: 스크롤 시 날짜 행 고정
  - 직원별 합계 (Tổng) 자동 계산

- ✅ **휴가 관리 시스템**
  - 롱프레스 메뉴로 휴가 유형 선택
  - 6가지 휴가 유형 지원:
    | 유형 | 색상 | 연차 차감 |
    |------|------|----------|
    | 🏖️ 연차 | #4caf50 (녹색) | O |
    | 🖤 경조사 | #9c27b0 (보라) | X |
    | 🏥 병가 | #ff9800 (주황) | O |
    | 📝 사유결근 | #607d8b (회색) | X |
    | ❌ 무단결근 | #000000 (검정) | X |
    | 🎌 공휴일 | #ff5252 (빨강) | X |

- ✅ **연차 현황 표시**
  - Phép: 연간 누적 사용일수 (1월~현재월)
  - Còn: 남은 연차일수 (연차발생 - 조정 - 사용)
  - 음수 연차 허용 (경고 + 사유 입력)

- ✅ **급여계산기 양방향 연동**
  - 📥 급여계산기에서 들고오기: leaveData 동기화
  - 📤 급여계산기로 보내기: 휴가 데이터 전송
  - 미저장 변경사항 경고 (beforeunload)

**영향 파일**:
- 신규: attendance.html, attendance.js
- 수정: salary-input.html (경조사/병가 토글 추가)
- 수정: styles.css (휴가 색상 통일)

---

#### 2️⃣ 급여계산기 휴가 토글 확장
**변경**: 기존 5단계 → 7단계 토글 사이클

```
근무일 → 공휴일 → 사유결근 → 무단결근 → 연차 → 경조사 → 병가 → 근무일
```

**구현 내용**:
- ✅ specialLeaveDays (경조사) Set 추가
- ✅ sickLeaveDays (병가) Set 추가
- ✅ toggleDay() 함수 7단계로 확장
- ✅ leaveData 동기화 (저장 시 모든 휴가 유형 포함)

---

#### 3️⃣ 색상 표준화
**목적**: 출퇴근 관리와 급여계산기 색상 통일

**통일된 색상**:
| 휴가 유형 | 색상 코드 |
|----------|----------|
| 🏖️ 연차 | #4caf50 |
| 🖤 경조사 | #9c27b0 |
| 🏥 병가 | #ff9800 |
| 📝 사유결근 | #607d8b |
| ❌ 무단결근 | #000000 |
| 🎌 공휴일 | #ff5252 |

**적용 파일**:
- styles.css: .calendar-day 관련 모든 클래스
- attendance.js: getLeaveStyle(), 메뉴 옵션
- attendance.html: 범례 색상

---

### 🆕 v1.3.2 중간 합계 추가 및 사용성 개선 (2025-11-18)

#### 1️⃣ 급여 계산 중간 합계 추가 (사용자 피드백 반영)
**문제**: 계산기로 수동 합산해야 하는 불편함

**해결**:
- ✅ **급여 입력 화면** (salary-input.html)
  - 💰 급여 상세 합계: 정규+야근+야간+일요일
  - 💵 수당 합계: 식대+모든 수당+특수수당
  - 📊 최종 정산 요약 박스 (실수령액 바로 전)
    - 급여 상세 합계
    - 수당 합계
    - = 총 급여
    - - 보험료 공제
    - - 개인소득세
    - - 선금 (있으면)

- ✅ **모바일 급여명세서** (payslip.html)
  - 최종 정산 요약 박스 추가 (보라색 그라데이션)
  - 계산 과정 한눈에 확인 가능

- ✅ **Excel 급여대장**
  - 합계 행 자동 추가 (모든 숫자 컬럼)
  - 기본급, 급여, 수당, 공제, 실수령액 합계

**효과**:
- 계산기 없이 중간 합계 확인 가능
- 급여 계산 과정 투명성 향상
- 검증 용이

---

#### 2️⃣ 모바일 급여명세서 HTML 저장 개선
**문제**: HTML 파일 저장 후 열면 "데이터가 없습니다" 경고

**해결**:
- ✅ 데이터를 embedded 스크립트로 파일에 포함
  ```javascript
  const EMBEDDED_PAYSLIP_DATA = { ... };
  ```
- ✅ 로드 로직 개선:
  1. Embedded 데이터 확인 (HTML 파일)
  2. URL 파라미터 확인 (일반)
- ✅ totalSalary 데이터 누락 수정
- ✅ createElement() 오류 수정

**효과**:
- 저장된 HTML 파일 독립 실행 가능
- 경고 없이 바로 표시
- 급여명세서 공유/보관 편의성 향상

---

### 🆕 v1.3.1 UI/UX 개선 (2025-11-18)

#### 1️⃣ 회사 주소 줄바꿈 지원
**문제**: 회사 주소가 길면 화면이 찌그러지는 현상

**해결 방법**:
- ✅ `.company-address` CSS에 줄바꿈 처리 추가:
  - `white-space: pre-line` - 입력한 줄바꿈 그대로 표시
  - `word-wrap: break-word` - 긴 단어 자동 줄바꿈
  - `max-width: 600px` - 최대 너비 제한으로 화면 안 밀림

**적용 파일**:
- index.html (메인 홈 화면)
- index_vn.html (베트남어 홈 화면)
- salary-input.html (급여 입력 화면)
- settings.html (설정 화면)

**사용법**:
- company-setup.html에서 주소 입력 시 **Enter로 줄바꿈**
- 모든 화면에서 **2줄 이상 주소 정상 표시**
- 긴 주소도 자동 줄바꿈으로 레이아웃 안정화

**예시**:
```
Củ Chi District, Hồ Chí Minh City
Vietnam 70000
```

---

#### 2️⃣ 수당 과세 처리 확인
**현재 상태**: 모든 수당은 **기본값 과세** 처리 (베트남 세법 준수)

**설정 방법**:
- settings.html에서 수당 추가/수정 시:
  - ☑️ **"⚖️ 과세 대상 수당"** 체크박스 기본 선택됨
  - 법적 근거가 명확한 경우에만 체크 해제 가능
  - 특수수당(Phụ cấp đặc biệt)은 **과세 처리 권장**

**자동 비과세 항목** (변경 불가):
- 식대: 월 730,000đ까지 비과세 (초과분 과세)
- 야근 수당: 1/3 비과세 (50% 가산분)
- 야간 수당: 30% 비과세 (가산분)
- 일요일 특근: 50% 비과세 (100% 가산분)

**안전 장치**:
- 주의 메시지 표시: "대부분의 수당은 과세 대상입니다"
- 세무 조사 대비 설명란 제공
- 기본값 과세로 법적 리스크 최소화

---

### 🆕 v1.3 주요 기능 추가 (2025-11-17)

#### 1️⃣ 특수수당 기능 추가
**기능**: 월별로 특수수당을 체크박스로 입력하여 급여 계산

**구현 내용**:
- ✅ UI: 체크박스 + 금액 입력란 (비활성화 시 회색)
- ✅ 실시간 계산: `oninput="calculate()"` 트리거
- ✅ 총급여 추가: `totalSalary += specialAllowance`
- ✅ 과세 소득: 특수수당 전액 과세 대상
- ✅ 데이터 저장: 직원별/월별 체크 상태 + 금액 저장
- ✅ 결과 표시: 오른쪽 패널에 조건부 표시
- ✅ 대시보드: 특수수당 열 추가 (index.html, dashboard.js)
- ✅ 모바일 급여명세서: 특수수당 섹션 + 총 수당 합계
- ✅ Excel/PDF 내보내기: 특수수당 컬럼 포함

**위치**: `salary-input.html` lines 346-368 (UI), 1713-1719 (계산), 2282-2283 (저장)

---

#### 2️⃣ 선금 차감 기능 추가
**기능**: 월별로 선금을 체크박스로 입력하여 실수령액에서 차감

**구현 내용**:
- ✅ UI: 체크박스 + 금액 입력란 (비활성화 시 회색)
- ✅ 실시간 계산: `oninput="calculate()"` 트리거
- ✅ 실수령액 차감: `netSalary -= advancePayment`
- ✅ 데이터 저장: 직원별/월별 체크 상태 + 금액 저장
- ✅ 결과 표시: 오른쪽 패널에 조건부 표시
- ✅ 대시보드: 선금 열 추가 (index.html, dashboard.js)
- ✅ 모바일 급여명세서: 선금 섹션 + 총 공제액에 포함
- ✅ Excel/PDF 내보내기: 선금 컬럼 포함

**위치**: `salary-input.html` lines 358-367 (UI), 1805-1810 (계산), 2284-2285 (저장)

---

#### 3️⃣ 회사 정보 설정 기능 추가
**기능**: settings.html에서 회사명과 로고 URL 설정

**구현 내용**:
- ✅ UI: 🏢 회사 정보 섹션 추가 (settings.html lines 595-608)
- ✅ 저장/로드: `companyName`, `companyLogo` 필드 관리
- ✅ 연도별 관리: `vietnamPayrollSettings_${year}` 키에 저장
- ✅ 모바일 급여명세서: 회사명/로고 표시 (payslip.html)
- ✅ 기본값 추가: 모든 기본 설정 객체에 필드 추가
- ✅ 마이그레이션: 기존 데이터에 새 필드 자동 추가

**위치**: `settings.html` lines 595-608, `settings.js` lines 508-509, 563-566

---

#### 4️⃣ localStorage 키 통일 작업 (중요 버그 수정)
**문제**: `data-manager.js`가 설정을 로드는 `vietnamPayrollSettings_2025`, 저장은 `vietnamPayrollSettings`로 불일치

**수정 내용**:
- ✅ `data-manager.js`: 모든 저장/삭제 로직 `vietnamPayrollSettings_${year}` 통일
- ✅ `salary-input.html`: 초기 로드 시 연도별 키 사용
- ✅ `salary-input.html`: 연도 변경 시 회사 설정 다시 로드
- ✅ `clearAllData()`: 모든 연도별 설정 삭제 (2024~2030)

**영향**:
- settings에서 저장한 설정이 올바르게 불러와짐
- 연도 변경 시 해당 연도의 회사 정보 자동 로드
- 데이터 삭제 시 모든 연도별 설정 완전 삭제

**상세**: `FIX_REPORT_회사정보설정.md` 참조

---

### 🔥 v1.1 중요 버그 수정 (2025-11-15 ~ 2025-11-16)

#### 1️⃣ 동적 수당 시스템 핵심 버그 수정 (2025-11-15)
**문제**: settings에서 수당 추가해도 계산되지 않고 표시되지 않음

**원인**:
- `companySettings` vs `window.companySettings` 변수 참조 불일치
- LocalStorage 키 불일치: `vietnamPayrollSettings_${year}` vs `companySettings`
- 마이그레이션 무한 반복 (빈 배열도 재생성 트리거)

**수정 내용**:
- ✅ 모든 `companySettings` → `window.companySettings` 통일 (14곳)
- ✅ LocalStorage 키 `vietnamPayrollSettings_${year}` 통일
- ✅ 마이그레이션 조건 수정: `!companySettings.allowances` (undefined만)
- ✅ 하드코딩 수당 조건부 표시 (활성화/비활성화 연동)

**상세**: `ALLOWANCE_SYSTEM_FIX_REPORT.md` 참조

---

#### 2️⃣ 날짜 키 호환성 버그 수정 (2025-11-15)
**문제**: 4월은 작동 안 하는데 11월은 작동함

**원인**:
```javascript
// 4월 검색: "2025-4-"로 시작
"2025-04-01"  // ❌ 매칭 실패! (신버전 키)
"2025-4-1"    // ✅ 매칭 성공 (구버전 키)

// 11월 검색: "2025-11-"로 시작
"2025-11-01"  // ✅ 매칭 성공
"2025-11-1"   // ✅ 매칭 성공
```

**수정 내용**:
- ✅ `isSelectedMonth()`, `isTargetMonth()` 헬퍼 함수 추가 (정수 파싱 비교)
- ✅ 모든 `startsWith()` 제거 → 헬퍼 함수 사용
- ✅ 구버전/신버전 키 모두 확인 (`data[dateKey] || data[dateKeyOld]`)
- ✅ **야간수당 버그 수정**: 30% → 130% (중요!)

**영향 함수**:
- `updateStats()` (통계 계산)
- `inputOvertimeHours()` (야근시간 입력)
- `calculateEmployeePayroll()` (급여대장)

**상세**: `DATEKEY_COMPATIBILITY_FIX.md` 참조

---

#### 3️⃣ 0원 수당 자동 숨김 처리 (2025-11-16)
**문제**: 수당이 없는데도 모바일 PDF에 0đ로 표시됨

**수정 내용**:
- ✅ 통계 영역: `if (amount > 0)` 조건 추가
- ✅ 결과 영역: `&& amount > 0` 조건 추가
- ✅ 동적 수당 렌더링: `if (amount > 0)` 필터
- ✅ Excel/PDF 출력: `if (amount > 0)` 필터

**적용 위치**:
- `salary-input.html`: Line 1396, 1400, 1428, 1687, 1691, 1695, 1713, 3124

**상세**: `DYNAMIC_ALLOWANCE_FIX_STATUS.md` 참조

---

#### 4️⃣ 모바일 급여명세서 동적 수당 지원 (2025-11-16)
**문제**: 모바일 급여명세서가 3개 하드코딩된 수당만 표시

**수정 내용**:

**salary-input.html** (Line 1824-1840):
```javascript
// 수정 전: 하드코딩 3개 필드
attendanceBonus: attendanceBonus,
transportAllowance: transportAllowance,
riskAllowance: riskAllowance,

// 수정 후: 동적 배열
allowances: [
    {id: '...', name: '개근수당', amount: 300000},
    {id: '...', name: '교통비', amount: 200000},
    // ... 무제한 확장 가능
]
```

**payslip.html** (Line 321-322, 475-497):
```javascript
// HTML: 하드코딩 3개 div → 동적 컨테이너
<div id="dynamicAllowancesContainer"></div>

// JS: 배열 순회하며 동적 렌더링
data.allowances.forEach(allowance => {
    // 각 수당마다 행 생성
});
```

**결과**:
- ✅ settings에서 추가한 모든 수당 표시
- ✅ 0원 수당 자동 숨김
- ✅ 수당 없으면 "설정된 수당이 없습니다" 메시지
- ✅ 무제한 수당 확장 가능

**상세**: `MOBILE_PAYSLIP_DYNAMIC_FIX.md` 참조

---

### 📊 수정 범위 요약

| 파일 | 수정된 함수/영역 | 주요 변경 |
|------|----------------|---------|
| **salary-input.html** | updateStats(), calculate(), calculateEmployeePayroll(), openMobilePayslip() | 변수 참조 통일, 날짜 키 호환성, 0원 숨김, 동적 배열 전달 |
| **payslip.html** | HTML 구조, displayPayslip() | 하드코딩 제거, 동적 렌더링 |
| **settings.js** | 마이그레이션 로직 | 무한 반복 방지 |

**총 수정 라인 수**: 100+ 라인
**수정된 함수**: 15+ 개
**영향받는 기능**: 통계, 계산, 급여대장, Excel, PDF, 모바일 급여명세서

---

### ✅ 상태 표시 로직 개선 (2025-11-15)
- **이전**: 데이터가 1명이라도 있으면 "등록완료" 표시
- **현재**:
  - 확정 인원 = 전체 직원 수 → "등록완료"
  - 확정 인원 > 0 → 진행률 표시 (예: "3/16")
  - 확정 인원 = 0 → "미등록"

### ✅ 급여 합산 정확도 개선 (2025-11-15)
- **이전**: historyData.data의 모든 직원 급여 합산
- **현재**: 확정된 직원(`confirmedEmployees`)의 급여만 합산
- 적용 위치:
  - 메인 대시보드 상단 통계 카드
  - 월별 급여 현황 테이블
  - 급여 대장 모달

---

### 🎯 완전히 동적화된 시스템

이제 **완전한 동적 수당 시스템**이 구축되었습니다:

1. ✅ **settings.html**: 수당 추가/삭제/수정/비활성화
2. ✅ **salary-input.html 통계**: 동적 수당 표시
3. ✅ **salary-input.html 결과**: 동적 수당 표시
4. ✅ **Excel 급여대장**: 동적 컬럼 생성
5. ✅ **개별 Excel/PDF**: 동적 수당 포함
6. ✅ **모바일 급여명세서**: 동적 수당 표시
7. ✅ **모바일 PDF 저장**: 동적 수당 포함

**핵심 성과**:
- 하드코딩 3개 → **무제한 확장 가능**
- 수당 추가 즉시 → **모든 화면 자동 반영**
- 0원 수당 → **자동 숨김**
- 날짜 키 → **구버전/신버전 모두 호환**

---

## 급여 계산 공식

### 1. 기본 시급
```
hourlyRate = 기본급 / 208시간
```

### 2. 수당 계산
- **정규시간**: `hourlyRate × 정규시간`
- **연장근무**: `hourlyRate × 연장시간 × 150%`
- **야간근무**: `hourlyRate × 야간시간 × 130%`
- **주말근무**: `hourlyRate × 주말시간 × 200%`

### 3. 총급여
```
총급여 = 정규급여 + 연장수당 + 야간수당 + 주말수당 + 식대 + 동적수당합계 + 특수수당
```

**특수수당** (v1.3):
- 월별 체크박스로 활성화/비활성화
- 총급여에 추가되며 전액 과세 대상
- 예시: `특수수당 500,000đ 체크 → 총급여 +500,000đ`

**동적 수당 계산** (v1.1):
- settings에서 설정한 모든 활성화된 수당 자동 합산
- 결근/사유결근/연차 시 차등 지급:
  - **전액 지급** (full): 무조건 100% 지급
  - **비례 지급** (proportional): (실근무일 / 총근무일) × 수당
  - **지급 안 함** (zero): 0원
- 예시:
  ```
  개근수당 300,000đ (결근 시: 지급안함)
  교통비 200,000đ (결근 시: 비례지급)
  위험수당 500,000đ (연차 시: 전액지급)
  ```

### 4. 공제액
```
보험료 = 기본급 × (BHXH 8% + BHYT 1.5% + BHTN 1% + 노조비 1%)
소득세 = (과세소득 - 공제액) × 누진세율
```

### 5. 실수령액
```
실수령액 = 총급여 - 보험료 - 소득세 - 기타공제 - 선금
```

**선금 차감** (v1.3):
- 월별 체크박스로 활성화/비활성화
- 실수령액에서 직접 차감 (세금 계산 후)
- 예시: `선금 2,000,000đ 체크 → 실수령액 -2,000,000đ`

---

## 소득세율 (2024년 기준)

| 과세소득 (VND) | 세율 |
|---------------|------|
| 0 ~ 5,000,000 | 5% |
| 5,000,001 ~ 10,000,000 | 10% |
| 10,000,001 ~ 18,000,000 | 15% |
| 18,000,001 ~ 32,000,000 | 20% |
| 32,000,001 ~ 52,000,000 | 25% |
| 52,000,001 ~ 80,000,000 | 30% |
| 80,000,001 이상 | 35% |

**기본공제**: 11,000,000 VND/월
**부양가족공제**: 4,400,000 VND/인

---

## 데이터 백업 및 복원

### 백업 방법
1. `salary-input.html` 열기
2. "💾 전체 데이터 백업" 클릭
3. JSON 파일 저장

### 복원 방법
1. `salary-input.html` 열기
2. "📥 데이터 복원" 클릭
3. 백업 JSON 파일 선택

### 백업 내용
- ✅ 직원 정보
- ✅ 회사 설정 (연도별)
- ✅ 급여 이력 목록
- ✅ 급여 상세 데이터

---

## Python 도구

### 1. 백업 생성
```bash
python create_backup.py
```
프로젝트 파일 백업 (HTML, JS, CSS)

### 2. 엑셀 분석
```bash
python analyze_excel.py
```
급여 엑셀 파일 구조 분석

### 3. 보험료 검증
```bash
python check_insurance.py
```
보험료 계산 검증

---

## 브라우저 호환성

✅ Chrome (권장)
✅ Edge
✅ Firefox
⚠️ Safari (일부 기능 제한)

---

## 기술 스택

- **Frontend**: HTML5, CSS3, JavaScript (ES6+)
- **Libraries**:
  - jsPDF: PDF 생성
  - jsPDF-AutoTable: PDF 테이블
  - SheetJS (xlsx): Excel 처리
- **Storage**: LocalStorage
- **Tools**: Python 3.x

---

## 향후 개발 계획

### ✅ 완료된 기능
- [x] 동적 수당 시스템 구축
- [x] 모바일 급여명세서
- [x] 개별 Excel/PDF 출력
- [x] 0원 수당 자동 숨김
- [x] 날짜 키 호환성
- [x] **출퇴근 관리 시스템** (v1.4)
- [x] **휴가 관리 (연차/경조사/병가)** (v1.4)

### 🔜 추가 기능
- [ ] 월별 비교 리포트
- [ ] 서버 백엔드 연동
- [ ] 알림 시스템 (급여 확정 마감일 등)

---

## 문제 해결

### Q1. settings에서 수당을 추가했는데 표시되지 않아요
**A**: v1.1에서 수정되었습니다. 다음을 확인하세요:
- F12 → Console에서 `📊 allowances 로드됨` 메시지 확인
- 수당이 활성화(ON) 상태인지 확인
- 페이지 새로고침 (F5)
- 문제가 계속되면 `ALLOWANCE_SYSTEM_FIX_REPORT.md` 참조

### Q2. 4월은 데이터가 안 보이는데 11월은 보여요
**A**: v1.1에서 수정되었습니다 (날짜 키 호환성 버그).
- 기존 데이터는 자동으로 구버전/신버전 모두 인식합니다
- 새로운 데이터 입력 시 신버전 키로 저장됩니다
- 자세한 내용: `DATEKEY_COMPATIBILITY_FIX.md` 참조

### Q3. 모바일 급여명세서에 새 수당이 안 나와요
**A**: v1.1에서 수정되었습니다.
- 이제 settings에서 추가한 모든 수당이 자동으로 표시됩니다
- 0원 수당은 자동으로 숨겨집니다
- 자세한 내용: `MOBILE_PAYSLIP_DYNAMIC_FIX.md` 참조

### Q4. 데이터가 표시되지 않아요
**A**: 브라우저의 LocalStorage를 확인하세요. F12 → Application → Local Storage

### Q5. PDF가 다운로드되지 않아요
**A**: 팝업 차단 설정을 확인하세요. 브라우저에서 팝업을 허용해야 합니다.

### Q6. 백업 파일을 복원했는데 데이터가 없어요
**A**: 백업 JSON 파일의 형식이 올바른지 확인하세요. `version`, `employees` 필드가 있어야 합니다.

### Q7. 급여가 정확하지 않아요
**A**:
- v1.1에서 야간수당 버그(30% → 130%)가 수정되었습니다
- 설정에서 보험료율과 소득세율을 확인하세요
- 베트남 법률에 따라 변경될 수 있습니다

### Q8. 수당을 삭제했는데 계속 다시 생겨요
**A**: v1.1에서 수정되었습니다 (마이그레이션 무한 반복 버그).
- 이제 수당 삭제 시 영구적으로 삭제됩니다
- 빈 배열도 정상적으로 저장됩니다

---

## 라이센스
This project is for internal use only.

---

## 연락처
**개발자**: Claude Code
**회사**: KHANH QUYNH
**마지막 업데이트**: 2025-12-10

---

## 변경 이력

### v1.4.1 (2025-12-10) - 출퇴근 관리 UX 개선
**UI 개선**:
- ✅ 직원별 4행 그룹 검은 테두리 추가 (시각적 구분 강화)

**입력 검증 강화**:
- ✅ 4가지 경고 유형 (노란색 배경 + 빨간 테두리)
  - 평일/토요일에 Holiday 칸 입력
  - 무급휴가/결근일에 근무시간 입력
  - 유급휴가일에 정규근무 외 시간 입력
  - **일요일에 평일 칸 입력** (신규)
- ✅ 값 삭제 시 경고 자동 제거

**연차/휴가 자동화**:
- ✅ **연차/특별휴가 8시간 고정** (readOnly, 수정 불가)
- ✅ **병가 스마트 처리**
  - 연차 잔여 있음 → 8시간 유급 (annualLeaveDays)
  - 연차 잔여 없음 → 0시간 무급 (excusedAbsents)
- ✅ **0시간 입력 시 사유결근 자동 제안**
  - 확인 창으로 사용자 선택
  - 확인 시 회색 사유결근 자동 설정

**기술 개선**:
- ✅ `updateReadonlyFields()` 함수 추가 (페이지 로드 시 자동 적용)
- ✅ `setWorkValue()` 수정 차단 로직 추가
- ✅ `setLeaveType()` 병가 처리 로직 분기

**영향 파일**:
- attendance.js, attendance.html

---

### v1.4.0 (2025-12-07) - 출퇴근 관리 시스템
**신규 기능**:
- ✅ **출퇴근 관리 페이지** (attendance.html/attendance.js)
  - 엑셀 스타일 월별 출퇴근 테이블
  - 4가지 근무 유형: 정상, 야간, 일요일, 공휴일
  - 스티키 헤더 (스크롤 시 날짜 고정)
  - 직원별/월별 합계 자동 계산
- ✅ **휴가 관리 시스템**
  - 6가지 휴가 유형: 연차, 경조사, 병가, 사유결근, 무단결근, 공휴일
  - 롱프레스 메뉴로 휴가 유형 선택
  - 연차/병가는 연차 일수에서 차감, 경조사는 차감 안 함
  - 음수 연차 허용 (경고 표시 + 사유 입력)
- ✅ **연차 현황 표시**
  - Phép (사용): 연간 누적 사용일수 (1월~현재월)
  - Còn (잔여): 남은 연차일수 자동 계산
- ✅ **급여계산기 양방향 연동**
  - 📥 급여계산기에서 들고오기 버튼
  - 📤 급여계산기로 보내기 버튼
  - leaveData 자동 동기화
- ✅ **급여계산기 휴가 토글 확장**
  - 기존 5단계 → 7단계 토글 사이클
  - 경조사, 병가 추가

**UI/UX 개선**:
- ✅ 색상 표준화 (출퇴근 관리 ↔ 급여계산기)
- ✅ 미저장 변경사항 경고 (beforeunload)
- ✅ 직관적인 휴가 유형 아이콘 및 색상

**영향 파일**:
- 신규: attendance.html, attendance.js
- 수정: salary-input.html, styles.css

---

### v1.3.2 (2025-11-18) - 중간 합계 추가 및 사용성 개선
**주요 기능 추가** (사용자 피드백 반영):
- ✅ **급여 계산 중간 합계**
  - 급여 상세 합계 (정규+야근+야간+일요일)
  - 수당 합계 (식대+모든 수당+특수수당)
  - 최종 정산 요약 박스 (계산 과정 투명화)
  - Excel 급여대장 합계 행 추가

**버그 수정**:
- 🔥 모바일 급여명세서 HTML 저장 개선
  - 데이터를 embedded 스크립트로 파일에 포함
  - 저장된 HTML 파일 독립 실행 가능
  - "데이터가 없습니다" 경고 제거
- ✅ totalSalary 데이터 누락 문제 해결
- ✅ createElement() 오류 수정

**영향 파일**:
- salary-input.html: 중간 합계 UI 및 계산 로직 (+116 lines)
- payslip.html: 최종 정산 요약 & HTML 저장 개선 (+74 lines)

---

### v1.3.1 (2025-11-18) - UI/UX 개선
**UI 개선**:
- ✅ **회사 주소 줄바꿈 지원**
  - .company-address CSS 개선 (white-space: pre-line, word-wrap, max-width)
  - Enter로 입력한 줄바꿈 그대로 화면에 표시
  - 긴 주소 자동 줄바꿈으로 레이아웃 안정화
  - 4개 파일 적용: index.html, index_vn.html, salary-input.html, settings.html
- ✅ **수당 과세 처리 검증**
  - 기본값 "과세" 확인 (베트남 세법 준수)
  - 체크박스로 과세/비과세 선택 가능
  - 안전 장치: 주의 메시지 및 설명란 제공

**문제 해결**:
- 🔥 회사 주소 길 때 화면 찌그러지는 문제 해결
- ✅ 2줄 이상 주소 입력 시 정상 표시

**영향 파일**:
- index.html, index_vn.html, salary-input.html, settings.html (CSS 수정)

---

### v1.3 (2025-11-17) - 특수수당, 선금, 회사 정보 설정
**신규 기능**:
- ✅ **특수수당 시스템**
  - 월별 체크박스 방식 입력
  - 총급여 추가, 전액 과세 처리
  - 실시간 계산 반영
  - 대시보드, 모바일 급여명세서, Excel/PDF 포함
- ✅ **선금 차감 시스템**
  - 월별 체크박스 방식 입력
  - 실수령액 차감 (세후)
  - 실시간 계산 반영
  - 대시보드, 모바일 급여명세서, Excel/PDF 포함
- ✅ **회사 정보 설정**
  - 회사명 입력 (모바일 급여명세서 표시용)
  - 회사 로고 URL 입력
  - settings.html에 🏢 회사 정보 섹션 추가
  - 연도별 독립 관리

**중요 버그 수정**:
- 🔥 **localStorage 키 불일치 수정**
  - data-manager.js: 로드는 `vietnamPayrollSettings_${year}`, 저장은 `vietnamPayrollSettings` 불일치 해결
  - 모든 파일에서 `vietnamPayrollSettings_${year}` 통일
  - 연도 변경 시 회사 설정 자동 갱신
  - clearAllData() 모든 연도별 설정 삭제
- ✅ 기본값에 회사 정보 필드 추가 (companyName, companyLogo)
- ✅ 마이그레이션 로직 추가 (하위 호환성)
- ✅ settings.html 하드코딩 기본값 제거

**UI 개선**:
- 특수수당: 💎 아이콘, 보라색 테마
- 선금: 💰 아이콘, 주황색 테마
- 모바일 급여명세서: 총 급여 기본액, 총 수당, 총 공제액 합계 표시

**영향 파일**:
- salary-input.html: 특수수당/선금 UI, 계산 로직, 데이터 저장/로드
- settings.html/settings.js: 회사 정보 설정
- data-manager.js: localStorage 키 통일
- dashboard.js: 특수수당/선금 열 추가
- payslip.html: 특수수당/선금 표시, 합계 표시
- index.html: 특수수당/선금 열 추가

**문서**:
- `FIX_REPORT_회사정보설정.md` - 회사 정보 설정 및 localStorage 키 통일 수정 보고서

---

### v1.2 (2025-11-16) - 엑셀 템플릿 및 로고 시스템
**신규 기능**:
- ✅ **엑셀 템플릿 시스템** (excel-template.js)
  - 템플릿 다운로드 (샘플 데이터 포함)
  - 직원 데이터 일괄 업로드
  - Excel 날짜 시리얼 변환 지원 (25000 → 1968-06-03)
  - 현재 직원 데이터 엑셀 내보내기
  - 모든 필수 필드 자동 초기화 (15개 필드)
- ✅ **회사 로고 시스템**
  - assets/lgos/ 폴더 구조
  - 다중 회사 프로필 지원
  - 로고 이미지 파일 또는 Base64 저장
  - 모든 페이지 자동 로고 표시
- ✅ **진단 도구**
  - check_data.html: localStorage 전체 검사, 데이터 삭제 기능
  - quick_check.html: 빠른 직원 수 확인
- ✅ **언어 선택 페이지** (start.html)
  - 한국어/베트남어 버전 선택
  - 회사 로고 표시
  - 반응형 디자인

**UI 개선**:
- 로고 크기 확대 (120px → 180px)
- 폰트 강화 (weight: 900, 색상 진하게)
- "베트남 급여 관리 시스템" 텍스트 제거
- 돈 이모지(💰) 제거, 로고로 대체

**버그 수정**:
- ✅ settings.js 템플릿 "일일식대" 컬럼 제거 (회사 설정에서 관리)
- ✅ Excel 템플릿 필드 매핑 오류 수정
- ✅ 직원 객체 필수 필드 15개 완전 초기화

**영향 파일**:
- 신규: excel-template.js, check_data.html, quick_check.html
- 수정: settings.js, settings.html, index.html, index_vn.html, salary-input.html, start.html

---

### v1.1 (2025-11-16) - 동적 수당 시스템 완성
**주요 버그 수정**:
- 🔥 동적 수당 시스템 핵심 버그 수정
  - `companySettings` vs `window.companySettings` 변수 참조 불일치 해결
  - LocalStorage 키 통일 (`vietnamPayrollSettings_${year}`)
  - 마이그레이션 무한 반복 방지
- 🔥 날짜 키 호환성 버그 수정
  - 1~9월 신버전 키 인식 안 되는 문제 해결
  - 구버전/신버전 키 모두 호환
  - **야간수당 30% → 130% 수정** (치명적 버그)
- ✅ 0원 수당 자동 숨김 처리
- ✅ 모바일 급여명세서 동적 수당 지원

**새로운 기능**:
- 🎉 무제한 수당 추가 가능 (하드코딩 3개 → 동적 배열)
- 🎉 모바일 급여명세서 (반응형, PDF 저장)
- 🎉 Excel 급여대장 동적 컬럼 생성
- 🎉 개별 직원 PDF/Excel 동적 수당 포함

**영향 범위**:
- 수정된 함수: 15개 이상
- 수정된 라인: 100+ 라인
- 영향받는 파일: `salary-input.html`, `payslip.html`, `settings.js`

**문서**:
- `ALLOWANCE_SYSTEM_FIX_REPORT.md` - 수당 시스템 버그 수정
- `DATEKEY_COMPATIBILITY_FIX.md` - 날짜 키 호환성 수정
- `DYNAMIC_ALLOWANCE_FIX_STATUS.md` - 동적 수당 표시 수정
- `MOBILE_PAYSLIP_DYNAMIC_FIX.md` - 모바일 급여명세서 수정

---

### v1.0 (2025-11-15) - 초기 릴리즈
- ✅ 직원 관리 기능
- ✅ 급여 계산 엔진
- ✅ PDF/Excel 출력
- ✅ 상태 표시 개선
- ✅ 확정 직원 추적
- ✅ 최초 등록일 기록
- ✅ 보험료 및 소득세 계산
