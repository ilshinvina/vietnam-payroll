<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸‰ì—¬ëª…ì„¸ì„œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .payslip-container {
            max-width: 450px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header .company-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .header .period {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .employee-info {
            background: #f8f9ff;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .employee-info .name {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .employee-info .code {
            font-size: 0.85em;
            color: #666;
        }

        .section {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 0.9em;
        }

        .row .label {
            color: #555;
        }

        .row .value {
            font-weight: 500;
            color: #333;
        }

        .row.highlight {
            background: #f0f4ff;
            margin: 5px -10px;
            padding: 8px 10px;
            border-radius: 8px;
        }

        .row.highlight .label,
        .row.highlight .value {
            font-weight: bold;
            color: #667eea;
        }

        .row.deduction .value {
            color: #e53935;
        }

        .total-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .total-section .label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .total-section .amount {
            font-size: 1.8em;
            font-weight: bold;
            margin-top: 5px;
        }

        .footer {
            padding: 15px 20px;
            text-align: center;
            color: #888;
            font-size: 0.8em;
        }

        .calendar-section {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            margin-top: 10px;
        }

        .calendar-header {
            text-align: center;
            font-size: 0.7em;
            font-weight: bold;
            padding: 5px 0;
            color: #666;
        }

        .calendar-header.sunday {
            color: #e53935;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.75em;
            border: 1px solid #eee;
            position: relative;
            padding: 4px;
        }

        .calendar-day .day-num {
            font-weight: 600;
            font-size: 1.1em;
        }

        .calendar-day .day-label {
            font-size: 0.65em;
            margin-top: 2px;
        }

        /* ê·¼ë¬´ í‘œì‹œ (ë™ê·¸ë¼ë¯¸ + ì‹œê°„) */
        .work-indicators {
            display: flex;
            flex-direction: column;
            gap: 1px;
            margin-top: 2px;
            width: 100%;
            font-size: 0.6em;
        }

        .work-item {
            display: flex;
            align-items: center;
            gap: 2px;
            justify-content: center;
        }

        .work-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .work-dot.overtime {
            background: #ffa000;
        }

        .work-dot.night {
            background: #1976d2;
        }

        .work-dot.sunday-work {
            background: #e64a19;
        }

        .work-dot.night-ot {
            background: #7b1fa2;
        }

        .work-hours {
            font-weight: 500;
            line-height: 1;
        }

        .calendar-day.normal {
            background: white;
            color: #333;
        }

        .calendar-day.sunday {
            background: #ffebee;
            color: #e53935;
            border-color: #ffcdd2;
        }

        .calendar-day.holiday {
            background: #fff3e0;
            color: #e65100;
            border-color: #ffcc80;
        }

        .calendar-day.annual {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
        }

        .calendar-day.excused {
            background: #e3f2fd;
            color: #1565c0;
            border-color: #90caf9;
        }

        .calendar-day.absent {
            background: #333;
            color: white;
            border-color: #333;
        }

        .calendar-day.family {
            background: #f3e5f5;
            color: #9c27b0;
            border-color: #ce93d8;
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
        }

        .calendar-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
            font-size: 0.7em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-box {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .button-section {
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-row {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            color: white;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #ff9a44 0%, #fc6075 100%);
        }

        .btn-html {
            background: linear-gradient(135deg, #2af598 0%, #009efd 100%);
        }

        .btn-print {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-close {
            background: linear-gradient(135deg, #e53935 0%, #c62828 100%);
        }
    </style>
</head>
<body>
    <div class="payslip-container">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="company-name" id="companyName">íšŒì‚¬ëª…</div>
            <div class="period" id="period">ê¸‰ì—¬ëª…ì„¸ì„œ - 00/0000</div>
        </div>

        <!-- ì§ì› ì •ë³´ -->
        <div class="employee-info">
            <div class="name" id="employeeName">ì§ì›ëª…</div>
            <div class="code" id="employeeCode">ì§ì›ì½”ë“œ | ë¶€ì„œ</div>
        </div>

        <!-- ğŸ’µ ê¸‰ì—¬ ìƒì„¸ -->
        <div class="section">
            <div class="section-title">ğŸ’µ ê¸‰ì—¬ ìƒì„¸</div>
            <div class="row">
                <span class="label">ê¸°ë³¸ê¸‰</span>
                <span class="value" id="basicSalary">0 ì›</span>
            </div>
            <div class="row">
                <span class="label">ê·¼ë¬´ì¼ìˆ˜</span>
                <span class="value" id="workDays">0 ì¼</span>
            </div>
            <div class="row">
                <span class="label">ì •ê·œ ê¸‰ì—¬</span>
                <span class="value" id="normalPay">0 ì›</span>
            </div>
            <div class="row" id="overtimeRow" style="display:none;">
                <span class="label" id="overtimeLabel">ì•¼ê·¼ (0h x 150%)</span>
                <span class="value" id="overtimePay">0 ì›</span>
            </div>
            <div class="row" id="nightRow" style="display:none;">
                <span class="label" id="nightLabel">ì•¼ê°„ (0h x 30%)</span>
                <span class="value" id="nightPay">0 ì›</span>
            </div>
            <div class="row" id="nightOTRow" style="display:none;">
                <span class="label" id="nightOTLabel">ì•¼ê°„OT (0h x 195%)</span>
                <span class="value" id="nightOTPay">0 ì›</span>
            </div>
            <div class="row" id="sundayRow" style="display:none;">
                <span class="label" id="sundayLabel">ì¼ìš”ì¼ (0h x 200%)</span>
                <span class="value" id="sundayPay">0 ì›</span>
            </div>
            <div class="row highlight">
                <span class="label">ğŸ’° ì´ ê¸‰ì—¬ ìƒì„¸</span>
                <span class="value" id="salaryDetailTotal">0 ì›</span>
            </div>
        </div>

        <!-- ğŸ ìˆ˜ë‹¹ -->
        <div class="section">
            <div class="section-title">ğŸ ìˆ˜ë‹¹</div>
            <div class="row">
                <span class="label">ì‹ëŒ€</span>
                <span class="value" id="mealAllowance">0 ì›</span>
            </div>
            <div id="dynamicAllowancesList"></div>
            <div class="row" id="specialAllowanceRow" style="display:none;">
                <span class="label">ğŸ’ íŠ¹ë³„ìˆ˜ë‹¹</span>
                <span class="value" id="specialAllowance">0 ì›</span>
            </div>
            <div class="row highlight" style="background:#e8f5e9;">
                <span class="label" style="color:#4caf50;">ğŸ’µ ì´ ìˆ˜ë‹¹</span>
                <span class="value" style="color:#4caf50;" id="allowanceTotal">0 ì›</span>
            </div>
        </div>

        <!-- ğŸ’° ì´ ê¸‰ì—¬ -->
        <div class="section" style="background:#e8f5e9;">
            <div class="section-title" style="color:#4caf50;">ğŸ’° ì´ ê¸‰ì—¬</div>
            <div class="row">
                <span class="label">ê¸‰ì—¬ ìƒì„¸</span>
                <span class="value" id="salaryDetailTotal2">0 ì›</span>
            </div>
            <div class="row">
                <span class="label">+ ìˆ˜ë‹¹</span>
                <span class="value" id="allowanceTotal2">0 ì›</span>
            </div>
            <div class="row highlight" style="background:#c8e6c9;">
                <span class="label" style="color:#2e7d32;font-size:1.1em;">= ì´ ê¸‰ì—¬</span>
                <span class="value" style="color:#2e7d32;font-size:1.2em;" id="totalSalary">0 ì›</span>
            </div>
        </div>

        <!-- ğŸ¥¼ ë³´í—˜ë£Œ ê³µì œ -->
        <div class="section" id="insuranceSection">
            <div class="section-title" style="color:#f57c00;">ğŸ¥¼ ë³´í—˜ë£Œ ê³µì œ (10.5%)</div>
            <div class="row deduction">
                <span class="label">ì‚¬íšŒë³´í—˜ (8%)</span>
                <span class="value" id="socialIns">-0 ì›</span>
            </div>
            <div class="row deduction">
                <span class="label">ê±´ê°•ë³´í—˜ (1.5%)</span>
                <span class="value" id="healthIns">-0 ì›</span>
            </div>
            <div class="row deduction">
                <span class="label">ì‹¤ì—…ë³´í—˜ (1%)</span>
                <span class="value" id="unemployIns">-0 ì›</span>
            </div>
            <div class="row highlight deduction">
                <span class="label">ì´ ê³µì œì•¡</span>
                <span class="value" id="totalDeduction">-0 ì›</span>
            </div>
        </div>

        <!-- ğŸ§¾ ì†Œë“ì„¸ -->
        <div class="section" id="taxSection">
            <div class="section-title" style="color:#e91e63;">ğŸ§¾ ì†Œë“ì„¸</div>
            <div class="row">
                <span class="label">ê³¼ì„¸ì†Œë“</span>
                <span class="value" id="taxableIncome">0 ì›</span>
            </div>
            <div class="row">
                <span class="label">ë³¸ì¸ ê³µì œ</span>
                <span class="value">-11,000,000 ì›</span>
            </div>
            <div class="row" id="dependentRow" style="display:none;">
                <span class="label" id="dependentLabel">ë¶€ì–‘ê°€ì¡± ê³µì œ (0Ã—4,400,000)</span>
                <span class="value" id="dependentDeduction">-0 ì›</span>
            </div>
            <div class="row" style="border-top:1px dashed #ddd;padding-top:6px;margin-top:6px;">
                <span class="label">ê³¼ì„¸í‘œì¤€</span>
                <span class="value" id="taxBase">0 ì›</span>
            </div>
            <div class="row highlight deduction" style="background:#fce4ec;">
                <span class="label" style="color:#e91e63;">ğŸ’° ì†Œë“ì„¸</span>
                <span class="value" style="color:#e91e63;" id="incomeTax">-0 ì›</span>
            </div>
        </div>

        <!-- ğŸ ë¹„ê³¼ì„¸ ë‚´ì—­ -->
        <div class="section" id="taxFreeSection" style="background:#e8f5e9;">
            <div class="section-title" style="color:#4caf50;">ğŸ ë¹„ê³¼ì„¸ ë‚´ì—­</div>
            <div class="row">
                <span class="label">ğŸ’š ì‹ëŒ€ (100%)</span>
                <span class="value" style="color:#4caf50;" id="taxFreeMeal">0 ì›</span>
            </div>
            <div class="row" id="taxFreeOTRow" style="display:none;">
                <span class="label">ğŸ’š ì•¼ê·¼ ë¹„ê³¼ì„¸ (1/3)</span>
                <span class="value" style="color:#4caf50;" id="taxFreeOT">0 ì›</span>
            </div>
            <div class="row" id="taxFreeSundayRow" style="display:none;">
                <span class="label">ğŸ’š ì¼ìš”ì¼ ë¹„ê³¼ì„¸ (1/2)</span>
                <span class="value" style="color:#4caf50;" id="taxFreeSunday">0 ì›</span>
            </div>
            <div class="row highlight" style="background:#c8e6c9;">
                <span class="label" style="color:#2e7d32;">ì´ ë¹„ê³¼ì„¸</span>
                <span class="value" style="color:#2e7d32;" id="totalTaxFree">0 ì›</span>
            </div>
        </div>

        <!-- ì„ ê¸ˆ ì°¨ê° -->
        <div class="section" id="advanceSection" style="display:none;">
            <div class="section-title" style="color:#ff5722;">ğŸ’¸ ì„ ê¸ˆ ì°¨ê°</div>
            <div class="row deduction">
                <span class="label">ì„ ê¸ˆì•¡</span>
                <span class="value" id="advancePayment">-0 ì›</span>
            </div>
        </div>

        <!-- ğŸ’µ ì‹¤ìˆ˜ë ¹ì•¡ -->
        <div class="total-section">
            <div class="label">ğŸ’µ ì‹¤ìˆ˜ë ¹ì•¡</div>
            <div class="amount" id="netSalary">0 ì›</div>
            <div style="font-size:0.8em;opacity:0.9;margin-top:5px;">
                ì´ ê¸‰ì—¬ - ë³´í—˜ë£Œ - ì†Œë“ì„¸ - ì„ ê¸ˆ
            </div>
        </div>

        <!-- ğŸ“… ê·¼ë¬´ ë‹¬ë ¥ -->
        <div class="calendar-section">
            <div class="section-title">ğŸ“… ê·¼ë¬´ ë‹¬ë ¥ - 00/0000</div>
            <div class="calendar-grid" id="calendarGrid">
                <!-- ë‹¬ë ¥ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            <div class="calendar-legend">
                <!-- ë°°ê²½ ìƒíƒœ -->
                <div class="legend-item">
                    <div class="legend-box" style="background:white;"></div>
                    <span>ê·¼ë¬´</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#ffebee;"></div>
                    <span>ì¼ìš”ì¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#fff3e0;"></div>
                    <span>ê³µíœ´ì¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#e8f5e9;"></div>
                    <span>ì—°ì°¨</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#e3f2fd;"></div>
                    <span>ë³‘ê°€</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#f3e5f5;"></div>
                    <span>ê²½ì¡°ì‚¬</span>
                </div>
                <div class="legend-item">
                    <div class="legend-box" style="background:#333;"></div>
                    <span>ê²°ê·¼</span>
                </div>
                <!-- ë™ê·¸ë¼ë¯¸ í‘œì‹œ -->
                <div style="width:100%; height:1px; background:#ddd; margin:5px 0;"></div>
                <div class="legend-item">
                    <div style="width:10px;height:10px;border-radius:50%;background:#ffd700;border:1px solid #ddd;"></div>
                    <span>ì•¼ê·¼</span>
                </div>
                <div class="legend-item">
                    <div style="width:10px;height:10px;border-radius:50%;background:#1e88e5;border:1px solid #ddd;"></div>
                    <span>ì•¼ê°„</span>
                </div>
                <div class="legend-item">
                    <div style="width:10px;height:10px;border-radius:50%;background:#ff6f00;border:1px solid #ddd;"></div>
                    <span>ì¼íŠ¹ê·¼</span>
                </div>
                <div class="legend-item">
                    <div style="width:10px;height:10px;border-radius:50%;background:#9c27b0;border:1px solid #ddd;"></div>
                    <span>ì•¼ê°„OT</span>
                </div>
            </div>
        </div>

        <!-- ë²„íŠ¼ -->
        <div class="button-section">
            <div class="btn-row">
                <button class="btn btn-pdf" onclick="downloadPDF()">ğŸ“„ PDF ë‹¤ìš´ë¡œë“œ</button>
                <button class="btn btn-html" onclick="downloadHTML()">ğŸ“ HTML ë‹¤ìš´ë¡œë“œ</button>
            </div>
            <div class="btn-row">
                <button class="btn btn-print" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / Print</button>
                <button class="btn btn-close" onclick="window.close()">âŒ ë‹«ê¸° / Close</button>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="footer">
            <div>ìƒì„±ì¼ / Created: <span id="createdDate"></span></div>
            <div>Vietnam Payroll System</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const dataString = urlParams.get('data');
        
        if (!dataString) {
            alert('âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
        } else {
            const data = JSON.parse(decodeURIComponent(dataString));
            console.log('ğŸ“¦ ë°›ì€ ë°ì´í„°:', data);
            displayPayslip(data);
        }

        function formatNumber(num) {
            return Math.round(num).toLocaleString('ko-KR');
        }

        function displayPayslip(data) {
            // í—¤ë”
            document.getElementById('companyName').textContent = data.companyName || 'íšŒì‚¬ëª…';
            document.getElementById('period').textContent = `ê¸‰ì—¬ëª…ì„¸ì„œ - ${data.month}/${data.year}`;

            // ì§ì› ì •ë³´
            document.getElementById('employeeName').textContent = data.employeeName || 'ì§ì›ëª…';
            document.getElementById('employeeCode').textContent = 'ì§ì›ì½”ë“œ | ë¶€ì„œ';

            // ê¸‰ì—¬ ìƒì„¸
            document.getElementById('basicSalary').textContent = formatNumber(data.basicSalary) + ' ì›';
            document.getElementById('workDays').textContent = data.workDays + ' ì¼';
            document.getElementById('normalPay').textContent = formatNumber(data.normalPay) + ' ì›';

            // ì•¼ê·¼
            if (data.overtimeHours > 0) {
                document.getElementById('overtimeRow').style.display = '';
                document.getElementById('overtimeLabel').textContent = `ì•¼ê·¼ (${data.overtimeHours}h Ã— 150%)`;
                document.getElementById('overtimePay').textContent = formatNumber(data.overtimePay) + ' ì›';
            }

            // ì•¼ê°„
            if (data.nightHours > 0) {
                document.getElementById('nightRow').style.display = '';
                document.getElementById('nightLabel').textContent = `ì•¼ê°„ (${data.nightHours}h Ã— 30%)`;
                document.getElementById('nightPay').textContent = formatNumber(data.nightPay) + ' ì›';
            }

            // ì•¼ê°„OT
            if (data.nightOTHours > 0) {
                document.getElementById('nightOTRow').style.display = '';
                document.getElementById('nightOTLabel').textContent = `ì•¼ê°„OT (${data.nightOTHours}h Ã— 195%)`;
                document.getElementById('nightOTPay').textContent = formatNumber(data.nightOTPay) + ' ì›';
            }

            // ì¼ìš”ì¼
            if (data.sundayHours > 0) {
                document.getElementById('sundayRow').style.display = '';
                document.getElementById('sundayLabel').textContent = `ì¼ìš”ì¼ (${data.sundayHours}h Ã— 200%)`;
                document.getElementById('sundayPay').textContent = formatNumber(data.sundayPay) + ' ì›';
            }

            // ê¸‰ì—¬ ìƒì„¸ í•©ê³„
            const salaryDetailTotal = data.normalPay + data.overtimePay + data.nightPay + data.nightOTPay + data.sundayPay;
            document.getElementById('salaryDetailTotal').textContent = formatNumber(salaryDetailTotal) + ' ì›';
            document.getElementById('salaryDetailTotal2').textContent = formatNumber(salaryDetailTotal) + ' ì›';

            // ìˆ˜ë‹¹
            document.getElementById('mealAllowance').textContent = formatNumber(data.mealAllowance) + ' ì›';

            // ë™ì  ìˆ˜ë‹¹
            const dynamicList = document.getElementById('dynamicAllowancesList');
            let dynamicTotal = 0;
            if (data.allowances && data.allowances.length > 0) {
                data.allowances.forEach(allowance => {
                    dynamicTotal += allowance.amount;
                    const row = document.createElement('div');
                    row.className = 'row';
                    row.innerHTML = `
                        <span class="label">${allowance.name}</span>
                        <span class="value">${formatNumber(allowance.amount)} ì›</span>
                    `;
                    dynamicList.appendChild(row);
                });
            }

            // íŠ¹ë³„ìˆ˜ë‹¹
            if (data.specialAllowance > 0) {
                document.getElementById('specialAllowanceRow').style.display = '';
                document.getElementById('specialAllowance').textContent = formatNumber(data.specialAllowance) + ' ì›';
            }

            // ìˆ˜ë‹¹ í•©ê³„
            const allowanceTotal = data.mealAllowance + dynamicTotal + data.specialAllowance;
            document.getElementById('allowanceTotal').textContent = formatNumber(allowanceTotal) + ' ì›';
            document.getElementById('allowanceTotal2').textContent = formatNumber(allowanceTotal) + ' ì›';

            // ì´ ê¸‰ì—¬
            document.getElementById('totalSalary').textContent = formatNumber(data.totalSalary) + ' ì›';

            // ë³´í—˜ë£Œ
            document.getElementById('socialIns').textContent = '-' + formatNumber(data.socialIns) + ' ì›';
            document.getElementById('healthIns').textContent = '-' + formatNumber(data.healthIns) + ' ì›';
            document.getElementById('unemployIns').textContent = '-' + formatNumber(data.unemployIns) + ' ì›';
            document.getElementById('totalDeduction').textContent = '-' + formatNumber(data.totalDeduction) + ' ì›';

            // ì†Œë“ì„¸
            const taxableIncome = data.normalPay + data.overtimePay * 2/3 + data.nightPay + data.nightOTPay * 2/3 + data.sundayPay * 1/2 + dynamicTotal + data.specialAllowance;
            document.getElementById('taxableIncome').textContent = formatNumber(taxableIncome) + ' ì›';

            if (data.dependents > 0) {
                document.getElementById('dependentRow').style.display = '';
                document.getElementById('dependentLabel').textContent = `ë¶€ì–‘ê°€ì¡± ê³µì œ (${data.dependents}Ã—4,400,000)`;
                document.getElementById('dependentDeduction').textContent = '-' + formatNumber(data.dependents * 4400000) + ' ì›';
            }

            const taxBase = Math.max(0, taxableIncome - 11000000 - (data.dependents * 4400000));
            document.getElementById('taxBase').textContent = formatNumber(taxBase) + ' ì›';
            document.getElementById('incomeTax').textContent = '-' + formatNumber(data.incomeTax) + ' ì›';

            // ë¹„ê³¼ì„¸
            document.getElementById('taxFreeMeal').textContent = formatNumber(data.mealAllowance) + ' ì›';
            
            if (data.overtimePay > 0) {
                document.getElementById('taxFreeOTRow').style.display = '';
                document.getElementById('taxFreeOT').textContent = formatNumber(data.overtimePay * 1/3) + ' ì›';
            }

            if (data.sundayPay > 0) {
                document.getElementById('taxFreeSundayRow').style.display = '';
                document.getElementById('taxFreeSunday').textContent = formatNumber(data.sundayPay * 1/2) + ' ì›';
            }

            const totalTaxFree = data.mealAllowance + (data.overtimePay * 1/3) + (data.sundayPay * 1/2);
            document.getElementById('totalTaxFree').textContent = formatNumber(totalTaxFree) + ' ì›';

            // ì„ ê¸ˆ
            if (data.advancePayment > 0) {
                document.getElementById('advanceSection').style.display = 'block';
                document.getElementById('advancePayment').textContent = '-' + formatNumber(data.advancePayment) + ' ì›';
            }

            // ì‹¤ìˆ˜ë ¹ì•¡
            document.getElementById('netSalary').textContent = formatNumber(data.netSalary) + ' ì›';

            // ë‹¬ë ¥ ìƒì„±
            generateCalendar(data);

            // ìƒì„±ì¼
            document.getElementById('createdDate').textContent = new Date().toLocaleDateString('ko-KR');
        }

        function generateCalendar(data) {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // ë‹¬ë ¥ í—¤ë”
            const headers = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            headers.forEach((day, i) => {
                const header = document.createElement('div');
                header.className = 'calendar-header' + (i === 0 ? ' sunday' : '');
                header.textContent = day;
                grid.appendChild(header);
            });

            // ì›”ì˜ ì²«ë‚ ê³¼ ë§ˆì§€ë§‰ë‚ 
            const firstDay = new Date(data.year, data.month - 1, 1).getDay();
            const lastDate = new Date(data.year, data.month, 0).getDate();

            // ë°ì´í„° Setìœ¼ë¡œ ë³€í™˜
            const holidays = new Set(data.holidays || []);
            const absents = new Set(data.absents || []);
            const excusedAbsents = new Set(data.excusedAbsents || []);
            const annualLeaveDays = new Set(data.annualLeaveDays || []);
            const specialLeaveDays = new Set(data.specialLeaveDays || []);
            const sickLeaveDays = new Set(data.sickLeaveDays || []);
            const overtimeData = data.overtimeData || {};
            const nightData = data.nightData || {};
            const sundayData = data.sundayData || {};

            // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day empty';
                grid.appendChild(empty);
            }

            // ë‚ ì§œ ì±„ìš°ê¸°
            for (let day = 1; day <= lastDate; day++) {
                const date = new Date(data.year, data.month - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = `${data.year}-${String(data.month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                const cell = document.createElement('div');
                cell.className = 'calendar-day';

                // ë‚ ì§œ ìˆ«ì
                const dayNum = document.createElement('span');
                dayNum.className = 'day-num';
                dayNum.textContent = day;
                cell.appendChild(dayNum);

                // ìƒíƒœ íŒë‹¨ (ìš°ì„ ìˆœìœ„ ìˆœì„œ)
                let status = '';
                let label = '';

                if (absents.has(dateKey)) {
                    cell.classList.add('absent');
                    status = 'absent';
                    label = 'X';
                } else if (holidays.has(dateKey)) {
                    cell.classList.add('holiday');
                    status = 'holiday';
                    label = 'ê³µ';
                } else if (annualLeaveDays.has(dateKey)) {
                    cell.classList.add('annual');
                    status = 'annual';
                    // label = 'ì—°';  // ë°°ê²½ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ê¸€ì ë¶ˆí•„ìš”
                } else if (specialLeaveDays.has(dateKey)) {
                    cell.classList.add('family');
                    status = 'family';
                    // label = 'ê²½';  // ë°°ê²½ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ê¸€ì ë¶ˆí•„ìš”
                } else if (sickLeaveDays.has(dateKey)) {
                    cell.classList.add('excused');
                    status = 'sick';
                    // label = 'ë³‘';  // ë°°ê²½ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ê¸€ì ë¶ˆí•„ìš”
                } else if (excusedAbsents.has(dateKey)) {
                    cell.classList.add('excused');
                    status = 'excused';
                    // label = 'ë¬´';  // ë°°ê²½ìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë¯€ë¡œ ê¸€ì ë¶ˆí•„ìš”
                } else if (dayOfWeek === 0) {
                    cell.classList.add('sunday');
                    status = 'sunday';
                    label = 'ì¼';
                } else {
                    cell.classList.add('normal');
                    status = 'normal';
                }

                // ë¼ë²¨ ì¶”ê°€ (ê²°ê·¼, ê³µíœ´ì¼, ì¼ìš”ì¼ë§Œ)
                if (label) {
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'day-label';
                    labelSpan.textContent = label;
                    cell.appendChild(labelSpan);
                }

                // ê·¼ë¬´ í‘œì‹œ ì¶”ê°€ (ë™ê·¸ë¼ë¯¸ + ì‹œê°„)
                const indicators = document.createElement('div');
                indicators.className = 'work-indicators';
                
                let hasIndicator = false;
                
                if (overtimeData[dateKey] && overtimeData[dateKey] > 0) {
                    const item = document.createElement('div');
                    item.className = 'work-item';
                    const dot = document.createElement('div');
                    dot.className = 'work-dot overtime';
                    const hours = document.createElement('span');
                    hours.className = 'work-hours';
                    hours.textContent = `+${overtimeData[dateKey]}`;
                    item.appendChild(dot);
                    item.appendChild(hours);
                    indicators.appendChild(item);
                    hasIndicator = true;
                }
                
                if (nightData[dateKey] && nightData[dateKey] > 0) {
                    const item = document.createElement('div');
                    item.className = 'work-item';
                    const dot = document.createElement('div');
                    dot.className = 'work-dot night';
                    const hours = document.createElement('span');
                    hours.className = 'work-hours';
                    hours.textContent = `+${nightData[dateKey]}`;
                    item.appendChild(dot);
                    item.appendChild(hours);
                    indicators.appendChild(item);
                    hasIndicator = true;
                }
                
                if (sundayData[dateKey] && sundayData[dateKey] > 0) {
                    const item = document.createElement('div');
                    item.className = 'work-item';
                    const dot = document.createElement('div');
                    dot.className = 'work-dot sunday-work';
                    const hours = document.createElement('span');
                    hours.className = 'work-hours';
                    hours.textContent = `+${sundayData[dateKey]}`;
                    item.appendChild(dot);
                    item.appendChild(hours);
                    indicators.appendChild(item);
                    hasIndicator = true;
                }
                
                // ì•¼ê°„OT
                if (data.nightOTData && data.nightOTData[dateKey] && data.nightOTData[dateKey] > 0) {
                    const item = document.createElement('div');
                    item.className = 'work-item';
                    const dot = document.createElement('div');
                    dot.className = 'work-dot night-ot';
                    const hours = document.createElement('span');
                    hours.className = 'work-hours';
                    hours.textContent = `+${data.nightOTData[dateKey]}`;
                    item.appendChild(dot);
                    item.appendChild(hours);
                    indicators.appendChild(item);
                    hasIndicator = true;
                }
                
                if (hasIndicator) {
                    cell.appendChild(indicators);
                }

                grid.appendChild(cell);
            }

            // ë‹¬ë ¥ ì œëª© ì—…ë°ì´íŠ¸
            document.querySelector('.calendar-section .section-title').textContent = 
                `ğŸ“… ê·¼ë¬´ ë‹¬ë ¥ - ${data.month}/${data.year}`;
        }

        function downloadPDF() {
            const element = document.querySelector('.payslip-container');
            const employeeName = document.getElementById('employeeName').textContent;
            const period = document.getElementById('period').textContent.replace('ê¸‰ì—¬ëª…ì„¸ì„œ - ', '');
            
            const opt = {
                margin: 5,
                filename: `ê¸‰ì—¬ëª…ì„¸ì„œ_${employeeName}_${period}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.querySelector('.button-section').style.display = 'none';
            
            html2pdf().set(opt).from(element).save().then(() => {
                document.querySelector('.button-section').style.display = '';
            });
        }

        function downloadHTML() {
            const employeeName = document.getElementById('employeeName').textContent;
            const period = document.getElementById('period').textContent.replace('ê¸‰ì—¬ëª…ì„¸ì„œ - ', '');
            
            // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            const buttonSection = document.querySelector('.button-section');
            buttonSection.style.display = 'none';
            
            const htmlContent = document.documentElement.outerHTML;
            
            // ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
            buttonSection.style.display = '';
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ê¸‰ì—¬ëª…ì„¸ì„œ_${employeeName}_${period}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
