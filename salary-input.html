<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë² íŠ¸ë‚¨ ê¸‰ì—¬ ê³„ì‚°ê¸° - ê¸‰ì—¬ ë“±ë¡</title>

    <!-- SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- jsPDF ë¼ì´ë¸ŒëŸ¬ë¦¬ (PDF ìƒì„±) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- ìŠ¤íƒ€ì¼ì‹œíŠ¸ -->
    <link rel="stylesheet" href="styles.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .modern-header {
            background: white;
            padding: 30px 40px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            position: relative;
        }

        .company-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
        }

        .company-info {
            text-align: left;
        }

        .company-name {
            font-size: 1.4em;
            color: #1a1a1a;
            font-weight: 900;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .company-address {
            font-size: 1em;
            color: #444;
            font-weight: 600;
            line-height: 1.6;
            white-space: pre-line;
            word-wrap: break-word;
            max-width: 600px;
        }

        .modern-header h1 {
            font-size: 2em;
            color: #667eea;
            margin: 0;
        }

        .modern-header p {
            color: #999;
            margin: 5px 0 0 0;
        }

        .btn-home-modern {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-home-modern:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modern-content-wrapper {
            background: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 0;
        }

        .action-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
        }

        .modern-btn {
            transition: all 0.3s ease;
        }

        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1600px; margin: 0 auto;">
        <div class="modern-header">
            <div>
                <div class="company-header" id="companyHeader">
                    <!-- Company logo and info will be loaded here -->
                </div>
                <h1 style="font-size: 2.2em; font-weight: 800; color: #667eea;">ê¸‰ì—¬ ê³„ì‚°ê¸° v2.0</h1>
                <p id="systemSubtitle" style="font-size: 1.1em; font-weight: 600; color: #555;">ë‹¬ë ¥ ê¸°ë°˜ ìë™ ê³„ì‚° ì‹œìŠ¤í…œ</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="settings.html" class="btn-home-modern">âš™ï¸ ì„¤ì •</a>
                <a href="index.html" class="btn-home-modern">ğŸ  í™ˆìœ¼ë¡œ</a>
            </div>
        </div>

        <div class="modern-content-wrapper">

        <div class="main-content" style="padding: 30px 40px;">
            <!-- ì…ë ¥ ì„¹ì…˜ -->
            <div class="input-section">
                <!-- ìƒë‹¨ ì•¡ì…˜ ì¹´ë“œ -->
                <div class="action-card">
                    <h2 class="section-title" style="color: #667eea;">ğŸ‘¥ ì§ì› ì„ íƒ</h2>

                    <div class="input-group">
                        <select id="employeeSelect" style="width: 100%; padding: 14px 16px; border-radius: 10px; border: 2px solid #e0e0e0; font-size: 1.1em; background: #fafafa; transition: all 0.3s;">
                            <option value="">-- ì§ì› ì„ íƒ --</option>
                        </select>
                    </div>
                </div>

                <!-- ê¸‰ì—¬ ë°ì´í„° ê´€ë¦¬ ì¹´ë“œ -->
                <div class="action-card">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.2em;">ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                        ğŸ’¡ ì§ì› ë“±ë¡ì€ <a href="settings.html" style="color: #667eea; font-weight: bold;">âš™ï¸ ì„¤ì • í˜ì´ì§€</a>ì—ì„œ í•˜ì„¸ìš”!
                    </p>

                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="printCurrentEmployeePDF()" class="modern-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); font-size: 1.05em;">
                            ğŸ“„ ê¸‰ì—¬ëª…ì„¸ì„œ PDF
                        </button>
                        <button onclick="exportCurrentEmployeeExcel()" class="modern-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.05em; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);">
                            ğŸ“Š ê¸‰ì—¬ëª…ì„¸ì„œ ì—‘ì…€
                        </button>
                    </div>

                    <!-- ë°ì´í„° í™•ì • ë²„íŠ¼ -->
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);">
                        <button onclick="confirmCurrentEmployee()" class="modern-btn" style="width: 100%; padding: 16px; background: white; color: #667eea; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.2em; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;">
                            âœ… í˜„ì¬ ì§ì› ë°ì´í„° í™•ì •
                        </button>
                        <p style="color: white; margin-top: 10px; font-size: 0.9em; text-align: center; margin-bottom: 0;">
                            í™•ì •ëœ ì§ì›ë§Œ ë©”ì¸ í˜ì´ì§€ì— í‘œì‹œë©ë‹ˆë‹¤!
                        </p>
                        <div id="confirmStatus" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; text-align: center; color: white; font-size: 0.9em; display: none;">
                            <!-- í™•ì • ìƒíƒœ í‘œì‹œ -->
                        </div>
                    </div>

                    <!-- ì´ë²ˆ ë‹¬ ë°ì´í„° ì´ˆê¸°í™” ë²„íŠ¼ -->
                    <div style="margin-top: 10px;">
                        <button onclick="clearCurrentMonthData()" class="modern-btn" style="width: 100%; padding: 12px; background: #e53935; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 4px 10px rgba(229, 57, 53, 0.3); transition: all 0.3s;">
                            ğŸ—‘ï¸ ì´ë²ˆ ë‹¬ ë°ì´í„° ì´ˆê¸°í™”
                        </button>
                        <p style="color: #666; margin-top: 5px; font-size: 0.85em; text-align: center; margin-bottom: 0;">
                            í˜„ì¬ ì§ì›ì˜ ì´ë²ˆ ë‹¬ ê·¼íƒœ/ì”ì—… ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤
                        </p>
                    </div>

                    <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; font-size: 0.85em; color: #e65100;">
                        <div><strong>ğŸ“„ ê°œì¸ ê¸‰ì—¬ëª…ì„¸ì„œ:</strong> í˜„ì¬ ì„ íƒëœ ì§ì›ì˜ ê¸‰ì—¬ëª…ì„¸ë¥¼ PDFë¡œ ì¶œë ¥</div>
                        <div style="margin-top: 5px;"><strong>ğŸ’¾ ì „ì²´ ë°ì´í„° ë°±ì—…:</strong> ëª¨ë“  ì§ì› ì •ë³´ + ê¸‰ì—¬ ì´ë ¥ì„ JSON íŒŒì¼ë¡œ ì €ì¥ (ì»´í“¨í„° ë¬¸ì œ ëŒ€ë¹„)</div>
                    </div>
                </div>

                <h2 class="section-title">ğŸ“ ê¸°ë³¸ ì •ë³´</h2>

                <div class="input-group">
                    <label>ì§ì› ì´ë¦„</label>
                    <input type="text" id="employeeName" placeholder="ì˜ˆ: ì‘ìš°ì˜Œ ë°˜ ë‚¨">
                </div>

                <div class="input-group">
                    <label>ê¸°ë³¸ê¸‰ (ë™/ì›”)</label>
                    <input type="number" id="basicSalary" value="6980000" placeholder="6,980,000">
                </div>

                <div class="input-group">
                    <label>ì¼ì¼ ì‹ëŒ€ (ë™/ì¼)</label>
                    <input type="number" id="dailyMeal" value="25000" placeholder="25,000">
                    <div class="tip">â€» ì‹¤ê·¼ë¬´ì¼ Ã— ì¼ì¼ì‹ëŒ€ë¡œ ìë™ ê³„ì‚°</div>
                </div>

                <div class="date-selector">
                    <div class="input-group">
                        <label>ë…„ë„</label>
                        <select id="yearSelect"></select>
                    </div>
                    <div class="input-group">
                        <label>ì›”</label>
                        <select id="monthSelect"></select>
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-title" id="calendarTitle">2025ë…„ 11ì›”</div>
                    </div>
                    <div class="calendar-grid" id="calendar"></div>
                </div>

                <div class="stats-box">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š ê·¼ë¬´ í†µê³„</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">ì´ ì¼ìˆ˜</span>
                            <span class="stat-value" id="totalDays">30ì¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">í‰ì¼</span>
                            <span class="stat-value" id="weekdays">26ì¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ì¼ìš”ì¼</span>
                            <span class="stat-value" id="weekends">4ì¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ê³µíœ´ì¼</span>
                            <span class="stat-value" id="holidays">0ì¼</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #ab47bc;">
                            <span class="stat-label" style="color: #ab47bc;">ì‚¬ìœ ê²°ê·¼</span>
                            <span class="stat-value" style="color: #ab47bc;" id="excusedAbsents">0ì¼</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e53935;">
                            <span class="stat-label" style="color: #e53935;">âš ï¸ ë¬´ë‹¨ê²°ê·¼</span>
                            <span class="stat-value" style="color: #e53935;" id="unexcusedAbsents">0ì¼</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">ğŸŒ´ ì—°ì°¨ ì‚¬ìš©</span>
                            <span class="stat-value" style="color: #4caf50;" id="annualLeaveCount">0ì¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ì‹¤ ê·¼ë¬´ì¼</span>
                            <span class="stat-value" id="workDays">22ì¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ì •ê·œì‹œê°„</span>
                            <span class="stat-value" id="normalHours">176h</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e91e63;">
                            <span class="stat-label" style="color: #e91e63;">â° ì´ ì•¼ê·¼</span>
                            <span class="stat-value" style="color: #e91e63;" id="totalOvertimeDisplay">0h</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e53935;">
                            <span class="stat-label" style="color: #e53935;">ğŸŒ ì´ íŠ¹ê·¼</span>
                            <span class="stat-value" style="color: #e53935;" id="totalSundayDisplay">0h</span>
                        </div>
                        <div class="stat-item" style="background: #fff3e0; border-left-color: #ff9800;">
                            <span class="stat-label" style="color: #ff9800; font-weight: bold;">ğŸš ì´ ì‹ëŒ€ = <span id="totalMealCount" style="font-size: 1.3em;">0ì‹</span></span>
                            <span class="stat-value" style="color: #ff9800; font-weight: bold;" id="autoMeal">550,000Ä‘</span>
                        </div>
                        <div class="stat-item" id="statsWeekdayLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” í‰ì¼ ì ì‹¬</span>
                            <span class="stat-value" id="weekdayLunchCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="statsWeekdayDinnerRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” í‰ì¼ ì €ë… (ì•¼ê·¼)</span>
                            <span class="stat-value" id="weekdayDinnerCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="statsSundayLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” ì¼ìš”ì¼ ì ì‹¬</span>
                            <span class="stat-value" id="sundayLunchCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="statsSundayDinnerRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” ì¼ìš”ì¼ ì €ë…</span>
                            <span class="stat-value" id="sundayDinnerCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="statsAnnualLeaveLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” ì—°ì°¨ ì ì‹¬</span>
                            <span class="stat-value" id="annualLeaveLunchCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="statsExcusedAbsentLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">â”” ì‚¬ìœ ê²°ê·¼ ì ì‹¬</span>
                            <span class="stat-value" id="excusedAbsentLunchCount">0ì‹</span>
                        </div>
                        <div class="stat-item" id="attendanceBonusContainer" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">ğŸ ê°œê·¼ìˆ˜ë‹¹</span>
                            <span class="stat-value" style="color: #4caf50;" id="attendanceBonus">0Ä‘</span>
                        </div>
                        <div class="stat-item" id="transportBonusContainer" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">ğŸš— êµí†µë¹„</span>
                            <span class="stat-value" style="color: #4caf50;" id="transportBonus">0Ä‘</span>
                        </div>
                        <!-- ë™ì  ìˆ˜ë‹¹ ëª©ë¡ (ì„¤ì •ì—ì„œ ì¶”ê°€í•œ ìˆ˜ë‹¹ë“¤) -->
                        <div id="dynamicAllowancesList" style="display: contents;">
                            <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                        </div>
                    </div>
                </div>

                <!-- ìˆ¨ê²¨ì§„ í•„ë“œ: ë‹¬ë ¥ì—ì„œ ìë™ ê³„ì‚°ë˜ì–´ ì±„ì›Œì§ -->
                <input type="hidden" id="overtimeHours" value="0">
                <input type="hidden" id="nightHours" value="0">
                <input type="hidden" id="sundayHours" value="0">
                <input type="hidden" id="totalAllowancesHidden" value="0">

                <div class="input-group" style="margin-top: 20px;">
                    <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ë¶€ì–‘ê°€ì¡± ìˆ˜ (ëª…)</label>
                    <input type="number" id="dependents" value="0" min="0" step="1" placeholder="0">
                    <div class="tip">â€» ë³¸ì¸ 11,000,000Ä‘ + ë¶€ì–‘ê°€ì¡± 4,400,000Ä‘/ì¸</div>
                </div>

                <!-- íŠ¹ìˆ˜ìˆ˜ë‹¹ ì²´í¬ë°•ìŠ¤ -->
                <div class="input-group" style="margin-top: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #9c27b0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="specialAllowanceEnabled" onchange="toggleSpecialAllowance()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="specialAllowanceEnabled" style="margin: 0; font-weight: bold; color: #9c27b0; font-size: 1.1em; cursor: pointer;">
                            ğŸ’ íŠ¹ìˆ˜ìˆ˜ë‹¹ (Phá»¥ cáº¥p Ä‘áº·c biá»‡t)
                        </label>
                    </div>
                    <input type="number" id="specialAllowanceAmount" value="0" min="0" step="100000" placeholder="0" disabled style="background: #f5f5f5;" oninput="calculate()">
                    <div class="tip">â€» ì²´í¬ ì‹œ ì…ë ¥í•œ ê¸ˆì•¡ì´ ì´ê¸‰ì—¬ì— ì¶”ê°€ë©ë‹ˆë‹¤ (ê³¼ì„¸ ì²˜ë¦¬)</div>
                </div>

                <!-- ì„ ê¸ˆ ì²´í¬ë°•ìŠ¤ -->
                <div class="input-group" style="margin-top: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="advancePaymentEnabled" onchange="toggleAdvancePayment()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="advancePaymentEnabled" style="margin: 0; font-weight: bold; color: #ff9800; font-size: 1.1em; cursor: pointer;">
                            ğŸ’° ì„ ê¸ˆ ì°¨ê° (á»¨ng lÆ°Æ¡ng)
                        </label>
                    </div>
                    <input type="number" id="advancePaymentAmount" value="0" min="0" step="100000" placeholder="0" disabled style="background: #f5f5f5;" oninput="calculate()">
                    <div class="tip">â€» ì²´í¬ ì‹œ ì…ë ¥í•œ ê¸ˆì•¡ì´ ì‹¤ìˆ˜ë ¹ì•¡ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤</div>
                </div>

                <button class="btn-calculate" onclick="calculate()">ğŸ’µ ê¸‰ì—¬ ê³„ì‚°í•˜ê¸°</button>
                <button class="btn-calculate" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-top: 10px;" onclick="openMobilePayslip()">ğŸ“± ëª¨ë°”ì¼ ê¸‰ì—¬ëª…ì„¸ì„œ</button>
            </div>

            <!-- ê²°ê³¼ ì„¹ì…˜ -->
            <div class="result-section">
                <h2 class="section-title">ğŸ“Š ê³„ì‚° ê²°ê³¼</h2>
                
                <div id="employeeNameResult" style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-bottom: 20px; text-align: center;">
                    ì§ì› ì´ë¦„
                </div>

                <div class="result-box">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ’µ ê¸‰ì—¬ ìƒì„¸</h3>
                    <div class="result-item">
                        <span class="result-label">ì‹œê°„ë‹¹ ê¸‰ì—¬</span>
                        <span class="result-value" id="hourlyRate">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì •ê·œ ê·¼ë¬´</span>
                        <span class="result-value" id="normalPay">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì•¼ê·¼ ìˆ˜ë‹¹ (150%)</span>
                        <span class="result-value" id="overtimePay">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì•¼ê°„ ìˆ˜ë‹¹ (130%)</span>
                        <span class="result-value" id="nightPay">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì¼ìš”ì¼ ìˆ˜ë‹¹ (200%)</span>
                        <span class="result-value" id="sundayPay">0 Ä‘</span>
                    </div>
                    <!-- ê¸‰ì—¬ ìƒì„¸ í•©ê³„ -->
                    <div class="result-item" style="border-top: 2px solid #667eea; padding-top: 15px; margin-top: 10px; background: #e8eaf6;">
                        <span class="result-label" style="color: #667eea; font-weight: bold; font-size: 1.1em;">ğŸ’° ê¸‰ì—¬ ìƒì„¸ í•©ê³„</span>
                        <span class="result-value" style="color: #667eea; font-size: 1.3em; font-weight: bold;" id="salaryDetailTotal">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box" style="background: #f1f8f4; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">ğŸŒ´ ì—°ì°¨ í˜„í™©</h3>
                    <div class="result-item">
                        <span class="result-label">ì˜¬í•´ ë°œìƒ ì—°ì°¨</span>
                        <span class="result-value" id="annualLeaveTotal">12ì¼</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì—°ì°¨ ì¡°ì •</span>
                        <span class="result-value" id="annualLeavePreUsed">+0ì¼</span>
                        <div style="font-size: 0.75em; color: #666; margin-top: 3px;">
                            ğŸ’¡ +ìˆ«ì: ì¶”ê°€ì§€ê¸‰(ì´ì›”) / -ìˆ«ì: ì´ë¯¸ì‚¬ìš©
                        </div>
                    </div>
                    <div class="result-item" style="background: #c8e6c9;">
                        <span class="result-label">ì´ë²ˆë‹¬ ì‚¬ìš© ì—°ì°¨</span>
                        <span class="result-value" style="color: #2e7d32;" id="annualLeaveThisMonth">0ì¼</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #4caf50; padding-top: 10px; margin-top: 5px;">
                        <span class="result-label" style="font-weight: bold;">ì‚¬ìš©ê°€ëŠ¥ ì—°ì°¨</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.2em; font-weight: bold;" id="annualLeaveRemaining">12ì¼</span>
                    </div>
                </div>

                <div class="result-box">
                    <h3 style="color: #28a745; margin-bottom: 15px;">ğŸ ìë™ ìˆ˜ë‹¹</h3>
                    <div class="result-item" style="background: #fff3e0; border-left: 3px solid #ff9800;">
                        <span class="result-label" style="color: #ff9800; font-weight: bold;">ğŸš ì´ ì‹ëŒ€ = <span id="resultTotalMealCount" style="font-size: 1.3em;">0ì‹</span></span>
                        <span class="result-value" style="color: #ff9800; font-weight: bold;" id="mealDisplay">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultWeekdayLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” í‰ì¼ ì ì‹¬: <span id="resultWeekdayLunch">0ì‹</span></span>
                        <span class="result-value" id="resultWeekdayLunchAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultWeekdayDinnerRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” í‰ì¼ ì €ë… (ì•¼ê·¼): <span id="resultWeekdayDinner">0ì‹</span></span>
                        <span class="result-value" id="resultWeekdayDinnerAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultSundayLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” ì¼ìš”ì¼ ì ì‹¬: <span id="resultSundayLunch">0ì‹</span></span>
                        <span class="result-value" id="resultSundayLunchAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultSundayDinnerRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” ì¼ìš”ì¼ ì €ë…: <span id="resultSundayDinner">0ì‹</span></span>
                        <span class="result-value" id="resultSundayDinnerAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultAnnualLeaveLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” ì—°ì°¨ ì ì‹¬: <span id="resultAnnualLeaveLunch">0ì‹</span></span>
                        <span class="result-value" id="resultAnnualLeaveLunchAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="resultExcusedAbsentLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">â”” ì‚¬ìœ ê²°ê·¼ ì ì‹¬: <span id="resultExcusedAbsentLunch">0ì‹</span></span>
                        <span class="result-value" id="resultExcusedAbsentLunchAmount">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="attendanceBonusResultContainer" style="background: #e8f5e9;">
                        <span class="result-label">ğŸ ê°œê·¼ìˆ˜ë‹¹</span>
                        <span class="result-value" style="color: #4caf50;" id="attendanceBonusDisplay">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="transportBonusResultContainer" style="background: #e8f5e9;">
                        <span class="result-label">ğŸš— êµí†µë¹„</span>
                        <span class="result-value" style="color: #4caf50;" id="transportDisplay">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="riskDisplayResultContainer">
                        <span class="result-label">ìœ„í—˜ìˆ˜ë‹¹</span>
                        <span class="result-value" id="riskDisplay">100,000 Ä‘</span>
                    </div>
                    <!-- ë™ì  ìˆ˜ë‹¹ ëª©ë¡ (ê³„ì‚° ê²°ê³¼) -->
                    <div id="resultDynamicAllowancesList">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                    <!-- íŠ¹ìˆ˜ìˆ˜ë‹¹ -->
                    <div class="result-item" id="specialAllowanceResultContainer" style="display: none; border-top: 2px solid #9c27b0; padding-top: 10px; margin-top: 10px;">
                        <span class="result-label" style="color: #9c27b0; font-weight: bold;">ğŸ’ íŠ¹ìˆ˜ìˆ˜ë‹¹</span>
                        <span class="result-value" style="color: #9c27b0; font-weight: bold;" id="specialAllowanceResult">0 Ä‘</span>
                    </div>
                    <!-- ìˆ˜ë‹¹ í•©ê³„ -->
                    <div class="result-item" style="border-top: 2px solid #28a745; padding-top: 15px; margin-top: 10px; background: #d4edda;">
                        <span class="result-label" style="color: #28a745; font-weight: bold; font-size: 1.1em;">ğŸ’µ ìˆ˜ë‹¹ í•©ê³„</span>
                        <span class="result-value" style="color: #28a745; font-size: 1.3em; font-weight: bold;" id="allowanceTotal">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box">
                    <h3 style="color: #2196f3; margin-bottom: 15px;">ğŸ¢ íšŒì‚¬ ë¶€ë‹´ê¸ˆ (ì°¸ê³ ìš©)</h3>
                    <div class="result-item">
                        <span class="result-label">BHXH | ì‚¬íšŒë³´í—˜ (17.5%)</span>
                        <span class="result-value" id="companySocialIns">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHYT | ê±´ê°•ë³´í—˜ (3%)</span>
                        <span class="result-value" id="companyHealthIns">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHTN | ì‹¤ì—…ë³´í—˜ (1%)</span>
                        <span class="result-value" id="companyUnemployIns">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #2196f3; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #2196f3;">ì´ íšŒì‚¬ ë¶€ë‹´ (21.5%)</span>
                        <span class="result-value" style="color: #2196f3; font-size: 1.2em;" id="totalCompanyIns">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box">
                    <h3 style="color: #f57c00; margin-bottom: 15px;">ğŸ¥ ê·¼ë¡œì ê³µì œ (10.5%)</h3>
                    <div class="result-item">
                        <span class="result-label">BHXH | ì‚¬íšŒë³´í—˜ (8%)</span>
                        <span class="result-value" id="socialIns">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHYT | ê±´ê°•ë³´í—˜ (1.5%)</span>
                        <span class="result-value" id="healthIns">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHTN | ì‹¤ì—…ë³´í—˜ (1%)</span>
                        <span class="result-value" id="unemployIns">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #f57c00; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #f57c00;">ì´ ê³µì œì•¡</span>
                        <span class="result-value" style="color: #f57c00; font-size: 1.2em;" id="totalDeduction">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box">
                    <h3 style="color: #e91e63; margin-bottom: 15px;">ğŸ§¾ ê°œì¸ì†Œë“ì„¸ (TNCN)</h3>
                    <div class="result-item">
                        <span class="result-label">ê³¼ì„¸ ëŒ€ìƒ ì†Œë“</span>
                        <span class="result-value" id="taxableIncome">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ê°€ì¡± ê³µì œ (ë³¸ì¸)</span>
                        <span class="result-value">11,000,000 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ê°€ì¡± ê³µì œ (ë¶€ì–‘ê°€ì¡±)</span>
                        <span class="result-value" id="dependentDeduction">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ì´ ê°€ì¡± ê³µì œ</span>
                        <span class="result-value" id="totalFamilyDeduction">11,000,000 Ä‘</span>
                    </div>
                    <div class="result-item" style="background: #fff3e0;">
                        <span class="result-label">ê³¼ì„¸ í‘œì¤€</span>
                        <span class="result-value" id="taxBase">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #e91e63; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #e91e63;">ê°œì¸ì†Œë“ì„¸</span>
                        <span class="result-value" style="color: #e91e63; font-size: 1.2em;" id="incomeTax">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">ğŸ ë¹„ê³¼ì„¸ ë‚´ì—­</h3>
                    <div class="result-item">
                        <span class="result-label">ğŸ’š ì‹ëŒ€ (100% ë¹„ê³¼ì„¸)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeMeal">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ’š ì•¼ê·¼ ë¹„ê³¼ì„¸ (1/3)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeOvertime">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">ğŸ’š íŠ¹ê·¼ ë¹„ê³¼ì„¸ (1/2)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeSunday">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #4caf50; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #4caf50; font-weight: bold;">ì´ ë¹„ê³¼ì„¸</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.2em;" id="totalTaxFree">0 Ä‘</span>
                    </div>
                </div>

                <div class="result-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">ğŸ’° ì´ ê¸‰ì—¬</h3>
                    <div class="result-item">
                        <span class="result-label" style="font-size: 1.2em;">ì´ ì§€ê¸‰ì•¡</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.3em;" id="totalSalary">0 Ä‘</span>
                    </div>
                </div>

                <!-- ì„ ê¸ˆ ì°¨ê° -->
                <div class="result-box" id="advancePaymentResultContainer" style="background: #fff3e0; border-left-color: #ff9800; display: none;">
                    <h3 style="color: #ff9800; margin-bottom: 15px;">ğŸ’° ì„ ê¸ˆ ì°¨ê°</h3>
                    <div class="result-item">
                        <span class="result-label" style="color: #ff9800; font-weight: bold;">á»¨ng lÆ°Æ¡ng | ì„ ê¸ˆ</span>
                        <span class="result-value" style="color: #ff9800; font-size: 1.2em; font-weight: bold;" id="advancePaymentResult">0 Ä‘</span>
                    </div>
                    <div class="tip" style="color: #666; margin-top: 10px;">â€» ì‹¤ìˆ˜ë ¹ì•¡ì—ì„œ ì°¨ê°ë©ë‹ˆë‹¤</div>
                </div>

                <!-- ìµœì¢… ì •ì‚° ìš”ì•½ -->
                <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 1.3em;">ğŸ“Š ìµœì¢… ì •ì‚°</h3>
                    <div class="result-item" style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">ê¸‰ì—¬ ìƒì„¸ í•©ê³„</span>
                        <span class="result-value" style="color: white;" id="finalSalaryDetail">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">ìˆ˜ë‹¹ í•©ê³„</span>
                        <span class="result-value" style="color: white;" id="finalAllowanceTotal">0 Ä‘</span>
                    </div>
                    <div class="result-item" style="border-bottom: 2px solid white; padding-bottom: 15px; margin-bottom: 15px;">
                        <span class="result-label" style="color: white; font-weight: bold; font-size: 1.1em;">= ì´ ê¸‰ì—¬</span>
                        <span class="result-value" style="color: #ffd700; font-size: 1.3em; font-weight: bold;" id="finalTotalSalary">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- ë³´í—˜ë£Œ ê³µì œ</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalDeduction">0 Ä‘</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- ê°œì¸ì†Œë“ì„¸</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalIncomeTax">0 Ä‘</span>
                    </div>
                    <div class="result-item" id="finalAdvancePaymentRow" style="display: none;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- ì„ ê¸ˆ</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalAdvancePayment">0 Ä‘</span>
                    </div>
                </div>

                <div class="highlight-box">
                    <div style="font-size: 1.2em;">ğŸ’° ì‹¤ìˆ˜ë ¹ì•¡</div>
                    <div class="big-number" id="netSalary">0 Ä‘</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">ì´ ê¸‰ì—¬ - ê³µì œì•¡ - ê°œì¸ì†Œë“ì„¸</div>
                </div>
            </div>
        </div>

        <!-- ê³„ì‚° ê³µì‹ ì„¤ëª… -->
        <div style="padding: 0 40px 40px 40px;">
            <div class="formula-section">
                <div class="formula-title">ğŸ§® ìë™ ê³„ì‚° ê·œì¹™</div>
                <div class="formula-item">
                    <strong>ì‹¤ ê·¼ë¬´ì¼</strong> = í‰ì¼ - ê³µíœ´ì¼ - ê²°ê·¼
                </div>
                <div class="formula-item">
                    <strong>ì •ê·œ ì‹œê°„</strong> = ê° ë‚ ì§œì˜ ì‹¤ì œ ê·¼ë¬´ì‹œê°„ í•©ê³„ (ê¸°ë³¸ 8h/ì¼)
                </div>
                <div class="formula-item">
                    <strong>ì‹ëŒ€</strong> = ì‹¤ ê·¼ë¬´ì¼ì— ë”°ë¼ ìë™ ê³„ì‚° (íšŒì‚¬ ì„¤ì •ì—ì„œ ê¸ˆì•¡/ì¡°ê±´ ì„¤ì •)
                </div>
                <div class="formula-item" style="background: #e8f5e9; border-left: 3px solid #4caf50;">
                    <strong>ìˆ˜ë‹¹</strong> = íšŒì‚¬ ì„¤ì •ì—ì„œ ë“±ë¡í•œ ìˆ˜ë‹¹ë“¤ (ê°œê·¼ìˆ˜ë‹¹, êµí†µë¹„ ë“±)
                    <br><small style="color: #666;">â€» ê° ìˆ˜ë‹¹ë³„ë¡œ ë¬´ë‹¨ê²°ê·¼/ì‚¬ìœ ê²°ê·¼/ì—°ì°¨ ì‹œ ê·œì¹™ ì ìš© (0ì›/ë¹„ìœ¨/ì „ì•¡)</small>
                    <br><small style="color: #666;">â€» ìˆ˜ë‹¹ ì¶”ê°€/ìˆ˜ì •/ì‚­ì œëŠ” "íšŒì‚¬ ì„¤ì •" í˜ì´ì§€ì—ì„œ ê´€ë¦¬</small>
                </div>
                <div class="formula-item" style="background: #e3f2fd; border-left: 3px solid #2196f3;">
                    <strong>ì‹œê°„ë‹¹ ê¸‰ì—¬</strong> = ê¸°ë³¸ê¸‰ Ã· 208ì‹œê°„
                </div>
            </div>
        </div>
    </div>

    <script>
        // ë‚ ì§œ í‚¤ ìƒì„± í•¨ìˆ˜ (í•­ìƒ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ 0 íŒ¨ë”©)
        function makeDateKey(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // ë‚ ì§œ ë¬¸ìì—´ ì •ê·œí™” (YYYY-M-D ë˜ëŠ” YYYY-MM-DD â†’ YYYY-MM-DD)
        function normalizeDateKey(dateStr) {
            if (!dateStr) return dateStr;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return makeDateKey(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
        }

        // Set ë˜ëŠ” Arrayì˜ ë‚ ì§œë¥¼ ì •ê·œí™”
        function normalizeDateSet(dateArray) {
            return dateArray.map(d => normalizeDateKey(d));
        }

        // Objectì˜ ë‚ ì§œ í‚¤ë¥¼ ì •ê·œí™”
        function normalizeDateObject(dateObj) {
            const normalized = {};
            Object.keys(dateObj).forEach(key => {
                const newKey = normalizeDateKey(key);
                normalized[newKey] = dateObj[key];
            });
            return normalized;
        }

        // íŠ¹ìˆ˜ìˆ˜ë‹¹ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleSpecialAllowance() {
            const checkbox = document.getElementById('specialAllowanceEnabled');
            const input = document.getElementById('specialAllowanceAmount');

            if (checkbox.checked) {
                input.disabled = false;
                input.style.background = 'white';
                input.focus();
            } else {
                input.disabled = true;
                input.style.background = '#f5f5f5';
                input.value = '0';
            }
            calculate(); // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì¬ê³„ì‚°
        }

        // ì„ ê¸ˆ ì²´í¬ë°•ìŠ¤ í† ê¸€
        function toggleAdvancePayment() {
            const checkbox = document.getElementById('advancePaymentEnabled');
            const input = document.getElementById('advancePaymentAmount');

            if (checkbox.checked) {
                input.disabled = false;
                input.style.background = 'white';
                input.focus();
            } else {
                input.disabled = true;
                input.style.background = '#f5f5f5';
                input.value = '0';
            }
            calculate(); // ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì‹œ ì¬ê³„ì‚°
        }

        let selectedYear = 2025;
        let selectedMonth = 11;
        let holidays = new Set();
        let excusedAbsents = new Set(); // ì‚¬ìœ  ìˆëŠ” ê²°ê·¼ (íœ´ê°€, ë³‘ê°€ ë“±)
        let absents = new Set();        // ë¬´ë‹¨ ê²°ê·¼
        let annualLeaveDays = new Set(); // ì—°ì°¨ ì‚¬ìš©ì¼
        let overtimeData = {}; // ì•¼ê·¼ì‹œê°„
        let nightData = {};     // ì•¼ê°„ì‹œê°„
        let sundayData = {};    // ì¼ìš”ì¼ íŠ¹ê·¼
        let normalHoursData = {}; // ì •ê·œ ê·¼ë¬´ì‹œê°„ (ê¸°ë³¸ 8ì‹œê°„)

        // ì§ì› ê´€ë¦¬
        let employees = {}; // {id: {name, basicSalary, dependents, dailyMeal, ...}}
        let currentEmployeeId = null;

        // ë™ì  ìˆ˜ë‹¹ ìƒì„¸ ì •ë³´ (ì „ì—­)
        let currentAllowanceDetails = {};

        // ì´ˆê¸°í™”
        function init() {
            // ë¨¼ì € URL íŒŒë¼ë¯¸í„° ì²´í¬ (ë…„ì›” ë¨¼ì € ì„¤ì •)
            checkURLParams();

            initYearMonth();
            loadEmployeesFromStorage();

            // URLì—ì„œ ì§ì› ë¡œë“œ (generateCalendar í¬í•¨)
            loadEmployeeFromURL();

            // URLì—ì„œ ì§ì›ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë‹¬ë ¥ ìƒì„±
            if (!currentEmployeeId) {
                generateCalendar();
                calculate();
            }
        }

        // URL íŒŒë¼ë¯¸í„° ì²´í¬ (ë…„ì›”ë§Œ ë¨¼ì € ì½ê¸°)
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const year = urlParams.get('year');
            const month = urlParams.get('month');

            // ë…„ì›” ì •ë³´ê°€ ìˆìœ¼ë©´ ì„¤ì •
            if (year && month) {
                selectedYear = parseInt(year);
                selectedMonth = parseInt(month);
            }
        }

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì§ì› ë¡œë“œ
        function loadEmployeeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('employee');

            // ì§ì› IDê°€ ìˆìœ¼ë©´ í•´ë‹¹ ì§ì› ë¡œë“œ
            if (employeeId && employees[employeeId]) {
                // ë“œë¡­ë‹¤ìš´ ê°’ ì„¤ì •
                document.getElementById('yearSelect').value = selectedYear;
                document.getElementById('monthSelect').value = selectedMonth;

                // ì§ì› ë¡œë“œ (ë‚´ë¶€ì—ì„œ generateCalendarì™€ calculate í˜¸ì¶œ)
                loadEmployee(employeeId);

                console.log(`âœ… URLì—ì„œ ì§ì› ë¡œë“œ: ${employees[employeeId].name}, ${selectedYear}ë…„ ${selectedMonth}ì›”`);
            }
        }

        // ë…„ë„/ì›” ì„ íƒ ì´ˆê¸°í™”
        function initYearMonth() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');

            for (let y = 2020; y <= 2030; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y + 'ë…„';
                if (y === selectedYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m + 'ì›”';
                if (m === selectedMonth) option.selected = true;
                monthSelect.appendChild(option);
            }

            yearSelect.addEventListener('change', () => {
                selectedYear = parseInt(yearSelect.value);

                // ì—°ë„ ë³€ê²½ ì‹œ íšŒì‚¬ ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
                console.log('ğŸ“… ì—°ë„ ë³€ê²½:', selectedYear);
                const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
                if (storedSettings) {
                    window.companySettings = JSON.parse(storedSettings);
                    console.log('âœ… ì—°ë„ë³„ íšŒì‚¬ ì„¤ì • ë¡œë“œ:', window.companySettings.companyName, window.companySettings.companyLogo);
                } else {
                    console.warn('âš ï¸', selectedYear, 'ë…„ë„ íšŒì‚¬ ì„¤ì • ì—†ìŒ');
                }

                generateCalendar();
            });

            monthSelect.addEventListener('change', () => {
                selectedMonth = parseInt(monthSelect.value);
                generateCalendar();
            });
        }

        // ë‹¬ë ¥ ìƒì„±
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendarTitle');
            
            title.textContent = `${selectedYear}ë…„ ${selectedMonth}ì›”`;
            
            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const firstDay = new Date(selectedYear, selectedMonth - 1, 1).getDay();
            
            calendar.innerHTML = '';

            // ìš”ì¼ í—¤ë”
            const dayHeaders = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                calendar.appendChild(empty);
            }
            
            // ë‚ ì§œ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';

                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0) {
                    dayEl.classList.add('sunday');
                } else if (dayOfWeek === 6) {
                    dayEl.classList.add('saturday');
                }

                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;  // êµ¬ë²„ì „ í˜¸í™˜

                if (holidays.has(dateKey) || holidays.has(dateKeyOld)) {
                    dayEl.classList.add('holiday', 'selected');
                }
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                    dayEl.classList.add('excused-absent', 'selected');
                }
                if (absents.has(dateKey) || absents.has(dateKeyOld)) {
                    dayEl.classList.add('absent', 'selected');
                }
                if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld)) {
                    dayEl.classList.add('annual-leave', 'selected');
                }

                // ë‚ ì§œ ìˆ«ì (í´ë¦­ì‹œ ì•¼ê·¼ì‹œê°„ ì…ë ¥)
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number day-number-clickable';
                dayNumber.textContent = day;
                dayNumber.title = 'í´ë¦­í•˜ì—¬ ì•¼ê·¼ì‹œê°„ ì…ë ¥';
                dayNumber.addEventListener('click', (e) => {
                    e.stopPropagation();
                    inputOvertimeHours(day, dayEl);
                });
                dayEl.appendChild(dayNumber);

                // ë¼ë²¨ ì œê±°ë¨

                // ì •ê·œ ê·¼ë¬´ì‹œê°„ í‘œì‹œ (ì¼ìš”ì¼ ì œì™¸, ê³µíœ´ì¼/ê²°ê·¼ ì œì™¸)
                if (dayOfWeek !== 0 && !holidays.has(dateKey) && !holidays.has(dateKeyOld) &&
                    !excusedAbsents.has(dateKey) && !excusedAbsents.has(dateKeyOld) &&
                    !absents.has(dateKey) && !absents.has(dateKeyOld)) {
                    const normalInfo = document.createElement('div');
                    normalInfo.className = 'normal-hours-info';
                    normalInfo.id = `normal-${dateKey}`;
                    normalInfo.title = 'ì¢Œí´ë¦­: +0.5ì‹œê°„ | ìš°í´ë¦­: -0.5ì‹œê°„';

                    const normalHours = normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8;

                    if (normalHours === 8) {
                        normalInfo.textContent = `ğŸ“… ${normalHours}h`;
                        normalInfo.classList.add('has-data');
                    } else if (normalHours < 8 && normalHours > 0) {
                        normalInfo.textContent = `ğŸ“… ${normalHours}h (ì¡°ê¸°)`;
                        normalInfo.classList.add('early-leave');
                    } else if (normalHours > 0) {
                        normalInfo.textContent = `ğŸ“… ${normalHours}h`;
                        normalInfo.classList.add('has-data');
                    } else {
                        normalInfo.textContent = 'ğŸ“… 0h';
                    }

                    // ì¢Œí´ë¦­: +0.5ì‹œê°„
                    normalInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementNormalHours(day, 0.5);
                    });

                    // ìš°í´ë¦­: -0.5ì‹œê°„
                    normalInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementNormalHours(day, -0.5);
                    });

                    dayEl.appendChild(normalInfo);
                }

                // ì•¼ê·¼/íŠ¹ê·¼ ì‹œê°„ í‘œì‹œ
                const overtimeInfo = document.createElement('div');
                overtimeInfo.className = 'overtime-info';
                overtimeInfo.id = `overtime-${dateKey}`;
                overtimeInfo.title = 'ì¢Œí´ë¦­: +0.5ì‹œê°„ | ìš°í´ë¦­: -0.5ì‹œê°„';

                // ì¼ìš”ì¼ì´ë©´ íŠ¹ê·¼, ì•„ë‹ˆë©´ ì•¼ê·¼
                if (dayOfWeek === 0) {
                    // ì¼ìš”ì¼ íŠ¹ê·¼
                    const sundayHours = sundayData[dateKey] || sundayData[dateKeyOld];
                    if (sundayHours) {
                        overtimeInfo.textContent = `ğŸŒ ${sundayHours}h`;
                        overtimeInfo.classList.add('has-data', 'sunday-work');
                    } else {
                        overtimeInfo.textContent = '+ íŠ¹ê·¼(200%)';
                        overtimeInfo.classList.add('sunday-work');
                    }

                    // ì¢Œí´ë¦­: +0.5ì‹œê°„
                    overtimeInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementSunday(day, 0.5);
                    });

                    // ìš°í´ë¦­: -0.5ì‹œê°„
                    overtimeInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementSunday(day, -0.5);
                    });
                } else {
                    // í‰ì¼/í† ìš”ì¼ ì•¼ê·¼
                    const overtimeHours = overtimeData[dateKey] || overtimeData[dateKeyOld];
                    if (overtimeHours) {
                        overtimeInfo.textContent = `â° ${overtimeHours}h`;
                        overtimeInfo.classList.add('has-data');
                    } else {
                        overtimeInfo.textContent = '+ ì•¼ê·¼';
                    }

                    // ì¢Œí´ë¦­: +0.5ì‹œê°„
                    overtimeInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementOvertime(day, 0.5);
                    });

                    // ìš°í´ë¦­: -0.5ì‹œê°„
                    overtimeInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementOvertime(day, -0.5);
                    });
                }

                dayEl.appendChild(overtimeInfo);

                // ë°°ê²½ í´ë¦­ì‹œ ê³µíœ´ì¼/ê²°ê·¼ í† ê¸€
                dayEl.addEventListener('click', () => toggleDay(day, dayEl, 1));  // ì™¼ìª½ í´ë¦­: ì •ë°©í–¥

                // ë°°ê²½ ìš°í´ë¦­ì‹œ ì—­ë°©í–¥ í† ê¸€
                dayEl.addEventListener('contextmenu', (e) => {
                    e.preventDefault();  // ë¸Œë¼ìš°ì € ê¸°ë³¸ ë©”ë‰´ ë°©ì§€
                    toggleDay(day, dayEl, -1);  // ì˜¤ë¥¸ìª½ í´ë¦­: ì—­ë°©í–¥
                });

                calendar.appendChild(dayEl);
            }
            
            updateStats();
        }

        // ì •ê·œ ê·¼ë¬´ì‹œê°„ ì¦ê°€/ê°ì†Œ
        function incrementNormalHours(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // êµ¬ë²„ì „ í‚¤ì˜ ê°’ë„ í™•ì¸
            const currentValue = normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8;
            const newValue = Math.max(0, Math.min(12, currentValue + amount)); // 0~12ì‹œê°„ ì œí•œ

            // êµ¬ë²„ì „ í‚¤ ì‚­ì œ
            if (dateKeyOld !== dateKey && normalHoursData[dateKeyOld]) {
                delete normalHoursData[dateKeyOld];
            }

            if (newValue !== 8) {
                normalHoursData[dateKey] = newValue;
            } else {
                delete normalHoursData[dateKey]; // 8ì‹œê°„ì´ë©´ ê¸°ë³¸ê°’ì´ë¯€ë¡œ ì‚­ì œ
            }

            // UI ì—…ë°ì´íŠ¸
            const normalInfo = document.getElementById(`normal-${dateKey}`);
            if (normalInfo) {
                normalInfo.classList.remove('has-data', 'early-leave');

                if (newValue === 8) {
                    normalInfo.textContent = `ğŸ“… ${newValue}h`;
                    normalInfo.classList.add('has-data');
                } else if (newValue < 8 && newValue > 0) {
                    normalInfo.textContent = `ğŸ“… ${newValue}h (ì¡°ê¸°)`;
                    normalInfo.classList.add('early-leave');
                } else if (newValue > 8) {
                    normalInfo.textContent = `ğŸ“… ${newValue}h`;
                    normalInfo.classList.add('has-data');
                } else {
                    normalInfo.textContent = 'ğŸ“… 0h';
                }
            }

            updateStats();
            calculate();
        }

        // ì•¼ê·¼ì‹œê°„ ì¦ê°€/ê°ì†Œ
        function incrementOvertime(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // êµ¬ë²„ì „ í‚¤ì˜ ê°’ë„ í™•ì¸
            const currentValue = overtimeData[dateKey] || overtimeData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            // êµ¬ë²„ì „ í‚¤ ì‚­ì œ
            if (dateKeyOld !== dateKey && overtimeData[dateKeyOld]) {
                delete overtimeData[dateKeyOld];
            }

            if (newValue > 0) {
                overtimeData[dateKey] = newValue;
            } else {
                delete overtimeData[dateKey];
            }

            // UI ì—…ë°ì´íŠ¸
            const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
            if (overtimeInfo) {
                if (newValue > 0) {
                    overtimeInfo.textContent = `â° ${newValue}h`;
                    overtimeInfo.classList.add('has-data');
                } else {
                    overtimeInfo.textContent = '+ ì•¼ê·¼';
                    overtimeInfo.classList.remove('has-data');
                }
            }

            updateStats();
            calculate();
        }

        // ì¼ìš”ì¼ íŠ¹ê·¼ì‹œê°„ ì¦ê°€/ê°ì†Œ
        function incrementSunday(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // êµ¬ë²„ì „ í‚¤ì˜ ê°’ë„ í™•ì¸
            const currentValue = sundayData[dateKey] || sundayData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            // êµ¬ë²„ì „ í‚¤ ì‚­ì œ
            if (dateKeyOld !== dateKey && sundayData[dateKeyOld]) {
                delete sundayData[dateKeyOld];
            }

            if (newValue > 0) {
                sundayData[dateKey] = newValue;
            } else {
                delete sundayData[dateKey];
            }

            // UI ì—…ë°ì´íŠ¸
            const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
            if (overtimeInfo) {
                if (newValue > 0) {
                    overtimeInfo.textContent = `ğŸŒ ${newValue}h`;
                    overtimeInfo.classList.add('has-data');
                    overtimeInfo.style.background = '#e53935';
                    overtimeInfo.style.borderColor = '#c62828';
                    overtimeInfo.style.color = 'white';
                } else {
                    overtimeInfo.textContent = '+ íŠ¹ê·¼(200%)';
                    overtimeInfo.classList.remove('has-data');
                    overtimeInfo.style.background = '#ffebee';
                    overtimeInfo.style.borderColor = '#e53935';
                    overtimeInfo.style.color = '#333';
                }
            }

            updateStats();
            calculate();
        }

        // ì•¼ê·¼ì‹œê°„ ì§ì ‘ ì…ë ¥
        function inputOvertimeHours(day, element) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // êµ¬ë²„ì „ í‚¤ì˜ ê°’ë„ í™•ì¸
            const currentValue = overtimeData[dateKey] || overtimeData[dateKeyOld] || 0;

            const input = prompt(`ğŸ“… ${selectedMonth}ì›” ${day}ì¼ ì•¼ê·¼ì‹œê°„ ì…ë ¥\n\nì•¼ê·¼ì‹œê°„ (ì‹œê°„):`, currentValue);

            if (input !== null) {
                const hours = parseFloat(input);
                if (!isNaN(hours) && hours >= 0) {
                    // êµ¬ë²„ì „ í‚¤ ì‚­ì œ
                    if (dateKeyOld !== dateKey && overtimeData[dateKeyOld]) {
                        delete overtimeData[dateKeyOld];
                    }

                    if (hours > 0) {
                        overtimeData[dateKey] = hours;
                    } else {
                        delete overtimeData[dateKey];
                    }

                    // UI ì—…ë°ì´íŠ¸
                    const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
                    if (overtimeInfo) {
                        if (hours > 0) {
                            overtimeInfo.textContent = `â° ${hours}h`;
                            overtimeInfo.classList.add('has-data');
                        } else {
                            overtimeInfo.textContent = '+ ì•¼ê·¼';
                            overtimeInfo.classList.remove('has-data');
                        }
                    }

                    updateStats();
                    calculate();
                } else {
                    alert('âš ï¸ ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”!');
                }
            }
        }

        // ë‚ ì§œ í† ê¸€ (ê³µíœ´ì¼/ì‚¬ìœ ê²°ê·¼/ë¬´ë‹¨ê²°ê·¼) - 4ë‹¨ê³„ ìˆœí™˜
        function toggleDay(day, element, direction = 1) {
            const date = new Date(selectedYear, selectedMonth - 1, day);
            const dayOfWeek = date.getDay();
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // êµ¬ë²„ì „ í‚¤ ì‚­ì œ (ìƒˆ í‚¤ë¡œ í†µì¼)
            if (dateKeyOld !== dateKey) {
                if (holidays.has(dateKeyOld)) { holidays.delete(dateKeyOld); holidays.add(dateKey); }
                if (excusedAbsents.has(dateKeyOld)) { excusedAbsents.delete(dateKeyOld); excusedAbsents.add(dateKey); }
                if (absents.has(dateKeyOld)) { absents.delete(dateKeyOld); absents.add(dateKey); }
                if (annualLeaveDays.has(dateKeyOld)) { annualLeaveDays.delete(dateKeyOld); annualLeaveDays.add(dateKey); }
            }

            if (direction === 1) {
                // ì •ë°©í–¥: ê·¼ë¬´ì¼ -> ê³µíœ´ì¼ -> ì‚¬ìœ ê²°ê·¼ -> ë¬´ë‹¨ê²°ê·¼ -> ì—°ì°¨ -> ê·¼ë¬´ì¼ ìˆœí™˜
                if (holidays.has(dateKey)) {
                    // ê³µíœ´ì¼ -> ì‚¬ìœ ê²°ê·¼
                    holidays.delete(dateKey);
                    excusedAbsents.add(dateKey);
                    element.classList.remove('holiday', 'selected');
                    element.classList.add('excused-absent', 'selected');
                } else if (excusedAbsents.has(dateKey)) {
                    // ì‚¬ìœ ê²°ê·¼ -> ë¬´ë‹¨ê²°ê·¼
                    excusedAbsents.delete(dateKey);
                    absents.add(dateKey);
                    element.classList.remove('excused-absent', 'selected');
                    element.classList.add('absent', 'selected');
                } else if (absents.has(dateKey)) {
                    // ë¬´ë‹¨ê²°ê·¼ -> ì—°ì°¨
                    absents.delete(dateKey);
                    annualLeaveDays.add(dateKey);
                    element.classList.remove('absent', 'selected');
                    element.classList.add('annual-leave', 'selected');
                } else if (annualLeaveDays.has(dateKey)) {
                    // ì—°ì°¨ -> ê·¼ë¬´ì¼ (ì›ë˜ ìƒíƒœë¡œ)
                    annualLeaveDays.delete(dateKey);
                    element.classList.remove('annual-leave', 'selected');

                    // ë¼ë²¨ ì œê±°
                    const label = element.querySelector('.day-label');
                    if (label) {
                        label.remove();
                    }
                } else {
                    // ê·¼ë¬´ì¼ -> ê³µíœ´ì¼
                    holidays.add(dateKey);
                    element.classList.add('holiday', 'selected');
                }
            } else {
                // ì—­ë°©í–¥: ê·¼ë¬´ì¼ -> ì—°ì°¨ -> ë¬´ë‹¨ê²°ê·¼ -> ì‚¬ìœ ê²°ê·¼ -> ê³µíœ´ì¼ -> ê·¼ë¬´ì¼ ìˆœí™˜
                if (annualLeaveDays.has(dateKey)) {
                    // ì—°ì°¨ -> ë¬´ë‹¨ê²°ê·¼
                    annualLeaveDays.delete(dateKey);
                    absents.add(dateKey);
                    element.classList.remove('annual-leave', 'selected');
                    element.classList.add('absent', 'selected');
                } else if (absents.has(dateKey)) {
                    // ë¬´ë‹¨ê²°ê·¼ -> ì‚¬ìœ ê²°ê·¼
                    absents.delete(dateKey);
                    excusedAbsents.add(dateKey);
                    element.classList.remove('absent', 'selected');
                    element.classList.add('excused-absent', 'selected');
                } else if (excusedAbsents.has(dateKey)) {
                    // ì‚¬ìœ ê²°ê·¼ -> ê³µíœ´ì¼
                    excusedAbsents.delete(dateKey);
                    holidays.add(dateKey);
                    element.classList.remove('excused-absent', 'selected');
                    element.classList.add('holiday', 'selected');
                } else if (holidays.has(dateKey)) {
                    // ê³µíœ´ì¼ -> ê·¼ë¬´ì¼ (ì›ë˜ ìƒíƒœë¡œ)
                    holidays.delete(dateKey);
                    element.classList.remove('holiday', 'selected');

                    // ë¼ë²¨ ì œê±°
                    const label = element.querySelector('.day-label');
                    if (label) {
                        label.remove();
                    }
                } else {
                    // ê·¼ë¬´ì¼ -> ì—°ì°¨
                    annualLeaveDays.add(dateKey);
                    element.classList.add('annual-leave', 'selected');
                }
            }

            updateStats();
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            // íšŒì‚¬ ì„¤ì • ë‹¤ì‹œ ë¡œë“œ (settings.htmlì—ì„œ ìˆ˜ë‹¹ ì¶”ê°€í–ˆì„ ë•Œ ë°˜ì˜ë˜ë„ë¡)
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            if (storedSettings) {
                window.companySettings = JSON.parse(storedSettings);
                console.log('ğŸ”„ íšŒì‚¬ ì„¤ì • ë‹¤ì‹œ ë¡œë“œë¨:', window.companySettings);
                console.log('ìˆ˜ë‹¹ ê°œìˆ˜:', (window.companySettings.allowances || []).length);
            }

            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();

            // í—¬í¼ í•¨ìˆ˜: dateKeyê°€ í˜„ì¬ ì„ íƒëœ ì—°/ì›”ì— ì†í•˜ëŠ”ì§€ í™•ì¸ (êµ¬ë²„ì „ í˜¸í™˜)
            function isSelectedMonth(key) {
                const parts = key.split('-');
                if (parts.length < 2) return false;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return keyYear === selectedYear && keyMonth === selectedMonth;
            }

            let sundays = 0;

            // ì¼ìš”ì¼ ì¹´ìš´íŠ¸
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0) {
                    sundays++;
                }
            }

            // ê³µíœ´ì¼, ì‚¬ìœ ê²°ê·¼, ë¬´ë‹¨ê²°ê·¼, ì—°ì°¨ ì¹´ìš´íŠ¸ (í˜„ì¬ ì›”ë§Œ!)
            // ê³µíœ´ì¼ ì¤‘ ì¼ìš”ì¼ì€ ì œì™¸ (ì´ì¤‘ ì°¨ê° ë°©ì§€)
            let holidayCount = 0;
            holidays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) {
                    const parts = dateKey.split('-');
                    const day = parseInt(parts[2]);
                    const date = new Date(selectedYear, selectedMonth - 1, day);
                    if (date.getDay() !== 0) { // ì¼ìš”ì¼ì´ ì•„ë‹Œ ê³µíœ´ì¼ë§Œ ì¹´ìš´íŠ¸
                        holidayCount++;
                    }
                }
            });

            let excusedAbsentCount = 0;
            excusedAbsents.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) excusedAbsentCount++;
            });

            let unexcusedAbsentCount = 0;
            absents.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) unexcusedAbsentCount++;
            });

            let annualLeaveCount = 0;
            annualLeaveDays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) annualLeaveCount++;
            });

            const totalAbsentCount = excusedAbsentCount + unexcusedAbsentCount;

            // í‰ì¼ = ì›”~í†  (ì´ì¼ìˆ˜ - ì¼ìš”ì¼)
            const weekdays = daysInMonth - sundays;

            // ì¼ìš”ì¼ íŠ¹ê·¼ ì¼ìˆ˜ ì¹´ìš´íŠ¸ (8ì‹œê°„ ì´ìƒ ì¼í•˜ë©´ ì‹ëŒ€ ì§€ê¸‰ - ì‹¤ê·¼ë¬´ì¼ì—ëŠ” í¬í•¨ ì•ˆë¨)
            let sundayWorkDays = 0;
            Object.keys(sundayData).forEach(key => {
                if (isSelectedMonth(key) && sundayData[key] >= 8) {
                    sundayWorkDays++;
                }
            });

            // ì‹¤ ê·¼ë¬´ì¼ = í‰ì¼ - ê³µíœ´ì¼ - ëª¨ë“  ê²°ê·¼ - ì—°ì°¨ (ì¼ìš”ì¼ íŠ¹ê·¼ì€ ì‹¤ê·¼ë¬´ì¼ì— í¬í•¨ ì•ˆí•¨)
            const workDays = weekdays - holidayCount - totalAbsentCount - annualLeaveCount;

            // ì‹¤ì œ ì •ê·œ ê·¼ë¬´ì‹œê°„ ê³„ì‚° (ê° ë‚ ì§œì˜ ì‹¤ì œ ì‹œê°„ í•©ì‚°)
            let normalHours = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                // ì œì™¸í•  ë‚ :
                // - ì¼ìš”ì¼
                // - ê³µíœ´ì¼ (ì¼ìš”ì¼ ì•„ë‹Œ)
                // - ì‚¬ìœ ê²°ê·¼ (ë¬´ê¸‰)
                // - ë¬´ë‹¨ê²°ê·¼
                if (dayOfWeek === 0) {
                    // ì¼ìš”ì¼ì€ ì œì™¸
                    continue;
                }
                if ((holidays.has(dateKey) || holidays.has(dateKeyOld)) && dayOfWeek !== 0) {
                    // ê³µíœ´ì¼ (ì¼ìš”ì¼ ì•„ë‹Œ) ì œì™¸
                    continue;
                }
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                    // ì‚¬ìœ ê²°ê·¼ ì œì™¸ (ë¬´ê¸‰ íœ´ê°€)
                    continue;
                }
                if (absents.has(dateKey) || absents.has(dateKeyOld)) {
                    // ë¬´ë‹¨ê²°ê·¼ ì œì™¸
                    continue;
                }

                // ì •ìƒ ê·¼ë¬´ ë˜ëŠ” ì—°ì°¨
                if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld)) {
                    normalHours += 8;  // ì—°ì°¨ = 8ì‹œê°„ ìœ ê¸‰ ì¸ì •!
                } else {
                    normalHours += (normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8);  // ì •ìƒ ê·¼ë¬´
                }
            }

            // íšŒì‚¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (window.companySettings ì‚¬ìš© - ì´ë¯¸ updateStats()ì—ì„œ ë¡œë“œë¨)
            const lunchMeal = (window.companySettings && window.companySettings.lunchMeal) || 25000;
            const dinnerMeal = (window.companySettings && window.companySettings.dinnerMeal) || 25000;
            const weekdayDinnerHours = (window.companySettings && window.companySettings.weekdayDinnerHours) || 3;
            const sundayLunchHours = (window.companySettings && window.companySettings.sundayLunchHours) || 4;
            const sundayDinnerHours = (window.companySettings && window.companySettings.sundayDinnerHours) || 12;
            const annualLeaveLunchMeal = (window.companySettings && window.companySettings.annualLeaveLunchMeal) === true;
            const excusedAbsenceLunchMinHours = (window.companySettings && window.companySettings.excusedAbsenceLunchMinHours) || 0;

            // ì‹ëŒ€ ì„¸ë¶€ ê³„ì‚°
            let weekdayLunchCount = 0;  // í‰ì¼ ì ì‹¬
            let weekdayDinnerCount = 0;  // í‰ì¼ ì €ë… (ì•¼ê·¼)
            let sundayLunchMealCount = 0;  // ì¼ìš”ì¼ ì ì‹¬
            let sundayDinnerMealCount = 0;  // ì¼ìš”ì¼ ì €ë…
            let annualLeaveLunchCount = 0;  // ì—°ì°¨ ì ì‹¬
            let excusedAbsentLunchCount = 0;  // ì‚¬ìœ ê²°ê·¼ ì ì‹¬

            // 1. í‰ì¼ ì ì‹¬ (ì‹¤ ê·¼ë¬´ì¼)
            weekdayLunchCount = workDays;

            // 2. ì—°ì°¨ ì‹œ ì ì‹¬ (ì„¤ì •ì— ë”°ë¼)
            if (annualLeaveLunchMeal) {
                annualLeaveLunchCount = annualLeaveCount;
            }

            // 3. ì‚¬ìœ ê²°ê·¼ ì‹œ ì ì‹¬ (ìµœì†Œ ì‹œê°„ ì¡°ê±´)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek !== 0 && (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld))) {
                    const normalHrsThisDay = normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 0;
                    if (normalHrsThisDay >= excusedAbsenceLunchMinHours) {
                        excusedAbsentLunchCount++;
                    }
                }
            }

            // 4. í‰ì¼ ì €ë… (ì•¼ê·¼ ì¡°ê±´)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek !== 0) {  // ì¼ìš”ì¼ ì œì™¸
                    const overtime = overtimeData[dateKey] || overtimeData[dateKeyOld] || 0;
                    if (overtime >= weekdayDinnerHours) {
                        weekdayDinnerCount++;
                    }
                }
            }

            // 5. ì¼ìš”ì¼ ì ì‹¬ ë° ì €ë… (ì´ ê·¼ë¬´ ì¡°ê±´)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek === 0) {  // ì¼ìš”ì¼ë§Œ
                    const totalHours = sundayData[dateKey] || sundayData[dateKeyOld] || 0;
                    if (totalHours >= sundayLunchHours) {
                        sundayLunchMealCount++;
                    }
                    // 6. ì¼ìš”ì¼ ì €ë… (ì´ ê·¼ë¬´ ì¡°ê±´)
                    if (totalHours >= sundayDinnerHours) {
                        sundayDinnerMealCount++;
                    }
                }
            }

            // ì´ ì‹ëŒ€ ê³„ì‚°
            const mealAllowance = (weekdayLunchCount * lunchMeal) +
                                  (weekdayDinnerCount * dinnerMeal) +
                                  (sundayLunchMealCount * lunchMeal) +
                                  (sundayDinnerMealCount * dinnerMeal) +
                                  (annualLeaveLunchCount * lunchMeal) +
                                  (excusedAbsentLunchCount * lunchMeal);

            // ë™ì  ìˆ˜ë‹¹ ì‹œìŠ¤í…œ
            // ì´ ê·¼ë¬´ ê°€ëŠ¥ì¼ = í‰ì¼ - ê³µíœ´ì¼ (ì¼ìš”ì¼ ì œì™¸í•œ ì‹¤ì œ ì¼í•  ìˆ˜ ìˆëŠ” ë‚ )
            const totalWorkableDays = daysInMonth - sundays - holidayCount;
            const attendanceRate = totalWorkableDays > 0 ? (totalWorkableDays - excusedAbsentCount - annualLeaveCount) / totalWorkableDays : 0;

            // íšŒì‚¬ ì„¤ì •ì—ì„œ ìˆ˜ë‹¹ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (window.companySettings ì‚¬ìš©!)
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            console.log('ğŸ“Š allowances ë¡œë“œë¨:', allowances.length, 'ê°œ', allowances);
            let totalAllowances = 0;
            currentAllowanceDetails = {}; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (calculate()ì—ì„œë„ ì‚¬ìš©)

            allowances.forEach(allowance => {
                if (!allowance.enabled) {
                    currentAllowanceDetails[allowance.id] = 0;
                    return;
                }

                let amount = 0;

                // ë¬´ë‹¨ê²°ê·¼ì´ ìˆëŠ” ê²½ìš°
                if (unexcusedAbsentCount > 0) {
                    if (allowance.onAbsence === 'zero') {
                        amount = 0;
                    } else if (allowance.onAbsence === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // ì‚¬ìœ ê²°ê·¼ì´ ìˆëŠ” ê²½ìš°
                else if (excusedAbsentCount > 0) {
                    const excusedAbsenceRule = allowance.onExcusedAbsence || 'proportional';
                    if (excusedAbsenceRule === 'zero') {
                        amount = 0;
                    } else if (excusedAbsenceRule === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // ì •ìƒ ì¶œê·¼ (ì—°ì°¨ë§Œ ìˆê±°ë‚˜ ì™„ì „ ì •ìƒ)
                else {
                    if (allowance.onAnnualLeave === 'zero' && annualLeaveCount > 0) {
                        amount = 0;
                    } else if (allowance.onAnnualLeave === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }

                currentAllowanceDetails[allowance.id] = amount;
                totalAllowances += amount;
            });

            // í•˜ìœ„ í˜¸í™˜ì„±: ê¸°ì¡´ í•˜ë“œì½”ë”©ëœ ìˆ˜ë‹¹ ë³€ìˆ˜ ìœ ì§€ (ê³„ì‚° í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
            let attendanceBonus = 0;
            let transportBonus = 0;
            let riskAllowance = 0;

            // ê¸°ì¡´ IDë¡œ ë§¤í•‘ (ë§ˆì´ê·¸ë ˆì´ì…˜ëœ ìˆ˜ë‹¹ë“¤)
            allowances.forEach(allowance => {
                if (allowance.id === 'allowance_attendance') attendanceBonus = currentAllowanceDetails[allowance.id] || 0;
                if (allowance.id === 'allowance_transport') transportBonus = currentAllowanceDetails[allowance.id] || 0;
                if (allowance.id === 'allowance_risk') riskAllowance = currentAllowanceDetails[allowance.id] || 0;
            });

            // ì´ ì•¼ê·¼ì‹œê°„ ê³„ì‚°
            let totalOvertime = 0;
            Object.keys(overtimeData).forEach(key => {
                if (isSelectedMonth(key)) {
                    totalOvertime += overtimeData[key];
                }
            });

            // ì´ ì¼ìš”ì¼ íŠ¹ê·¼ì‹œê°„ ê³„ì‚°
            let totalSunday = 0;
            Object.keys(sundayData).forEach(key => {
                if (isSelectedMonth(key)) {
                    totalSunday += sundayData[key];
                }
            });

            document.getElementById('totalDays').textContent = daysInMonth + 'ì¼';
            document.getElementById('weekdays').textContent = weekdays + 'ì¼';
            document.getElementById('weekends').textContent = sundays + 'ì¼';
            document.getElementById('holidays').textContent = holidayCount + 'ì¼';
            document.getElementById('excusedAbsents').textContent = excusedAbsentCount + 'ì¼';
            document.getElementById('unexcusedAbsents').textContent = unexcusedAbsentCount + 'ì¼';
            document.getElementById('annualLeaveCount').textContent = annualLeaveCount + 'ì¼';
            document.getElementById('workDays').textContent = workDays + 'ì¼';
            document.getElementById('normalHours').textContent = normalHours + 'h';
            document.getElementById('totalOvertimeDisplay').textContent = totalOvertime + 'h';
            document.getElementById('totalSundayDisplay').textContent = totalSunday + 'h';
            document.getElementById('autoMeal').textContent = formatNumber(mealAllowance) + 'Ä‘';

            // ì´ ì‹ì‚¬ ìˆ˜ ê³„ì‚°
            const totalMealCount = weekdayLunchCount + weekdayDinnerCount + sundayLunchMealCount +
                                   sundayDinnerMealCount + annualLeaveLunchCount + excusedAbsentLunchCount;
            document.getElementById('totalMealCount').textContent = totalMealCount + 'ì‹';

            // ì‹ëŒ€ ì„¸ë¶€ ë‚´ì—­ í‘œì‹œ (0ì‹ì¸ í•­ëª©ì€ ìˆ¨ê¸°ê¸°)
            document.getElementById('weekdayLunchCount').textContent = weekdayLunchCount + 'ì‹';
            document.getElementById('statsWeekdayLunchRow').style.display = weekdayLunchCount > 0 ? '' : 'none';

            document.getElementById('weekdayDinnerCount').textContent = weekdayDinnerCount + 'ì‹';
            document.getElementById('statsWeekdayDinnerRow').style.display = weekdayDinnerCount > 0 ? '' : 'none';

            document.getElementById('sundayLunchCount').textContent = sundayLunchMealCount + 'ì‹';
            document.getElementById('statsSundayLunchRow').style.display = sundayLunchMealCount > 0 ? '' : 'none';

            document.getElementById('sundayDinnerCount').textContent = sundayDinnerMealCount + 'ì‹';
            document.getElementById('statsSundayDinnerRow').style.display = sundayDinnerMealCount > 0 ? '' : 'none';

            document.getElementById('annualLeaveLunchCount').textContent = annualLeaveLunchCount + 'ì‹';
            document.getElementById('statsAnnualLeaveLunchRow').style.display = annualLeaveLunchCount > 0 ? '' : 'none';

            document.getElementById('excusedAbsentLunchCount').textContent = excusedAbsentLunchCount + 'ì‹';
            document.getElementById('statsExcusedAbsentLunchRow').style.display = excusedAbsentLunchCount > 0 ? '' : 'none';

            document.getElementById('attendanceBonus').textContent = formatNumber(attendanceBonus) + 'Ä‘';
            document.getElementById('transportBonus').textContent = formatNumber(transportBonus) + 'Ä‘';
            document.getElementById('riskDisplay').textContent = formatNumber(riskAllowance) + ' Ä‘';

            // í•˜ë“œì½”ë”©ëœ ìˆ˜ë‹¹ ì»¨í…Œì´ë„ˆ show/hide (settings ì„¤ì • + ê¸ˆì•¡ì— ë”°ë¼)
            const attendanceAllowance = allowances.find(a => a.id === 'allowance_attendance');
            const transportAllowance = allowances.find(a => a.id === 'allowance_transport');
            const riskAllowance_obj = allowances.find(a => a.id === 'allowance_risk');

            // í†µê³„ ì˜ì—­ (enabled=trueì´ê³  ê¸ˆì•¡ > 0ì¼ ë•Œë§Œ í‘œì‹œ)
            const attendanceContainer = document.getElementById('attendanceBonusContainer');
            if (attendanceContainer) {
                attendanceContainer.style.display = (attendanceAllowance && attendanceAllowance.enabled && attendanceBonus > 0) ? '' : 'none';
            }
            const transportContainer = document.getElementById('transportBonusContainer');
            if (transportContainer) {
                transportContainer.style.display = (transportAllowance && transportAllowance.enabled && transportBonus > 0) ? '' : 'none';
            }

            // ë™ì  ìˆ˜ë‹¹ ëª©ë¡ í‘œì‹œ (ì¶”ê°€ ìˆ˜ë‹¹ë§Œ - ê¸°ì¡´ 3ê°œëŠ” ìœ„ì— ì´ë¯¸ í‘œì‹œë¨)
            const dynamicAllowancesListEl = document.getElementById('dynamicAllowancesList');
            if (dynamicAllowancesListEl) {
                console.log('=== ë™ì  ìˆ˜ë‹¹ ë Œë”ë§ ì‹œì‘ ===');
                console.log('ì „ì²´ ìˆ˜ë‹¹ ëª©ë¡:', allowances);
                console.log('ìˆ˜ë‹¹ ìƒì„¸:', currentAllowanceDetails);

                let allowancesHTML = '';
                allowances.forEach(allowance => {
                    console.log(`ìˆ˜ë‹¹ ì²´í¬: ${allowance.name}, enabled: ${allowance.enabled}, id: ${allowance.id}`);

                    if (!allowance.enabled) {
                        console.log(`  â†’ ${allowance.name} ë¹„í™œì„±í™”ë¨, ìŠ¤í‚µ`);
                        return;
                    }

                    // ê¸°ì¡´ 3ê°œ ìˆ˜ë‹¹ì€ ì œì™¸ (ì´ë¯¸ ìœ„ì—ì„œ í‘œì‹œë¨)
                    if (allowance.id === 'allowance_attendance' ||
                        allowance.id === 'allowance_transport' ||
                        allowance.id === 'allowance_risk') {
                        console.log(`  â†’ ${allowance.name} ê¸°ì¡´ ìˆ˜ë‹¹, ìŠ¤í‚µ`);
                        return;
                    }

                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {  // 0ì›ì¸ ìˆ˜ë‹¹ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        console.log(`  â†’ ${allowance.name} í‘œì‹œ! ê¸ˆì•¡: ${amount}`);

                        allowancesHTML += `
                            <div class="stat-item" style="border-left-color: #4caf50;">
                                <span class="stat-label" style="color: #4caf50;">ğŸ ${allowance.name}</span>
                                <span class="stat-value" style="color: #4caf50;">${formatNumber(amount)}Ä‘</span>
                            </div>
                        `;
                    } else {
                        console.log(`  â†’ ${allowance.name} ê¸ˆì•¡ 0ì›, ìŠ¤í‚µ`);
                    }
                });

                console.log('ìƒì„±ëœ HTML:', allowancesHTML);
                dynamicAllowancesListEl.innerHTML = allowancesHTML;
                console.log('=== ë™ì  ìˆ˜ë‹¹ ë Œë”ë§ ì™„ë£Œ ===');
            }

            // ì—°ì°¨ í˜„í™© ì—…ë°ì´íŠ¸
            if (currentEmployeeId && employees[currentEmployeeId]) {
                const emp = employees[currentEmployeeId];
                const annualLeaveTotal = emp.annualLeavePerYear || 12;
                const annualLeaveAdjustment = emp.annualLeaveAdjustment || 0; // ì¡°ì •ê°’ (+ ì´ì›” ë˜ëŠ” - ì„ ì‚¬ìš©)

                // í˜„ì¬ ì—°ë„ì˜ ì „ì²´ ì—°ì°¨ ì‚¬ìš©ì¼ ì¹´ìš´íŠ¸
                let totalAnnualLeaveUsed = 0;
                annualLeaveDays.forEach(dateKey => {
                    const parts = dateKey.split('-');
                    if (parts.length >= 1 && parseInt(parts[0]) === selectedYear) {
                        totalAnnualLeaveUsed++;
                    }
                });

                const annualLeaveAvailable = Math.max(0, annualLeaveTotal + annualLeaveAdjustment - totalAnnualLeaveUsed); // ì‚¬ìš©ê°€ëŠ¥ ì—°ì°¨

                document.getElementById('annualLeaveTotal').textContent = annualLeaveTotal + 'ì¼';

                // ì¡°ì •ê°’ í‘œì‹œ (+ì´ë©´ ì´ˆë¡, -ì´ë©´ ë¹¨ê°•)
                const adjustmentText = annualLeaveAdjustment >= 0 ? `+${annualLeaveAdjustment}ì¼` : `${annualLeaveAdjustment}ì¼`;
                const adjustmentColor = annualLeaveAdjustment >= 0 ? '#4caf50' : '#e53935';
                document.getElementById('annualLeavePreUsed').textContent = adjustmentText;
                document.getElementById('annualLeavePreUsed').style.color = adjustmentColor;

                document.getElementById('annualLeaveThisMonth').textContent = annualLeaveCount + 'ì¼';
                document.getElementById('annualLeaveRemaining').textContent = annualLeaveAvailable + 'ì¼';
            }

            // ì•¼ê·¼ì‹œê°„ ìë™ ì…ë ¥
            document.getElementById('overtimeHours').value = totalOvertime;

            // ì¼ìš”ì¼ íŠ¹ê·¼ì‹œê°„ ìë™ ì…ë ¥
            document.getElementById('sundayHours').value = totalSunday;

            // ë™ì  ìˆ˜ë‹¹ ì´ì•¡ ì €ì¥ (ì‹ëŒ€ ì œì™¸)
            document.getElementById('totalAllowancesHidden').value = totalAllowances;
        }

        // ê¸‰ì—¬ ê³„ì‚°
        function calculate() {
            // íšŒì‚¬ ì„¤ì • ë‹¤ì‹œ ë¡œë“œ (settings.htmlì—ì„œ ìˆ˜ë‹¹ ì¶”ê°€í–ˆì„ ë•Œ ë°˜ì˜ë˜ë„ë¡)
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            if (storedSettings) {
                window.companySettings = JSON.parse(storedSettings);
                console.log('ğŸ”„ ê¸‰ì—¬ ê³„ì‚° ì‹œ íšŒì‚¬ ì„¤ì • ë‹¤ì‹œ ë¡œë“œë¨:', window.companySettings);
                console.log('ìˆ˜ë‹¹ ê°œìˆ˜:', (window.companySettings.allowances || []).length);
            }

            const employeeName = document.getElementById('employeeName').value || 'ì§ì›';
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;

            // í†µê³„ì—ì„œ ê³„ì‚°ëœ ì‹¤ì œ ì •ê·œì‹œê°„ ê°€ì ¸ì˜¤ê¸°
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const absentCount = absents.size;

            // ì‹œê°„ë‹¹ ê¸‰ì—¬
            const hourlyRate = basicSalary / 208;

            // ê¸‰ì—¬ ê³„ì‚°
            const normalPay = hourlyRate * normalHours;
            const overtimePay = hourlyRate * overtimeHours * 1.5;
            const nightPay = hourlyRate * nightHours * 1.3;
            const sundayPay = hourlyRate * sundayHours * 2.0;

            // ìë™ ìˆ˜ë‹¹ (í†µê³„ì—ì„œ ê³„ì‚°ëœ ê°’ ì‚¬ìš©)
            const mealAllowanceText = document.getElementById('autoMeal').textContent;
            const mealAllowance = parseFloat(mealAllowanceText.replace(/[^\d]/g, '')) || 0;

            // íšŒì‚¬ ì„¤ì •ì—ì„œ ì‹ëŒ€ ê¸ˆì•¡ ê°€ì ¸ì˜¤ê¸° (window.companySettings ì‚¬ìš©)
            const lunchMeal = (window.companySettings && window.companySettings.lunchMeal) || 25000;
            const dinnerMeal = (window.companySettings && window.companySettings.dinnerMeal) || 25000;

            // ì‹ëŒ€ ì„¸ë¶€ ë‚´ì—­ (í†µê³„ì—ì„œ ê³„ì‚°ëœ ì‹ì‚¬ ìˆ˜ ê°€ì ¸ì˜¤ê¸°)
            const weekdayLunchCountText = document.getElementById('weekdayLunchCount').textContent;
            const weekdayLunchCount = parseInt(weekdayLunchCountText.replace(/[^\d]/g, '')) || 0;
            const weekdayDinnerCountText = document.getElementById('weekdayDinnerCount').textContent;
            const weekdayDinnerCount = parseInt(weekdayDinnerCountText.replace(/[^\d]/g, '')) || 0;
            const sundayLunchCountText = document.getElementById('sundayLunchCount').textContent;
            const sundayLunchCount = parseInt(sundayLunchCountText.replace(/[^\d]/g, '')) || 0;
            const sundayDinnerCountText = document.getElementById('sundayDinnerCount').textContent;
            const sundayDinnerCount = parseInt(sundayDinnerCountText.replace(/[^\d]/g, '')) || 0;
            const annualLeaveLunchCountText = document.getElementById('annualLeaveLunchCount').textContent;
            const annualLeaveLunchCount = parseInt(annualLeaveLunchCountText.replace(/[^\d]/g, '')) || 0;
            const excusedAbsentLunchCountText = document.getElementById('excusedAbsentLunchCount').textContent;
            const excusedAbsentLunchCount = parseInt(excusedAbsentLunchCountText.replace(/[^\d]/g, '')) || 0;

            // ë™ì  ìˆ˜ë‹¹ ì´ì•¡ ê°€ì ¸ì˜¤ê¸° (updateStats()ì—ì„œ ê³„ì‚°ë¨)
            const dynamicAllowances = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;

            // í•˜ìœ„ í˜¸í™˜ì„±: ê°œë³„ ìˆ˜ë‹¹ ê°’ë„ ì½ê¸° (í™”ë©´ í‘œì‹œìš©)
            const attendanceBonusText = document.getElementById('attendanceBonus').textContent;
            const attendanceBonus = parseFloat(attendanceBonusText.replace(/[^\d]/g, '')) || 0;

            const transportBonusText = document.getElementById('transportBonus').textContent;
            const transportAllowance = parseFloat(transportBonusText.replace(/[^\d]/g, '')) || 0;

            const riskAllowanceText = document.getElementById('riskDisplay').textContent;
            const riskAllowance = parseFloat(riskAllowanceText.replace(/[^\d]/g, '')) || 0;

            // íŠ¹ìˆ˜ìˆ˜ë‹¹ ê°€ì ¸ì˜¤ê¸°
            const specialAllowanceEnabled = document.getElementById('specialAllowanceEnabled')?.checked || false;
            const specialAllowance = specialAllowanceEnabled ?
                (parseFloat(document.getElementById('specialAllowanceAmount')?.value) || 0) : 0;

            // ì´ ê¸‰ì—¬ (ë™ì  ìˆ˜ë‹¹ ì‹œìŠ¤í…œ + íŠ¹ìˆ˜ìˆ˜ë‹¹)
            const totalSalary = normalPay + overtimePay + nightPay + sundayPay +
                              mealAllowance + dynamicAllowances + specialAllowance;

            // íšŒì‚¬ ë¶€ë‹´ê¸ˆ (ê¸°ë³¸ê¸‰ ê¸°ì¤€) - ì°¸ê³ ìš©
            const companySocialIns = basicSalary * 0.175;
            const companyHealthIns = basicSalary * 0.03;
            const companyUnemployIns = basicSalary * 0.01;
            const totalCompanyIns = companySocialIns + companyHealthIns + companyUnemployIns;

            // ê·¼ë¡œì ë³´í—˜ë£Œ (ê¸°ë³¸ê¸‰ ê¸°ì¤€)
            const socialIns = basicSalary * 0.08;
            const healthIns = basicSalary * 0.015;
            const unemployIns = basicSalary * 0.01;

            // ì´ ê³µì œ (10.5%)
            const totalDeduction = socialIns + healthIns + unemployIns;

            // ê°œì¸ì†Œë“ì„¸ ê³„ì‚°
            const dependents = parseInt(document.getElementById('dependents').value) || 0;

            // ê³¼ì„¸ ëŒ€ìƒ ì†Œë“ ê³„ì‚° (ë² íŠ¸ë‚¨ ì„¸ë²•)
            // - ì‹ëŒ€: 100% ë¹„ê³¼ì„¸
            // - ì•¼ê·¼ ìˆ˜ë‹¹: 1/3 ë¹„ê³¼ì„¸, 2/3ë§Œ ê³¼ì„¸
            // - ì¼ìš”ì¼ íŠ¹ê·¼: 1/2 ë¹„ê³¼ì„¸, 1/2ë§Œ ê³¼ì„¸
            const taxableIncome = normalPay                           // ì •ê·œê¸‰ì—¬: ì „ì•¡ ê³¼ì„¸
                                + (overtimePay * 2/3)           // ì•¼ê·¼: 2/3ë§Œ ê³¼ì„¸
                                + nightPay                       // ì•¼ê°„: ì „ì•¡ ê³¼ì„¸
                                + (sundayPay * 1/2)             // íŠ¹ê·¼: 1/2ë§Œ ê³¼ì„¸
                                + dynamicAllowances              // ëª¨ë“  ìˆ˜ë‹¹: ì „ì•¡ ê³¼ì„¸
                                + specialAllowance               // íŠ¹ìˆ˜ìˆ˜ë‹¹: ì „ì•¡ ê³¼ì„¸
                                // ì‹ëŒ€(mealAllowance)ëŠ” ì œì™¸: ë¹„ê³¼ì„¸
                                - totalDeduction;                // ë³´í—˜ë£Œ ê³µì œ

            // ê°€ì¡± ê³µì œ
            const selfDeduction = 11000000; // ë³¸ì¸
            const dependentDeduction = dependents * 4400000; // ë¶€ì–‘ê°€ì¡±
            const totalFamilyDeduction = selfDeduction + dependentDeduction;

            // ê³¼ì„¸ í‘œì¤€ = ê³¼ì„¸ ëŒ€ìƒ ì†Œë“ - ê°€ì¡± ê³µì œ
            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            // ëˆ„ì§„ì„¸ìœ¨ ê³„ì‚°
            let incomeTax = 0;
            if (taxBase > 0) {
                // Báº­c 1: 0 - 5,000,000 (5%)
                if (taxBase > 0) {
                    const tier1 = Math.min(taxBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    taxBase -= tier1;
                }
                // Báº­c 2: 5,000,001 - 10,000,000 (10%)
                if (taxBase > 0) {
                    const tier2 = Math.min(taxBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    taxBase -= tier2;
                }
                // Báº­c 3: 10,000,001 - 18,000,000 (15%)
                if (taxBase > 0) {
                    const tier3 = Math.min(taxBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    taxBase -= tier3;
                }
                // Báº­c 4: 18,000,001 - 32,000,000 (20%)
                if (taxBase > 0) {
                    const tier4 = Math.min(taxBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    taxBase -= tier4;
                }
                // Báº­c 5: 32,000,001 - 52,000,000 (25%)
                if (taxBase > 0) {
                    const tier5 = Math.min(taxBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    taxBase -= tier5;
                }
                // Báº­c 6: 52,000,001 - 80,000,000 (30%)
                if (taxBase > 0) {
                    const tier6 = Math.min(taxBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    taxBase -= tier6;
                }
                // Báº­c 7: 80,000,001 ì´ìƒ (35%)
                if (taxBase > 0) {
                    incomeTax += taxBase * 0.35;
                }
            }

            // ì„ ê¸ˆ ê°€ì ¸ì˜¤ê¸°
            const advancePaymentEnabled = document.getElementById('advancePaymentEnabled')?.checked || false;
            const advancePayment = advancePaymentEnabled ?
                (parseFloat(document.getElementById('advancePaymentAmount')?.value) || 0) : 0;

            // ì‹¤ìˆ˜ë ¹ì•¡ = ì´ ê¸‰ì—¬ - ë³´í—˜ë£Œ - ê°œì¸ì†Œë“ì„¸ - ì„ ê¸ˆ
            const netSalary = totalSalary - totalDeduction - incomeTax - advancePayment;

            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('employeeNameResult').textContent = employeeName + ' ë‹˜';
            document.getElementById('hourlyRate').textContent = formatNumber(hourlyRate) + ' Ä‘/ì‹œê°„';
            document.getElementById('normalPay').textContent = formatNumber(normalPay) + ' Ä‘';
            document.getElementById('overtimePay').textContent = formatNumber(overtimePay) + ' Ä‘';
            document.getElementById('nightPay').textContent = formatNumber(nightPay) + ' Ä‘';
            document.getElementById('sundayPay').textContent = formatNumber(sundayPay) + ' Ä‘';
            document.getElementById('mealDisplay').textContent = formatNumber(mealAllowance) + ' Ä‘';

            // ì´ ì‹ì‚¬ ìˆ˜ ê³„ì‚°
            const totalMealCount = weekdayLunchCount + weekdayDinnerCount + sundayLunchCount +
                                   sundayDinnerCount + annualLeaveLunchCount + excusedAbsentLunchCount;
            document.getElementById('resultTotalMealCount').textContent = totalMealCount + 'ì‹';

            // ì‹ëŒ€ ì„¸ë¶€ ë‚´ì—­ í‘œì‹œ (0ì‹ì¸ í•­ëª©ì€ ìˆ¨ê¸°ê¸°)
            document.getElementById('resultWeekdayLunch').textContent = weekdayLunchCount + 'ì‹';
            document.getElementById('resultWeekdayLunchAmount').textContent = formatNumber(weekdayLunchCount * lunchMeal) + ' Ä‘';
            document.getElementById('resultWeekdayLunchRow').style.display = weekdayLunchCount > 0 ? '' : 'none';

            document.getElementById('resultWeekdayDinner').textContent = weekdayDinnerCount + 'ì‹';
            document.getElementById('resultWeekdayDinnerAmount').textContent = formatNumber(weekdayDinnerCount * dinnerMeal) + ' Ä‘';
            document.getElementById('resultWeekdayDinnerRow').style.display = weekdayDinnerCount > 0 ? '' : 'none';

            document.getElementById('resultSundayLunch').textContent = sundayLunchCount + 'ì‹';
            document.getElementById('resultSundayLunchAmount').textContent = formatNumber(sundayLunchCount * lunchMeal) + ' Ä‘';
            document.getElementById('resultSundayLunchRow').style.display = sundayLunchCount > 0 ? '' : 'none';

            document.getElementById('resultSundayDinner').textContent = sundayDinnerCount + 'ì‹';
            document.getElementById('resultSundayDinnerAmount').textContent = formatNumber(sundayDinnerCount * dinnerMeal) + ' Ä‘';
            document.getElementById('resultSundayDinnerRow').style.display = sundayDinnerCount > 0 ? '' : 'none';

            document.getElementById('resultAnnualLeaveLunch').textContent = annualLeaveLunchCount + 'ì‹';
            document.getElementById('resultAnnualLeaveLunchAmount').textContent = formatNumber(annualLeaveLunchCount * lunchMeal) + ' Ä‘';
            document.getElementById('resultAnnualLeaveLunchRow').style.display = annualLeaveLunchCount > 0 ? '' : 'none';

            document.getElementById('resultExcusedAbsentLunch').textContent = excusedAbsentLunchCount + 'ì‹';
            document.getElementById('resultExcusedAbsentLunchAmount').textContent = formatNumber(excusedAbsentLunchCount * lunchMeal) + ' Ä‘';
            document.getElementById('resultExcusedAbsentLunchRow').style.display = excusedAbsentLunchCount > 0 ? '' : 'none';

            // ê¸°ì¡´ í•˜ë“œì½”ë”©ëœ ìˆ˜ë‹¹ í‘œì‹œ
            document.getElementById('attendanceBonusDisplay').textContent = formatNumber(attendanceBonus) + ' Ä‘';
            document.getElementById('transportDisplay').textContent = formatNumber(transportAllowance) + ' Ä‘';
            document.getElementById('riskDisplay').textContent = formatNumber(riskAllowance) + ' Ä‘';

            // í•˜ë“œì½”ë”©ëœ ìˆ˜ë‹¹ ì»¨í…Œì´ë„ˆ show/hide (ê²°ê³¼ ì˜ì—­ - enabled=trueì´ê³  ê¸ˆì•¡ > 0ì¼ ë•Œë§Œ í‘œì‹œ)
            const attendanceAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_attendance');
            const transportAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_transport');
            const riskAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_risk');

            const attendanceResultContainer = document.getElementById('attendanceBonusResultContainer');
            if (attendanceResultContainer) {
                attendanceResultContainer.style.display = (attendanceAllowanceObj && attendanceAllowanceObj.enabled && attendanceBonus > 0) ? '' : 'none';
            }
            const transportResultContainer = document.getElementById('transportBonusResultContainer');
            if (transportResultContainer) {
                transportResultContainer.style.display = (transportAllowanceObj && transportAllowanceObj.enabled && transportAllowance > 0) ? '' : 'none';
            }
            const riskResultContainer = document.getElementById('riskDisplayResultContainer');
            if (riskResultContainer) {
                riskResultContainer.style.display = (riskAllowanceObj && riskAllowanceObj.enabled && riskAllowance > 0) ? '' : 'none';
            }

            // ê²°ê³¼ ì„¹ì…˜ì— ë™ì  ìˆ˜ë‹¹ ëª©ë¡ í‘œì‹œ (ì¶”ê°€ ìˆ˜ë‹¹ë§Œ, ê¸ˆì•¡ > 0ì¸ ê²ƒë§Œ)
            const resultDynamicAllowancesListEl = document.getElementById('resultDynamicAllowancesList');
            if (resultDynamicAllowancesListEl) {
                let resultAllowancesHTML = '';
                const allowances = (window.companySettings && window.companySettings.allowances) || [];
                allowances.forEach(allowance => {
                    if (!allowance.enabled) return;
                    // ê¸°ì¡´ 3ê°œ ìˆ˜ë‹¹ì€ ì œì™¸ (ì´ë¯¸ ìœ„ì—ì„œ í‘œì‹œë¨)
                    if (allowance.id === 'allowance_attendance' ||
                        allowance.id === 'allowance_transport' ||
                        allowance.id === 'allowance_risk') {
                        return;
                    }

                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {  // 0ì›ì¸ ìˆ˜ë‹¹ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                        resultAllowancesHTML += `
                            <div class="result-item" style="background: #e8f5e9;">
                                <span class="result-label">ğŸ ${allowance.name}</span>
                                <span class="result-value" style="color: #4caf50;">${formatNumber(amount)} Ä‘</span>
                            </div>
                        `;
                    }
                });
                resultDynamicAllowancesListEl.innerHTML = resultAllowancesHTML;
            }

            // íŠ¹ìˆ˜ìˆ˜ë‹¹ í‘œì‹œ
            const specialAllowanceContainer = document.getElementById('specialAllowanceResultContainer');
            if (specialAllowanceContainer) {
                if (specialAllowance > 0) {
                    specialAllowanceContainer.style.display = 'flex';
                    document.getElementById('specialAllowanceResult').textContent = formatNumber(specialAllowance) + ' Ä‘';
                } else {
                    specialAllowanceContainer.style.display = 'none';
                }
            }

            // ì„ ê¸ˆ í‘œì‹œ
            const advancePaymentContainer = document.getElementById('advancePaymentResultContainer');
            if (advancePaymentContainer) {
                if (advancePayment > 0) {
                    advancePaymentContainer.style.display = 'block';
                    document.getElementById('advancePaymentResult').textContent = formatNumber(advancePayment) + ' Ä‘';
                } else {
                    advancePaymentContainer.style.display = 'none';
                }
            }

            // íšŒì‚¬ ë¶€ë‹´ê¸ˆ í‘œì‹œ
            document.getElementById('companySocialIns').textContent = formatNumber(companySocialIns) + ' Ä‘';
            document.getElementById('companyHealthIns').textContent = formatNumber(companyHealthIns) + ' Ä‘';
            document.getElementById('companyUnemployIns').textContent = formatNumber(companyUnemployIns) + ' Ä‘';
            document.getElementById('totalCompanyIns').textContent = formatNumber(totalCompanyIns) + ' Ä‘';

            // ê·¼ë¡œì ê³µì œ í‘œì‹œ
            document.getElementById('socialIns').textContent = formatNumber(socialIns) + ' Ä‘';
            document.getElementById('healthIns').textContent = formatNumber(healthIns) + ' Ä‘';
            document.getElementById('unemployIns').textContent = formatNumber(unemployIns) + ' Ä‘';

            // ê°œì¸ì†Œë“ì„¸ í‘œì‹œ
            document.getElementById('taxableIncome').textContent = formatNumber(taxableIncome) + ' Ä‘';
            document.getElementById('dependentDeduction').textContent = formatNumber(dependentDeduction) + ' Ä‘';
            document.getElementById('totalFamilyDeduction').textContent = formatNumber(totalFamilyDeduction) + ' Ä‘';
            document.getElementById('taxBase').textContent = formatNumber(Math.max(0, taxableIncome - totalFamilyDeduction)) + ' Ä‘';
            document.getElementById('incomeTax').textContent = formatNumber(incomeTax) + ' Ä‘';

            // ë¹„ê³¼ì„¸ ë‚´ì—­ í‘œì‹œ
            const taxFreeMeal = mealAllowance;  // 100% ë¹„ê³¼ì„¸
            const taxFreeOvertime = overtimePay * 1/3;  // 1/3 ë¹„ê³¼ì„¸
            const taxFreeSunday = sundayPay * 1/2;  // 1/2 ë¹„ê³¼ì„¸
            const totalTaxFree = taxFreeMeal + taxFreeOvertime + taxFreeSunday;

            document.getElementById('taxFreeMeal').textContent = formatNumber(taxFreeMeal) + ' Ä‘';
            document.getElementById('taxFreeOvertime').textContent = formatNumber(taxFreeOvertime) + ' Ä‘';
            document.getElementById('taxFreeSunday').textContent = formatNumber(taxFreeSunday) + ' Ä‘';
            document.getElementById('totalTaxFree').textContent = formatNumber(totalTaxFree) + ' Ä‘';

            // ===== ì¤‘ê°„ í•©ê³„ ê³„ì‚° ë° í‘œì‹œ =====
            // 1. ê¸‰ì—¬ ìƒì„¸ í•©ê³„ (ì •ê·œ+ì•¼ê·¼+ì•¼ê°„+ì¼ìš”ì¼)
            const salaryDetailTotal = normalPay + overtimePay + nightPay + sundayPay;
            document.getElementById('salaryDetailTotal').textContent = formatNumber(salaryDetailTotal) + ' Ä‘';

            // 2. ìˆ˜ë‹¹ í•©ê³„ (ì‹ëŒ€+ë™ì ìˆ˜ë‹¹+íŠ¹ìˆ˜ìˆ˜ë‹¹)
            const allowanceTotal = mealAllowance + dynamicAllowances + specialAllowance;
            document.getElementById('allowanceTotal').textContent = formatNumber(allowanceTotal) + ' Ä‘';

            // 3. ìµœì¢… ì •ì‚° ìš”ì•½ (ì‹¤ìˆ˜ë ¹ì•¡ ì „ ìš”ì•½)
            document.getElementById('finalSalaryDetail').textContent = formatNumber(salaryDetailTotal) + ' Ä‘';
            document.getElementById('finalAllowanceTotal').textContent = formatNumber(allowanceTotal) + ' Ä‘';
            document.getElementById('finalTotalSalary').textContent = formatNumber(totalSalary) + ' Ä‘';
            document.getElementById('finalDeduction').textContent = formatNumber(totalDeduction) + ' Ä‘';
            document.getElementById('finalIncomeTax').textContent = formatNumber(incomeTax) + ' Ä‘';

            // ì„ ê¸ˆ í‘œì‹œ (ìˆì„ ê²½ìš°ë§Œ)
            const finalAdvanceRow = document.getElementById('finalAdvancePaymentRow');
            if (advancePayment > 0) {
                finalAdvanceRow.style.display = '';
                document.getElementById('finalAdvancePayment').textContent = formatNumber(advancePayment) + ' Ä‘';
            } else {
                finalAdvanceRow.style.display = 'none';
            }

            document.getElementById('totalSalary').textContent = formatNumber(totalSalary) + ' Ä‘';
            document.getElementById('totalDeduction').textContent = formatNumber(totalDeduction) + ' Ä‘';
            document.getElementById('netSalary').textContent = formatNumber(netSalary) + ' Ä‘';
        }

        // ìˆ«ì í¬ë§·íŒ…
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN').format(Math.round(num));
        }

        // ğŸ“± ëª¨ë°”ì¼ ê¸‰ì—¬ëª…ì„¸ì„œ ì—´ê¸° (ì™„ì „íˆ ìƒˆë¡œ ì‘ì„±)
        function openMobilePayslip() {
            // 1. ì§ì› ì„ íƒ í™•ì¸
            if (!currentEmployeeId) {
                alert('âš ï¸ ë¨¼ì € ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            // 2. ê¸‰ì—¬ ê³„ì‚° ì‹¤í–‰
            calculate();

            // 3. íšŒì‚¬ ì„¤ì • ë¡œë“œ
            const settings = getCompanySettings();
            
            // 4. ê¸‰ì—¬ ë°ì´í„° ìˆ˜ì§‘
            const payslipData = collectPayslipData(settings);
            
            // 5. ëª¨ë°”ì¼ í˜ì´ì§€ ì—´ê¸°
            openPayslipPage(payslipData);
        }

        // íšŒì‚¬ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        function getCompanySettings() {
            console.log('==========================================');
            console.log('ğŸ” íšŒì‚¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘');
            console.log('==========================================');

            // 1. íšŒì‚¬ í”„ë¡œí•„ì—ì„œ íšŒì‚¬ëª…/ë¡œê³  ê°€ì ¸ì˜¤ê¸°
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            let companyName = 'íšŒì‚¬ëª…';
            let companyLogo = null;

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];
                companyName = company.name || 'íšŒì‚¬ëª…';
                companyLogo = company.logo || null;
                console.log('âœ… íšŒì‚¬ í”„ë¡œí•„ ë°œê²¬: ' + currentCompanyId);
            } else {
                console.log('âš ï¸ íšŒì‚¬ í”„ë¡œí•„ ì—†ìŒ - ê¸°ë³¸ê°’ ì‚¬ìš©');
            }

            console.log('ğŸ¢ íšŒì‚¬ëª…:', companyName);
            console.log('ğŸ–¼ï¸ ë¡œê³ :', companyLogo);

            // 2. ê¸‰ì—¬ ê·œì •ì€ vietnamPayrollSettingsì—ì„œ ê°€ì ¸ì˜¤ê¸°
            const storageKey = `vietnamPayrollSettings_${selectedYear}`;
            console.log('ğŸ”‘ ê¸‰ì—¬ì„¤ì • í‚¤:', storageKey);

            const storedData = localStorage.getItem(storageKey);
            let settings = {};

            if (storedData) {
                try {
                    settings = JSON.parse(storedData);
                    console.log('âœ… ê¸‰ì—¬ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');
                } catch (e) {
                    console.error('âŒ ê¸‰ì—¬ì„¤ì • íŒŒì‹± ì‹¤íŒ¨:', e);
                }
            } else {
                console.log('âš ï¸ ê¸‰ì—¬ì„¤ì • ì—†ìŒ - ë¹ˆ ê°ì²´ ì‚¬ìš©');
            }

            // íšŒì‚¬ëª…/ë¡œê³ ë¥¼ ì„¤ì •ì— ì¶”ê°€
            settings.companyName = companyName;
            settings.companyLogo = companyLogo;

            console.log('âœ… ìµœì¢… ì„¤ì • ì™„ë£Œ');
            console.log('==========================================');
            return settings;
        }

        // ê¸‰ì—¬ëª…ì„¸ì„œ ë°ì´í„° ìˆ˜ì§‘
        function collectPayslipData(settings) {
            console.log('==========================================');
            console.log('ğŸ“‹ ê¸‰ì—¬ëª…ì„¸ì„œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘');
            console.log('==========================================');
            console.log('ğŸ“¦ ì „ë‹¬ë°›ì€ settings:', settings);

            // íšŒì‚¬ ì •ë³´
            const companyName = (settings && settings.companyName) || 'íšŒì‚¬ëª…';
            const companyLogo = (settings && settings.companyLogo) || null;

            console.log('ğŸ¢ ìˆ˜ì§‘ëœ íšŒì‚¬ëª…:', companyName);
            console.log('ğŸ–¼ï¸ ìˆ˜ì§‘ëœ ë¡œê³ :', companyLogo);
            
            // ì§ì› ì •ë³´
            const employeeName = document.getElementById('employeeName').value || 'ì§ì›';
            const basicSalary = parseFloat(document.getElementById('basicSalary').value) || 0;
            const dependents = parseInt(document.getElementById('dependents').value) || 0;
            
            // ê·¼ë¬´ í†µê³„
            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const workDays = parseInt(document.getElementById('workDays').textContent.replace(/[^\d]/g, '')) || 0;
            const normalHours = parseFloat(document.getElementById('normalHours').textContent.replace(/[^\d.]/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;
            
            // ê¸‰ì—¬
            const normalPay = parseFloat(document.getElementById('normalPay').textContent.replace(/[^\d]/g, '')) || 0;
            const overtimePay = parseFloat(document.getElementById('overtimePay').textContent.replace(/[^\d]/g, '')) || 0;
            const nightPay = parseFloat(document.getElementById('nightPay').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayPay = parseFloat(document.getElementById('sundayPay').textContent.replace(/[^\d]/g, '')) || 0;
            
            // ì‹ëŒ€
            const lunchMeal = (settings && settings.lunchMeal) || 25000;
            const dinnerMeal = (settings && settings.dinnerMeal) || 25000;
            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;
            const totalMealCount = parseInt(document.getElementById('totalMealCount').textContent.replace(/[^\d]/g, '')) || 0;
            const weekdayLunchCount = parseInt(document.getElementById('weekdayLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const weekdayDinnerCount = parseInt(document.getElementById('weekdayDinnerCount').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayLunchCount = parseInt(document.getElementById('sundayLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayDinnerCount = parseInt(document.getElementById('sundayDinnerCount').textContent.replace(/[^\d]/g, '')) || 0;
            const annualLeaveLunchCount = parseInt(document.getElementById('annualLeaveLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const excusedAbsentLunchCount = parseInt(document.getElementById('excusedAbsentLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            
            // ë™ì  ìˆ˜ë‹¹
            const allowances = (settings && settings.allowances) || [];
            const dynamicAllowances = [];
            allowances.forEach(allowance => {
                if (allowance.enabled) {
                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {
                        dynamicAllowances.push({
                            id: allowance.id,
                            name: allowance.name,
                            amount: amount
                        });
                    }
                }
            });
            
            // íŠ¹ìˆ˜ìˆ˜ë‹¹
            const specialAllowance = document.getElementById('specialAllowanceEnabled')?.checked ? 
                (parseFloat(document.getElementById('specialAllowanceAmount')?.value) || 0) : 0;
            
            // ê³µì œ
            const socialIns = parseFloat(document.getElementById('socialIns').textContent.replace(/[^\d]/g, '')) || 0;
            const healthIns = parseFloat(document.getElementById('healthIns').textContent.replace(/[^\d]/g, '')) || 0;
            const unemployIns = parseFloat(document.getElementById('unemployIns').textContent.replace(/[^\d]/g, '')) || 0;
            const totalDeduction = parseFloat(document.getElementById('totalDeduction').textContent.replace(/[^\d]/g, '')) || 0;
            const incomeTax = parseFloat(document.getElementById('incomeTax').textContent.replace(/[^\d]/g, '')) || 0;
            
            // ì„ ê¸ˆ
            const advancePayment = document.getElementById('advancePaymentEnabled')?.checked ?
                (parseFloat(document.getElementById('advancePaymentAmount')?.value) || 0) : 0;
            
            // ì´ ê¸‰ì—¬ (í™”ë©´ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
            const totalSalary = parseFloat(document.getElementById('totalSalary').textContent.replace(/[^\d]/g, '')) || 0;

            // ì‹¤ìˆ˜ë ¹ì•¡
            const netSalary = parseFloat(document.getElementById('netSalary').textContent.replace(/[^\d]/g, '')) || 0;

            return {
                companyName,
                companyLogo,
                year: selectedYear,
                month: selectedMonth,
                employeeName,
                basicSalary,
                dependents,
                totalDays: daysInMonth,
                workDays,
                normalHours,
                overtimeHours,
                nightHours,
                sundayHours,
                normalPay,
                overtimePay,
                nightPay,
                sundayPay,
                mealAllowance,
                totalMealCount,
                lunchMeal,
                dinnerMeal,
                weekdayLunchCount,
                weekdayDinnerCount,
                sundayLunchCount,
                sundayDinnerCount,
                annualLeaveLunchCount,
                excusedAbsentLunchCount,
                allowances: dynamicAllowances,
                specialAllowance,
                totalSalary,  // ì¶”ê°€!
                socialIns,
                healthIns,
                unemployIns,
                totalDeduction,
                incomeTax,
                advancePayment,
                netSalary
            };
        }

        // ëª¨ë°”ì¼ í˜ì´ì§€ ì—´ê¸°
        function openPayslipPage(data) {
            console.log('==========================================');
            console.log('ğŸš€ ëª¨ë°”ì¼ í˜ì´ì§€ ì—´ê¸°');
            console.log('==========================================');
            console.log('ğŸ“¦ ì „ë‹¬í•  ë°ì´í„°:', data);
            console.log('ğŸ¢ íšŒì‚¬ëª…:', data.companyName);
            console.log('ğŸ–¼ï¸ ë¡œê³ :', data.companyLogo);
            console.log('==========================================');

            const dataString = encodeURIComponent(JSON.stringify(data));
            const url = `payslip.html?data=${dataString}`;
            console.log('ğŸ”— ìƒì„±ëœ URL (ì²˜ìŒ 200ì):', url.substring(0, 200));
            window.open(url, '_blank');
        }
        // ==================== ì§ì› ê´€ë¦¬ í•¨ìˆ˜ ====================

        // íšŒì‚¬ ì„¤ì • (ê³µí†µ ì„¤ì •)
        let companySettings = {
            dailyMeal: 25000,
            attendanceBonus: 300000,
            transportBonus: 200000,
            riskBonus: 100000,
            employeeSocialRate: 8,
            employeeHealthRate: 1.5,
            employeeUnemployRate: 1,
            companySocialRate: 17.5,
            companyHealthRate: 3,
            companyUnemployRate: 1
        };

        // LocalStorageì—ì„œ ì§ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadEmployeesFromStorage() {
            const stored = localStorage.getItem('vietnamPayrollEmployees');
            if (stored) {
                employees = JSON.parse(stored);
                updateEmployeeSelect();
            }

            // íšŒì‚¬ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (í˜„ì¬ ì—°ë„ ê¸°ì¤€)
            console.log('===== ğŸ’¼ ì´ˆê¸° íšŒì‚¬ ì„¤ì • ë¡œë“œ =====');
            console.log('ğŸ“… ì„ íƒëœ ì—°ë„:', selectedYear);
            console.log('ğŸ”‘ localStorage í‚¤:', `vietnamPayrollSettings_${selectedYear}`);
            
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            
            if (storedSettings) {
                try {
                    window.companySettings = JSON.parse(storedSettings);
                    console.log('âœ… íšŒì‚¬ ì„¤ì • ë¡œë“œ ì„±ê³µ!');
                    console.log('ğŸ¢ íšŒì‚¬ëª…:', window.companySettings.companyName);
                    console.log('ğŸ–¼ï¸ ë¡œê³ :', window.companySettings.companyLogo);
                    console.log('=====================================');
                } catch (e) {
                    console.error('âŒ íšŒì‚¬ ì„¤ì • íŒŒì‹± ì‹¤íŒ¨:', e);
                    console.log('=====================================');
                }
            } else {
                console.warn('âš ï¸ localStorageì— íšŒì‚¬ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤!');
                console.warn('ğŸ’¡ settings.htmlì—ì„œ íšŒì‚¬ ì •ë³´ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                console.log('=====================================');
            }
        }

        // LocalStorageì— ì§ì› ë°ì´í„° ì €ì¥
        function saveEmployeesToStorage() {
            localStorage.setItem('vietnamPayrollEmployees', JSON.stringify(employees));
        }

        // ì§ì› ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
        function updateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- ì§ì› ì„ íƒ --</option>';

            for (const id in employees) {
                const emp = employees[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = emp.name;
                if (id === currentEmployeeId) option.selected = true;
                select.appendChild(option);
            }

            // ì„ íƒ ì´ë²¤íŠ¸
            select.onchange = function() {
                if (this.value) {
                    loadEmployee(this.value);
                }
            };
        }

        // ì§ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        function loadEmployee(id) {
            const emp = employees[id];
            if (!emp) return;

            currentEmployeeId = id;

            // ë“œë¡­ë‹¤ìš´ ì„ íƒ
            const select = document.getElementById('employeeSelect');
            if (select) {
                select.value = id;
            }

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('employeeName').value = emp.name;
            document.getElementById('basicSalary').value = emp.basicSalary;
            document.getElementById('dependents').value = emp.dependents || 0;
            document.getElementById('dailyMeal').value = emp.dailyMeal || 25000;

            // ë‹¬ë ¥ ë°ì´í„° (ë‚ ì§œ í˜•ì‹ ì •ê·œí™”)
            holidays = new Set(normalizeDateSet(emp.holidays || []));
            excusedAbsents = new Set(normalizeDateSet(emp.excusedAbsents || []));
            absents = new Set(normalizeDateSet(emp.absents || []));
            annualLeaveDays = new Set(normalizeDateSet(emp.annualLeaveDays || []));
            overtimeData = normalizeDateObject(emp.overtimeData || {});
            nightData = normalizeDateObject(emp.nightData || {});
            sundayData = normalizeDateObject(emp.sundayData || {});
            normalHoursData = normalizeDateObject(emp.normalHoursData || {});

            // ì¼ìš”ì¼ ì •ê·œê·¼ë¬´ ë°ì´í„° ì œê±° (ì¼ìš”ì¼ì€ ì •ê·œê·¼ë¬´ ì—†ìŒ)
            Object.keys(normalHoursData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 0) {  // ì¼ìš”ì¼
                    delete normalHoursData[dateKey];
                }
            });

            // íŠ¹ìˆ˜ìˆ˜ë‹¹ ë³µì›
            const specialAllowanceCheckbox = document.getElementById('specialAllowanceEnabled');
            const specialAllowanceInput = document.getElementById('specialAllowanceAmount');
            if (specialAllowanceCheckbox && specialAllowanceInput) {
                specialAllowanceCheckbox.checked = emp.specialAllowanceEnabled || false;
                specialAllowanceInput.value = emp.specialAllowanceAmount || 0;
                if (specialAllowanceCheckbox.checked) {
                    specialAllowanceInput.disabled = false;
                    specialAllowanceInput.style.background = 'white';
                } else {
                    specialAllowanceInput.disabled = true;
                    specialAllowanceInput.style.background = '#f5f5f5';
                }
            }

            // ì„ ê¸ˆ ë³µì›
            const advancePaymentCheckbox = document.getElementById('advancePaymentEnabled');
            const advancePaymentInput = document.getElementById('advancePaymentAmount');
            if (advancePaymentCheckbox && advancePaymentInput) {
                advancePaymentCheckbox.checked = emp.advancePaymentEnabled || false;
                advancePaymentInput.value = emp.advancePaymentAmount || 0;
                if (advancePaymentCheckbox.checked) {
                    advancePaymentInput.disabled = false;
                    advancePaymentInput.style.background = 'white';
                } else {
                    advancePaymentInput.disabled = true;
                    advancePaymentInput.style.background = '#f5f5f5';
                }
            }

            generateCalendar();
            calculate();
            updateConfirmStatus(); // í™•ì • ìƒíƒœ í‘œì‹œ
        }

        // í˜„ì¬ ì§ì› ë°ì´í„° ì €ì¥
        function saveCurrentEmployee() {
            if (!currentEmployeeId) return;

            // ì¼ìš”ì¼ ì •ê·œê·¼ë¬´ ë°ì´í„° ì œê±° (ì¼ìš”ì¼ì€ ì •ê·œê·¼ë¬´ ì—†ìŒ)
            const filteredNormalHours = {};
            Object.keys(normalHoursData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                if (date.getDay() !== 0) {  // ì¼ìš”ì¼ ì•„ë‹Œ ë‚ ë§Œ
                    filteredNormalHours[dateKey] = normalHoursData[dateKey];
                }
            });

            const emp = employees[currentEmployeeId];
            employees[currentEmployeeId] = {
                ...emp, // ê¸°ì¡´ ë°ì´í„° ìœ ì§€ (hireDate, annualLeavePerYear, annualLeaveUsed ë“±)
                name: document.getElementById('employeeName').value,
                basicSalary: parseFloat(document.getElementById('basicSalary').value) || 0,
                dependents: parseInt(document.getElementById('dependents').value) || 0,
                dailyMeal: parseFloat(document.getElementById('dailyMeal').value) || 25000,
                holidays: Array.from(holidays),
                excusedAbsents: Array.from(excusedAbsents),
                absents: Array.from(absents),
                annualLeaveDays: Array.from(annualLeaveDays),
                overtimeData: overtimeData,
                nightData: nightData,
                sundayData: sundayData,
                normalHoursData: filteredNormalHours,
                specialAllowanceEnabled: document.getElementById('specialAllowanceEnabled')?.checked || false,
                specialAllowanceAmount: parseFloat(document.getElementById('specialAllowanceAmount')?.value) || 0,
                advancePaymentEnabled: document.getElementById('advancePaymentEnabled')?.checked || false,
                advancePaymentAmount: parseFloat(document.getElementById('advancePaymentAmount')?.value) || 0
            };

            saveEmployeesToStorage();
        }

        // í¼ ì´ˆê¸°í™”
        function clearForm() {
            document.getElementById('employeeName').value = '';
            document.getElementById('basicSalary').value = 6980000;
            document.getElementById('dependents').value = 0;
            document.getElementById('dailyMeal').value = 25000;

            // íŠ¹ìˆ˜ìˆ˜ë‹¹/ì„ ê¸ˆ ì´ˆê¸°í™”
            const specialAllowanceCheckbox = document.getElementById('specialAllowanceEnabled');
            const specialAllowanceInput = document.getElementById('specialAllowanceAmount');
            if (specialAllowanceCheckbox && specialAllowanceInput) {
                specialAllowanceCheckbox.checked = false;
                specialAllowanceInput.value = 0;
                specialAllowanceInput.disabled = true;
                specialAllowanceInput.style.background = '#f5f5f5';
            }

            const advancePaymentCheckbox = document.getElementById('advancePaymentEnabled');
            const advancePaymentInput = document.getElementById('advancePaymentAmount');
            if (advancePaymentCheckbox && advancePaymentInput) {
                advancePaymentCheckbox.checked = false;
                advancePaymentInput.value = 0;
                advancePaymentInput.disabled = true;
                advancePaymentInput.style.background = '#f5f5f5';
            }

            holidays = new Set();
            excusedAbsents = new Set();
            absents = new Set();
            overtimeData = {};
            nightData = {};
            sundayData = {};
            normalHoursData = {};
            generateCalendar();
            calculate();
        }

        // ì „ì²´ ê¸‰ì—¬ëª…ì„¸ Excel ì €ì¥
        function exportAllToExcel() {
            if (Object.keys(employees).length === 0) {
                alert('âš ï¸ ì €ì¥í•  ì§ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            const wb = XLSX.utils.book_new();
            const results = [];

            // ë™ì  ìˆ˜ë‹¹ í—¤ë” ìƒì„±
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            const enabledAllowances = allowances.filter(a => a.enabled);
            const allowanceHeaders = enabledAllowances.map(a => a.name);

            // í—¤ë” (ë™ì  ìˆ˜ë‹¹ í¬í•¨)
            const headerRow = [
                'ì§ì›ëª…', 'ê¸°ë³¸ê¸‰', 'ë¶€ì–‘ê°€ì¡±', 'ì‹œê°„ê¸‰', 'ì •ê·œê¸‰ì—¬', 'ì•¼ê·¼ìˆ˜ë‹¹', 'ì•¼ê°„ìˆ˜ë‹¹', 'íŠ¹ê·¼ìˆ˜ë‹¹',
                'ì‹ëŒ€', ...allowanceHeaders, 'ì´ê¸‰ì—¬', 'ì‚¬íšŒë³´í—˜', 'ê±´ê°•ë³´í—˜', 'ì‹¤ì—…ë³´í—˜',
                'ë³´í—˜ê³µì œ', 'ê³¼ì„¸ì†Œë“', 'ê°€ì¡±ê³µì œ', 'ê³¼ì„¸í‘œì¤€', 'ì†Œë“ì„¸', 'ì‹¤ìˆ˜ë ¹ì•¡'
            ];
            results.push(headerRow);

            // í•©ê³„ ëˆ„ì  ë³€ìˆ˜ ì´ˆê¸°í™”
            let sumBasicSalary = 0;
            let sumNormalPay = 0;
            let sumOvertimePay = 0;
            let sumNightPay = 0;
            let sumSundayPay = 0;
            let sumMealAllowance = 0;
            let sumAllowances = new Array(enabledAllowances.length).fill(0);
            let sumTotalSalary = 0;
            let sumSocialIns = 0;
            let sumHealthIns = 0;
            let sumUnemployIns = 0;
            let sumTotalDeduction = 0;
            let sumIncomeTax = 0;
            let sumNetSalary = 0;

            // ê° ì§ì› ê³„ì‚°
            for (const id in employees) {
                const emp = employees[id];

                // ì„ì‹œë¡œ ì§ì› ë°ì´í„° ë¡œë“œ
                const tempCurrent = currentEmployeeId;
                loadEmployee(id);

                // ê³„ì‚° ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
                const hourlyRate = emp.basicSalary / 208;
                const normalHoursText = document.getElementById('normalHours').textContent;
                const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
                const normalPay = hourlyRate * normalHours;
                const overtimePay = hourlyRate * (parseFloat(document.getElementById('overtimeHours').value) || 0) * 1.5;
                const nightPay = hourlyRate * (parseFloat(document.getElementById('nightHours').value) || 0) * 1.3;
                const sundayPay = hourlyRate * (parseFloat(document.getElementById('sundayHours').value) || 0) * 2.0;

                const mealAllowanceText = document.getElementById('autoMeal').textContent;
                const mealAllowance = parseFloat(mealAllowanceText.replace(/[^\d]/g, '')) || 0;

                // ë™ì  ìˆ˜ë‹¹ ì´ì•¡ ê°€ì ¸ì˜¤ê¸°
                const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;

                // ê°œë³„ ìˆ˜ë‹¹ ê°’ë“¤ (ì—‘ì…€ ê° ì—´ì— í‘œì‹œìš©)
                const allowanceValues = enabledAllowances.map(allowance => {
                    return currentAllowanceDetails[allowance.id] || 0;
                });

                const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

                const socialIns = emp.basicSalary * 0.08;
                const healthIns = emp.basicSalary * 0.015;
                const unemployIns = emp.basicSalary * 0.01;
                const totalDeduction = socialIns + healthIns + unemployIns;

                // ê³¼ì„¸ ëŒ€ìƒ ì†Œë“ (ì‹ëŒ€ ë¹„ê³¼ì„¸, ì•¼ê·¼ 2/3, íŠ¹ê·¼ 1/2, ìˆ˜ë‹¹ ì „ì•¡ ê³¼ì„¸)
                const taxableIncome = normalPay
                                    + (overtimePay * 2/3)
                                    + nightPay
                                    + (sundayPay * 1/2)
                                    + dynamicAllowancesTotal  // ëª¨ë“  ìˆ˜ë‹¹ ì „ì•¡ ê³¼ì„¸
                                    - totalDeduction;
                const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
                let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

                // ì†Œë“ì„¸ ê³„ì‚°
                let incomeTax = 0;
                let remainingBase = taxBase;
                if (remainingBase > 0) {
                    const tier1 = Math.min(remainingBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    remainingBase -= tier1;
                }
                if (remainingBase > 0) {
                    const tier2 = Math.min(remainingBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    remainingBase -= tier2;
                }
                if (remainingBase > 0) {
                    const tier3 = Math.min(remainingBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    remainingBase -= tier3;
                }
                if (remainingBase > 0) {
                    const tier4 = Math.min(remainingBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    remainingBase -= tier4;
                }
                if (remainingBase > 0) {
                    const tier5 = Math.min(remainingBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    remainingBase -= tier5;
                }
                if (remainingBase > 0) {
                    const tier6 = Math.min(remainingBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    remainingBase -= tier6;
                }
                if (remainingBase > 0) {
                    incomeTax += remainingBase * 0.35;
                }

                const netSalary = totalSalary - totalDeduction - incomeTax;

                // ë°ì´í„° í–‰ ìƒì„± (ë™ì  ìˆ˜ë‹¹ í¬í•¨)
                const dataRow = [
                    emp.name, emp.basicSalary, emp.dependents,
                    Math.round(hourlyRate), Math.round(normalPay), Math.round(overtimePay), Math.round(nightPay), Math.round(sundayPay),
                    Math.round(mealAllowance),
                    ...allowanceValues.map(v => Math.round(v)),  // ë™ì  ìˆ˜ë‹¹ë“¤
                    Math.round(totalSalary), Math.round(socialIns), Math.round(healthIns), Math.round(unemployIns),
                    Math.round(totalDeduction), Math.round(taxableIncome), Math.round(totalFamilyDeduction), Math.round(taxBase),
                    Math.round(incomeTax), Math.round(netSalary)
                ];
                results.push(dataRow);

                // í•©ê³„ ëˆ„ì 
                sumBasicSalary += emp.basicSalary;
                sumNormalPay += normalPay;
                sumOvertimePay += overtimePay;
                sumNightPay += nightPay;
                sumSundayPay += sundayPay;
                sumMealAllowance += mealAllowance;
                allowanceValues.forEach((val, idx) => {
                    sumAllowances[idx] += val;
                });
                sumTotalSalary += totalSalary;
                sumSocialIns += socialIns;
                sumHealthIns += healthIns;
                sumUnemployIns += unemployIns;
                sumTotalDeduction += totalDeduction;
                sumIncomeTax += incomeTax;
                sumNetSalary += netSalary;

                // ì›ë˜ ì§ì›ìœ¼ë¡œ ë³µê·€
                if (tempCurrent) loadEmployee(tempCurrent);
            }

            // í•©ê³„ í–‰ ì¶”ê°€
            const sumRow = [
                'í•©ê³„', Math.round(sumBasicSalary), '', '',
                Math.round(sumNormalPay), Math.round(sumOvertimePay), Math.round(sumNightPay), Math.round(sumSundayPay),
                Math.round(sumMealAllowance),
                ...sumAllowances.map(v => Math.round(v)),
                Math.round(sumTotalSalary), Math.round(sumSocialIns), Math.round(sumHealthIns), Math.round(sumUnemployIns),
                Math.round(sumTotalDeduction), '', '', '',
                Math.round(sumIncomeTax), Math.round(sumNetSalary)
            ];
            results.push(sumRow);

            const ws = XLSX.utils.aoa_to_sheet(results);
            XLSX.utils.book_append_sheet(wb, ws, 'ê¸‰ì—¬ëª…ì„¸');

            XLSX.writeFile(wb, `ê¸‰ì—¬ëª…ì„¸_${selectedYear}_${selectedMonth}.xlsx`);
            alert('âœ… ê¸‰ì—¬ëª…ì„¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ==================== ëª¨ë‹¬ í•¨ìˆ˜ ====================

        // ========================================
        // ê¸‰ì—¬ ê³„ì‚° í•µì‹¬ ê¸°ëŠ¥
        // ========================================

        // ì „ì²´ ì§ì› ê¸‰ì—¬ ê³„ì‚°
        function calculateAllEmployeesPayroll(year, month) {
            const results = [];

            Object.keys(employees).forEach(empId => {
                const emp = employees[empId];
                const payroll = calculateEmployeePayroll(empId, year, month);

                if (payroll) {
                    results.push({
                        employeeId: empId,  // dashboard.jsì—ì„œ ì‚¬ìš©
                        id: empId,          // í˜¸í™˜ì„± ìœ ì§€
                        name: emp.name,
                        ...payroll
                    });
                }
            });

            return results;
        }

        // ê°œë³„ ì§ì› ê¸‰ì—¬ ê³„ì‚°
        function calculateEmployeePayroll(employeeId, year, month) {
            const emp = employees[employeeId];
            if (!emp) return null;

            // í—¬í¼ í•¨ìˆ˜: dateKeyê°€ ì§€ì •ëœ ì—°/ì›”ì— ì†í•˜ëŠ”ì§€ í™•ì¸ (êµ¬ë²„ì „ í˜¸í™˜)
            function isTargetMonth(key) {
                const parts = key.split('-');
                if (parts.length < 2) return false;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return keyYear === year && keyMonth === month;
            }

            // í•´ë‹¹ ì›”ì˜ ë‹¬ë ¥ ë°ì´í„° ë¡œë“œ
            const basicSalary = emp.basicSalary || 6980000;
            const dailyMeal = emp.dailyMeal || 25000;
            const dependents = emp.dependents || 0;

            // ì›”ë³„ ë°ì´í„° í•„í„°ë§ (êµ¬ë²„ì „ í˜¸í™˜)
            const holidays = new Set((emp.holidays || []).filter(d => isTargetMonth(d)));
            const excusedAbsents = new Set((emp.excusedAbsents || []).filter(d => isTargetMonth(d)));
            const absents = new Set((emp.absents || []).filter(d => isTargetMonth(d)));
            const annualLeaveDays = new Set((emp.annualLeaveDays || []).filter(d => isTargetMonth(d)));

            const overtimeData = {};
            const nightData = {};
            const sundayData = {};
            const normalHoursData = {};

            Object.keys(emp.overtimeData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    overtimeData[key] = emp.overtimeData[key];
                }
            });

            Object.keys(emp.nightData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    nightData[key] = emp.nightData[key];
                }
            });

            Object.keys(emp.sundayData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    sundayData[key] = emp.sundayData[key];
                }
            });

            Object.keys(emp.normalHoursData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    normalHoursData[key] = emp.normalHoursData[key];
                }
            });

            // í†µê³„ ê³„ì‚°
            const daysInMonth = new Date(year, month, 0).getDate();
            let sundays = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 0) sundays++;
            }

            const weekdays = daysInMonth - sundays;

            // ê³µíœ´ì¼ ì¤‘ ì¼ìš”ì¼ì€ ì œì™¸
            let holidayCount = 0;
            holidays.forEach(dateKey => {
                const parts = dateKey.split('-');
                const day = parseInt(parts[2]);
                const date = new Date(year, month - 1, day);
                if (date.getDay() !== 0) {
                    holidayCount++;
                }
            });

            const excusedAbsentCount = excusedAbsents.size;
            const unexcusedAbsentCount = absents.size;
            const annualLeaveCount = annualLeaveDays.size;
            const totalAbsentCount = excusedAbsentCount + unexcusedAbsentCount;

            // ì¼ìš”ì¼ íŠ¹ê·¼ì¼ ìˆ˜ ê³„ì‚° (8ì‹œê°„ ì´ìƒ ì¼í•˜ë©´ ì‹ëŒ€ ì§€ê¸‰ - ì‹¤ê·¼ë¬´ì¼ì—ëŠ” í¬í•¨ ì•ˆë¨)
            let sundayWorkDays = 0;
            Object.keys(sundayData).forEach(key => {
                if (sundayData[key] >= 8) sundayWorkDays++;
            });

            const workDays = weekdays - holidayCount - totalAbsentCount - annualLeaveCount;

            // ì •ê·œ ê·¼ë¬´ì‹œê°„ ê³„ì‚°
            let normalHours = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(year, month, day);
                const dateKeyOld = `${year}-${month}-${day}`;

                if (dayOfWeek === 0) continue;
                if ((holidays.has(dateKey) || holidays.has(dateKeyOld)) && dayOfWeek !== 0) continue;
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) continue;
                if (absents.has(dateKey) || absents.has(dateKeyOld)) continue;

                if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld)) {
                    normalHours += 8;
                } else {
                    normalHours += (normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8);
                }
            }

            // ì‹œê¸‰ ê³„ì‚°
            const monthlyHours = weekdays * 8;
            const hourlyRate = monthlyHours > 0 ? basicSalary / monthlyHours : 0;

            // ê¸‰ì—¬ ê³„ì‚°
            const normalPay = Math.round(hourlyRate * normalHours);

            let totalOvertime = 0;
            Object.keys(overtimeData).forEach(key => {
                totalOvertime += overtimeData[key];
            });

            let totalNight = 0;
            Object.keys(nightData).forEach(key => {
                totalNight += nightData[key];
            });

            let totalSunday = 0;
            Object.keys(sundayData).forEach(key => {
                totalSunday += sundayData[key];
            });

            const overtimePay = Math.round(hourlyRate * totalOvertime * 1.5);
            const nightPay = Math.round(hourlyRate * totalNight * 1.3);
            const sundayPay = Math.round(hourlyRate * totalSunday * 2.0);

            // ìˆ˜ë‹¹ ê³„ì‚° (ì‹ëŒ€: ì‹¤ê·¼ë¬´ì¼ + ì¼ìš”ì¼ íŠ¹ê·¼ 8ì‹œê°„ ì´ìƒ)
            const mealAllowance = (workDays + sundayWorkDays) * dailyMeal;
            const totalWorkableDays = daysInMonth - sundays - holidayCount;

            // ë™ì  ìˆ˜ë‹¹ ì‹œìŠ¤í…œ (ê¸‰ì—¬ëŒ€ì¥ìš©)
            const attendanceRate = totalWorkableDays > 0 ? (totalWorkableDays - excusedAbsentCount - annualLeaveCount) / totalWorkableDays : 0;

            // íšŒì‚¬ ì„¤ì •ì—ì„œ ìˆ˜ë‹¹ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (window.companySettings ì‚¬ìš©!)
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            let dynamicAllowancesTotal = 0;

            allowances.forEach(allowance => {
                if (!allowance.enabled) return;

                let amount = 0;

                // ë¬´ë‹¨ê²°ê·¼ì´ ìˆëŠ” ê²½ìš°
                if (unexcusedAbsentCount > 0) {
                    if (allowance.onAbsence === 'zero') {
                        amount = 0;
                    } else if (allowance.onAbsence === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // ì‚¬ìœ ê²°ê·¼ì´ ìˆëŠ” ê²½ìš°
                else if (excusedAbsentCount > 0) {
                    const excusedAbsenceRule = allowance.onExcusedAbsence || 'proportional';
                    if (excusedAbsenceRule === 'zero') {
                        amount = 0;
                    } else if (excusedAbsenceRule === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // ì •ìƒ ì¶œê·¼ (ì—°ì°¨ë§Œ ìˆê±°ë‚˜ ì™„ì „ ì •ìƒ)
                else {
                    if (allowance.onAnnualLeave === 'zero' && annualLeaveCount > 0) {
                        amount = 0;
                    } else if (allowance.onAnnualLeave === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }

                dynamicAllowancesTotal += amount;
            });

            const totalAllowances = mealAllowance + dynamicAllowancesTotal;

            // ì´ ê¸‰ì—¬
            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + totalAllowances;

            // ë³´í—˜ë£Œ ê³µì œ
            const socialIns = Math.round(basicSalary * 0.08);
            const healthIns = Math.round(basicSalary * 0.015);
            const unemployIns = Math.round(basicSalary * 0.01);
            const totalDeduction = socialIns + healthIns + unemployIns;

            // ì†Œë“ì„¸ ê³„ì‚°
            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                 + dynamicAllowancesTotal - totalDeduction;

            const selfDeduction = 11000000;
            const dependentDeduction = dependents * 4400000;
            const totalFamilyDeduction = selfDeduction + dependentDeduction;

            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);
            let incomeTax = 0;

            if (taxBase > 0) {
                const originalTaxBase = taxBase;
                if (taxBase > 0) {
                    const tier1 = Math.min(taxBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    taxBase -= tier1;
                }
                if (taxBase > 0) {
                    const tier2 = Math.min(taxBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    taxBase -= tier2;
                }
                if (taxBase > 0) {
                    const tier3 = Math.min(taxBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    taxBase -= tier3;
                }
                if (taxBase > 0) {
                    const tier4 = Math.min(taxBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    taxBase -= tier4;
                }
                if (taxBase > 0) {
                    const tier5 = Math.min(taxBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    taxBase -= tier5;
                }
                if (taxBase > 0) {
                    const tier6 = Math.min(taxBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    taxBase -= tier6;
                }
                if (taxBase > 0) {
                    incomeTax += taxBase * 0.35;
                }
            }

            // ì‹¤ìˆ˜ë ¹ì•¡
            const netSalary = totalSalary - totalDeduction - incomeTax;

            return {
                workDays: workDays,
                normalHours: normalHours,
                basicPay: normalPay,
                allowances: totalAllowances,
                totalSalary: totalSalary,
                deductions: totalDeduction,
                incomeTax: Math.round(incomeTax),
                netSalary: netSalary
            };
        }

        // í˜„ì¬ ì§ì›ì˜ ì´ë²ˆ ë‹¬ ë°ì´í„° ì´ˆê¸°í™”
        function clearCurrentMonthData() {
            if (!currentEmployeeId) {
                alert('âš ï¸ ë¨¼ì € ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            if (!selectedYear || !selectedMonth) {
                alert('âš ï¸ ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            const emp = employees[currentEmployeeId];
            const monthStr = `${selectedYear}ë…„ ${selectedMonth}ì›”`;

            if (!confirm(`âš ï¸ ${emp.name} ì§ì›ì˜ ${monthStr} ë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œë˜ëŠ” ë°ì´í„°:\n- ê³µíœ´ì¼\n- ì‚¬ìœ ê²°ê·¼/ë¬´ë‹¨ê²°ê·¼\n- ì—°ì°¨\n- ì”ì—…/ì•¼ê°„/ì¼ìš”ì¼ íŠ¹ê·¼\n- ì •ê·œ ê·¼ë¬´ì‹œê°„ ì¡°ì •\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`)) {
                return;
            }

            // í•´ë‹¹ ì›”ì˜ ë°ì´í„°ë§Œ í•„í„°ë§í•˜ì—¬ ì‚­ì œ (êµ¬ë²„ì „ í˜¸í™˜)
            function isNotCurrentMonth(dateKey) {
                const parts = dateKey.split('-');
                if (parts.length < 2) return true;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return !(keyYear === selectedYear && keyMonth === selectedMonth);
            }

            // Set íƒ€ì… ë°ì´í„° í•„í„°ë§
            const newHolidays = Array.from(holidays).filter(date => isNotCurrentMonth(date));
            const newExcusedAbsents = Array.from(excusedAbsents).filter(date => isNotCurrentMonth(date));
            const newAbsents = Array.from(absents).filter(date => isNotCurrentMonth(date));
            const newAnnualLeaveDays = Array.from(annualLeaveDays).filter(date => isNotCurrentMonth(date));

            // Object íƒ€ì… ë°ì´í„° í•„í„°ë§
            const newOvertimeData = {};
            const newNightData = {};
            const newSundayData = {};
            const newNormalHoursData = {};

            Object.keys(overtimeData).forEach(key => {
                if (isNotCurrentMonth(key)) newOvertimeData[key] = overtimeData[key];
            });
            Object.keys(nightData).forEach(key => {
                if (isNotCurrentMonth(key)) newNightData[key] = nightData[key];
            });
            Object.keys(sundayData).forEach(key => {
                if (isNotCurrentMonth(key)) newSundayData[key] = sundayData[key];
            });
            Object.keys(normalHoursData).forEach(key => {
                if (isNotCurrentMonth(key)) newNormalHoursData[key] = normalHoursData[key];
            });

            // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            holidays = new Set(newHolidays);
            excusedAbsents = new Set(newExcusedAbsents);
            absents = new Set(newAbsents);
            annualLeaveDays = new Set(newAnnualLeaveDays);
            overtimeData = newOvertimeData;
            nightData = newNightData;
            sundayData = newSundayData;
            normalHoursData = newNormalHoursData;

            // ì§ì› ë°ì´í„°ì— ì €ì¥
            employees[currentEmployeeId] = {
                ...emp,
                holidays: Array.from(holidays),
                excusedAbsents: Array.from(excusedAbsents),
                absents: Array.from(absents),
                annualLeaveDays: Array.from(annualLeaveDays),
                overtimeData: overtimeData,
                nightData: nightData,
                sundayData: sundayData,
                normalHoursData: normalHoursData
            };

            // ì €ì¥
            saveEmployeesToStorage();

            // ê¸‰ì—¬ ëŒ€ì¥(historyData)ì—ì„œë„ í•´ë‹¹ ì§ì› ë°ì´í„° ì‚­ì œ
            const historyKey = `payrollHistory_${selectedYear}_${selectedMonth}`;
            const historyData = JSON.parse(localStorage.getItem(historyKey) || 'null');

            if (historyData) {
                // confirmedEmployeesì—ì„œ ì œê±°
                if (historyData.confirmedEmployees && Array.isArray(historyData.confirmedEmployees)) {
                    historyData.confirmedEmployees = historyData.confirmedEmployees.filter(id => id !== currentEmployeeId);
                }

                // dataì—ì„œ ì œê±°
                if (historyData.data && Array.isArray(historyData.data)) {
                    historyData.data = historyData.data.filter(item => item.employeeId !== currentEmployeeId);
                }

                // ì €ì¥ ë˜ëŠ” ì™„ì „ ì‚­ì œ
                if (historyData.confirmedEmployees.length === 0) {
                    // í™•ì •ëœ ì§ì›ì´ ì•„ë¬´ë„ ì—†ìœ¼ë©´ íˆìŠ¤í† ë¦¬ ìì²´ ì‚­ì œ
                    localStorage.removeItem(historyKey);
                } else {
                    // ë‚¨ì€ ì§ì›ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                    localStorage.setItem(historyKey, JSON.stringify(historyData));
                }
            }

            // í™•ì • ë¦¬ìŠ¤íŠ¸(payrollConfirmed)ì—ì„œë„ í•´ë‹¹ ì§ì› ì œê±°
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
            confirmedList = confirmedList.filter(id => id !== currentEmployeeId);

            if (confirmedList.length === 0) {
                // í™•ì •ëœ ì§ì›ì´ ì•„ë¬´ë„ ì—†ìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ ìì²´ ì‚­ì œ
                localStorage.removeItem(confirmKey);
            } else {
                // ë‚¨ì€ ì§ì›ì´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                localStorage.setItem(confirmKey, JSON.stringify(confirmedList));
            }

            // í™•ì • ìƒíƒœ í•´ì œ
            updateConfirmStatus();

            // ë‹¬ë ¥ê³¼ ê³„ì‚° ê°±ì‹ 
            generateCalendar();
            calculate();

            alert(`âœ… ${emp.name} ì§ì›ì˜ ${monthStr} ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!\n\ní™•ì • ìƒíƒœê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        // í˜„ì¬ ì§ì› ë°ì´í„° í™•ì •
        function confirmCurrentEmployee() {
            if (!currentEmployeeId) {
                alert('âš ï¸ ë¨¼ì € ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            if (!selectedYear || !selectedMonth) {
                alert('âš ï¸ ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            const emp = employees[currentEmployeeId];
            const monthKey = `${selectedYear}_${selectedMonth}`;

            // í˜„ì¬ ì§ì› ë°ì´í„° ì €ì¥
            saveCurrentEmployee();

            // í™•ì •ëœ ì§ì› ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const confirmKey = `payrollConfirmed_${monthKey}`;
            let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');

            // ì´ë¯¸ í™•ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if (!confirmedList.includes(currentEmployeeId)) {
                confirmedList.push(currentEmployeeId);
                localStorage.setItem(confirmKey, JSON.stringify(confirmedList));
            }

            // ê¸°ì¡´ ê¸‰ì—¬ ì´ë ¥ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            const historyKey = `payrollHistory_${monthKey}`;
            let historyData = JSON.parse(localStorage.getItem(historyKey) || '{}');

            // ìµœì´ˆ ë“±ë¡ì¼ ë³´ì¡´
            const firstSavedDate = historyData.firstSavedDate || new Date().toISOString();

            // ê¸°ì¡´ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
            if (!historyData.data) {
                historyData = {
                    year: selectedYear,
                    month: selectedMonth,
                    savedDate: new Date().toISOString(),
                    firstSavedDate: firstSavedDate,
                    data: [],
                    confirmedEmployees: confirmedList
                };
            }

            // í˜„ì¬ ì§ì›ì˜ ê¸‰ì—¬ ë°ì´í„° ê³„ì‚°
            const currentPayroll = calculateEmployeePayroll(currentEmployeeId, selectedYear, selectedMonth);
            if (currentPayroll) {
                // ê¸°ì¡´ ë°ì´í„°ì—ì„œ í˜„ì¬ ì§ì› ì œê±° (ì¤‘ë³µ ë°©ì§€)
                historyData.data = historyData.data.filter(d => d.employeeId !== currentEmployeeId);

                // ìƒˆ ë°ì´í„° ì¶”ê°€
                historyData.data.push({
                    employeeId: currentEmployeeId,
                    id: currentEmployeeId,
                    name: emp.name,
                    ...currentPayroll
                });
            }

            // í™•ì • ëª©ë¡ ì—…ë°ì´íŠ¸
            historyData.confirmedEmployees = confirmedList;
            historyData.savedDate = new Date().toISOString();
            historyData.firstSavedDate = firstSavedDate;  // ìµœì´ˆ ë“±ë¡ì¼ ìœ ì§€

            // ì €ì¥
            localStorage.setItem(historyKey, JSON.stringify(historyData));

            // payrollHistoryListì—ë„ ì¶”ê°€ (ë©”ì¸ í˜ì´ì§€ì—ì„œ ì¸ì‹í•˜ë„ë¡)
            let historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            const existingIndex = historyList.findIndex(h => h.year === selectedYear && h.month === selectedMonth);

            const listItem = {
                year: selectedYear,
                month: selectedMonth,
                savedDate: historyData.savedDate
            };

            if (existingIndex >= 0) {
                // ê¸°ì¡´ í•­ëª© ì—…ë°ì´íŠ¸
                historyList[existingIndex] = listItem;
            } else {
                // ìƒˆ í•­ëª© ì¶”ê°€
                historyList.push(listItem);
            }

            localStorage.setItem('payrollHistoryList', JSON.stringify(historyList));

            // í™•ì • ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            updateConfirmStatus();

            alert(`âœ… ${emp.name} ì§ì›ì˜ ${selectedYear}ë…„ ${selectedMonth}ì›” ë°ì´í„°ê°€ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\n\në©”ì¸ í˜ì´ì§€ì— í‘œì‹œë©ë‹ˆë‹¤.`);
        }

        // í™•ì • ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateConfirmStatus() {
            if (!currentEmployeeId || !selectedYear || !selectedMonth) {
                document.getElementById('confirmStatus').style.display = 'none';
                return;
            }

            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            const confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
            const statusDiv = document.getElementById('confirmStatus');

            if (confirmedList.includes(currentEmployeeId)) {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = 'âœ… í™•ì •ë¨';
                statusDiv.style.background = 'rgba(76, 175, 80, 0.3)';
            } else {
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = 'âš ï¸ ë¯¸í™•ì •';
                statusDiv.style.background = 'rgba(255, 152, 0, 0.3)';
            }
        }

        // í˜„ì¬ ì„ íƒëœ ë…„ì›”ì˜ ê¸‰ì—¬ë¥¼ ë©”ì¸ í˜ì´ì§€ì— ë“±ë¡ (ì „ì²´ ì €ì¥ìš©)
        function saveCurrentMonthPayroll() {
            console.log('=== saveCurrentMonthPayroll ì‹œì‘ ===');
            console.log('selectedYear:', selectedYear);
            console.log('selectedMonth:', selectedMonth);

            if (!selectedYear || !selectedMonth) {
                alert('âš ï¸ ë…„ì›”ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            const payrollData = calculateAllEmployeesPayroll(selectedYear, selectedMonth);
            console.log('payrollData:', payrollData);

            if (payrollData.length === 0) {
                alert('âš ï¸ ì €ì¥í•  ê¸‰ì—¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì§ì›ì„ ì„ íƒí•˜ê³  ê·¼ë¬´ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            // ì´ë ¥ ë°ì´í„° ì €ì¥
            const historyKey = `payrollHistory_${selectedYear}_${selectedMonth}`;

            // ê¸°ì¡´ ë°ì´í„° í™•ì¸ (ìµœì´ˆ ë“±ë¡ì¼ê³¼ í™•ì • ëª©ë¡ ë³´ì¡´)
            const existingData = JSON.parse(localStorage.getItem(historyKey) || 'null');
            const firstSavedDate = existingData && existingData.firstSavedDate
                ? existingData.firstSavedDate
                : new Date().toISOString();

            // í™•ì • ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            const confirmedEmployees = JSON.parse(localStorage.getItem(confirmKey) || '[]');

            const historyData = {
                year: selectedYear,
                month: selectedMonth,
                savedDate: new Date().toISOString(),
                firstSavedDate: firstSavedDate,  // ìµœì´ˆ ë“±ë¡ì¼ ë³´ì¡´
                confirmedEmployees: confirmedEmployees,  // í™•ì • ì§ì› ëª©ë¡ ì €ì¥
                data: payrollData
            };

            console.log('historyKey:', historyKey);
            console.log('historyData:', historyData);

            localStorage.setItem(historyKey, JSON.stringify(historyData));
            console.log('localStorageì— ì €ì¥ë¨:', localStorage.getItem(historyKey));

            // ì´ë ¥ ëª©ë¡ ì—…ë°ì´íŠ¸
            let historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            console.log('ê¸°ì¡´ historyList:', historyList);

            const existingIndex = historyList.findIndex(h => h.year === selectedYear && h.month === selectedMonth);

            if (existingIndex >= 0) {
                historyList[existingIndex] = { year: selectedYear, month: selectedMonth, savedDate: historyData.savedDate };
            } else {
                historyList.push({ year: selectedYear, month: selectedMonth, savedDate: historyData.savedDate });
            }

            // ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬
            historyList.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });

            console.log('ì—…ë°ì´íŠ¸ëœ historyList:', historyList);
            localStorage.setItem('payrollHistoryList', JSON.stringify(historyList));
            console.log('ì €ì¥ëœ payrollHistoryList:', localStorage.getItem('payrollHistoryList'));

            alert(`âœ… ${selectedYear}ë…„ ${selectedMonth}ì›” ê¸‰ì—¬ê°€ ë©”ì¸ í˜ì´ì§€ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nì§ì› ìˆ˜: ${payrollData.length}ëª…\nì´ê¸‰ì—¬: ${formatNumber(payrollData.reduce((sum, d) => sum + d.totalSalary, 0))}Ä‘\n\në©”ì¸ í˜ì´ì§€(index.html)ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);

            console.log('=== saveCurrentMonthPayroll ì™„ë£Œ ===');
        }

        // ê¸‰ì—¬ ì´ë ¥ ì¡°íšŒ
        function viewPayrollHistory() {
            const historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');

            if (historyList.length === 0) {
                alert('ì €ì¥ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let message = 'ğŸ“‹ ê¸‰ì—¬ ì´ë ¥ ëª©ë¡\n\n';
            historyList.forEach((h, index) => {
                const savedDate = new Date(h.savedDate).toLocaleString('ko-KR');
                message += `${index + 1}. ${h.year}ë…„ ${h.month}ì›” (ì €ì¥: ${savedDate})\n`;
            });

            message += '\nì¡°íšŒí•  ì´ë ¥ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì·¨ì†Œ: 0):';

            const input = prompt(message);
            if (!input || input === '0') return;

            const selectedIndex = parseInt(input) - 1;
            if (selectedIndex < 0 || selectedIndex >= historyList.length) {
                alert('ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.');
                return;
            }

            const selected = historyList[selectedIndex];
            document.getElementById('payrollYear').value = selected.year;
            document.getElementById('payrollMonth').value = selected.month;
            refreshPayrollTable();

            alert(`âœ… ${selected.year}ë…„ ${selected.month}ì›” ì´ë ¥ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        }

        // ì§ì›ë³„ ì—°ê°„ ëˆ„ì  ê¸‰ì—¬ ê³„ì‚°
        function calculateYearlyAccumulation(employeeId) {
            const year = parseInt(document.getElementById('payrollYear').value);
            const currentMonth = parseInt(document.getElementById('payrollMonth').value);

            let yearlyTotal = {
                totalSalary: 0,
                deductions: 0,
                incomeTax: 0,
                netSalary: 0,
                months: []
            };

            // 1ì›”ë¶€í„° í˜„ì¬ ì›”ê¹Œì§€ ê³„ì‚°
            for (let month = 1; month <= currentMonth; month++) {
                const payroll = calculateEmployeePayroll(employeeId, year, month);
                if (payroll) {
                    yearlyTotal.totalSalary += payroll.totalSalary;
                    yearlyTotal.deductions += payroll.deductions;
                    yearlyTotal.incomeTax += payroll.incomeTax;
                    yearlyTotal.netSalary += payroll.netSalary;
                    yearlyTotal.months.push({
                        month: month,
                        ...payroll
                    });
                }
            }

            return yearlyTotal;
        }

        // ì—°ê°„ ëˆ„ì  ìƒì„¸ ë³´ê¸°
        function viewYearlyAccumulation(employeeId) {
            const emp = employees[employeeId];
            if (!emp) return;

            const yearly = calculateYearlyAccumulation(employeeId);
            const year = parseInt(document.getElementById('payrollYear').value);
            const currentMonth = parseInt(document.getElementById('payrollMonth').value);

            let message = `ğŸ“Š ${emp.name} - ${year}ë…„ ì—°ê°„ ëˆ„ì  (1ì›”~${currentMonth}ì›”)\n`;
            message += 'â”'.repeat(50) + '\n\n';

            // ì›”ë³„ ìƒì„¸
            message += 'ğŸ“… ì›”ë³„ ë‚´ì—­:\n';
            yearly.months.forEach(m => {
                message += `${m.month}ì›”: ${formatNumber(m.netSalary)}Ä‘ (ì´ê¸‰ì—¬: ${formatNumber(m.totalSalary)}Ä‘)\n`;
            });

            message += '\n' + 'â”'.repeat(50) + '\n';
            message += `ğŸ’° ì—°ê°„ ì´ ê¸‰ì—¬: ${formatNumber(yearly.totalSalary)}Ä‘\n`;
            message += `ğŸ”» ì—°ê°„ ë³´í—˜ë£Œ: ${formatNumber(yearly.deductions)}Ä‘\n`;
            message += `ğŸ”» ì—°ê°„ ì†Œë“ì„¸: ${formatNumber(yearly.incomeTax)}Ä‘\n`;
            message += `âœ… ì—°ê°„ ì‹¤ìˆ˜ë ¹ì•¡: ${formatNumber(yearly.netSalary)}Ä‘\n\n`;

            // ì›” í‰ê· 
            const avgNet = Math.round(yearly.netSalary / yearly.months.length);
            message += `ğŸ“ˆ ì›” í‰ê·  ì‹¤ìˆ˜ë ¹ì•¡: ${formatNumber(avgNet)}Ä‘`;

            alert(message);
        }

        // ==================== PDF ë° ë°±ì—… ê¸°ëŠ¥ ====================

        // ê°œì¸ ê¸‰ì—¬ëª…ì„¸ì„œ PDF ì¶œë ¥ (ê°œì„ ëœ ë²„ì „)
        function printCurrentEmployeePDF() {
            if (!currentEmployeeId) {
                alert('âš ï¸ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            const emp = employees[currentEmployeeId];
            if (!emp) {
                alert('âš ï¸ ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            // ê³„ì‚° ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
            const hourlyRate = emp.basicSalary / 208;
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const normalPay = hourlyRate * normalHours;

            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;

            const overtimePay = hourlyRate * overtimeHours * 1.5;
            const nightPay = hourlyRate * nightHours * 1.3;
            const sundayPay = hourlyRate * sundayHours * 2.0;

            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;

            // ë™ì  ìˆ˜ë‹¹ ì‹œìŠ¤í…œ ì‚¬ìš©
            const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;
            const allowances = (window.companySettings && window.companySettings.allowances) || [];

            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

            const socialIns = emp.basicSalary * 0.08;
            const healthIns = emp.basicSalary * 0.015;
            const unemployIns = emp.basicSalary * 0.01;
            const totalDeduction = socialIns + healthIns + unemployIns;

            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                + dynamicAllowancesTotal - totalDeduction;
            const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            let incomeTax = 0;
            let remainingBase = taxBase;
            const tiers = [[5000000, 0.05], [5000000, 0.10], [8000000, 0.15], [14000000, 0.20], [20000000, 0.25], [28000000, 0.30], [Infinity, 0.35]];

            for (const [limit, rate] of tiers) {
                if (remainingBase <= 0) break;
                const tier = Math.min(remainingBase, limit);
                incomeTax += tier * rate;
                remainingBase -= tier;
            }

            const netSalary = totalSalary - totalDeduction - incomeTax;

            // ë¹„ê³¼ì„¸ ê¸ˆì•¡ ê³„ì‚°
            const taxFreeMeal = mealAllowance;
            const taxFreeOvertime = overtimePay * 1/3;
            const taxFreeSunday = sundayPay * 1/2;
            const totalTaxFree = taxFreeMeal + taxFreeOvertime + taxFreeSunday;

            // jsPDF ìƒì„±
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 15;

            // ========== 0. íšŒì‚¬ ë¡œê³  ë° ì •ë³´ ==========
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];

                // íšŒì‚¬ ë¡œê³  ì¶”ê°€ (ìˆëŠ” ê²½ìš°)
                if (company.logo) {
                    try {
                        // ë¡œê³ ë¥¼ PDFì— ì¶”ê°€ (ì™¼ìª½ ìƒë‹¨)
                        doc.addImage(company.logo, 'PNG', 15, yPos, 30, 30);
                    } catch (e) {
                        console.log('Logo could not be added to PDF:', e);
                    }
                }

                // íšŒì‚¬ ì •ë³´ ì¶”ê°€ (ë¡œê³  ì˜¤ë¥¸ìª½)
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text(company.name || 'Company Name', 50, yPos + 8);

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                if (company.address) {
                    doc.text(company.address, 50, yPos + 15);
                }
                if (company.contact) {
                    doc.text(company.contact, 50, yPos + 20);
                }

                yPos += 35; // íšŒì‚¬ ì •ë³´ ì˜ì—­ í™•ë³´
            }

            // ========== 1. ì‹¤ìˆ˜ë ¹ì•¡ í—¤ë” (ë§¨ ìœ„ì— í¬ê²Œ!) ==========
            doc.setFillColor(76, 175, 80);
            doc.rect(0, yPos, 210, 28, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('NET SALARY / LUONG THUC LINH', 105, yPos + 8, { align: 'center' });

            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text(formatNumber(Math.round(netSalary)) + ' VND', 105, yPos + 18, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${selectedYear}.${String(selectedMonth).padStart(2, '0')} | ${emp.name}`, 105, yPos + 24, { align: 'center' });

            yPos += 35;

            // ========== 2. ê¸‰ì—¬ ìš”ì•½ ë°•ìŠ¤ ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY / TOM TAT', 20, yPos);

            yPos += 2;
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.rect(20, yPos, 170, 26);

            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Total Salary / Tong luong', 25, yPos);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(33, 150, 243);
            doc.text('+' + formatNumber(Math.round(totalSalary)), 185, yPos, { align: 'right' });

            yPos += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.text('Total Deduction / Tong tru', 25, yPos);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(244, 67, 54);
            doc.text('-' + formatNumber(Math.round(totalDeduction + incomeTax)), 185, yPos, { align: 'right' });

            yPos += 2;
            doc.setDrawColor(200, 200, 200);
            doc.line(25, yPos, 185, yPos);

            yPos += 6;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('Net Salary / Thuc linh', 25, yPos);
            doc.setTextColor(76, 175, 80);
            doc.text('=' + formatNumber(Math.round(netSalary)), 185, yPos, { align: 'right' });

            yPos += 12;

            // ========== 3. ìˆ˜ì… ë‚´ì—­ (EARNINGS) ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('EARNINGS / THU NHAP', 20, yPos);

            yPos += 2;

            const earningsData = [];

            if (normalPay > 0) {
                earningsData.push(['Regular Pay / Luong co ban', normalHours + 'h', formatNumber(Math.round(normalPay))]);
            }
            if (overtimePay > 0) {
                earningsData.push(['Overtime 1.5x / Tang ca 1.5x', overtimeHours + 'h', formatNumber(Math.round(overtimePay))]);
            }
            if (nightPay > 0) {
                earningsData.push(['Night Shift 1.3x / Ca dem 1.3x', nightHours + 'h', formatNumber(Math.round(nightPay))]);
            }
            if (sundayPay > 0) {
                earningsData.push(['Sunday 2.0x / Chu nhat 2.0x', sundayHours + 'h', formatNumber(Math.round(sundayPay))]);
            }

            doc.autoTable({
                startY: yPos,
                body: earningsData,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 100, fontStyle: 'normal' },
                    1: { cellWidth: 25, halign: 'center', textColor: [100, 100, 100] },
                    2: { cellWidth: 45, halign: 'right', fontStyle: 'bold' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            // ë¹„ê³¼ì„¸ í•­ëª©
            doc.setFillColor(255, 249, 196);
            doc.rect(20, yPos, 170, 6, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(230, 126, 0);
            doc.text('Meal (Tax-Free) / Tien an (mien thue)', 25, yPos + 4);
            doc.setFont('helvetica', 'bold');
            doc.text(formatNumber(Math.round(mealAllowance)), 185, yPos + 4, { align: 'right' });

            yPos += 8;

            // ë™ì  ìˆ˜ë‹¹ í‘œì‹œ (ì „ì—­ ë³€ìˆ˜ currentAllowanceDetails ì‚¬ìš©)
            if (dynamicAllowancesTotal > 0 && typeof currentAllowanceDetails !== 'undefined') {
                const allowanceData = [];
                allowances.forEach(allowance => {
                    if (allowance.enabled) {
                        const amount = currentAllowanceDetails[allowance.id] || 0;
                        if (amount > 0) {
                            allowanceData.push([allowance.name, '', formatNumber(Math.round(amount))]);
                        }
                    }
                });

                if (allowanceData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        body: allowanceData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: {
                            0: { cellWidth: 100, fontStyle: 'normal' },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 45, halign: 'right', fontStyle: 'bold' }
                        }
                    });
                    yPos = doc.lastAutoTable.finalY + 2;
                }
            }

            yPos += 3;

            // ========== 4. ê³µì œ ë‚´ì—­ (DEDUCTIONS) ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('DEDUCTIONS / KHAU TRU', 20, yPos);

            yPos += 2;

            const deductionsData = [
                ['Insurance / Bao hiem (8% + 1.5% + 1%)', '', formatNumber(Math.round(totalDeduction))],
                ['  - Social Insurance / BHXH (8%)', '', formatNumber(Math.round(socialIns))],
                ['  - Health Insurance / BHYT (1.5%)', '', formatNumber(Math.round(healthIns))],
                ['  - Unemployment / BHTN (1%)', '', formatNumber(Math.round(unemployIns))],
                ['Income Tax / Thue TNCN', '', formatNumber(Math.round(incomeTax))]
            ];

            doc.autoTable({
                startY: yPos,
                body: deductionsData,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 100, fontStyle: 'normal', textColor: [100, 100, 100] },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 45, halign: 'right', fontStyle: 'bold', textColor: [244, 67, 54] }
                },
                didParseCell: function(data) {
                    if (data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                }
            });

            yPos = doc.lastAutoTable.finalY + 8;

            // ========== 5. ë¹„ê³¼ì„¸ ìš”ì•½ ==========
            doc.setFillColor(232, 245, 233);
            doc.rect(20, yPos, 170, 16, 'F');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('TAX-FREE SUMMARY / TOM TAT MIEN THUE', 25, yPos + 5);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            yPos += 9;
            doc.text(`Meal 100%: ${formatNumber(Math.round(taxFreeMeal))}  |  Overtime 33%: ${formatNumber(Math.round(taxFreeOvertime))}  |  Sunday 50%: ${formatNumber(Math.round(taxFreeSunday))}`, 25, yPos);

            doc.setFont('helvetica', 'bold');
            yPos += 4;
            doc.text(`Total Tax-Free / Tong mien thue: ${formatNumber(Math.round(totalTaxFree))} VND`, 25, yPos);

            yPos += 10;

            // ========== 6. ì§ì› ì •ë³´ ==========
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, 190, yPos);
            yPos += 6;

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Employee / Nhan vien: ${emp.name}  |  Hire Date / Ngay vao: ${emp.hireDate || 'N/A'}  |  Dependents / Nguoi phu thuoc: ${emp.dependents || 0}`, 20, yPos);
            yPos += 4;
            doc.text(`Basic Salary / Luong co ban: ${formatNumber(emp.basicSalary)} VND  |  Hourly Rate / Gio: ${formatNumber(Math.round(hourlyRate))} VND`, 20, yPos);

            yPos += 10;

            // ========== 7. ì„œëª…ë€ ==========
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, 190, yPos);
            yPos += 8;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text('Employee Signature / Chu ky NV', 40, yPos);
            doc.text('Manager Signature / Chu ky quan ly', 130, yPos);

            yPos += 15;
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Issued / Ngay phat hanh: ' + new Date().toLocaleDateString('vi-VN'), 105, yPos, { align: 'center' });

            // PDF ì €ì¥
            doc.save(`PaySlip_${emp.name}_${selectedYear}_${String(selectedMonth).padStart(2, '0')}.pdf`);
            alert(`âœ… ${emp.name} ê¸‰ì—¬ëª…ì„¸ì„œ PDFê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ê°œì¸ ê¸‰ì—¬ëª…ì„¸ì„œ ì—‘ì…€ ì¶œë ¥
        function exportCurrentEmployeeExcel() {
            if (!currentEmployeeId) {
                alert('âš ï¸ ì§ì›ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!');
                return;
            }

            const emp = employees[currentEmployeeId];
            if (!emp) {
                alert('âš ï¸ ì§ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }

            // ê³„ì‚° ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
            const hourlyRate = emp.basicSalary / 208;
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const normalPay = hourlyRate * normalHours;

            const overtimePay = hourlyRate * (parseFloat(document.getElementById('overtimeHours').value) || 0) * 1.5;
            const nightPay = hourlyRate * (parseFloat(document.getElementById('nightHours').value) || 0) * 1.3;
            const sundayPay = hourlyRate * (parseFloat(document.getElementById('sundayHours').value) || 0) * 2.0;

            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;

            // ë™ì  ìˆ˜ë‹¹ ì´ì•¡ ë° ê°œë³„ ìˆ˜ë‹¹ ê°€ì ¸ì˜¤ê¸°
            const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            const enabledAllowances = allowances.filter(a => a.enabled);

            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

            const socialIns = emp.basicSalary * 0.08;
            const healthIns = emp.basicSalary * 0.015;
            const unemployIns = emp.basicSalary * 0.01;
            const totalDeduction = socialIns + healthIns + unemployIns;

            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                + dynamicAllowancesTotal - totalDeduction;
            const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            let incomeTax = 0;
            let remainingBase = taxBase;
            const tiers = [[5000000, 0.05], [5000000, 0.10], [8000000, 0.15], [14000000, 0.20], [20000000, 0.25], [28000000, 0.30], [Infinity, 0.35]];

            for (const [tier_limit, rate] of tiers) {
                if (remainingBase <= 0) break;
                const tier = Math.min(remainingBase, tier_limit);
                incomeTax += tier * rate;
                remainingBase -= tier;
            }

            const netSalary = totalSalary - totalDeduction - incomeTax;

            // ì—‘ì…€ ë°ì´í„° ìƒì„±
            const wb = XLSX.utils.book_new();

            const data = [
                ['ê¸‰ì—¬ëª…ì„¸ì„œ / SALARY STATEMENT'],
                [`${selectedYear}ë…„ ${selectedMonth}ì›”`],
                [],
                ['ì§ì› ì •ë³´ / Employee Information'],
                ['ì´ë¦„ / Name', emp.name],
                ['ì…ì‚¬ì¼ / Hire Date', emp.hireDate || 'N/A'],
                ['ë¶€ì–‘ê°€ì¡± / Dependents', emp.dependents || 0],
                [],
                ['ê¸‰ì—¬ ë‚´ì—­ / Salary Details', 'ê¸ˆì•¡ / Amount (VND)'],
                ['ê¸°ë³¸ê¸‰ / Basic Salary', Math.round(emp.basicSalary)],
                ['ì‹œê¸‰ / Hourly Rate', Math.round(hourlyRate)],
                ['ì •ê·œ ê·¼ë¬´ì‹œê°„ / Regular Hours', normalHours + 'h'],
                ['ì •ê·œ ê¸‰ì—¬ / Regular Pay', Math.round(normalPay)],
                ['ì•¼ê·¼ ìˆ˜ë‹¹ (1.5x) / Overtime Pay', Math.round(overtimePay)],
                ['ì•¼ê°„ ìˆ˜ë‹¹ (1.3x) / Night Pay', Math.round(nightPay)],
                ['ì¼ìš”ì¼ íŠ¹ê·¼ (2.0x) / Sunday Pay', Math.round(sundayPay)],
                ['ì‹ëŒ€ / Meal Allowance', Math.round(mealAllowance)]
            ];

            // ë™ì  ìˆ˜ë‹¹ ì¶”ê°€ (ê¸ˆì•¡ì´ 0ë³´ë‹¤ í° ê²ƒë§Œ)
            enabledAllowances.forEach(allowance => {
                const amount = currentAllowanceDetails[allowance.id] || 0;
                if (amount > 0) {  // 0ì›ì¸ ìˆ˜ë‹¹ì€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                    data.push([`${allowance.name} / ${allowance.name}`, Math.round(amount)]);
                }
            });

            data.push(
                [],
                ['ì´ ê¸‰ì—¬ / Total Salary', Math.round(totalSalary)],
                [],
                ['ê³µì œ ë‚´ì—­ / Deductions', 'ê¸ˆì•¡ / Amount (VND)'],
                ['ì‚¬íšŒë³´í—˜ (8%) / Social Insurance', Math.round(socialIns)],
                ['ê±´ê°•ë³´í—˜ (1.5%) / Health Insurance', Math.round(healthIns)],
                ['ì‹¤ì—…ë³´í—˜ (1%) / Unemployment Insurance', Math.round(unemployIns)],
                ['ì´ ê³µì œì•¡ / Total Deductions', Math.round(totalDeduction)],
                [],
                ['ì„¸ê¸ˆ ê³„ì‚° / Tax Calculation', 'ê¸ˆì•¡ / Amount (VND)'],
                ['ê³¼ì„¸ ì†Œë“ / Taxable Income', Math.round(taxableIncome)],
                ['ê°€ì¡± ê³µì œ / Family Deduction', Math.round(totalFamilyDeduction)],
                ['ê³¼ì„¸ í‘œì¤€ / Tax Base', Math.round(taxBase)],
                ['ê°œì¸ì†Œë“ì„¸ / Income Tax', Math.round(incomeTax)],
                [],
                ['ì‹¤ìˆ˜ë ¹ì•¡ / Net Salary', Math.round(netSalary)]
            );

            const ws = XLSX.utils.aoa_to_sheet(data);

            // ì—´ ë„ˆë¹„ ì„¤ì •
            ws['!cols'] = [
                { wch: 35 },
                { wch: 20 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, 'ê¸‰ì—¬ëª…ì„¸ì„œ');
            XLSX.writeFile(wb, `ê¸‰ì—¬ëª…ì„¸ì„œ_${emp.name}_${selectedYear}_${selectedMonth}.xlsx`);

            alert(`âœ… ${emp.name} ê¸‰ì—¬ëª…ì„¸ì„œ ì—‘ì…€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
        }

        // ì „ì²´ ë°ì´í„° ë°±ì—…
        function backupAllData() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                employees: employees,
                companySettings: companySettings,
                payrollHistoryList: JSON.parse(localStorage.getItem('payrollHistoryList') || '[]')
            };

            // ëª¨ë“  ê¸‰ì—¬ ì´ë ¥ë„ ë°±ì—…
            const historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            const payrollHistories = {};

            historyList.forEach(h => {
                const key = `payrollHistory_${h.year}_${h.month}`;
                const data = localStorage.getItem(key);
                if (data) {
                    payrollHistories[key] = JSON.parse(data);
                }
            });

            backupData.payrollHistories = payrollHistories;

            // JSON íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `ê¸‰ì—¬ì‹œìŠ¤í…œ_ë°±ì—…_${dateStr}.json`;
            link.click();

            URL.revokeObjectURL(url);

            alert(`âœ… ì „ì²´ ë°ì´í„° ë°±ì—… ì™„ë£Œ!\n\nì§ì›: ${Object.keys(employees).length}ëª…\nê¸‰ì—¬ ì´ë ¥: ${historyList.length}ê°œì›”\n\níŒŒì¼ëª…: ê¸‰ì—¬ì‹œìŠ¤í…œ_ë°±ì—…_${dateStr}.json`);
        }

        // ë°±ì—… íŒŒì¼ ë³µì› (íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°)
        function restoreAllData() {
            if (!confirm('âš ï¸ ë°±ì—… íŒŒì¼ì„ ë³µì›í•˜ë©´ í˜„ì¬ ë°ì´í„°ê°€ ëª¨ë‘ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            document.getElementById('backupFileInput').click();
        }

        // ë°±ì—… íŒŒì¼ ë³µì› ì²˜ë¦¬
        function handleBackupRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                    if (!backupData.version || !backupData.employees) {
                        throw new Error('ì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }

                    // ì§ì› ë°ì´í„° ë³µì›
                    employees = backupData.employees;
                    localStorage.setItem('vietnamPayrollEmployees', JSON.stringify(employees));

                    // íšŒì‚¬ ì„¤ì • ë³µì›
                    if (backupData.companySettings) {
                        companySettings = backupData.companySettings;
                        // ëª¨ë“  ì—°ë„ë³„ ì„¤ì • ì €ì¥
                        for (let year = 2024; year <= 2030; year++) {
                            localStorage.setItem(`vietnamPayrollSettings_${year}`, JSON.stringify(companySettings));
                        }
                    }

                    // ê¸‰ì—¬ ì´ë ¥ ë³µì›
                    if (backupData.payrollHistoryList) {
                        localStorage.setItem('payrollHistoryList', JSON.stringify(backupData.payrollHistoryList));
                    }

                    if (backupData.payrollHistories) {
                        for (const key in backupData.payrollHistories) {
                            localStorage.setItem(key, JSON.stringify(backupData.payrollHistories[key]));
                        }
                    }

                    // UI ì—…ë°ì´íŠ¸
                    updateEmployeeSelect();

                    const exportDateStr = backupData.exportDate ? new Date(backupData.exportDate).toLocaleString('ko-KR') : 'ì•Œ ìˆ˜ ì—†ìŒ';
                    alert(`âœ… ë°±ì—… ë°ì´í„° ë³µì› ì™„ë£Œ!\n\në°±ì—… ì¼ì‹œ: ${exportDateStr}\nì§ì›: ${Object.keys(employees).length}ëª…\nê¸‰ì—¬ ì´ë ¥: ${backupData.payrollHistoryList ? backupData.payrollHistoryList.length : 0}ê°œì›”\n\ní˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.`);

                    location.reload();
                } catch (error) {
                    alert('âš ï¸ ë°±ì—… íŒŒì¼ ë³µì› ì‹¤íŒ¨: ' + error.message);
                }
            };
            reader.readAsText(file);

            // íŒŒì¼ ì„ íƒ ì´ˆê¸°í™”
            event.target.value = '';
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.onload = init;

        // Load and display company profile
        function loadCompanyProfile() {
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            const companyHeaderDiv = document.getElementById('companyHeader');
            const systemSubtitle = document.getElementById('systemSubtitle');

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];

                // Build company header HTML
                let headerHTML = '';

                if (company.logo) {
                    headerHTML += `<img src="${company.logo}" alt="${company.name}" class="company-logo">`;
                }

                headerHTML += `
                    <div class="company-info">
                        <div class="company-name">${company.name}</div>
                        ${company.address ? `<div class="company-address">ğŸ“ ${company.address}</div>` : ''}
                    </div>
                `;

                companyHeaderDiv.innerHTML = headerHTML;

                // Update subtitle with Vietnamese name if available
                if (company.nameVN) {
                    systemSubtitle.textContent = company.nameVN + ' - ê¸‰ì—¬ ê³„ì‚°ê¸°';
                }

                // Apply company color theme
                if (company.color) {
                    const style = document.createElement('style');
                    style.textContent = `
                        body {
                            background: linear-gradient(135deg, ${company.color} 0%, #764ba2 100%) !important;
                        }
                        .modern-header h1 {
                            color: ${company.color} !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // Load company profile on page load
        document.addEventListener('DOMContentLoaded', loadCompanyProfile);
    </script>

    </div> <!-- modern-content-wrapper ë‹«ê¸° -->
    </div> <!-- container ë‹«ê¸° -->

    <!-- JavaScript ëª¨ë“ˆ ë¡œë“œ (ìˆœì„œ ì¤‘ìš”!) -->
    <!-- data-manager.jsëŠ” settings.htmlì—ì„œë§Œ ì‚¬ìš© (ë³€ìˆ˜ ì¶©ëŒ ë°©ì§€) -->
</body>
</html>