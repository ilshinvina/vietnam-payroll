<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>베트남 급여 계산기 - 급여 등록</title>

    <!-- SheetJS 라이브러리 -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- jsPDF 라이브러리 (PDF 생성) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- 스타일시트 -->
    <link rel="stylesheet" href="styles.css">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .modern-header {
            background: white;
            padding: 30px 40px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            position: relative;
        }

        .company-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .company-logo {
            max-width: 100px;
            max-height: 100px;
            object-fit: contain;
        }

        .company-info {
            text-align: left;
        }

        .company-name {
            font-size: 1.4em;
            color: #1a1a1a;
            font-weight: 900;
            margin-bottom: 5px;
            letter-spacing: -0.5px;
        }

        .company-address {
            font-size: 1em;
            color: #444;
            font-weight: 600;
            line-height: 1.6;
            white-space: pre-line;
            word-wrap: break-word;
            max-width: 600px;
        }

        .modern-header h1 {
            font-size: 2em;
            color: #667eea;
            margin: 0;
        }

        .modern-header p {
            color: #999;
            margin: 5px 0 0 0;
        }

        .btn-home-modern {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
        }

        .btn-home-modern:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .modern-content-wrapper {
            background: white;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 0;
        }

        .action-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.15);
        }

        .modern-btn {
            transition: all 0.3s ease;
        }

        .modern-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1600px; margin: 0 auto;">
        <div class="modern-header">
            <div>
                <div class="company-header" id="companyHeader">
                    <!-- Company logo and info will be loaded here -->
                </div>
                <h1 style="font-size: 2.2em; font-weight: 800; color: #667eea;">급여 계산기 v2.0</h1>
                <p id="systemSubtitle" style="font-size: 1.1em; font-weight: 600; color: #555;">달력 기반 자동 계산 시스템</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="settings.html" class="btn-home-modern">⚙️ 설정</a>
                <a href="index.html" class="btn-home-modern">🏠 홈으로</a>
            </div>
        </div>

        <div class="modern-content-wrapper">

        <div class="main-content" style="padding: 30px 40px;">
            <!-- 입력 섹션 -->
            <div class="input-section">
                <!-- 상단 액션 카드 -->
                <div class="action-card">
                    <h2 class="section-title" style="color: #667eea;">👥 직원 선택</h2>

                    <div class="input-group">
                        <select id="employeeSelect" style="width: 100%; padding: 14px 16px; border-radius: 10px; border: 2px solid #e0e0e0; font-size: 1.1em; background: #fafafa; transition: all 0.3s;">
                            <option value="">-- 직원 선택 --</option>
                        </select>
                        <!-- 보험 미가입자 표시 -->
                        <div id="insuranceExemptBadge" style="display: none; margin-top: 10px; padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; border-left: 4px solid #2196f3;">
                            <span style="color: #1976d2; font-weight: bold; font-size: 1em;">🏥 사회보험 미가입자</span>
                            <p style="margin: 5px 0 0 0; color: #0277bd; font-size: 0.9em;">보험료(BHXH, BHYT, BHTN, 노조비)가 공제되지 않습니다</p>
                        </div>
                    </div>
                </div>

                <!-- ========== 데이터 관리 섹션 숨김 처리 (2025-12-08) ==========
                <div class="action-card">
                    <h3 style="color: #667eea; margin-bottom: 15px; font-size: 1.2em;">💾 데이터 관리</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;">
                        💡 직원 등록은 <a href="settings.html" style="color: #667eea; font-weight: bold;">⚙️ 설정 페이지</a>에서 하세요!
                    </p>

                    DAILY-REPORT 연동
                    <div style="margin-bottom: 15px; padding: 15px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); border-radius: 10px;">
                        <h4 style="color: white; margin-bottom: 10px; font-size: 1.1em;">📋 출근기록 불러오기</h4>
                        <input type="file" id="dailyReportExcelUpload" accept=".xlsx, .xls" onchange="importFromDailyReport(event)" style="display: none;">
                        <button onclick="document.getElementById('dailyReportExcelUpload').click()" class="modern-btn" style="width: 100%; padding: 12px; background: white; color: #11998e; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
                            📥 DAILY-REPORT 엑셀 불러오기
                        </button>
                        <p style="color: white; margin-top: 8px; font-size: 0.85em; margin-bottom: 0; opacity: 0.9;">
                            일일보고서 프로그램에서 내보낸 엑셀 파일을 불러와 야근/특근 시간을 자동 입력합니다
                        </p>
                    </div>

                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="printCurrentEmployeePDF()" class="modern-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(233, 30, 99, 0.3); font-size: 1.05em;">
                            📄 급여명세서 PDF
                        </button>
                        <button onclick="exportCurrentEmployeeExcel()" class="modern-btn" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.05em; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3);">
                            📊 급여명세서 엑셀
                        </button>
                    </div>

                    데이터 확정 버튼
                    <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);">
                        <button onclick="confirmCurrentEmployee()" class="modern-btn" style="width: 100%; padding: 16px; background: white; color: #667eea; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.2em; box-shadow: 0 4px 12px rgba(0,0,0,0.2); transition: all 0.3s;">
                            ✅ 현재 직원 데이터 확정
                        </button>
                        <p style="color: white; margin-top: 10px; font-size: 0.9em; text-align: center; margin-bottom: 0;">
                            확정된 직원만 메인 페이지에 표시됩니다!
                        </p>
                        <div id="confirmStatus" style="margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.2); border-radius: 6px; text-align: center; color: white; font-size: 0.9em; display: none;">
                            확정 상태 표시
                        </div>
                    </div>

                    이번 달 데이터 초기화 버튼
                    <div style="margin-top: 10px;">
                        <button onclick="clearCurrentMonthData()" class="modern-btn" style="width: 100%; padding: 12px; background: #e53935; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em; box-shadow: 0 4px 10px rgba(229, 57, 53, 0.3); transition: all 0.3s;">
                            🗑️ 이번 달 데이터 초기화
                        </button>
                        <p style="color: #666; margin-top: 5px; font-size: 0.85em; text-align: center; margin-bottom: 0;">
                            현재 직원의 이번 달 근태/잔업 데이터를 모두 삭제합니다
                        </p>
                    </div>

                    <div style="margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; font-size: 0.85em; color: #e65100;">
                        <div><strong>📄 개인 급여명세서:</strong> 현재 선택된 직원의 급여명세를 PDF로 출력</div>
                        <div style="margin-top: 5px;"><strong>💾 전체 데이터 백업:</strong> 모든 직원 정보 + 급여 이력을 JSON 파일로 저장 (컴퓨터 문제 대비)</div>
                    </div>
                </div>
                ========== 데이터 관리 섹션 끝 ========== -->

                <h2 class="section-title">📝 기본 정보</h2>

                <div class="input-group">
                    <label>직원 이름</label>
                    <input type="text" id="employeeName" placeholder="예: 응우옌 반 남">
                </div>

                <div class="input-group">
                    <label>기본급 (동/월)</label>
                    <input type="text" id="basicSalary" value="6,980,000" placeholder="6,980,000" oninput="formatMoneyInput(this); calculate();" onfocus="selectAllOnFocus(this)">
                </div>

                <div class="input-group">
                    <label>일일 식대 (동/일)</label>
                    <input type="text" id="dailyMeal" value="25,000" placeholder="25,000" oninput="formatMoneyInput(this); calculate();" onfocus="selectAllOnFocus(this)">
                    <div class="tip">※ 실근무일 × 일일식대로 자동 계산</div>
                </div>

                <div class="date-selector">
                    <div class="input-group">
                        <label>년도</label>
                        <select id="yearSelect"></select>
                    </div>
                    <div class="input-group">
                        <label>월</label>
                        <select id="monthSelect"></select>
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-title" id="calendarTitle">2025년 11월</div>
                    </div>
                    <div class="calendar-grid" id="calendar"></div>
                </div>

                <div class="stats-box">
                    <h3 style="color: #667eea; margin-bottom: 15px;">📊 근무 통계</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-label">총 일수</span>
                            <span class="stat-value" id="totalDays">30일</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">평일</span>
                            <span class="stat-value" id="weekdays">26일</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">일요일</span>
                            <span class="stat-value" id="weekends">4일</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">공휴일</span>
                            <span class="stat-value" id="holidays">0일</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #ab47bc;">
                            <span class="stat-label" style="color: #ab47bc;">사유결근</span>
                            <span class="stat-value" style="color: #ab47bc;" id="excusedAbsents">0일</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e53935;">
                            <span class="stat-label" style="color: #e53935;">⚠️ 무단결근</span>
                            <span class="stat-value" style="color: #e53935;" id="unexcusedAbsents">0일</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">🌴 연차 사용</span>
                            <span class="stat-value" style="color: #4caf50;" id="annualLeaveCount">0일</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">실 근무일</span>
                            <span class="stat-value" id="workDays">22일</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">정규시간</span>
                            <span class="stat-value" id="normalHours">176h</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e91e63;">
                            <span class="stat-label" style="color: #e91e63;">⏰ 총 야근</span>
                            <span class="stat-value" style="color: #e91e63;" id="totalOvertimeDisplay">0h</span>
                        </div>
                        <div class="stat-item" id="nightStatRow" style="border-left-color: #8e44ad; display: none;">
                            <span class="stat-label" style="color: #8e44ad;">🌙 총 야간</span>
                            <span class="stat-value" style="color: #8e44ad;" id="totalNightDisplay">0h</span>
                        </div>
                        <div class="stat-item" id="nightOTStatRow" style="border-left-color: #c2185b; display: none;">
                            <span class="stat-label" style="color: #c2185b;">🌙⏰ 야간OT</span>
                            <span class="stat-value" style="color: #c2185b;" id="totalNightOTDisplay">0h</span>
                        </div>
                        <div class="stat-item" style="border-left-color: #e53935;">
                            <span class="stat-label" style="color: #e53935;">🔥 총 특근</span>
                            <span class="stat-value" style="color: #e53935;" id="totalSundayDisplay">0h</span>
                        </div>
                        <div class="stat-item" style="background: #fff3e0; border-left-color: #ff9800;">
                            <span class="stat-label" style="color: #ff9800; font-weight: bold;">🍚 총 식대 = <span id="totalMealCount" style="font-size: 1.3em;">0식</span></span>
                            <span class="stat-value" style="color: #ff9800; font-weight: bold;" id="autoMeal">550,000đ</span>
                        </div>
                        <div class="stat-item" id="statsWeekdayLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 평일 점심</span>
                            <span class="stat-value" id="weekdayLunchCount">0식</span>
                        </div>
                        <div class="stat-item" id="statsWeekdayDinnerRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 평일 저녁 (야근)</span>
                            <span class="stat-value" id="weekdayDinnerCount">0식</span>
                        </div>
                        <div class="stat-item" id="statsSundayLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 일요일 점심</span>
                            <span class="stat-value" id="sundayLunchCount">0식</span>
                        </div>
                        <div class="stat-item" id="statsSundayDinnerRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 일요일 저녁</span>
                            <span class="stat-value" id="sundayDinnerCount">0식</span>
                        </div>
                        <div class="stat-item" id="statsAnnualLeaveLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 연차 점심</span>
                            <span class="stat-value" id="annualLeaveLunchCount">0식</span>
                        </div>
                        <div class="stat-item" id="statsExcusedAbsentLunchRow" style="font-size: 0.85em; padding: 5px 10px; background: #fffef7;">
                            <span class="stat-label" style="font-size: 0.9em;">└ 사유결근 점심</span>
                            <span class="stat-value" id="excusedAbsentLunchCount">0식</span>
                        </div>
                        <div class="stat-item" id="attendanceBonusContainer" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">🎁 개근수당</span>
                            <span class="stat-value" style="color: #4caf50;" id="attendanceBonus">0đ</span>
                        </div>
                        <div class="stat-item" id="transportBonusContainer" style="border-left-color: #4caf50;">
                            <span class="stat-label" style="color: #4caf50;">🚗 교통비</span>
                            <span class="stat-value" style="color: #4caf50;" id="transportBonus">0đ</span>
                        </div>
                        <!-- 동적 수당 목록 (설정에서 추가한 수당들) -->
                        <div id="dynamicAllowancesList" style="display: contents;">
                            <!-- JavaScript로 동적 생성 -->
                        </div>
                    </div>
                </div>

                <!-- 숨겨진 필드: 달력에서 자동 계산되어 채워짐 -->
                <input type="hidden" id="overtimeHours" value="0">
                <input type="hidden" id="nightHours" value="0">
                <input type="hidden" id="nightOTHours" value="0">
                <input type="hidden" id="sundayHours" value="0">
                <input type="hidden" id="totalAllowancesHidden" value="0">

                <div class="input-group" style="margin-top: 20px;">
                    <label>👨‍👩‍👧‍👦 부양가족 수 (명)</label>
                    <input type="number" id="dependents" value="0" min="0" step="1" placeholder="0">
                    <div class="tip">※ 본인 11,000,000đ + 부양가족 4,400,000đ/인</div>
                </div>

                <!-- 특수수당 체크박스 -->
                <div class="input-group" style="margin-top: 20px; background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #9c27b0;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="specialAllowanceEnabled" onchange="toggleSpecialAllowance()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="specialAllowanceEnabled" style="margin: 0; font-weight: bold; color: #9c27b0; font-size: 1.1em; cursor: pointer;">
                            💎 특수수당 (Phụ cấp đặc biệt)
                        </label>
                    </div>
                    <input type="text" id="specialAllowanceAmount" value="0" placeholder="0" disabled style="background: #f5f5f5;" oninput="formatMoneyInput(this); calculate();" onfocus="selectAllOnFocus(this)">
                    <div class="tip">※ 체크 시 입력한 금액이 총급여에 추가됩니다 (과세 처리)</div>
                </div>

                <!-- 선금 체크박스 -->
                <div class="input-group" style="margin-top: 15px; background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); padding: 20px; border-radius: 10px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <input type="checkbox" id="advancePaymentEnabled" onchange="toggleAdvancePayment()" style="width: 20px; height: 20px; cursor: pointer;">
                        <label for="advancePaymentEnabled" style="margin: 0; font-weight: bold; color: #ff9800; font-size: 1.1em; cursor: pointer;">
                            💰 선금 차감 (Ứng lương)
                        </label>
                    </div>
                    <input type="text" id="advancePaymentAmount" value="0" placeholder="0" disabled style="background: #f5f5f5;" oninput="formatMoneyInput(this); calculate();" onfocus="selectAllOnFocus(this)">
                    <div class="tip">※ 체크 시 입력한 금액이 실수령액에서 차감됩니다</div>
                </div>

                <!-- ========== 급여 계산 버튼 ========== -->
                <button class="btn-calculate" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); font-size: 1.3em; padding: 18px; box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);" onclick="calculate()">
                    📊 TÍNH LƯƠNG
                </button>
                
                <!-- ========== 확정 상태 표시 박스 ========== -->
                <div id="confirmStatusBox" style="margin-top: 15px; padding: 20px; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 3px solid #4caf50; border-radius: 12px; text-align: center; display: none;">
                    <div style="font-size: 2.5em; margin-bottom: 5px;">✅</div>
                    <div style="font-size: 1.3em; font-weight: bold; color: #2e7d32; margin-bottom: 5px;">ĐÃ XÁC NHẬN</div>
                    <div id="confirmDate" style="font-size: 0.95em; color: #558b2f;">11/2025 • 6/12/2025</div>
                </div>
                
                <!-- ========== 확정 / 삭제 버튼 ========== -->
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn-calculate" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1em; padding: 14px;" onclick="confirmCurrentEmployee()">
                        ✅ Xác nhận
                    </button>
                    <button class="btn-calculate" style="flex: 1; background: linear-gradient(135deg, #e53935 0%, #c62828 100%); font-size: 1.1em; padding: 14px;" onclick="deleteCurrentEmployee()">
                        🗑️ Xóa
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 8px; font-size: 0.85em; color: #666;">
                    <div>☑️ Xác nhận để hiển thị trên trang chủ | 🗑️ Xóa dữ liệu tháng này</div>
                </div>
                
                <!-- ========== 모바일 급여명세서 버튼 숨김 처리 ==========
                <button class="btn-calculate" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); margin-top: 10px;" onclick="openMobilePayslip()">📱 모바일 급여명세서</button>
                ========== 모바일 급여명세서 버튼 끝 ========== -->
            </div>

            <!-- 결과 섹션 -->
            <div class="result-section">
                <h2 class="section-title">📊 계산 결과</h2>
                
                <div id="employeeNameResult" style="font-size: 1.3em; color: #667eea; font-weight: bold; margin-bottom: 20px; text-align: center;">
                    직원 이름
                </div>

                <div class="result-box">
                    <h3 style="color: #667eea; margin-bottom: 15px;">💵 급여 상세</h3>
                    <div class="result-item">
                        <span class="result-label">시간당 급여</span>
                        <span class="result-value" id="hourlyRate">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">정규 근무</span>
                        <span class="result-value" id="normalPay">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">야근 수당 (150%)</span>
                        <span class="result-value" id="overtimePay">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">야간 수당 (130%)</span>
                        <span class="result-value" id="nightPay">0 đ</span>
                    </div>
                    <div class="result-item" id="nightOTPayRow" style="display: none;">
                        <span class="result-label" id="nightOTPayLabel">야간+OT 수당 (200%)</span>
                        <span class="result-value" id="nightOTPay" style="color: #c2185b;">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">일요일 수당 (200%)</span>
                        <span class="result-value" id="sundayPay">0 đ</span>
                    </div>
                    <!-- 급여 상세 합계 -->
                    <div class="result-item" style="border-top: 2px solid #667eea; padding-top: 15px; margin-top: 10px; background: #e8eaf6;">
                        <span class="result-label" style="color: #667eea; font-weight: bold; font-size: 1.1em;">💰 급여 상세 합계</span>
                        <span class="result-value" style="color: #667eea; font-size: 1.3em; font-weight: bold;" id="salaryDetailTotal">0 đ</span>
                    </div>
                </div>

                <div class="result-box" style="background: #f1f8f4; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">🌴 연차 현황</h3>
                    <div class="result-item">
                        <span class="result-label">올해 발생 연차</span>
                        <span class="result-value" id="annualLeaveTotal">12일</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">연차 조정</span>
                        <span class="result-value" id="annualLeavePreUsed">+0일</span>
                        <div style="font-size: 0.75em; color: #666; margin-top: 3px;">
                            💡 +숫자: 추가지급(이월) / -숫자: 이미사용
                        </div>
                    </div>
                    <div class="result-item" style="background: #c8e6c9;">
                        <span class="result-label">이번달 사용 연차</span>
                        <span class="result-value" style="color: #2e7d32;" id="annualLeaveThisMonth">0일</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #4caf50; padding-top: 10px; margin-top: 5px;">
                        <span class="result-label" style="font-weight: bold;">사용가능 연차</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.2em; font-weight: bold;" id="annualLeaveRemaining">12일</span>
                    </div>
                </div>

                <div class="result-box">
                    <h3 style="color: #28a745; margin-bottom: 15px;">🎁 자동 수당</h3>
                    <div class="result-item" style="background: #fff3e0; border-left: 3px solid #ff9800;">
                        <span class="result-label" style="color: #ff9800; font-weight: bold;">🍚 총 식대 = <span id="resultTotalMealCount" style="font-size: 1.3em;">0식</span></span>
                        <span class="result-value" style="color: #ff9800; font-weight: bold;" id="mealDisplay">0 đ</span>
                    </div>
                    <div class="result-item" id="resultWeekdayLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 평일 점심: <span id="resultWeekdayLunch">0식</span></span>
                        <span class="result-value" id="resultWeekdayLunchAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="resultWeekdayDinnerRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 평일 저녁 (야근): <span id="resultWeekdayDinner">0식</span></span>
                        <span class="result-value" id="resultWeekdayDinnerAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="resultSundayLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 일요일 점심: <span id="resultSundayLunch">0식</span></span>
                        <span class="result-value" id="resultSundayLunchAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="resultSundayDinnerRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 일요일 저녁: <span id="resultSundayDinner">0식</span></span>
                        <span class="result-value" id="resultSundayDinnerAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="resultAnnualLeaveLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 연차 점심: <span id="resultAnnualLeaveLunch">0식</span></span>
                        <span class="result-value" id="resultAnnualLeaveLunchAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="resultExcusedAbsentLunchRow" style="font-size: 0.85em; padding: 8px 12px; background: #fffef7; margin-left: 15px;">
                        <span class="result-label">└ 사유결근 점심: <span id="resultExcusedAbsentLunch">0식</span></span>
                        <span class="result-value" id="resultExcusedAbsentLunchAmount">0 đ</span>
                    </div>
                    <div class="result-item" id="attendanceBonusResultContainer" style="background: #e8f5e9;">
                        <span class="result-label">🎁 개근수당</span>
                        <span class="result-value" style="color: #4caf50;" id="attendanceBonusDisplay">0 đ</span>
                    </div>
                    <div class="result-item" id="transportBonusResultContainer" style="background: #e8f5e9;">
                        <span class="result-label">🚗 교통비</span>
                        <span class="result-value" style="color: #4caf50;" id="transportDisplay">0 đ</span>
                    </div>
                    <div class="result-item" id="riskDisplayResultContainer">
                        <span class="result-label">위험수당</span>
                        <span class="result-value" id="riskDisplay">100,000 đ</span>
                    </div>
                    <!-- 동적 수당 목록 (계산 결과) -->
                    <div id="resultDynamicAllowancesList">
                        <!-- JavaScript로 동적 생성 -->
                    </div>
                    <!-- 특수수당 -->
                    <div class="result-item" id="specialAllowanceResultContainer" style="display: none; border-top: 2px solid #9c27b0; padding-top: 10px; margin-top: 10px;">
                        <span class="result-label" style="color: #9c27b0; font-weight: bold;">💎 특수수당</span>
                        <span class="result-value" style="color: #9c27b0; font-weight: bold;" id="specialAllowanceResult">0 đ</span>
                    </div>
                    <!-- 수당 합계 -->
                    <div class="result-item" style="border-top: 2px solid #28a745; padding-top: 15px; margin-top: 10px; background: #d4edda;">
                        <span class="result-label" style="color: #28a745; font-weight: bold; font-size: 1.1em;">💵 수당 합계</span>
                        <span class="result-value" style="color: #28a745; font-size: 1.3em; font-weight: bold;" id="allowanceTotal">0 đ</span>
                    </div>
                </div>

                <div class="result-box" id="companyInsuranceBox">
                    <h3 style="color: #2196f3; margin-bottom: 15px;">🏢 회사 부담금 (참고용)</h3>
                    <div class="result-item">
                        <span class="result-label">BHXH | 사회보험 (17.5%)</span>
                        <span class="result-value" id="companySocialIns">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHYT | 건강보험 (3%)</span>
                        <span class="result-value" id="companyHealthIns">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHTN | 실업보험 (1%)</span>
                        <span class="result-value" id="companyUnemployIns">0 đ</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #2196f3; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #2196f3;">총 회사 부담 (21.5%)</span>
                        <span class="result-value" style="color: #2196f3; font-size: 1.2em;" id="totalCompanyIns">0 đ</span>
                    </div>
                </div>

                <!-- 보험 미가입자 표시 (숨김 기본값) -->
                <div class="result-box" id="insuranceExemptBox" style="display: none; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 5px solid #2196f3;">
                    <h3 style="color: #1976d2; margin-bottom: 15px;">🏥 사회보험 미가입</h3>
                    <div style="padding: 15px; background: white; border-radius: 8px;">
                        <p style="margin: 0; color: #0277bd; font-size: 1.1em; font-weight: bold;">이 직원은 사회보험 미가입자입니다</p>
                        <p style="margin: 10px 0 0 0; color: #555; font-size: 0.95em;">BHXH, BHYT, BHTN, 노조비가 공제되지 않습니다</p>
                    </div>
                </div>

                <div class="result-box" id="employeeInsuranceBox">
                    <h3 style="color: #f57c00; margin-bottom: 15px;">🏥 근로자 공제 (10.5%)</h3>
                    <div class="result-item">
                        <span class="result-label">BHXH | 사회보험 (8%)</span>
                        <span class="result-value" id="socialIns">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHYT | 건강보험 (1.5%)</span>
                        <span class="result-value" id="healthIns">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">BHTN | 실업보험 (1%)</span>
                        <span class="result-value" id="unemployIns">0 đ</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #f57c00; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #f57c00;">총 공제액</span>
                        <span class="result-value" style="color: #f57c00; font-size: 1.2em;" id="totalDeduction">0 đ</span>
                    </div>
                </div>

                <div class="result-box" id="incomeTaxBox">
                    <h3 style="color: #e91e63; margin-bottom: 15px;">🧾 개인소득세 (TNCN)</h3>
                    <div class="result-item">
                        <span class="result-label">과세 대상 소득</span>
                        <span class="result-value" id="taxableIncome">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">가족 공제 (본인)</span>
                        <span class="result-value">11,000,000 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">가족 공제 (부양가족)</span>
                        <span class="result-value" id="dependentDeduction">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">총 가족 공제</span>
                        <span class="result-value" id="totalFamilyDeduction">11,000,000 đ</span>
                    </div>
                    <div class="result-item" style="background: #fff3e0;">
                        <span class="result-label">과세 표준</span>
                        <span class="result-value" id="taxBase">0 đ</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #e91e63; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #e91e63;">개인소득세</span>
                        <span class="result-value" style="color: #e91e63; font-size: 1.2em;" id="incomeTax">0 đ</span>
                    </div>
                </div>

                <div class="result-box" id="taxFreeBox" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">🎁 비과세 내역</h3>
                    <div class="result-item">
                        <span class="result-label">💚 식대 (100% 비과세)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeMeal">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">💚 야근 비과세 (1/3)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeOvertime">0 đ</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">💚 특근 비과세 (1/2)</span>
                        <span class="result-value" style="color: #4caf50;" id="taxFreeSunday">0 đ</span>
                    </div>
                    <div class="result-item" style="border-top: 2px solid #4caf50; padding-top: 15px; margin-top: 10px;">
                        <span class="result-label" style="color: #4caf50; font-weight: bold;">총 비과세</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.2em;" id="totalTaxFree">0 đ</span>
                    </div>
                </div>

                <div class="result-box" style="background: #e8f5e9; border-left-color: #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 15px;">💰 총 급여</h3>
                    <div class="result-item">
                        <span class="result-label" style="font-size: 1.2em;">총 지급액</span>
                        <span class="result-value" style="color: #4caf50; font-size: 1.3em;" id="totalSalary">0 đ</span>
                    </div>
                </div>

                <!-- 선금 차감 -->
                <div class="result-box" id="advancePaymentResultContainer" style="background: #fff3e0; border-left-color: #ff9800; display: none;">
                    <h3 style="color: #ff9800; margin-bottom: 15px;">💰 선금 차감</h3>
                    <div class="result-item">
                        <span class="result-label" style="color: #ff9800; font-weight: bold;">Ứng lương | 선금</span>
                        <span class="result-value" style="color: #ff9800; font-size: 1.2em; font-weight: bold;" id="advancePaymentResult">0 đ</span>
                    </div>
                    <div class="tip" style="color: #666; margin-top: 10px;">※ 실수령액에서 차감됩니다</div>
                </div>

                <!-- 최종 정산 요약 -->
                <div class="result-box" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; color: white;">
                    <h3 style="color: white; margin-bottom: 20px; font-size: 1.3em;">📊 최종 정산</h3>
                    <div class="result-item" style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">급여 상세 합계</span>
                        <span class="result-value" style="color: white;" id="finalSalaryDetail">0 đ</span>
                    </div>
                    <div class="result-item" style="border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">수당 합계</span>
                        <span class="result-value" style="color: white;" id="finalAllowanceTotal">0 đ</span>
                    </div>
                    <div class="result-item" style="border-bottom: 2px solid white; padding-bottom: 15px; margin-bottom: 15px;">
                        <span class="result-label" style="color: white; font-weight: bold; font-size: 1.1em;">= 총 급여</span>
                        <span class="result-value" style="color: #ffd700; font-size: 1.3em; font-weight: bold;" id="finalTotalSalary">0 đ</span>
                    </div>
                    <div class="result-item" id="finalDeductionRow">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- 보험료 공제</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalDeduction">0 đ</span>
                    </div>
                    <div class="result-item" id="finalIncomeTaxRow">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- 개인소득세</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalIncomeTax">0 đ</span>
                    </div>
                    <div class="result-item" id="finalAdvancePaymentRow" style="display: none;">
                        <span class="result-label" style="color: rgba(255,255,255,0.9);">- 선금</span>
                        <span class="result-value" style="color: #ffcccc;" id="finalAdvancePayment">0 đ</span>
                    </div>
                </div>

                <div class="highlight-box">
                    <div style="font-size: 1.2em;">💰 실수령액</div>
                    <div class="big-number" id="netSalary">0 đ</div>
                    <div style="font-size: 0.9em; opacity: 0.9;">Tổng lương - Khấu trừ - Thuế TNCN</div>
                </div>

                <!-- 💾 출력 버튼 -->
                <div style="margin-top: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 15px; text-align: center;">💾 Xuất phiếu lương</h3>
                    <div style="display: flex; gap: 10px;">
                        <button onclick="exportCurrentEmployeeExcel()" class="btn-calculate" style="flex: 1; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); font-size: 1.1em; padding: 14px;">
                            📊 Excel
                        </button>
                        <button onclick="openMobilePayslip()" class="btn-calculate" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); font-size: 1.1em; padding: 14px;">
                            📱 Mobile
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 8px; font-size: 0.85em; color: #666;">
                        📊 Excel có thể in PDF | 📱 Xem trước & tải file gửi Zalo
                    </div>
                </div>
            </div>
        </div>

        <!-- 계산 공식 설명 -->
        <div style="padding: 0 40px 40px 40px;">
            <div class="formula-section">
                <div class="formula-title">🧮 자동 계산 규칙</div>
                <div class="formula-item">
                    <strong>실 근무일</strong> = 평일 - 공휴일 - 결근
                </div>
                <div class="formula-item">
                    <strong>정규 시간</strong> = 각 날짜의 실제 근무시간 합계 (기본 8h/일)
                </div>
                <div class="formula-item">
                    <strong>식대</strong> = 실 근무일에 따라 자동 계산 (회사 설정에서 금액/조건 설정)
                </div>
                <div class="formula-item" style="background: #e8f5e9; border-left: 3px solid #4caf50;">
                    <strong>수당</strong> = 회사 설정에서 등록한 수당들 (개근수당, 교통비 등)
                    <br><small style="color: #666;">※ 각 수당별로 무단결근/사유결근/연차 시 규칙 적용 (0원/비율/전액)</small>
                    <br><small style="color: #666;">※ 수당 추가/수정/삭제는 "회사 설정" 페이지에서 관리</small>
                </div>
                <div class="formula-item" style="background: #e3f2fd; border-left: 3px solid #2196f3;">
                    <strong>시간당 급여</strong> = 기본급 ÷ (해당 월 근무일수 × 8시간)
                    <br><small style="color: #666;">※ 근무일수 = 총일수 - 일요일 - 공휴일 (매월 자동 계산)</small>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 날짜 키 생성 함수 (항상 YYYY-MM-DD 형식으로 0 패딩)
        function makeDateKey(year, month, day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // 날짜 문자열 정규화 (YYYY-M-D 또는 YYYY-MM-DD → YYYY-MM-DD)
        function normalizeDateKey(dateStr) {
            if (!dateStr) return dateStr;
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            return makeDateKey(parseInt(parts[0]), parseInt(parts[1]), parseInt(parts[2]));
        }

        // Set 또는 Array의 날짜를 정규화
        function normalizeDateSet(dateArray) {
            return dateArray.map(d => normalizeDateKey(d));
        }

        // Object의 날짜 키를 정규화
        function normalizeDateObject(dateObj) {
            const normalized = {};
            Object.keys(dateObj).forEach(key => {
                const newKey = normalizeDateKey(key);
                normalized[newKey] = dateObj[key];
            });
            return normalized;
        }

        // 금액 입력 포맷팅 (쉼표 구분)
        function formatMoneyInput(input) {
            // 숫자만 추출
            let value = input.value.replace(/[^\d]/g, '');
            if (value === '') value = '0';

            // 숫자로 변환 후 포맷팅
            const num = parseInt(value, 10);
            input.value = formatNumber(num);
        }

        // 포맷된 금액에서 숫자 추출
        function parseMoneyInput(value) {
            if (!value) return 0;
            // 쉼표, 점, 공백 모두 제거
            const cleaned = value.toString().replace(/[,.\s]/g, '');
            return parseInt(cleaned, 10) || 0;
        }

        // 포커스 시 전체 선택
        function selectAllOnFocus(input) {
            setTimeout(() => input.select(), 50);
        }

        // 특수수당 체크박스 토글
        function toggleSpecialAllowance() {
            const checkbox = document.getElementById('specialAllowanceEnabled');
            const input = document.getElementById('specialAllowanceAmount');

            if (checkbox.checked) {
                input.disabled = false;
                input.style.background = 'white';
                input.focus();
            } else {
                input.disabled = true;
                input.style.background = '#f5f5f5';
                input.value = '0';
            }
            calculate(); // 체크박스 변경 시 재계산
        }

        // 선금 체크박스 토글
        function toggleAdvancePayment() {
            const checkbox = document.getElementById('advancePaymentEnabled');
            const input = document.getElementById('advancePaymentAmount');

            if (checkbox.checked) {
                input.disabled = false;
                input.style.background = 'white';
                input.focus();
            } else {
                input.disabled = true;
                input.style.background = '#f5f5f5';
                input.value = '0';
            }
            calculate(); // 체크박스 변경 시 재계산
        }

        let selectedYear = 2025;
        let selectedMonth = 11;
        let holidays = new Set();
        let excusedAbsents = new Set(); // 사유 있는 결근
        let absents = new Set();        // 무단 결근
        let annualLeaveDays = new Set(); // 연차 사용일
        let specialLeaveDays = new Set(); // 경조사/특별휴가
        let sickLeaveDays = new Set(); // 병가
        let annualLeaveMemos = {}; // 연차 메모 (특수 사유)
        let overtimeData = {}; // 야근시간
        let nightData = {};     // 야간시간
        let nightOTData = {};   // 야간+OT (200%)
        let sundayData = {};    // 일요일 특근
        let normalHoursData = {}; // 정규 근무시간 (기본 8시간)
        let nightShiftDays = new Set(); // 야간조 날짜 (예: "2024-12-05" = 해당일 야간조)

        // 날짜가 야간조인지 확인 (전역 함수)
        function isNightShiftDay(day) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;
            return nightShiftDays.has(dateKey) || nightShiftDays.has(dateKeyOld);
        }

        // 직원 관리
        let employees = {}; // {id: {name, basicSalary, dependents, dailyMeal, ...}}
        let currentEmployeeId = null;

        // ==================== 자동저장 시스템 ====================
        let autoSaveTimer = null;
        const AUTO_SAVE_DELAY = 2000; // 2초 딜레이

        // 자동저장 예약 (디바운스)
        function scheduleAutoSave() {
            if (!currentEmployeeId) return;

            if (autoSaveTimer) {
                clearTimeout(autoSaveTimer);
            }

            autoSaveTimer = setTimeout(() => {
                autoSaveCurrentEmployee();
            }, AUTO_SAVE_DELAY);

            console.log('💾 자동저장 예약됨 (2초 후)');
        }

        // 자동저장 실행
        function autoSaveCurrentEmployee() {
            if (!currentEmployeeId) return;

            saveCurrentEmployee();
            console.log('✅ 자동저장 완료:', new Date().toLocaleTimeString());
        }

        // 동적 수당 상세 정보 (전역)
        let currentAllowanceDetails = {};

        // 초기화
        function init() {
            // 먼저 URL 파라미터 체크 (년월 먼저 설정)
            checkURLParams();

            initYearMonth();
            loadEmployeesFromStorage();

            // 데이터 무결성 검증 (고아 데이터 정리)
            cleanupOrphanData();

            // URL에서 직원 로드 (generateCalendar 포함)
            loadEmployeeFromURL();

            // URL에서 직원이 없으면 기본 달력 생성
            if (!currentEmployeeId) {
                generateCalendar();
                calculate();
            }
        }

        // 고아 데이터 정리 (삭제된 직원의 데이터 제거)
        function cleanupOrphanData() {
            const validEmployeeIds = new Set(Object.keys(employees));
            let cleanedCount = 0;

            // 급여 이력에서 존재하지 않는 직원 데이터 제거
            const historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');

            historyList.forEach(item => {
                const historyKey = `payrollHistory_${item.year}_${item.month}`;
                const confirmKey = `payrollConfirmed_${item.year}_${item.month}`;

                let historyData = JSON.parse(localStorage.getItem(historyKey) || '{}');
                let needsSave = false;

                // data 배열에서 존재하지 않는 직원 제거
                if (historyData.data && Array.isArray(historyData.data)) {
                    const originalLength = historyData.data.length;
                    historyData.data = historyData.data.filter(d => {
                        const empId = d.employeeId || d.id;
                        return validEmployeeIds.has(empId);
                    });
                    if (historyData.data.length < originalLength) {
                        needsSave = true;
                        cleanedCount += originalLength - historyData.data.length;
                    }
                }

                // confirmedEmployees에서 존재하지 않는 직원 제거
                if (historyData.confirmedEmployees && Array.isArray(historyData.confirmedEmployees)) {
                    historyData.confirmedEmployees = historyData.confirmedEmployees.filter(id => validEmployeeIds.has(id));
                    needsSave = true;
                }

                if (needsSave) {
                    if (historyData.data && historyData.data.length > 0) {
                        localStorage.setItem(historyKey, JSON.stringify(historyData));
                    } else {
                        localStorage.removeItem(historyKey);
                    }
                }

                // 확정 목록도 정리
                let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
                const filteredList = confirmedList.filter(id => validEmployeeIds.has(id));
                if (filteredList.length !== confirmedList.length) {
                    if (filteredList.length > 0) {
                        localStorage.setItem(confirmKey, JSON.stringify(filteredList));
                    } else {
                        localStorage.removeItem(confirmKey);
                    }
                }
            });

            if (cleanedCount > 0) {
                console.log(`🧹 고아 데이터 정리: ${cleanedCount}건 삭제됨`);
            }
        }

        // URL 파라미터 체크 (년월만 먼저 읽기)
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const year = urlParams.get('year');
            const month = urlParams.get('month');
            const autoCalc = urlParams.get('autoCalc');

            // 년월 정보가 있으면 설정
            if (year && month) {
                selectedYear = parseInt(year);
                selectedMonth = parseInt(month);
            }

            // 자동 계산 모드 확인
            if (autoCalc === 'all') {
                // 페이지 로드 후 자동 계산 실행
                setTimeout(() => {
                    autoCalculateAllEmployees();
                }, 500);
            }
        }

        // 전체 직원 자동 계산 및 확정
        function autoCalculateAllEmployees() {
            const employeeIds = Object.keys(employees);
            if (employeeIds.length === 0) {
                alert('❌ 등록된 직원이 없습니다.');
                return;
            }

            let successCount = 0;
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            const historyKey = `payrollHistory_${monthKey}`;

            // 기존 이력 데이터 확인
            let historyData = JSON.parse(localStorage.getItem(historyKey) || '{}');
            const firstSavedDate = historyData.firstSavedDate || new Date().toISOString();

            // 초기화
            if (!historyData.data) {
                historyData = {
                    year: selectedYear,
                    month: selectedMonth,
                    savedDate: new Date().toISOString(),
                    firstSavedDate: firstSavedDate,
                    data: [],
                    confirmedEmployees: []
                };
            }

            let confirmedList = [];
            let payrollDataList = [];

            // 각 직원별로 계산 및 확정
            employeeIds.forEach(empId => {
                const emp = employees[empId];
                if (!emp) return;

                // 직원 로드 및 계산
                loadEmployee(empId);

                // 급여 데이터 계산 (기존 calculateEmployeePayroll 함수 사용)
                const currentPayroll = calculateEmployeePayroll(empId, selectedYear, selectedMonth);

                if (currentPayroll) {
                    // 확정 목록에 추가
                    if (!confirmedList.includes(empId)) {
                        confirmedList.push(empId);
                    }

                    // 급여 데이터 추가
                    // 직원 코드 포함된 이름 생성
                    let displayName = emp.name;
                    if (emp.employeeCode && !emp.name.includes(`[${emp.employeeCode}]`)) {
                        displayName = `[${emp.employeeCode}] ${emp.name}`;
                    }

                    payrollDataList.push({
                        employeeId: empId,
                        id: empId,
                        employeeCode: emp.employeeCode || '',
                        name: displayName,
                        ...currentPayroll
                    });

                    successCount++;
                }
            });

            // 히스토리 데이터 업데이트
            historyData.data = payrollDataList;
            historyData.confirmedEmployees = confirmedList;
            historyData.savedDate = new Date().toISOString();
            historyData.firstSavedDate = firstSavedDate;

            // 저장
            localStorage.setItem(historyKey, JSON.stringify(historyData));
            localStorage.setItem(confirmKey, JSON.stringify(confirmedList));

            // 이력 목록 업데이트
            let historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            const existingIndex = historyList.findIndex(h => h.year === selectedYear && h.month === selectedMonth);

            const listItem = {
                year: selectedYear,
                month: selectedMonth,
                savedDate: new Date().toISOString()
            };

            if (existingIndex >= 0) {
                historyList[existingIndex] = listItem;
            } else {
                historyList.push(listItem);
            }

            localStorage.setItem('payrollHistoryList', JSON.stringify(historyList));

            // URL에서 autoCalc 파라미터 제거
            const newUrl = window.location.pathname;
            window.history.replaceState({}, '', newUrl);

            // 확정 상태 업데이트
            updateConfirmStatus();

            console.log(`✅ 전체 직원 급여 확정 완료: ${successCount}명`);

            alert(`✅ 전체 직원 급여 확정 완료!\n\n• 확정된 직원: ${successCount}명\n• 대상 월: ${selectedYear}년 ${selectedMonth}월\n\n급여대장에서 확인하세요.`);

            // 메인으로 이동할지 확인
            if (confirm('메인 페이지로 이동하시겠습니까?')) {
                window.location.href = 'index.html';
            }
        }

        // URL 파라미터에서 직원 로드
        function loadEmployeeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const employeeId = urlParams.get('employee');

            // 직원 ID가 있으면 해당 직원 로드
            if (employeeId && employees[employeeId]) {
                // 드롭다운 값 설정
                document.getElementById('yearSelect').value = selectedYear;
                document.getElementById('monthSelect').value = selectedMonth;

                // 직원 로드 (내부에서 generateCalendar와 calculate 호출)
                loadEmployee(employeeId);

                console.log(`✅ URL에서 직원 로드: ${employees[employeeId].name}, ${selectedYear}년 ${selectedMonth}월`);
            }
        }

        // 년도/월 선택 초기화
        function initYearMonth() {
            const yearSelect = document.getElementById('yearSelect');
            const monthSelect = document.getElementById('monthSelect');

            for (let y = 2020; y <= 2030; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y + '년';
                if (y === selectedYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            for (let m = 1; m <= 12; m++) {
                const option = document.createElement('option');
                option.value = m;
                option.textContent = m + '월';
                if (m === selectedMonth) option.selected = true;
                monthSelect.appendChild(option);
            }

            yearSelect.addEventListener('change', () => {
                selectedYear = parseInt(yearSelect.value);

                // 연도 변경 시 회사 설정 다시 로드
                console.log('📅 연도 변경:', selectedYear);
                const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
                if (storedSettings) {
                    window.companySettings = JSON.parse(storedSettings);
                    console.log('✅ 연도별 회사 설정 로드:', window.companySettings.companyName, window.companySettings.companyLogo);
                } else {
                    console.warn('⚠️', selectedYear, '년도 회사 설정 없음');
                }

                generateCalendar();
            });

            monthSelect.addEventListener('change', () => {
                selectedMonth = parseInt(monthSelect.value);
                generateCalendar();
            });
        }

        // 달력 생성
        function generateCalendar() {
            const calendar = document.getElementById('calendar');
            const title = document.getElementById('calendarTitle');

            title.textContent = `${selectedYear}년 ${selectedMonth}월`;

            // 야간 설정에 따라 통계 행 표시/숨기기
            const nightStatRow = document.getElementById('nightStatRow');
            const nightOTStatRow = document.getElementById('nightOTStatRow');
            const nightEnabled = window.companySettings && window.companySettings.nightShiftEnabled;
            if (nightStatRow) {
                nightStatRow.style.display = nightEnabled ? '' : 'none';
            }
            if (nightOTStatRow) {
                nightOTStatRow.style.display = nightEnabled ? '' : 'none';
            }
            
            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const firstDay = new Date(selectedYear, selectedMonth - 1, 1).getDay();
            
            calendar.innerHTML = '';

            // 요일 헤더
            const dayHeaders = ['일', '월', '화', '수', '목', '금', '토'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendar.appendChild(header);
            });

            // 빈 칸
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                calendar.appendChild(empty);
            }

            // 날짜
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';

                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0) {
                    dayEl.classList.add('sunday');
                } else if (dayOfWeek === 6) {
                    dayEl.classList.add('saturday');
                }

                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;  // 구버전 호환

                if (holidays.has(dateKey) || holidays.has(dateKeyOld)) {
                    dayEl.classList.add('holiday', 'selected');
                }
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                    dayEl.classList.add('excused-absent', 'selected');
                }
                if (absents.has(dateKey) || absents.has(dateKeyOld)) {
                    dayEl.classList.add('absent', 'selected');
                }
                if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld)) {
                    dayEl.classList.add('annual-leave', 'selected');

                    // 연차 메모가 있으면 표시
                    const memo = annualLeaveMemos[dateKey] || annualLeaveMemos[dateKeyOld];
                    if (memo) {
                        const memoIndicator = document.createElement('div');
                        memoIndicator.className = 'annual-leave-memo';
                        memoIndicator.textContent = `📝 ${memo}`;
                        memoIndicator.title = memo;
                        memoIndicator.style.cssText = 'font-size: 0.7em; background: #fff3e0; color: #e65100; padding: 2px 4px; border-radius: 3px; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;';
                        dayEl.appendChild(memoIndicator);
                    }
                }
                if (specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld)) {
                    dayEl.classList.add('special-leave', 'selected');
                }
                if (sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld)) {
                    dayEl.classList.add('sick-leave', 'selected');
                }

                // 야간조 토글 (일요일 제외, 야간 설정 활성화 시만)
                if (dayOfWeek !== 0 && window.companySettings && window.companySettings.nightShiftEnabled) {
                    const isNightShift = nightShiftDays.has(dateKey) || nightShiftDays.has(dateKeyOld);
                    const shiftToggle = document.createElement('div');
                    shiftToggle.className = 'shift-toggle';
                    shiftToggle.id = `shift-${dateKey}`;
                    shiftToggle.style.cssText = `
                        position: absolute;
                        top: 2px;
                        left: 2px;
                        font-size: 12px;
                        cursor: pointer;
                        z-index: 10;
                        padding: 2px;
                        border-radius: 3px;
                        background: ${isNightShift ? '#4a148c' : '#1565c0'};
                    `;
                    shiftToggle.textContent = isNightShift ? '🌙' : '☀️';
                    shiftToggle.title = isNightShift ? '야간조 (클릭: 주간조로 변경)' : '주간조 (클릭: 야간조로 변경)';
                    shiftToggle.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleDayShift(day);
                    });
                    dayEl.appendChild(shiftToggle);
                    dayEl.style.position = 'relative';
                }

                // 날짜 숫자 (클릭시 야근시간 입력)
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number day-number-clickable';
                dayNumber.textContent = day;
                dayNumber.title = '클릭하여 야근시간 입력';
                dayNumber.addEventListener('click', (e) => {
                    e.stopPropagation();
                    inputOvertimeHours(day, dayEl);
                });
                dayEl.appendChild(dayNumber);

                // 라벨 제거됨

                // 정규 근무시간 표시 (일요일 제외, 공휴일/결근 제외)
                if (dayOfWeek !== 0 && !holidays.has(dateKey) && !holidays.has(dateKeyOld) &&
                    !excusedAbsents.has(dateKey) && !excusedAbsents.has(dateKeyOld) &&
                    !absents.has(dateKey) && !absents.has(dateKeyOld)) {
                    const normalInfo = document.createElement('div');
                    normalInfo.className = 'normal-hours-info';
                    normalInfo.id = `normal-${dateKey}`;
                    normalInfo.title = '좌클릭: +0.5시간 | 우클릭: -0.5시간';

                    const normalHours = normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8;

                    if (normalHours === 8) {
                        normalInfo.textContent = `📅 ${normalHours}h`;
                        normalInfo.classList.add('has-data');
                    } else if (normalHours < 8 && normalHours > 0) {
                        normalInfo.textContent = `📅 ${normalHours}h (조기)`;
                        normalInfo.classList.add('early-leave');
                    } else if (normalHours > 0) {
                        normalInfo.textContent = `📅 ${normalHours}h`;
                        normalInfo.classList.add('has-data');
                    } else {
                        normalInfo.textContent = '📅 0h';
                    }

                    // 좌클릭: +0.5시간
                    normalInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementNormalHours(day, 0.5);
                    });

                    // 우클릭: -0.5시간
                    normalInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementNormalHours(day, -0.5);
                    });

                    dayEl.appendChild(normalInfo);
                }

                // 야근/특근 시간 표시
                const overtimeInfo = document.createElement('div');
                overtimeInfo.className = 'overtime-info';
                overtimeInfo.id = `overtime-${dateKey}`;
                overtimeInfo.title = '좌클릭: +0.5시간 | 우클릭: -0.5시간';

                // 일요일이면 특근, 아니면 야근
                if (dayOfWeek === 0) {
                    // 일요일 특근
                    const sundayHours = sundayData[dateKey] || sundayData[dateKeyOld];
                    if (sundayHours) {
                        overtimeInfo.textContent = `🔥 ${sundayHours}h`;
                        overtimeInfo.classList.add('has-data', 'sunday-work');
                    } else {
                        overtimeInfo.textContent = '+ 특근(200%)';
                        overtimeInfo.classList.add('sunday-work');
                    }

                    // 좌클릭: +0.5시간
                    overtimeInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementSunday(day, 0.5);
                    });

                    // 우클릭: -0.5시간
                    overtimeInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementSunday(day, -0.5);
                    });
                } else {
                    // 평일/토요일 야근 (야간조 날에는 숨김)
                    const overtimeHours = overtimeData[dateKey] || overtimeData[dateKeyOld];
                    if (overtimeHours) {
                        overtimeInfo.textContent = `⏰ ${overtimeHours}h`;
                        overtimeInfo.classList.add('has-data');
                    } else {
                        overtimeInfo.textContent = '+ 야근';
                    }

                    // 좌클릭: +0.5시간
                    overtimeInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementOvertime(day, 0.5);
                    });

                    // 우클릭: -0.5시간
                    overtimeInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementOvertime(day, -0.5);
                    });

                    // 야간조 날에는 숨기기
                    if (isNightShiftDay(day)) {
                        overtimeInfo.style.display = 'none';
                    }
                }

                dayEl.appendChild(overtimeInfo);

                // 야간+OT 표시 (야간 설정 활성화 시 생성, 주간조 날에는 숨김)
                // 주간조: 8h + 야근만
                // 야간조: 8h + 야간OT만
                if (dayOfWeek !== 0 && window.companySettings && window.companySettings.nightShiftEnabled) {
                    const nightOTInfo = document.createElement('div');
                    nightOTInfo.className = 'night-ot-info';
                    nightOTInfo.id = `nightot-${dateKey}`;
                    const currentNightOTRate = (window.companySettings && window.companySettings.nightOTRate) || 2.0;
                    nightOTInfo.title = `야간+OT (${Math.round(currentNightOTRate * 100)}%) | 좌클릭: +0.5시간 | 우클릭: -0.5시간`;

                    const nightOTHours = nightOTData[dateKey] || nightOTData[dateKeyOld];
                    if (nightOTHours) {
                        nightOTInfo.textContent = `🌙⏰ ${nightOTHours}h`;
                        nightOTInfo.classList.add('has-data');
                    } else {
                        nightOTInfo.textContent = '+ 야간OT';
                    }

                    nightOTInfo.addEventListener('click', (e) => {
                        e.stopPropagation();
                        incrementNightOT(day, 0.5);
                    });

                    nightOTInfo.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        incrementNightOT(day, -0.5);
                    });

                    // 주간조 날에는 숨기기
                    if (!isNightShiftDay(day)) {
                        nightOTInfo.style.display = 'none';
                    }

                    dayEl.appendChild(nightOTInfo);
                }

                // 배경 클릭시 공휴일/결근 토글
                dayEl.addEventListener('click', () => toggleDay(day, dayEl, 1));  // 왼쪽 클릭: 정방향

                // 배경 우클릭시 역방향 토글
                dayEl.addEventListener('contextmenu', (e) => {
                    e.preventDefault();  // 브라우저 기본 메뉴 방지
                    toggleDay(day, dayEl, -1);  // 오른쪽 클릭: 역방향
                });

                calendar.appendChild(dayEl);
            }
            
            updateStats();
        }

        // 정규 근무시간 증가/감소
        function incrementNormalHours(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 구버전 키의 값도 확인
            const currentValue = normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8;
            const newValue = Math.max(0, Math.min(12, currentValue + amount)); // 0~12시간 제한

            // 구버전 키 삭제
            if (dateKeyOld !== dateKey && normalHoursData[dateKeyOld]) {
                delete normalHoursData[dateKeyOld];
            }

            if (newValue !== 8) {
                normalHoursData[dateKey] = newValue;
            } else {
                delete normalHoursData[dateKey]; // 8시간이면 기본값이므로 삭제
            }

            // UI 업데이트
            const normalInfo = document.getElementById(`normal-${dateKey}`);
            if (normalInfo) {
                normalInfo.classList.remove('has-data', 'early-leave');

                if (newValue === 8) {
                    normalInfo.textContent = `📅 ${newValue}h`;
                    normalInfo.classList.add('has-data');
                } else if (newValue < 8 && newValue > 0) {
                    normalInfo.textContent = `📅 ${newValue}h (조기)`;
                    normalInfo.classList.add('early-leave');
                } else if (newValue > 8) {
                    normalInfo.textContent = `📅 ${newValue}h`;
                    normalInfo.classList.add('has-data');
                } else {
                    normalInfo.textContent = '📅 0h';
                }
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 야근시간 증가/감소
        function incrementOvertime(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 연차/공휴일/결근일 체크
            if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                absents.has(dateKey) || absents.has(dateKeyOld) ||
                excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                alert('⚠️ 연차/공휴일/결근일에는 야근을 입력할 수 없습니다.');
                return;
            }

            // 구버전 키의 값도 확인
            const currentValue = overtimeData[dateKey] || overtimeData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            // 구버전 키 삭제
            if (dateKeyOld !== dateKey && overtimeData[dateKeyOld]) {
                delete overtimeData[dateKeyOld];
            }

            if (newValue > 0) {
                overtimeData[dateKey] = newValue;
            } else {
                delete overtimeData[dateKey];
            }

            // UI 업데이트
            const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
            if (overtimeInfo) {
                if (newValue > 0) {
                    overtimeInfo.textContent = `⏰ ${newValue}h`;
                    overtimeInfo.classList.add('has-data');
                } else {
                    overtimeInfo.textContent = '+ 야근';
                    overtimeInfo.classList.remove('has-data');
                }
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 일요일 특근시간 증가/감소
        function incrementSunday(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 연차/공휴일/결근일 체크
            if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                absents.has(dateKey) || absents.has(dateKeyOld) ||
                excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                alert('⚠️ 연차/공휴일/결근일에는 특근을 입력할 수 없습니다.');
                return;
            }

            // 구버전 키의 값도 확인
            const currentValue = sundayData[dateKey] || sundayData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            // 구버전 키 삭제
            if (dateKeyOld !== dateKey && sundayData[dateKeyOld]) {
                delete sundayData[dateKeyOld];
            }

            if (newValue > 0) {
                sundayData[dateKey] = newValue;
            } else {
                delete sundayData[dateKey];
            }

            // UI 업데이트
            const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
            if (overtimeInfo) {
                if (newValue > 0) {
                    overtimeInfo.textContent = `🔥 ${newValue}h`;
                    overtimeInfo.classList.add('has-data');
                    overtimeInfo.style.background = '#e53935';
                    overtimeInfo.style.borderColor = '#c62828';
                    overtimeInfo.style.color = 'white';
                } else {
                    overtimeInfo.textContent = '+ 특근(200%)';
                    overtimeInfo.classList.remove('has-data');
                    overtimeInfo.style.background = '#ffebee';
                    overtimeInfo.style.borderColor = '#e53935';
                    overtimeInfo.style.color = '#333';
                }
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 날짜별 주간조/야간조 전환
        function toggleDayShift(day) {
            console.log(`🔄 toggleDayShift 호출됨: day=${day}`);
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 현재 야간조인지 확인 (구버전 또는 신버전 키 모두 체크)
            const isCurrentlyNightShift = nightShiftDays.has(dateKey) || nightShiftDays.has(dateKeyOld);
            console.log(`   dateKey=${dateKey}, 현재 야간조=${isCurrentlyNightShift}`);

            // 구버전 키 삭제 (마이그레이션)
            if (nightShiftDays.has(dateKeyOld)) {
                nightShiftDays.delete(dateKeyOld);
                console.log(`   구버전 키 삭제: ${dateKeyOld}`);
            }

            // 토글: 야간조 → 주간조 / 주간조 → 야간조
            if (isCurrentlyNightShift) {
                // 야간조 → 주간조
                nightShiftDays.delete(dateKey);  // 혹시 있으면 삭제
                console.log(`☀️ ${selectedMonth}/${day}: 주간조로 변경`);
            } else {
                // 주간조 → 야간조
                nightShiftDays.add(dateKey);
                console.log(`🌙 ${selectedMonth}/${day}: 야간조로 변경`);
            }
            console.log(`   변경 후 nightShiftDays:`, [...nightShiftDays]);

            // 토글 아이콘 업데이트
            const isNightShift = nightShiftDays.has(dateKey);
            const shiftToggle = document.getElementById(`shift-${dateKey}`);
            if (shiftToggle) {
                shiftToggle.textContent = isNightShift ? '🌙' : '☀️';
                shiftToggle.style.background = isNightShift ? '#4a148c' : '#1565c0';
                shiftToggle.title = isNightShift ? '야간조 (클릭: 주간조로 변경)' : '주간조 (클릭: 야간조로 변경)';
            }

            // 야근/야간OT 버튼 표시/숨기기
            const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
            const nightOTInfo = document.getElementById(`nightot-${dateKey}`);

            if (isNightShift) {
                // 야간조: 야근 숨기고 야간OT 표시
                if (overtimeInfo) overtimeInfo.style.display = 'none';
                if (nightOTInfo) nightOTInfo.style.display = '';
            } else {
                // 주간조: 야근 표시하고 야간OT 숨기기
                if (overtimeInfo) overtimeInfo.style.display = '';
                if (nightOTInfo) nightOTInfo.style.display = 'none';
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 야간시간 증가/감소
        function incrementNight(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 구버전 키의 값도 확인
            const currentValue = nightData[dateKey] || nightData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            // 구버전 키 삭제
            if (dateKeyOld !== dateKey && nightData[dateKeyOld]) {
                delete nightData[dateKeyOld];
            }

            if (newValue > 0) {
                nightData[dateKey] = newValue;
            } else {
                delete nightData[dateKey];
            }

            // UI 업데이트
            const nightInfo = document.getElementById(`night-${dateKey}`);
            if (nightInfo) {
                if (newValue > 0) {
                    nightInfo.textContent = `🌙 ${newValue}h`;
                    nightInfo.classList.add('has-data');
                } else {
                    nightInfo.textContent = '+ 야간';
                    nightInfo.classList.remove('has-data');
                }
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 야간+OT 시간 증가/감소 (200%)
        function incrementNightOT(day, amount) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            const currentValue = nightOTData[dateKey] || nightOTData[dateKeyOld] || 0;
            const newValue = Math.max(0, currentValue + amount);

            if (dateKeyOld !== dateKey && nightOTData[dateKeyOld]) {
                delete nightOTData[dateKeyOld];
            }

            if (newValue > 0) {
                nightOTData[dateKey] = newValue;
            } else {
                delete nightOTData[dateKey];
            }

            const nightOTInfo = document.getElementById(`nightot-${dateKey}`);
            if (nightOTInfo) {
                if (newValue > 0) {
                    nightOTInfo.textContent = `🌙⏰ ${newValue}h`;
                    nightOTInfo.classList.add('has-data');
                } else {
                    nightOTInfo.textContent = '+ 야간OT';
                    nightOTInfo.classList.remove('has-data');
                }
            }

            updateStats();
            calculate();
            scheduleAutoSave(); // 자동저장
        }

        // 야근시간 직접 입력
        function inputOvertimeHours(day, element) {
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;
            const date = new Date(selectedYear, selectedMonth - 1, day);
            const dayOfWeek = date.getDay();
            const isSunday = (dayOfWeek === 0);

            // 연차/공휴일/결근일 체크
            if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                absents.has(dateKey) || absents.has(dateKeyOld) ||
                excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                alert('⚠️ 연차/공휴일/결근일에는 야근을 입력할 수 없습니다.');
                return;
            }

            // 일요일이면 sundayData, 평일이면 overtimeData 사용
            const targetData = isSunday ? sundayData : overtimeData;
            const labelText = isSunday ? '일요특근' : '야근';

            // 구버전 키의 값도 확인
            const currentValue = targetData[dateKey] || targetData[dateKeyOld] || 0;

            const input = prompt(`📅 ${selectedMonth}월 ${day}일 ${labelText}시간 입력\n\n${labelText}시간 (시간):`, currentValue);

            if (input !== null) {
                const hours = parseFloat(input);
                if (!isNaN(hours) && hours >= 0) {
                    // 구버전 키 삭제
                    if (dateKeyOld !== dateKey && targetData[dateKeyOld]) {
                        delete targetData[dateKeyOld];
                    }

                    if (hours > 0) {
                        targetData[dateKey] = hours;
                    } else {
                        delete targetData[dateKey];
                    }

                    // UI 업데이트
                    const overtimeInfo = document.getElementById(`overtime-${dateKey}`);
                    if (overtimeInfo) {
                        if (hours > 0) {
                            overtimeInfo.textContent = isSunday ? `🔥 ${hours}h` : `⏰ ${hours}h`;
                            overtimeInfo.classList.add('has-data');
                        } else {
                            overtimeInfo.textContent = isSunday ? '+ 특근' : '+ 야근';
                            overtimeInfo.classList.remove('has-data');
                        }
                    }

                    updateStats();
                    calculate();
                    scheduleAutoSave(); // 자동저장
                } else {
                    alert('⚠️ 올바른 숫자를 입력하세요!');
                }
            }
        }

        // 날짜 토글 (공휴일/사유결근/무단결근) - 4단계 순환
        function toggleDay(day, element, direction = 1) {
            const date = new Date(selectedYear, selectedMonth - 1, day);
            const dayOfWeek = date.getDay();
            const dateKey = makeDateKey(selectedYear, selectedMonth, day);
            const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

            // 구버전 키 삭제 (새 키로 통일)
            if (dateKeyOld !== dateKey) {
                if (holidays.has(dateKeyOld)) { holidays.delete(dateKeyOld); holidays.add(dateKey); }
                if (excusedAbsents.has(dateKeyOld)) { excusedAbsents.delete(dateKeyOld); excusedAbsents.add(dateKey); }
                if (absents.has(dateKeyOld)) { absents.delete(dateKeyOld); absents.add(dateKey); }
                if (annualLeaveDays.has(dateKeyOld)) {
                    annualLeaveDays.delete(dateKeyOld);
                    annualLeaveDays.add(dateKey);
                    // 메모도 새 키로 이동
                    if (annualLeaveMemos[dateKeyOld]) {
                        annualLeaveMemos[dateKey] = annualLeaveMemos[dateKeyOld];
                        delete annualLeaveMemos[dateKeyOld];
                    }
                }
            }

            // 헬퍼 함수: 해당 날짜에 잔업 데이터가 있는지 확인
            function hasOvertimeData(key, keyOld) {
                return (overtimeData[key] || overtimeData[keyOld] ||
                        nightData[key] || nightData[keyOld] ||
                        sundayData[key] || sundayData[keyOld]);
            }

            // 헬퍼 함수: 잔업 데이터 요약 문자열
            function getOvertimeDataSummary(key, keyOld) {
                const parts = [];
                const ot = overtimeData[key] || overtimeData[keyOld];
                const nt = nightData[key] || nightData[keyOld];
                const sd = sundayData[key] || sundayData[keyOld];
                if (ot) parts.push(`야근 ${ot}h`);
                if (nt) parts.push(`야간 ${nt}h`);
                if (sd) parts.push(`특근 ${sd}h`);
                return parts.join(', ');
            }

            // 헬퍼 함수: 해당 날짜의 잔업 데이터 삭제
            function clearOvertimeDataForDate(key, keyOld) {
                delete overtimeData[key];
                delete overtimeData[keyOld];
                delete nightData[key];
                delete nightData[keyOld];
                delete sundayData[key];
                delete sundayData[keyOld];
                delete normalHoursData[key];
                delete normalHoursData[keyOld];
            }

            // 헬퍼 함수: 연차 사용 가능 여부 체크
            function canUseAnnualLeave(dateKey) {
                if (!currentEmployeeId || !employees[currentEmployeeId]) return false;
                const emp = employees[currentEmployeeId];

                // 보험 미가입자는 연차 없음
                if (emp.insuranceExempt) {
                    alert('⚠️ 사회보험 미가입자는 연차를 사용할 수 없습니다.');
                    return false;
                }

                const annualLeaveTotal = emp.annualLeavePerYear || 12;
                const annualLeaveAdjustment = emp.annualLeaveAdjustment || 0;

                // 현재 연도의 전체 연차 사용일 카운트
                let totalAnnualLeaveUsed = 0;
                annualLeaveDays.forEach(key => {
                    if (key.startsWith(selectedYear + '-')) {
                        totalAnnualLeaveUsed++;
                    }
                });

                const annualLeaveAvailable = annualLeaveTotal + annualLeaveAdjustment - totalAnnualLeaveUsed;

                if (annualLeaveAvailable <= 0) {
                    // 연차 초과 - 확인 후 허용 (특수 케이스: 경조사 등)
                    const confirmMsg = `⚠️ 연차를 모두 사용했습니다!\n\n` +
                        `연간 연차: ${annualLeaveTotal}일\n` +
                        `조정: ${annualLeaveAdjustment >= 0 ? '+' : ''}${annualLeaveAdjustment}일\n` +
                        `사용: ${totalAnnualLeaveUsed}일\n` +
                        `잔여: 0일\n\n` +
                        `📝 특수 사유(경조사 등)로 추가하시겠습니까?`;

                    if (!confirm(confirmMsg)) {
                        return false;
                    }

                    // 메모 입력 받기
                    const memo = prompt('📝 사유를 입력하세요 (예: 부모님 상, 결혼 등):');
                    if (memo && memo.trim()) {
                        // 연차 메모 저장
                        if (!annualLeaveMemos) {
                            window.annualLeaveMemos = {};
                        }
                        annualLeaveMemos[dateKey] = memo.trim();
                    }
                }

                return true;
            }

            if (direction === 1) {
                // 정방향: 근무일 -> 공휴일 -> 사유결근 -> 무단결근 -> 연차 -> 경조사 -> 병가 -> 근무일
                if (holidays.has(dateKey)) {
                    // 공휴일 -> 사유결근
                    holidays.delete(dateKey);
                    excusedAbsents.add(dateKey);
                    element.classList.remove('holiday', 'selected');
                    element.classList.add('excused-absent', 'selected');
                } else if (excusedAbsents.has(dateKey)) {
                    // 사유결근 -> 무단결근
                    excusedAbsents.delete(dateKey);
                    absents.add(dateKey);
                    element.classList.remove('excused-absent', 'selected');
                    element.classList.add('absent', 'selected');
                } else if (absents.has(dateKey)) {
                    // 무단결근 -> 연차 (연차 잔여일수 체크)
                    if (!canUseAnnualLeave(dateKey)) {
                        return;  // 연차 사용 불가
                    }
                    absents.delete(dateKey);
                    annualLeaveDays.add(dateKey);
                    element.classList.remove('absent', 'selected');
                    element.classList.add('annual-leave', 'selected');
                } else if (annualLeaveDays.has(dateKey)) {
                    // 연차 -> 경조사
                    annualLeaveDays.delete(dateKey);
                    delete annualLeaveMemos[dateKey];
                    delete annualLeaveMemos[dateKeyOld];
                    specialLeaveDays.add(dateKey);
                    element.classList.remove('annual-leave', 'selected');
                    element.classList.add('special-leave', 'selected');
                } else if (specialLeaveDays.has(dateKey)) {
                    // 경조사 -> 병가
                    specialLeaveDays.delete(dateKey);
                    sickLeaveDays.add(dateKey);
                    element.classList.remove('special-leave', 'selected');
                    element.classList.add('sick-leave', 'selected');
                } else if (sickLeaveDays.has(dateKey)) {
                    // 병가 -> 근무일 (원래 상태로)
                    sickLeaveDays.delete(dateKey);
                    generateCalendar();  // 달력 갱신하여 야근 버튼 복원
                } else {
                    // 근무일 -> 공휴일
                    if (hasOvertimeData(dateKey, dateKeyOld)) {
                        const summary = getOvertimeDataSummary(dateKey, dateKeyOld);
                        if (!confirm(`⚠️ 이 날에 [${summary}] 데이터가 있습니다.\n\n공휴일로 변경하면 삭제됩니다. 계속하시겠습니까?`)) {
                            return;  // 취소
                        }
                    }
                    holidays.add(dateKey);
                    element.classList.add('holiday', 'selected');
                    clearOvertimeDataForDate(dateKey, dateKeyOld);
                    generateCalendar();  // 달력 갱신
                }
            } else {
                // 역방향: 근무일 -> 병가 -> 경조사 -> 연차 -> 무단결근 -> 사유결근 -> 공휴일 -> 근무일
                if (sickLeaveDays.has(dateKey)) {
                    // 병가 -> 경조사
                    sickLeaveDays.delete(dateKey);
                    specialLeaveDays.add(dateKey);
                    element.classList.remove('sick-leave', 'selected');
                    element.classList.add('special-leave', 'selected');
                } else if (specialLeaveDays.has(dateKey)) {
                    // 경조사 -> 연차
                    specialLeaveDays.delete(dateKey);
                    annualLeaveDays.add(dateKey);
                    element.classList.remove('special-leave', 'selected');
                    element.classList.add('annual-leave', 'selected');
                } else if (annualLeaveDays.has(dateKey)) {
                    // 연차 -> 무단결근
                    annualLeaveDays.delete(dateKey);
                    delete annualLeaveMemos[dateKey];
                    delete annualLeaveMemos[dateKeyOld];
                    absents.add(dateKey);
                    element.classList.remove('annual-leave', 'selected');
                    element.classList.add('absent', 'selected');
                } else if (absents.has(dateKey)) {
                    // 무단결근 -> 사유결근
                    absents.delete(dateKey);
                    excusedAbsents.add(dateKey);
                    element.classList.remove('absent', 'selected');
                    element.classList.add('excused-absent', 'selected');
                } else if (excusedAbsents.has(dateKey)) {
                    // 사유결근 -> 공휴일
                    excusedAbsents.delete(dateKey);
                    holidays.add(dateKey);
                    element.classList.remove('excused-absent', 'selected');
                    element.classList.add('holiday', 'selected');
                } else if (holidays.has(dateKey)) {
                    // 공휴일 -> 근무일 (원래 상태로)
                    holidays.delete(dateKey);
                    generateCalendar();  // 달력 갱신하여 야근 버튼 복원
                } else {
                    // 근무일 -> 병가
                    if (hasOvertimeData(dateKey, dateKeyOld)) {
                        const summary = getOvertimeDataSummary(dateKey, dateKeyOld);
                        if (!confirm(`⚠️ 이 날에 [${summary}] 데이터가 있습니다.\n\n병가로 변경하면 삭제됩니다. 계속하시겠습니까?`)) {
                            return;  // 취소
                        }
                    }
                    sickLeaveDays.add(dateKey);
                    element.classList.add('sick-leave', 'selected');
                    clearOvertimeDataForDate(dateKey, dateKeyOld);
                    generateCalendar();  // 달력 갱신
                }
            }

            updateStats();
            scheduleAutoSave(); // 자동저장
        }

        // 통계 업데이트
        function updateStats() {
            // 회사 설정 다시 로드 (settings.html에서 수당 추가했을 때 반영되도록)
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            if (storedSettings) {
                window.companySettings = JSON.parse(storedSettings);
                console.log('🔄 회사 설정 다시 로드됨:', window.companySettings);
                console.log('수당 개수:', (window.companySettings.allowances || []).length);
            }

            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();

            // 헬퍼 함수: dateKey가 현재 선택된 연/월에 속하는지 확인 (구버전 호환)
            function isSelectedMonth(key) {
                const parts = key.split('-');
                if (parts.length < 2) return false;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return keyYear === selectedYear && keyMonth === selectedMonth;
            }

            let sundays = 0;

            // 일요일 카운트
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();

                if (dayOfWeek === 0) {
                    sundays++;
                }
            }

            // 공휴일, 사유결근, 무단결근, 연차 카운트 (현재 월만!)
            // 공휴일 중 일요일은 제외 (이중 차감 방지)
            let holidayCount = 0;
            holidays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) {
                    const parts = dateKey.split('-');
                    const day = parseInt(parts[2]);
                    const date = new Date(selectedYear, selectedMonth - 1, day);
                    if (date.getDay() !== 0) { // 일요일이 아닌 공휴일만 카운트
                        holidayCount++;
                    }
                }
            });

            let excusedAbsentCount = 0;
            excusedAbsents.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) excusedAbsentCount++;
            });

            let unexcusedAbsentCount = 0;
            absents.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) unexcusedAbsentCount++;
            });

            let annualLeaveCount = 0;
            annualLeaveDays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) annualLeaveCount++;
            });

            let specialLeaveCount = 0;
            specialLeaveDays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) specialLeaveCount++;
            });

            let sickLeaveCount = 0;
            sickLeaveDays.forEach(dateKey => {
                if (isSelectedMonth(dateKey)) sickLeaveCount++;
            });

            const totalAbsentCount = excusedAbsentCount + unexcusedAbsentCount;

            // 평일 = 월~토 (총일수 - 일요일)
            const weekdays = daysInMonth - sundays;

            // 일요일 특근 일수 카운트 (8시간 이상 일하면 식대 지급 - 실근무일에는 포함 안됨)
            let sundayWorkDays = 0;
            Object.keys(sundayData).forEach(key => {
                if (isSelectedMonth(key) && sundayData[key] >= 8) {
                    sundayWorkDays++;
                }
            });

            // 실 근무일 = 평일 - 공휴일 - 모든 결근 - 연차 - 경조사 - 병가 (일요일 특근은 실근무일에 포함 안함)
            const workDays = weekdays - holidayCount - totalAbsentCount - annualLeaveCount - specialLeaveCount - sickLeaveCount;

            // isNightShiftDay() 는 전역 함수로 정의됨 (802줄 근처)

            // 야간조 시간 분배 설정값 가져오기
            const nightNormalHoursSetting = (window.companySettings && window.companySettings.nightNormalHours) || 4.5;
            const nightNightHoursSetting = (window.companySettings && window.companySettings.nightNightHours) || 3.5;

            // 실제 정규 근무시간 계산 (각 날짜의 실제 시간 합산)
            // 야간조 날짜: 정규시간을 100%/130%로 분배
            let normalHours = 0;
            let autoNightHours = 0;  // 야간조 130% 시간 (자동 계산)
            let autoNightOTHours = 0;  // 야간조 야근시간 → 야간OT 200%로 변환

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;
                const isNightDay = isNightShiftDay(day);

                // 제외할 날:
                // - 일요일
                // - 공휴일 (일요일 아닌)
                // - 사유결근 (무급)
                // - 무단결근
                if (dayOfWeek === 0) {
                    // 일요일은 제외
                    continue;
                }
                if ((holidays.has(dateKey) || holidays.has(dateKeyOld)) && dayOfWeek !== 0) {
                    // 공휴일 (일요일 아닌) 제외
                    continue;
                }
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) {
                    // 사유결근 제외 (무급 휴가)
                    continue;
                }
                if (absents.has(dateKey) || absents.has(dateKeyOld)) {
                    // 무단결근 제외
                    continue;
                }
                if (sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld)) {
                    // 병가 제외 (사회보험에서 지급)
                    continue;
                }

                // 정상 근무, 연차, 또는 경조사
                const dayNormalHours = (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld))
                    ? 8  // 연차 = 8시간 유급 인정!
                    : (specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld))
                    ? 8  // 경조사 = 8시간 유급 인정! (베트남 노동법 제115조)
                    : (normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8);

                if (isNightDay) {
                    // 야간조 날짜: 순차 방식으로 분배
                    // 100% 시간(17:30~22:00) 먼저 채우고, 나머지가 130%(22:00~02:30)
                    if (dayNormalHours <= nightNormalHoursSetting) {
                        // 조기퇴근: 100% 시간만 채움 (22시 이전 퇴근)
                        normalHours += dayNormalHours;
                    } else {
                        // 정상 또는 초과: 100% 먼저 채우고 나머지는 130%
                        normalHours += nightNormalHoursSetting;  // 100% 부분 (4.5시간)
                        autoNightHours += dayNormalHours - nightNormalHoursSetting;  // 130% 부분
                    }
                } else {
                    // 주간조: 일반 정규시간 (100%)
                    normalHours += dayNormalHours;
                }
            }

            // 회사 설정 불러오기 (window.companySettings 사용 - 이미 updateStats()에서 로드됨)
            const lunchMeal = (window.companySettings && window.companySettings.lunchMeal) || 25000;
            const dinnerMeal = (window.companySettings && window.companySettings.dinnerMeal) || 25000;
            const weekdayDinnerHours = (window.companySettings && window.companySettings.weekdayDinnerHours) || 3;
            const sundayLunchHours = (window.companySettings && window.companySettings.sundayLunchHours) || 4;
            const sundayDinnerHours = (window.companySettings && window.companySettings.sundayDinnerHours) || 12;
            const annualLeaveLunchMeal = (window.companySettings && window.companySettings.annualLeaveLunchMeal) === true;
            const excusedAbsenceLunchMeal = (window.companySettings && window.companySettings.excusedAbsenceLunchMeal) === true;
            const sickLeaveLunchMeal = (window.companySettings && window.companySettings.sickLeaveLunchMeal) === true;
            const specialLeaveLunchMeal = (window.companySettings && window.companySettings.specialLeaveLunchMeal) === true;

            // 식대 세부 계산
            let weekdayLunchCount = 0;  // 평일 점심 (주간조)
            let weekdayDinnerCount = 0;  // 평일 저녁 (야근 or 야간조)
            let sundayLunchMealCount = 0;  // 일요일 점심
            let sundayDinnerMealCount = 0;  // 일요일 저녁
            let annualLeaveLunchCount = 0;  // 연차 점심
            let excusedAbsentLunchCount = 0;  // 사유결근 점심
            let sickLeaveLunchCount = 0;  // 병가 점심
            let specialLeaveLunchCount = 0;  // 경조사 점심

            // 야간조 근무일 수 계산 (점심 대신 저녁 지급용)
            let nightShiftWorkDays = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek !== 0 && isNightShiftDay(day)) {
                    // 야간조 날짜: 연차/공휴일/결근일 제외
                    const isExcluded = annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                                       holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                                       absents.has(dateKey) || absents.has(dateKeyOld);
                    if (!isExcluded) {
                        nightShiftWorkDays++;
                    }
                }
            }

            // 1. 평일 점심 (주간조 근무일만 - 야간조 제외)
            weekdayLunchCount = workDays - nightShiftWorkDays;

            // 2. 연차 시 점심 (설정에 따라)
            if (annualLeaveLunchMeal) {
                annualLeaveLunchCount = annualLeaveCount;
            }

            // 3. 사유결근 시 점심 (설정에 따라)
            if (excusedAbsenceLunchMeal) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(selectedYear, selectedMonth - 1, day);
                    const dayOfWeek = date.getDay();
                    const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                    const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                    if (dayOfWeek !== 0 && (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld))) {
                        excusedAbsentLunchCount++;
                    }
                }
            }

            // 4. 병가 시 점심 (설정에 따라)
            if (sickLeaveLunchMeal) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(selectedYear, selectedMonth - 1, day);
                    const dayOfWeek = date.getDay();
                    const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                    const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                    if (dayOfWeek !== 0 && (sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld))) {
                        sickLeaveLunchCount++;
                    }
                }
            }

            // 5. 경조사 시 점심 (설정에 따라)
            if (specialLeaveLunchMeal) {
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(selectedYear, selectedMonth - 1, day);
                    const dayOfWeek = date.getDay();
                    const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                    const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                    if (dayOfWeek !== 0 && (specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld))) {
                        specialLeaveLunchCount++;
                    }
                }
            }

            // 6. 평일 저녁 (야간조: 자동 지급 / 주간조: OT 조건)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek !== 0) {  // 일요일 제외
                    // 연차/공휴일/결근/경조사/병가는 저녁식대 제외
                    const isExcluded = annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                                       holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                                       absents.has(dateKey) || absents.has(dateKeyOld) ||
                                       excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld) ||
                                       specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld) ||
                                       sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld);
                    if (!isExcluded) {
                        if (isNightShiftDay(day)) {
                            // 야간조: 저녁 식대 자동 지급 (OT 상관없이)
                            weekdayDinnerCount++;
                        } else {
                            // 주간조: OT 조건 충족 시만 저녁 식대
                            const overtime = overtimeData[dateKey] || overtimeData[dateKeyOld] || 0;
                            if (overtime >= weekdayDinnerHours) {
                                weekdayDinnerCount++;
                            }
                        }
                    }
                }
            }

            // 7. 일요일 점심 및 저녁 (총 근무 조건)
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(selectedYear, selectedMonth - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(selectedYear, selectedMonth, day);
                const dateKeyOld = `${selectedYear}-${selectedMonth}-${day}`;

                if (dayOfWeek === 0) {  // 일요일만
                    // 연차/공휴일/결근/경조사/병가는 식대 제외
                    const isExcluded = annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld) ||
                                       holidays.has(dateKey) || holidays.has(dateKeyOld) ||
                                       absents.has(dateKey) || absents.has(dateKeyOld) ||
                                       excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld) ||
                                       specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld) ||
                                       sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld);
                    if (!isExcluded) {
                        const totalHours = sundayData[dateKey] || sundayData[dateKeyOld] || 0;
                        if (totalHours >= sundayLunchHours) {
                            sundayLunchMealCount++;
                        }
                        // 8. 일요일 저녁 (총 근무 조건)
                        if (totalHours >= sundayDinnerHours) {
                            sundayDinnerMealCount++;
                        }
                    }
                }
            }

            // 총 식대 계산
            const mealAllowance = (weekdayLunchCount * lunchMeal) +
                                  (weekdayDinnerCount * dinnerMeal) +
                                  (sundayLunchMealCount * lunchMeal) +
                                  (sundayDinnerMealCount * dinnerMeal) +
                                  (annualLeaveLunchCount * lunchMeal) +
                                  (excusedAbsentLunchCount * lunchMeal) +
                                  (sickLeaveLunchCount * lunchMeal) +
                                  (specialLeaveLunchCount * lunchMeal);

            // 동적 수당 시스템
            // 총 근무 가능일 = 평일 - 공휴일 (일요일 제외한 실제 일할 수 있는 날)
            const totalWorkableDays = daysInMonth - sundays - holidayCount;
            const attendanceRate = totalWorkableDays > 0 ? (totalWorkableDays - excusedAbsentCount - annualLeaveCount) / totalWorkableDays : 0;

            // 회사 설정에서 수당 목록 불러오기 (window.companySettings 사용!)
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            console.log('📊 allowances 로드됨:', allowances.length, '개', allowances);
            let totalAllowances = 0;
            currentAllowanceDetails = {}; // 전역 변수에 저장 (calculate()에서도 사용)

            allowances.forEach(allowance => {
                if (!allowance.enabled) {
                    currentAllowanceDetails[allowance.id] = 0;
                    return;
                }

                let amount = 0;

                // 무단결근이 있는 경우
                if (unexcusedAbsentCount > 0) {
                    if (allowance.onAbsence === 'zero') {
                        amount = 0;
                    } else if (allowance.onAbsence === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // 사유결근이 있는 경우
                else if (excusedAbsentCount > 0) {
                    const excusedAbsenceRule = allowance.onExcusedAbsence || 'proportional';
                    if (excusedAbsenceRule === 'zero') {
                        amount = 0;
                    } else if (excusedAbsenceRule === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // 정상 출근 (연차만 있거나 완전 정상)
                else {
                    if (allowance.onAnnualLeave === 'zero' && annualLeaveCount > 0) {
                        amount = 0;
                    } else if (allowance.onAnnualLeave === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }

                currentAllowanceDetails[allowance.id] = amount;
                totalAllowances += amount;
            });

            // 하위 호환성: 기존 하드코딩된 수당 변수 유지 (계산 함수에서 사용)
            let attendanceBonus = 0;
            let transportBonus = 0;
            let riskAllowance = 0;

            // 기존 ID로 매핑 (마이그레이션된 수당들)
            allowances.forEach(allowance => {
                if (allowance.id === 'allowance_attendance') attendanceBonus = currentAllowanceDetails[allowance.id] || 0;
                if (allowance.id === 'allowance_transport') transportBonus = currentAllowanceDetails[allowance.id] || 0;
                if (allowance.id === 'allowance_risk') riskAllowance = currentAllowanceDetails[allowance.id] || 0;
            });

            // 총 야근시간 계산 (연차/공휴일/결근일 제외)
            // 야간조 주간이면 야근 → 야간OT로 자동 변환
            let totalOvertime = 0;
            Object.keys(overtimeData).forEach(key => {
                if (isSelectedMonth(key)) {
                    // 연차/공휴일/결근일은 제외
                    if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                        // 날짜에서 day 추출
                        const parts = key.split('-');
                        const day = parseInt(parts[2]);
                        if (isNightShiftDay(day)) {
                            // 야간조 주간: 야근 → 야간OT로
                            autoNightOTHours += overtimeData[key];
                        } else {
                            // 주간조: 일반 야근
                            totalOvertime += overtimeData[key];
                        }
                    }
                }
            });

            // 총 일요일 특근시간 계산 (연차/공휴일/결근일 제외)
            let totalSunday = 0;
            Object.keys(sundayData).forEach(key => {
                if (isSelectedMonth(key)) {
                    // 연차/공휴일/결근일은 제외
                    if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                        totalSunday += sundayData[key];
                    }
                }
            });

            // 총 야간 시간 계산 (130%) - 수동 입력 + 야간조 정규시간
            let totalNight = autoNightHours;  // 야간조 주간의 정규시간
            Object.keys(nightData).forEach(key => {
                if (isSelectedMonth(key)) {
                    if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                        totalNight += nightData[key];
                    }
                }
            });

            // 총 야간+OT 시간 계산 (200%) - 수동 입력 + 야간조 야근시간
            let totalNightOT = autoNightOTHours;  // 야간조 주간의 야근시간
            Object.keys(nightOTData).forEach(key => {
                if (isSelectedMonth(key)) {
                    if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                        totalNightOT += nightOTData[key];
                    }
                }
            });

            document.getElementById('totalDays').textContent = daysInMonth + '일';
            document.getElementById('weekdays').textContent = weekdays + '일';
            document.getElementById('weekends').textContent = sundays + '일';
            document.getElementById('holidays').textContent = holidayCount + '일';
            document.getElementById('excusedAbsents').textContent = excusedAbsentCount + '일';
            document.getElementById('unexcusedAbsents').textContent = unexcusedAbsentCount + '일';
            document.getElementById('annualLeaveCount').textContent = annualLeaveCount + '일';
            document.getElementById('workDays').textContent = workDays + '일';
            document.getElementById('normalHours').textContent = normalHours + 'h';
            document.getElementById('totalOvertimeDisplay').textContent = totalOvertime + 'h';
            document.getElementById('totalSundayDisplay').textContent = totalSunday + 'h';
            document.getElementById('totalNightDisplay').textContent = totalNight + 'h';
            document.getElementById('totalNightOTDisplay').textContent = totalNightOT + 'h';
            document.getElementById('autoMeal').textContent = formatNumber(mealAllowance) + 'đ';

            // 총 식사 수 계산
            const totalMealCount = weekdayLunchCount + weekdayDinnerCount + sundayLunchMealCount +
                                   sundayDinnerMealCount + annualLeaveLunchCount + excusedAbsentLunchCount;
            document.getElementById('totalMealCount').textContent = totalMealCount + '식';

            // 식대 세부 내역 표시 (0식인 항목은 숨기기)
            document.getElementById('weekdayLunchCount').textContent = weekdayLunchCount + '식';
            document.getElementById('statsWeekdayLunchRow').style.display = weekdayLunchCount > 0 ? '' : 'none';

            document.getElementById('weekdayDinnerCount').textContent = weekdayDinnerCount + '식';
            document.getElementById('statsWeekdayDinnerRow').style.display = weekdayDinnerCount > 0 ? '' : 'none';

            document.getElementById('sundayLunchCount').textContent = sundayLunchMealCount + '식';
            document.getElementById('statsSundayLunchRow').style.display = sundayLunchMealCount > 0 ? '' : 'none';

            document.getElementById('sundayDinnerCount').textContent = sundayDinnerMealCount + '식';
            document.getElementById('statsSundayDinnerRow').style.display = sundayDinnerMealCount > 0 ? '' : 'none';

            document.getElementById('annualLeaveLunchCount').textContent = annualLeaveLunchCount + '식';
            document.getElementById('statsAnnualLeaveLunchRow').style.display = annualLeaveLunchCount > 0 ? '' : 'none';

            document.getElementById('excusedAbsentLunchCount').textContent = excusedAbsentLunchCount + '식';
            document.getElementById('statsExcusedAbsentLunchRow').style.display = excusedAbsentLunchCount > 0 ? '' : 'none';

            document.getElementById('attendanceBonus').textContent = formatNumber(attendanceBonus) + 'đ';
            document.getElementById('transportBonus').textContent = formatNumber(transportBonus) + 'đ';
            document.getElementById('riskDisplay').textContent = formatNumber(riskAllowance) + ' đ';

            // 하드코딩된 수당 컨테이너 show/hide (settings 설정 + 금액에 따라)
            const attendanceAllowance = allowances.find(a => a.id === 'allowance_attendance');
            const transportAllowance = allowances.find(a => a.id === 'allowance_transport');
            const riskAllowance_obj = allowances.find(a => a.id === 'allowance_risk');

            // 통계 영역 (enabled=true이고 금액 > 0일 때만 표시)
            const attendanceContainer = document.getElementById('attendanceBonusContainer');
            if (attendanceContainer) {
                attendanceContainer.style.display = (attendanceAllowance && attendanceAllowance.enabled && attendanceBonus > 0) ? '' : 'none';
            }
            const transportContainer = document.getElementById('transportBonusContainer');
            if (transportContainer) {
                transportContainer.style.display = (transportAllowance && transportAllowance.enabled && transportBonus > 0) ? '' : 'none';
            }

            // 동적 수당 목록 표시 (추가 수당만 - 기존 3개는 위에 이미 표시됨)
            const dynamicAllowancesListEl = document.getElementById('dynamicAllowancesList');
            if (dynamicAllowancesListEl) {
                console.log('=== 동적 수당 렌더링 시작 ===');
                console.log('전체 수당 목록:', allowances);
                console.log('수당 상세:', currentAllowanceDetails);

                let allowancesHTML = '';
                allowances.forEach(allowance => {
                    console.log(`수당 체크: ${allowance.name}, enabled: ${allowance.enabled}, id: ${allowance.id}`);

                    if (!allowance.enabled) {
                        console.log(`  → ${allowance.name} 비활성화됨, 스킵`);
                        return;
                    }

                    // 기존 3개 수당은 제외 (이미 위에서 표시됨)
                    if (allowance.id === 'allowance_attendance' ||
                        allowance.id === 'allowance_transport' ||
                        allowance.id === 'allowance_risk') {
                        console.log(`  → ${allowance.name} 기존 수당, 스킵`);
                        return;
                    }

                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {  // 0원인 수당은 표시하지 않음
                        console.log(`  → ${allowance.name} 표시! 금액: ${amount}`);

                        allowancesHTML += `
                            <div class="stat-item" style="border-left-color: #4caf50;">
                                <span class="stat-label" style="color: #4caf50;">🎁 ${allowance.name}</span>
                                <span class="stat-value" style="color: #4caf50;">${formatNumber(amount)}đ</span>
                            </div>
                        `;
                    } else {
                        console.log(`  → ${allowance.name} 금액 0원, 스킵`);
                    }
                });

                console.log('생성된 HTML:', allowancesHTML);
                dynamicAllowancesListEl.innerHTML = allowancesHTML;
                console.log('=== 동적 수당 렌더링 완료 ===');
            }

            // 연차 현황 업데이트
            if (currentEmployeeId && employees[currentEmployeeId]) {
                const emp = employees[currentEmployeeId];
                const annualLeaveTotal = emp.annualLeavePerYear || 12;
                const annualLeaveAdjustment = emp.annualLeaveAdjustment || 0; // 조정값 (+ 이월 또는 - 선사용)

                // 현재 연도의 전체 연차 사용일 카운트 (leaveData 기반)
                // annual(연차) + sick(병가) = 연차에서 차감
                // special(경조사/특별휴가) = 별도 (연차 차감 안 함)
                let totalAnnualLeaveUsed = 0;
                if (emp.leaveData) {
                    Object.entries(emp.leaveData).forEach(([dateKey, leaveType]) => {
                        if ((leaveType === 'annual' || leaveType === 'sick') && dateKey.startsWith(selectedYear + '-')) {
                            totalAnnualLeaveUsed++;
                        }
                    });
                }

                // 사용가능 연차 (음수 허용)
                const annualLeaveAvailable = annualLeaveTotal + annualLeaveAdjustment - totalAnnualLeaveUsed;

                document.getElementById('annualLeaveTotal').textContent = annualLeaveTotal + '일';

                // 조정값 표시 (+이면 초록, -이면 빨강)
                const adjustmentText = annualLeaveAdjustment >= 0 ? `+${annualLeaveAdjustment}일` : `${annualLeaveAdjustment}일`;
                const adjustmentColor = annualLeaveAdjustment >= 0 ? '#4caf50' : '#e53935';
                document.getElementById('annualLeavePreUsed').textContent = adjustmentText;
                document.getElementById('annualLeavePreUsed').style.color = adjustmentColor;

                document.getElementById('annualLeaveThisMonth').textContent = annualLeaveCount + '일';

                // 연차 잔여 표시 (음수면 경고)
                const remainingEl = document.getElementById('annualLeaveRemaining');
                if (annualLeaveAvailable < 0) {
                    remainingEl.textContent = `${annualLeaveAvailable}일 ⚠️`;
                    remainingEl.style.color = '#f44336';
                    remainingEl.style.fontWeight = 'bold';

                    // 초과 사유 표시
                    const leaveReasons = emp.leaveReasons || {};
                    const reasonsForYear = Object.entries(leaveReasons)
                        .filter(([dateKey]) => dateKey.startsWith(selectedYear + '-'))
                        .map(([dateKey, reason]) => `${dateKey}: ${reason}`)
                        .join('\n');

                    if (reasonsForYear && !remainingEl.dataset.warned) {
                        remainingEl.dataset.warned = 'true';
                        setTimeout(() => {
                            alert(`⚠️ 연차 초과 사용 (${Math.abs(annualLeaveAvailable)}일)\n\n[사유]\n${reasonsForYear}`);
                        }, 500);
                    }
                } else {
                    remainingEl.textContent = annualLeaveAvailable + '일';
                    remainingEl.style.color = '#4caf50';
                    remainingEl.style.fontWeight = 'bold';
                    delete remainingEl.dataset.warned;
                }
            }

            // 야근시간 자동 입력
            document.getElementById('overtimeHours').value = totalOvertime;

            // 일요일 특근시간 자동 입력
            document.getElementById('sundayHours').value = totalSunday;

            // 야간 시간 자동 입력
            document.getElementById('nightHours').value = totalNight;

            // 야간+OT 시간 자동 입력
            document.getElementById('nightOTHours').value = totalNightOT;

            // 동적 수당 총액 저장 (식대 제외)
            document.getElementById('totalAllowancesHidden').value = totalAllowances;
        }

        // 급여 계산
        function calculate() {
            // 회사 설정 다시 로드 (settings.html에서 수당 추가했을 때 반영되도록)
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            if (storedSettings) {
                window.companySettings = JSON.parse(storedSettings);
                console.log('🔄 급여 계산 시 회사 설정 다시 로드됨:', window.companySettings);
                console.log('수당 개수:', (window.companySettings.allowances || []).length);
            }

            const employeeName = document.getElementById('employeeName').value || '직원';
            const basicSalary = parseMoneyInput(document.getElementById('basicSalary').value);
            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;

            // 통계에서 계산된 실제 정규시간 가져오기
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const absentCount = absents.size;

            // 시간당 급여 (월별 근무일수 기준)
            const weekdaysText = document.getElementById('weekdays').textContent;
            const weekdays = parseFloat(weekdaysText.replace('일', '')) || 26;
            const monthlyHours = weekdays * 8;
            const hourlyRate = monthlyHours > 0 ? basicSalary / monthlyHours : 0;

            // 야간+OT 시간 가져오기
            const nightOTHours = parseFloat(document.getElementById('nightOTHours')?.value) || 0;

            // 급여 계산
            const normalPay = hourlyRate * normalHours;
            const overtimePay = hourlyRate * overtimeHours * 1.5;
            const nightPay = hourlyRate * nightHours * 1.3;
            // 야간+OT 비율 (설정에서 가져오기, 기본값 2.0 = 200%)
            const nightOTRate = (window.companySettings && window.companySettings.nightOTRate) || 2.0;
            const nightOTPay = hourlyRate * nightOTHours * nightOTRate;
            const sundayPay = hourlyRate * sundayHours * 2.0;

            // 자동 수당 (통계에서 계산된 값 사용)
            const mealAllowanceText = document.getElementById('autoMeal').textContent;
            const mealAllowance = parseFloat(mealAllowanceText.replace(/[^\d]/g, '')) || 0;

            // 회사 설정에서 식대 금액 가져오기 (window.companySettings 사용)
            const lunchMeal = (window.companySettings && window.companySettings.lunchMeal) || 25000;
            const dinnerMeal = (window.companySettings && window.companySettings.dinnerMeal) || 25000;

            // 식대 세부 내역 (통계에서 계산된 식사 수 가져오기)
            const weekdayLunchCountText = document.getElementById('weekdayLunchCount').textContent;
            const weekdayLunchCount = parseInt(weekdayLunchCountText.replace(/[^\d]/g, '')) || 0;
            const weekdayDinnerCountText = document.getElementById('weekdayDinnerCount').textContent;
            const weekdayDinnerCount = parseInt(weekdayDinnerCountText.replace(/[^\d]/g, '')) || 0;
            const sundayLunchCountText = document.getElementById('sundayLunchCount').textContent;
            const sundayLunchCount = parseInt(sundayLunchCountText.replace(/[^\d]/g, '')) || 0;
            const sundayDinnerCountText = document.getElementById('sundayDinnerCount').textContent;
            const sundayDinnerCount = parseInt(sundayDinnerCountText.replace(/[^\d]/g, '')) || 0;
            const annualLeaveLunchCountText = document.getElementById('annualLeaveLunchCount').textContent;
            const annualLeaveLunchCount = parseInt(annualLeaveLunchCountText.replace(/[^\d]/g, '')) || 0;
            const excusedAbsentLunchCountText = document.getElementById('excusedAbsentLunchCount').textContent;
            const excusedAbsentLunchCount = parseInt(excusedAbsentLunchCountText.replace(/[^\d]/g, '')) || 0;

            // 동적 수당 총액 가져오기 (updateStats()에서 계산됨)
            const dynamicAllowances = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;

            // 하위 호환성: 개별 수당 값도 읽기 (화면 표시용)
            const attendanceBonusText = document.getElementById('attendanceBonus').textContent;
            const attendanceBonus = parseFloat(attendanceBonusText.replace(/[^\d]/g, '')) || 0;

            const transportBonusText = document.getElementById('transportBonus').textContent;
            const transportAllowance = parseFloat(transportBonusText.replace(/[^\d]/g, '')) || 0;

            const riskAllowanceText = document.getElementById('riskDisplay').textContent;
            const riskAllowance = parseFloat(riskAllowanceText.replace(/[^\d]/g, '')) || 0;

            // 특수수당 가져오기
            const specialAllowanceEnabled = document.getElementById('specialAllowanceEnabled')?.checked || false;
            const specialAllowance = specialAllowanceEnabled ?
                parseMoneyInput(document.getElementById('specialAllowanceAmount')?.value) : 0;

            // 총 급여 (동적 수당 시스템 + 특수수당)
            const totalSalary = normalPay + overtimePay + nightPay + nightOTPay + sundayPay +
                              mealAllowance + dynamicAllowances + specialAllowance;

            // 회사 부담금 (기본급 기준) - 참고용
            const companySocialIns = basicSalary * 0.175;
            const companyHealthIns = basicSalary * 0.03;
            const companyUnemployIns = basicSalary * 0.01;
            const totalCompanyIns = companySocialIns + companyHealthIns + companyUnemployIns;

            // 보험 미가입자 확인
            const isInsuranceExempt = currentEmployeeId && employees[currentEmployeeId]
                ? (employees[currentEmployeeId].insuranceExempt || false)
                : false;

            // 근로자 보험료 (기본급 기준) - 보험 미가입자는 0원
            const socialIns = isInsuranceExempt ? 0 : basicSalary * 0.08;
            const healthIns = isInsuranceExempt ? 0 : basicSalary * 0.015;
            const unemployIns = isInsuranceExempt ? 0 : basicSalary * 0.01;

            // 총 공제 (10.5%) - 보험 미가입자는 0원
            const totalDeduction = socialIns + healthIns + unemployIns;

            // 개인소득세 계산 (보험 미가입자는 소득세도 면제)
            const dependents = parseInt(document.getElementById('dependents').value) || 0;
            let incomeTax = 0;

            // 변수 초기화 (보험 미가입자도 표시용으로 필요)
            const selfDeduction = 11000000; // 본인
            const dependentDeduction = dependents * 4400000; // 부양가족
            const totalFamilyDeduction = selfDeduction + dependentDeduction;
            let taxableIncome = 0;
            let taxBase = 0;

            if (!isInsuranceExempt) {
            // 과세 대상 소득 계산 (베트남 세법)
            // - 식대: 100% 비과세
            // - 야근 수당: 1/3 비과세, 2/3만 과세
            // - 일요일 특근: 1/2 비과세, 1/2만 과세
            taxableIncome = normalPay                           // 정규급여: 전액 과세
                                + (overtimePay * 2/3)           // 야근: 2/3만 과세
                                + nightPay                       // 야간: 전액 과세
                                + nightOTPay                     // 야간+OT: 전액 과세
                                + (sundayPay * 1/2)             // 특근: 1/2만 과세
                                + dynamicAllowances              // 모든 수당: 전액 과세
                                + specialAllowance               // 특수수당: 전액 과세
                                // 식대(mealAllowance)는 제외: 비과세
                                - totalDeduction;                // 보험료 공제

            // 과세 표준 = 과세 대상 소득 - 가족 공제
            taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            // 누진세율 계산
            if (taxBase > 0) {
                // Bậc 1: 0 - 5,000,000 (5%)
                if (taxBase > 0) {
                    const tier1 = Math.min(taxBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    taxBase -= tier1;
                }
                // Bậc 2: 5,000,001 - 10,000,000 (10%)
                if (taxBase > 0) {
                    const tier2 = Math.min(taxBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    taxBase -= tier2;
                }
                // Bậc 3: 10,000,001 - 18,000,000 (15%)
                if (taxBase > 0) {
                    const tier3 = Math.min(taxBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    taxBase -= tier3;
                }
                // Bậc 4: 18,000,001 - 32,000,000 (20%)
                if (taxBase > 0) {
                    const tier4 = Math.min(taxBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    taxBase -= tier4;
                }
                // Bậc 5: 32,000,001 - 52,000,000 (25%)
                if (taxBase > 0) {
                    const tier5 = Math.min(taxBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    taxBase -= tier5;
                }
                // Bậc 6: 52,000,001 - 80,000,000 (30%)
                if (taxBase > 0) {
                    const tier6 = Math.min(taxBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    taxBase -= tier6;
                }
                // Bậc 7: 80,000,001 이상 (35%)
                if (taxBase > 0) {
                    incomeTax += taxBase * 0.35;
                }
            }
            } // end if (!isInsuranceExempt)

            // 선금 가져오기
            const advancePaymentEnabled = document.getElementById('advancePaymentEnabled')?.checked || false;
            const advancePayment = advancePaymentEnabled ?
                parseMoneyInput(document.getElementById('advancePaymentAmount')?.value) : 0;

            // 실수령액 = 총 급여 - 보험료 - 개인소득세 - 선금
            const netSalary = totalSalary - totalDeduction - incomeTax - advancePayment;

            // 결과 표시
            document.getElementById('employeeNameResult').textContent = employeeName + ' 님';
            document.getElementById('hourlyRate').textContent = formatNumber(hourlyRate) + ' đ/시간';
            document.getElementById('normalPay').textContent = formatNumber(normalPay) + ' đ';
            document.getElementById('overtimePay').textContent = formatNumber(overtimePay) + ' đ';
            document.getElementById('nightPay').textContent = formatNumber(nightPay) + ' đ';
            // 야간+OT 표시 (야간 근무 설정 활성화 시)
            document.getElementById('nightOTPay').textContent = formatNumber(nightOTPay) + ' đ';
            document.getElementById('nightOTPayRow').style.display =
                (window.companySettings && window.companySettings.nightShiftEnabled) ? '' : 'none';
            // 야간+OT 라벨 동적 업데이트
            const nightOTPayLabel = document.getElementById('nightOTPayLabel');
            if (nightOTPayLabel) {
                const ratePercent = Math.round(nightOTRate * 100);
                nightOTPayLabel.textContent = `야간+OT 수당 (${ratePercent}%)`;
            }
            document.getElementById('sundayPay').textContent = formatNumber(sundayPay) + ' đ';
            document.getElementById('mealDisplay').textContent = formatNumber(mealAllowance) + ' đ';

            // 총 식사 수 계산
            const totalMealCount = weekdayLunchCount + weekdayDinnerCount + sundayLunchCount +
                                   sundayDinnerCount + annualLeaveLunchCount + excusedAbsentLunchCount;
            document.getElementById('resultTotalMealCount').textContent = totalMealCount + '식';

            // 식대 세부 내역 표시 (0식인 항목은 숨기기)
            document.getElementById('resultWeekdayLunch').textContent = weekdayLunchCount + '식';
            document.getElementById('resultWeekdayLunchAmount').textContent = formatNumber(weekdayLunchCount * lunchMeal) + ' đ';
            document.getElementById('resultWeekdayLunchRow').style.display = weekdayLunchCount > 0 ? '' : 'none';

            document.getElementById('resultWeekdayDinner').textContent = weekdayDinnerCount + '식';
            document.getElementById('resultWeekdayDinnerAmount').textContent = formatNumber(weekdayDinnerCount * dinnerMeal) + ' đ';
            document.getElementById('resultWeekdayDinnerRow').style.display = weekdayDinnerCount > 0 ? '' : 'none';

            document.getElementById('resultSundayLunch').textContent = sundayLunchCount + '식';
            document.getElementById('resultSundayLunchAmount').textContent = formatNumber(sundayLunchCount * lunchMeal) + ' đ';
            document.getElementById('resultSundayLunchRow').style.display = sundayLunchCount > 0 ? '' : 'none';

            document.getElementById('resultSundayDinner').textContent = sundayDinnerCount + '식';
            document.getElementById('resultSundayDinnerAmount').textContent = formatNumber(sundayDinnerCount * dinnerMeal) + ' đ';
            document.getElementById('resultSundayDinnerRow').style.display = sundayDinnerCount > 0 ? '' : 'none';

            document.getElementById('resultAnnualLeaveLunch').textContent = annualLeaveLunchCount + '식';
            document.getElementById('resultAnnualLeaveLunchAmount').textContent = formatNumber(annualLeaveLunchCount * lunchMeal) + ' đ';
            document.getElementById('resultAnnualLeaveLunchRow').style.display = annualLeaveLunchCount > 0 ? '' : 'none';

            document.getElementById('resultExcusedAbsentLunch').textContent = excusedAbsentLunchCount + '식';
            document.getElementById('resultExcusedAbsentLunchAmount').textContent = formatNumber(excusedAbsentLunchCount * lunchMeal) + ' đ';
            document.getElementById('resultExcusedAbsentLunchRow').style.display = excusedAbsentLunchCount > 0 ? '' : 'none';

            // 기존 하드코딩된 수당 표시
            document.getElementById('attendanceBonusDisplay').textContent = formatNumber(attendanceBonus) + ' đ';
            document.getElementById('transportDisplay').textContent = formatNumber(transportAllowance) + ' đ';
            document.getElementById('riskDisplay').textContent = formatNumber(riskAllowance) + ' đ';

            // 하드코딩된 수당 컨테이너 show/hide (결과 영역 - enabled=true이고 금액 > 0일 때만 표시)
            const attendanceAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_attendance');
            const transportAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_transport');
            const riskAllowanceObj = ((window.companySettings && window.companySettings.allowances) || []).find(a => a.id === 'allowance_risk');

            const attendanceResultContainer = document.getElementById('attendanceBonusResultContainer');
            if (attendanceResultContainer) {
                attendanceResultContainer.style.display = (attendanceAllowanceObj && attendanceAllowanceObj.enabled && attendanceBonus > 0) ? '' : 'none';
            }
            const transportResultContainer = document.getElementById('transportBonusResultContainer');
            if (transportResultContainer) {
                transportResultContainer.style.display = (transportAllowanceObj && transportAllowanceObj.enabled && transportAllowance > 0) ? '' : 'none';
            }
            const riskResultContainer = document.getElementById('riskDisplayResultContainer');
            if (riskResultContainer) {
                riskResultContainer.style.display = (riskAllowanceObj && riskAllowanceObj.enabled && riskAllowance > 0) ? '' : 'none';
            }

            // 결과 섹션에 동적 수당 목록 표시 (추가 수당만, 금액 > 0인 것만)
            const resultDynamicAllowancesListEl = document.getElementById('resultDynamicAllowancesList');
            if (resultDynamicAllowancesListEl) {
                let resultAllowancesHTML = '';
                const allowances = (window.companySettings && window.companySettings.allowances) || [];
                allowances.forEach(allowance => {
                    if (!allowance.enabled) return;
                    // 기존 3개 수당은 제외 (이미 위에서 표시됨)
                    if (allowance.id === 'allowance_attendance' ||
                        allowance.id === 'allowance_transport' ||
                        allowance.id === 'allowance_risk') {
                        return;
                    }

                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {  // 0원인 수당은 표시하지 않음
                        resultAllowancesHTML += `
                            <div class="result-item" style="background: #e8f5e9;">
                                <span class="result-label">🎁 ${allowance.name}</span>
                                <span class="result-value" style="color: #4caf50;">${formatNumber(amount)} đ</span>
                            </div>
                        `;
                    }
                });
                resultDynamicAllowancesListEl.innerHTML = resultAllowancesHTML;
            }

            // 특수수당 표시
            const specialAllowanceContainer = document.getElementById('specialAllowanceResultContainer');
            if (specialAllowanceContainer) {
                if (specialAllowance > 0) {
                    specialAllowanceContainer.style.display = 'flex';
                    document.getElementById('specialAllowanceResult').textContent = formatNumber(specialAllowance) + ' đ';
                } else {
                    specialAllowanceContainer.style.display = 'none';
                }
            }

            // 선금 표시
            const advancePaymentContainer = document.getElementById('advancePaymentResultContainer');
            if (advancePaymentContainer) {
                if (advancePayment > 0) {
                    advancePaymentContainer.style.display = 'block';
                    document.getElementById('advancePaymentResult').textContent = formatNumber(advancePayment) + ' đ';
                } else {
                    advancePaymentContainer.style.display = 'none';
                }
            }

            // 회사 부담금 표시
            document.getElementById('companySocialIns').textContent = formatNumber(companySocialIns) + ' đ';
            document.getElementById('companyHealthIns').textContent = formatNumber(companyHealthIns) + ' đ';
            document.getElementById('companyUnemployIns').textContent = formatNumber(companyUnemployIns) + ' đ';
            document.getElementById('totalCompanyIns').textContent = formatNumber(totalCompanyIns) + ' đ';

            // 근로자 공제 표시
            document.getElementById('socialIns').textContent = formatNumber(socialIns) + ' đ';
            document.getElementById('healthIns').textContent = formatNumber(healthIns) + ' đ';
            document.getElementById('unemployIns').textContent = formatNumber(unemployIns) + ' đ';

            // 개인소득세 표시
            document.getElementById('taxableIncome').textContent = formatNumber(taxableIncome) + ' đ';
            document.getElementById('dependentDeduction').textContent = formatNumber(dependentDeduction) + ' đ';
            document.getElementById('totalFamilyDeduction').textContent = formatNumber(totalFamilyDeduction) + ' đ';
            document.getElementById('taxBase').textContent = formatNumber(Math.max(0, taxableIncome - totalFamilyDeduction)) + ' đ';
            document.getElementById('incomeTax').textContent = formatNumber(incomeTax) + ' đ';

            // 비과세 내역 표시
            const taxFreeMeal = mealAllowance;  // 100% 비과세
            const taxFreeOvertime = overtimePay * 1/3;  // 1/3 비과세
            const taxFreeSunday = sundayPay * 1/2;  // 1/2 비과세
            const totalTaxFree = taxFreeMeal + taxFreeOvertime + taxFreeSunday;

            document.getElementById('taxFreeMeal').textContent = formatNumber(taxFreeMeal) + ' đ';
            document.getElementById('taxFreeOvertime').textContent = formatNumber(taxFreeOvertime) + ' đ';
            document.getElementById('taxFreeSunday').textContent = formatNumber(taxFreeSunday) + ' đ';
            document.getElementById('totalTaxFree').textContent = formatNumber(totalTaxFree) + ' đ';

            // ===== 중간 합계 계산 및 표시 =====
            // 1. 급여 상세 합계 (정규+야근+야간+야간OT+일요일)
            const salaryDetailTotal = normalPay + overtimePay + nightPay + nightOTPay + sundayPay;
            document.getElementById('salaryDetailTotal').textContent = formatNumber(salaryDetailTotal) + ' đ';

            // 2. 수당 합계 (식대+동적수당+특수수당)
            const allowanceTotal = mealAllowance + dynamicAllowances + specialAllowance;
            document.getElementById('allowanceTotal').textContent = formatNumber(allowanceTotal) + ' đ';

            // 3. 최종 정산 요약 (실수령액 전 요약)
            document.getElementById('finalSalaryDetail').textContent = formatNumber(salaryDetailTotal) + ' đ';
            document.getElementById('finalAllowanceTotal').textContent = formatNumber(allowanceTotal) + ' đ';
            document.getElementById('finalTotalSalary').textContent = formatNumber(totalSalary) + ' đ';
            document.getElementById('finalDeduction').textContent = formatNumber(totalDeduction) + ' đ';
            document.getElementById('finalIncomeTax').textContent = formatNumber(incomeTax) + ' đ';

            // 선금 표시 (있을 경우만)
            const finalAdvanceRow = document.getElementById('finalAdvancePaymentRow');
            if (advancePayment > 0) {
                finalAdvanceRow.style.display = '';
                document.getElementById('finalAdvancePayment').textContent = formatNumber(advancePayment) + ' đ';
            } else {
                finalAdvanceRow.style.display = 'none';
            }

            // 보험 미가입자 확인 및 UI 업데이트 (isInsuranceExempt는 위에서 이미 선언됨)

            const companyInsuranceBox = document.getElementById('companyInsuranceBox');
            const employeeInsuranceBox = document.getElementById('employeeInsuranceBox');
            const insuranceExemptBox = document.getElementById('insuranceExemptBox');
            const taxFreeBox = document.getElementById('taxFreeBox');
            const incomeTaxBox = document.getElementById('incomeTaxBox');
            const finalDeductionRow = document.getElementById('finalDeductionRow');
            const finalIncomeTaxRow = document.getElementById('finalIncomeTaxRow');

            if (isInsuranceExempt) {
                // 보험 미가입자: 보험료/소득세 섹션 숨기고, 미가입 표시 보이기
                if (companyInsuranceBox) companyInsuranceBox.style.display = 'none';
                if (employeeInsuranceBox) employeeInsuranceBox.style.display = 'none';
                if (insuranceExemptBox) insuranceExemptBox.style.display = 'block';
                if (taxFreeBox) taxFreeBox.style.display = 'none';  // 비과세 내역 숨김
                if (incomeTaxBox) incomeTaxBox.style.display = 'none';  // 개인소득세 섹션 숨김
                if (finalDeductionRow) finalDeductionRow.style.display = 'none';  // 최종 정산 보험료 숨김
                if (finalIncomeTaxRow) finalIncomeTaxRow.style.display = 'none';  // 최종 정산 소득세 숨김
            } else {
                // 보험 가입자: 보험료/소득세 섹션 보이고, 미가입 표시 숨기기
                if (companyInsuranceBox) companyInsuranceBox.style.display = 'block';
                if (employeeInsuranceBox) employeeInsuranceBox.style.display = 'block';
                if (insuranceExemptBox) insuranceExemptBox.style.display = 'none';
                if (taxFreeBox) taxFreeBox.style.display = 'block';  // 비과세 내역 보이기
                if (incomeTaxBox) incomeTaxBox.style.display = 'block';  // 개인소득세 섹션 보이기
                if (finalDeductionRow) finalDeductionRow.style.display = '';  // 최종 정산 보험료 보이기
                if (finalIncomeTaxRow) finalIncomeTaxRow.style.display = '';  // 최종 정산 소득세 보이기
            }

            document.getElementById('totalSalary').textContent = formatNumber(totalSalary) + ' đ';
            document.getElementById('totalDeduction').textContent = formatNumber(totalDeduction) + ' đ';
            document.getElementById('netSalary').textContent = formatNumber(netSalary) + ' đ';
            
            // 확정 상태 표시 업데이트
            updateConfirmStatus();
        }

        // 숫자 포맷팅 (회사 설정에 따라)
        function formatNumber(num) {
            const rounded = Math.round(num);

            // 현재 회사 설정 가져오기
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');
            const company = companyProfiles[currentCompanyId] || {};

            const numberFormat = company.numberFormat || 'comma';

            let locale;
            if (numberFormat === 'comma') {
                locale = 'en-US';  // 1,234,567
            } else if (numberFormat === 'dot') {
                locale = 'de-DE';  // 1.234.567
            } else {
                locale = 'fr-FR';  // 1 234 567
            }

            return new Intl.NumberFormat(locale).format(rounded);
        }

        // 📱 모바일 급여명세서 열기 (완전히 새로 작성)
        function openMobilePayslip() {
            // 1. 직원 선택 확인
            if (!currentEmployeeId) {
                alert('⚠️ 먼저 직원을 선택하세요!');
                return;
            }

            // 2. 급여 계산 실행
            calculate();

            // 3. 회사 설정 로드
            const settings = getCompanySettings();
            
            // 4. 급여 데이터 수집
            const payslipData = collectPayslipData(settings);
            
            // 5. 모바일 페이지 열기
            openPayslipPage(payslipData);
        }

        // 회사 설정 가져오기
        function getCompanySettings() {
            console.log('==========================================');
            console.log('🔍 회사 설정 불러오기 시작');
            console.log('==========================================');

            // 1. 회사 프로필에서 회사명/로고 가져오기
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            let companyName = '회사명';
            let companyLogo = null;

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];
                companyName = company.name || '회사명';
                companyLogo = company.logo || null;
                console.log('✅ 회사 프로필 발견: ' + currentCompanyId);
            } else {
                console.log('⚠️ 회사 프로필 없음 - 기본값 사용');
            }

            console.log('🏢 회사명:', companyName);
            console.log('🖼️ 로고:', companyLogo);

            // 2. 급여 규정은 vietnamPayrollSettings에서 가져오기
            const storageKey = `vietnamPayrollSettings_${selectedYear}`;
            console.log('🔑 급여설정 키:', storageKey);

            const storedData = localStorage.getItem(storageKey);
            let settings = {};

            if (storedData) {
                try {
                    settings = JSON.parse(storedData);
                    console.log('✅ 급여설정 불러오기 성공');
                } catch (e) {
                    console.error('❌ 급여설정 파싱 실패:', e);
                }
            } else {
                console.log('⚠️ 급여설정 없음 - 빈 객체 사용');
            }

            // 회사명/로고를 설정에 추가
            settings.companyName = companyName;
            settings.companyLogo = companyLogo;

            console.log('✅ 최종 설정 완료');
            console.log('==========================================');
            return settings;
        }

        // 급여명세서 데이터 수집
        function collectPayslipData(settings) {
            console.log('==========================================');
            console.log('📋 급여명세서 데이터 수집 시작');
            console.log('==========================================');
            console.log('📦 전달받은 settings:', settings);

            // 회사 정보
            const companyName = (settings && settings.companyName) || '회사명';
            const companyLogo = (settings && settings.companyLogo) || null;

            console.log('🏢 수집된 회사명:', companyName);
            console.log('🖼️ 수집된 로고:', companyLogo);
            
            // 직원 정보
            const employeeName = document.getElementById('employeeName').value || '직원';
            const basicSalary = parseMoneyInput(document.getElementById('basicSalary').value);
            const dependents = parseInt(document.getElementById('dependents').value) || 0;
            
            // 근무 통계
            const daysInMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const workDays = parseInt(document.getElementById('workDays').textContent.replace(/[^\d]/g, '')) || 0;
            const normalHours = parseFloat(document.getElementById('normalHours').textContent.replace(/[^\d.]/g, '')) || 0;
            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const nightOTHours = parseFloat(document.getElementById('nightOTHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;

            // 야간 설정 여부
            const nightShiftEnabled = (settings && settings.nightShiftEnabled) || false;

            // 급여
            const normalPay = parseFloat(document.getElementById('normalPay').textContent.replace(/[^\d]/g, '')) || 0;
            const overtimePay = parseFloat(document.getElementById('overtimePay').textContent.replace(/[^\d]/g, '')) || 0;
            const nightPay = parseFloat(document.getElementById('nightPay').textContent.replace(/[^\d]/g, '')) || 0;
            const nightOTPay = parseFloat(document.getElementById('nightOTPay').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayPay = parseFloat(document.getElementById('sundayPay').textContent.replace(/[^\d]/g, '')) || 0;
            
            // 식대
            const lunchMeal = (settings && settings.lunchMeal) || 25000;
            const dinnerMeal = (settings && settings.dinnerMeal) || 25000;
            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;
            const totalMealCount = parseInt(document.getElementById('totalMealCount').textContent.replace(/[^\d]/g, '')) || 0;
            const weekdayLunchCount = parseInt(document.getElementById('weekdayLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const weekdayDinnerCount = parseInt(document.getElementById('weekdayDinnerCount').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayLunchCount = parseInt(document.getElementById('sundayLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const sundayDinnerCount = parseInt(document.getElementById('sundayDinnerCount').textContent.replace(/[^\d]/g, '')) || 0;
            const annualLeaveLunchCount = parseInt(document.getElementById('annualLeaveLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            const excusedAbsentLunchCount = parseInt(document.getElementById('excusedAbsentLunchCount').textContent.replace(/[^\d]/g, '')) || 0;
            
            // 동적 수당
            const allowances = (settings && settings.allowances) || [];
            const dynamicAllowances = [];
            allowances.forEach(allowance => {
                if (allowance.enabled) {
                    const amount = currentAllowanceDetails[allowance.id] || 0;
                    if (amount > 0) {
                        dynamicAllowances.push({
                            id: allowance.id,
                            name: allowance.name,
                            amount: amount
                        });
                    }
                }
            });
            
            // 특수수당
            const specialAllowance = document.getElementById('specialAllowanceEnabled')?.checked ?
                parseMoneyInput(document.getElementById('specialAllowanceAmount')?.value) : 0;

            // 공제
            const socialIns = parseFloat(document.getElementById('socialIns').textContent.replace(/[^\d]/g, '')) || 0;
            const healthIns = parseFloat(document.getElementById('healthIns').textContent.replace(/[^\d]/g, '')) || 0;
            const unemployIns = parseFloat(document.getElementById('unemployIns').textContent.replace(/[^\d]/g, '')) || 0;
            const totalDeduction = parseFloat(document.getElementById('totalDeduction').textContent.replace(/[^\d]/g, '')) || 0;
            const incomeTax = parseFloat(document.getElementById('incomeTax').textContent.replace(/[^\d]/g, '')) || 0;

            // 선금
            const advancePayment = document.getElementById('advancePaymentEnabled')?.checked ?
                parseMoneyInput(document.getElementById('advancePaymentAmount')?.value) : 0;
            
            // 총 급여 (화면에서 가져오기)
            const totalSalary = parseFloat(document.getElementById('totalSalary').textContent.replace(/[^\d]/g, '')) || 0;

            // 실수령액
            const netSalary = parseFloat(document.getElementById('netSalary').textContent.replace(/[^\d]/g, '')) || 0;

            return {
                companyName,
                companyLogo,
                year: selectedYear,
                month: selectedMonth,
                employeeName,
                basicSalary,
                dependents,
                totalDays: daysInMonth,
                workDays,
                normalHours,
                overtimeHours,
                nightHours,
                nightOTHours,
                sundayHours,
                nightShiftEnabled,
                normalPay,
                overtimePay,
                nightPay,
                nightOTPay,
                sundayPay,
                mealAllowance,
                totalMealCount,
                lunchMeal,
                dinnerMeal,
                weekdayLunchCount,
                weekdayDinnerCount,
                sundayLunchCount,
                sundayDinnerCount,
                annualLeaveLunchCount,
                excusedAbsentLunchCount,
                allowances: dynamicAllowances,
                specialAllowance,
                totalSalary,  // 추가!
                socialIns,
                healthIns,
                unemployIns,
                totalDeduction,
                incomeTax,
                advancePayment,
                netSalary,
                // 달력 데이터 추가
                holidays: Array.from(holidays),
                absents: Array.from(absents),
                excusedAbsents: Array.from(excusedAbsents),
                annualLeaveDays: Array.from(annualLeaveDays),
                specialLeaveDays: Array.from(specialLeaveDays),
                sickLeaveDays: Array.from(sickLeaveDays),
                overtimeData: overtimeData,
                nightData: nightData,
                nightOTData: nightOTData,
                sundayData: sundayData
            };
        }

        // 모바일 페이지 열기
        function openPayslipPage(data) {
            console.log('==========================================');
            console.log('🚀 모바일 페이지 열기');
            console.log('==========================================');
            console.log('📦 전달할 데이터:', data);
            console.log('🏢 회사명:', data.companyName);
            console.log('🖼️ 로고:', data.companyLogo);
            console.log('==========================================');

            const dataString = encodeURIComponent(JSON.stringify(data));
            const url = `payslip.html?data=${dataString}`;
            console.log('🔗 생성된 URL (처음 200자):', url.substring(0, 200));
            window.open(url, '_blank');
        }
        // ==================== 직원 관리 함수 ====================

        // 회사 설정 (공통 설정)
        let companySettings = {
            dailyMeal: 25000,
            attendanceBonus: 300000,
            transportBonus: 200000,
            riskBonus: 100000,
            employeeSocialRate: 8,
            employeeHealthRate: 1.5,
            employeeUnemployRate: 1,
            companySocialRate: 17.5,
            companyHealthRate: 3,
            companyUnemployRate: 1
        };

        // LocalStorage에서 직원 데이터 불러오기
        function loadEmployeesFromStorage() {
            const stored = localStorage.getItem('vietnamPayrollEmployees');
            if (stored) {
                employees = JSON.parse(stored);
                updateEmployeeSelect();
            }

            // 회사 설정 불러오기 (현재 연도 기준)
            console.log('===== 💼 초기 회사 설정 로드 =====');
            console.log('📅 선택된 연도:', selectedYear);
            console.log('🔑 localStorage 키:', `vietnamPayrollSettings_${selectedYear}`);
            
            const storedSettings = localStorage.getItem(`vietnamPayrollSettings_${selectedYear}`);
            
            if (storedSettings) {
                try {
                    window.companySettings = JSON.parse(storedSettings);
                    console.log('✅ 회사 설정 로드 성공!');
                    console.log('🏢 회사명:', window.companySettings.companyName);
                    console.log('🖼️ 로고:', window.companySettings.companyLogo);
                    console.log('=====================================');
                } catch (e) {
                    console.error('❌ 회사 설정 파싱 실패:', e);
                    console.log('=====================================');
                }
            } else {
                console.warn('⚠️ localStorage에 회사 설정이 없습니다!');
                console.warn('💡 settings.html에서 회사 정보를 먼저 설정해주세요!');
                console.log('=====================================');
            }
        }

        // LocalStorage에 직원 데이터 저장
        function saveEmployeesToStorage() {
            localStorage.setItem('vietnamPayrollEmployees', JSON.stringify(employees));
        }

        // 직원 선택 드롭다운 업데이트
        function updateEmployeeSelect() {
            const select = document.getElementById('employeeSelect');
            select.innerHTML = '<option value="">-- 직원 선택 --</option>';

            // 직원 코드 기준으로 정렬
            const sortedEmployeeIds = Object.keys(employees).sort((a, b) => {
                const codeA = employees[a].employeeCode || '';
                const codeB = employees[b].employeeCode || '';
                return codeA.localeCompare(codeB, undefined, { numeric: true });
            });

            for (const id of sortedEmployeeIds) {
                const emp = employees[id];
                const option = document.createElement('option');
                option.value = id;
                // 코드가 있으면 [KQ-001] 형태로 표시 (이미 포함되어 있지 않으면)
                let displayText = emp.name;
                if (emp.employeeCode && !emp.name.includes(`[${emp.employeeCode}]`)) {
                    displayText = `[${emp.employeeCode}] ${emp.name}`;
                }
                option.textContent = displayText;
                if (id === currentEmployeeId) option.selected = true;
                select.appendChild(option);
            }

            // 선택 이벤트
            select.onchange = function() {
                if (this.value) {
                    loadEmployee(this.value);
                }
            };
        }

        // 직원 데이터 불러오기
        function loadEmployee(id) {
            const emp = employees[id];
            if (!emp) return;

            currentEmployeeId = id;

            // 드롭다운 선택
            const select = document.getElementById('employeeSelect');
            if (select) {
                select.value = id;
            }

            // 기본 정보 (코드가 있으면 함께 표시)
            let nameDisplay = emp.name;
            // 이름에 이미 코드가 포함되어 있지 않으면 추가
            if (emp.employeeCode && !emp.name.includes(`[${emp.employeeCode}]`)) {
                nameDisplay = `[${emp.employeeCode}] ${emp.name}`;
            }
            document.getElementById('employeeName').value = nameDisplay;
            document.getElementById('basicSalary').value = formatNumber(emp.basicSalary || 0);
            document.getElementById('dependents').value = emp.dependents || 0;
            document.getElementById('dailyMeal').value = formatNumber(emp.dailyMeal || 25000);

            // 달력 데이터 (날짜 형식 정규화)
            holidays = new Set(normalizeDateSet(emp.holidays || []));
            excusedAbsents = new Set(normalizeDateSet(emp.excusedAbsents || []));
            absents = new Set(normalizeDateSet(emp.absents || []));
            annualLeaveDays = new Set(normalizeDateSet(emp.annualLeaveDays || []));
            annualLeaveMemos = emp.annualLeaveMemos || {};

            // 경조사/병가 데이터 로드
            specialLeaveDays = new Set(normalizeDateSet(emp.specialLeaveDays || []));
            sickLeaveDays = new Set(normalizeDateSet(emp.sickLeaveDays || []));

            // 출퇴근 관리(leaveData)에서 연차/휴가 데이터 동기화
            if (emp.leaveData) {
                Object.entries(emp.leaveData).forEach(([dateKey, leaveType]) => {
                    const normalizedKey = normalizeDateKey(dateKey);
                    if (leaveType === 'annual') {
                        annualLeaveDays.add(normalizedKey);
                    } else if (leaveType === 'special') {
                        specialLeaveDays.add(normalizedKey);
                    } else if (leaveType === 'sick') {
                        sickLeaveDays.add(normalizedKey);
                    } else if (leaveType === 'excused') {
                        excusedAbsents.add(normalizedKey);
                    } else if (leaveType === 'absent') {
                        absents.add(normalizedKey);
                    }
                });
            }
            overtimeData = normalizeDateObject(emp.overtimeData || {});
            nightData = normalizeDateObject(emp.nightData || {});
            nightOTData = normalizeDateObject(emp.nightOTData || {});
            nightShiftDays = new Set(emp.nightShiftDays || []);
            sundayData = normalizeDateObject(emp.sundayData || {});
            normalHoursData = normalizeDateObject(emp.normalHoursData || {});

            // 일요일 정규근무 데이터 제거 (일요일은 정규근무 없음)
            Object.keys(normalHoursData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 0) {  // 일요일
                    delete normalHoursData[dateKey];
                }
            });

            // 특수수당 복원
            const specialAllowanceCheckbox = document.getElementById('specialAllowanceEnabled');
            const specialAllowanceInput = document.getElementById('specialAllowanceAmount');
            if (specialAllowanceCheckbox && specialAllowanceInput) {
                specialAllowanceCheckbox.checked = emp.specialAllowanceEnabled || false;
                specialAllowanceInput.value = formatNumber(emp.specialAllowanceAmount || 0);
                if (specialAllowanceCheckbox.checked) {
                    specialAllowanceInput.disabled = false;
                    specialAllowanceInput.style.background = 'white';
                } else {
                    specialAllowanceInput.disabled = true;
                    specialAllowanceInput.style.background = '#f5f5f5';
                }
            }

            // 선금 복원
            const advancePaymentCheckbox = document.getElementById('advancePaymentEnabled');
            const advancePaymentInput = document.getElementById('advancePaymentAmount');
            if (advancePaymentCheckbox && advancePaymentInput) {
                advancePaymentCheckbox.checked = emp.advancePaymentEnabled || false;
                advancePaymentInput.value = formatNumber(emp.advancePaymentAmount || 0);
                if (advancePaymentCheckbox.checked) {
                    advancePaymentInput.disabled = false;
                    advancePaymentInput.style.background = 'white';
                } else {
                    advancePaymentInput.disabled = true;
                    advancePaymentInput.style.background = '#f5f5f5';
                }
            }

            // 보험 미가입자 표시
            const insuranceExemptBadge = document.getElementById('insuranceExemptBadge');
            if (insuranceExemptBadge) {
                if (emp.insuranceExempt) {
                    insuranceExemptBadge.style.display = 'block';
                } else {
                    insuranceExemptBadge.style.display = 'none';
                }
            }

            generateCalendar();
            calculate();
            updateConfirmStatus(); // 확정 상태 표시
        }

        // 현재 직원 데이터 저장
        function saveCurrentEmployee() {
            if (!currentEmployeeId) return;

            // 일요일 정규근무 데이터 제거 (일요일은 정규근무 없음)
            const filteredNormalHours = {};
            Object.keys(normalHoursData).forEach(dateKey => {
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                if (date.getDay() !== 0) {  // 일요일 아닌 날만
                    filteredNormalHours[dateKey] = normalHoursData[dateKey];
                }
            });

            const emp = employees[currentEmployeeId];

            // 이름에서 코드 제거 (저장 시 순수 이름만 저장)
            let nameToSave = document.getElementById('employeeName').value;
            if (emp.employeeCode && nameToSave.includes(`[${emp.employeeCode}]`)) {
                nameToSave = nameToSave.replace(`[${emp.employeeCode}] `, '').replace(`[${emp.employeeCode}]`, '').trim();
            }

            employees[currentEmployeeId] = {
                ...emp, // 기존 데이터 유지 (hireDate, annualLeavePerYear, annualLeaveUsed 등)
                name: nameToSave,
                basicSalary: parseMoneyInput(document.getElementById('basicSalary').value),
                dependents: parseInt(document.getElementById('dependents').value) || 0,
                dailyMeal: parseMoneyInput(document.getElementById('dailyMeal').value) || 25000,
                holidays: Array.from(holidays),
                excusedAbsents: Array.from(excusedAbsents),
                absents: Array.from(absents),
                annualLeaveDays: Array.from(annualLeaveDays),
                specialLeaveDays: Array.from(specialLeaveDays),
                sickLeaveDays: Array.from(sickLeaveDays),
                annualLeaveMemos: annualLeaveMemos,
                overtimeData: overtimeData,
                nightData: nightData,
                nightOTData: nightOTData,
                nightShiftDays: Array.from(nightShiftDays),
                sundayData: sundayData,
                normalHoursData: filteredNormalHours,
                specialAllowanceEnabled: document.getElementById('specialAllowanceEnabled')?.checked || false,
                specialAllowanceAmount: parseMoneyInput(document.getElementById('specialAllowanceAmount')?.value),
                advancePaymentEnabled: document.getElementById('advancePaymentEnabled')?.checked || false,
                advancePaymentAmount: parseMoneyInput(document.getElementById('advancePaymentAmount')?.value)
            };

            // 출퇴근 관리 연동: leaveData 업데이트
            const leaveData = employees[currentEmployeeId].leaveData || {};
            annualLeaveDays.forEach(key => { leaveData[key] = 'annual'; });
            specialLeaveDays.forEach(key => { leaveData[key] = 'special'; });
            sickLeaveDays.forEach(key => { leaveData[key] = 'sick'; });
            excusedAbsents.forEach(key => { leaveData[key] = 'excused'; });
            absents.forEach(key => { leaveData[key] = 'absent'; });
            employees[currentEmployeeId].leaveData = leaveData;

            saveEmployeesToStorage();
        }

        // 폼 초기화
        function clearForm() {
            document.getElementById('employeeName').value = '';
            document.getElementById('basicSalary').value = formatNumber(6980000);
            document.getElementById('dependents').value = 0;
            document.getElementById('dailyMeal').value = formatNumber(25000);

            // 특수수당/선금 초기화
            const specialAllowanceCheckbox = document.getElementById('specialAllowanceEnabled');
            const specialAllowanceInput = document.getElementById('specialAllowanceAmount');
            if (specialAllowanceCheckbox && specialAllowanceInput) {
                specialAllowanceCheckbox.checked = false;
                specialAllowanceInput.value = formatNumber(0);
                specialAllowanceInput.disabled = true;
                specialAllowanceInput.style.background = '#f5f5f5';
            }

            const advancePaymentCheckbox = document.getElementById('advancePaymentEnabled');
            const advancePaymentInput = document.getElementById('advancePaymentAmount');
            if (advancePaymentCheckbox && advancePaymentInput) {
                advancePaymentCheckbox.checked = false;
                advancePaymentInput.value = formatNumber(0);
                advancePaymentInput.disabled = true;
                advancePaymentInput.style.background = '#f5f5f5';
            }

            holidays = new Set();
            excusedAbsents = new Set();
            absents = new Set();
            overtimeData = {};
            nightData = {};
            nightOTData = {};
            nightShiftDays = new Set();
            sundayData = {};
            normalHoursData = {};
            generateCalendar();
            calculate();
        }

        // 전체 급여명세 Excel 저장
        function exportAllToExcel() {
            if (Object.keys(employees).length === 0) {
                alert('⚠️ 저장할 직원 데이터가 없습니다!');
                return;
            }

            const wb = XLSX.utils.book_new();
            const results = [];

            // 동적 수당 헤더 생성
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            const enabledAllowances = allowances.filter(a => a.enabled);
            const allowanceHeaders = enabledAllowances.map(a => a.name);

            // 헤더 (동적 수당 포함)
            const headerRow = [
                '직원명', '기본급', '부양가족', '시간급', '정규급여', '야근수당', '야간수당', '특근수당',
                '식대', ...allowanceHeaders, '총급여', '사회보험', '건강보험', '실업보험',
                '보험공제', '과세소득', '가족공제', '과세표준', '소득세', '실수령액'
            ];
            results.push(headerRow);

            // 합계 누적 변수 초기화
            let sumBasicSalary = 0;
            let sumNormalPay = 0;
            let sumOvertimePay = 0;
            let sumNightPay = 0;
            let sumSundayPay = 0;
            let sumMealAllowance = 0;
            let sumAllowances = new Array(enabledAllowances.length).fill(0);
            let sumTotalSalary = 0;
            let sumSocialIns = 0;
            let sumHealthIns = 0;
            let sumUnemployIns = 0;
            let sumTotalDeduction = 0;
            let sumIncomeTax = 0;
            let sumNetSalary = 0;

            // 각 직원 계산
            for (const id in employees) {
                const emp = employees[id];

                // 임시로 직원 데이터 로드
                const tempCurrent = currentEmployeeId;
                loadEmployee(id);

                // 계산 결과 가져오기 (월별 근무일수 기준)
                const weekdaysText = document.getElementById('weekdays').textContent;
                const weekdays = parseFloat(weekdaysText.replace('일', '')) || 26;
                const monthlyHours = weekdays * 8;
                const hourlyRate = monthlyHours > 0 ? emp.basicSalary / monthlyHours : 0;
                const normalHoursText = document.getElementById('normalHours').textContent;
                const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
                const normalPay = hourlyRate * normalHours;
                const overtimePay = hourlyRate * (parseFloat(document.getElementById('overtimeHours').value) || 0) * 1.5;
                const nightPay = hourlyRate * (parseFloat(document.getElementById('nightHours').value) || 0) * 1.3;
                const sundayPay = hourlyRate * (parseFloat(document.getElementById('sundayHours').value) || 0) * 2.0;

                const mealAllowanceText = document.getElementById('autoMeal').textContent;
                const mealAllowance = parseFloat(mealAllowanceText.replace(/[^\d]/g, '')) || 0;

                // 동적 수당 총액 가져오기
                const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;

                // 개별 수당 값들 (엑셀 각 열에 표시용)
                const allowanceValues = enabledAllowances.map(allowance => {
                    return currentAllowanceDetails[allowance.id] || 0;
                });

                const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

                const socialIns = emp.basicSalary * 0.08;
                const healthIns = emp.basicSalary * 0.015;
                const unemployIns = emp.basicSalary * 0.01;
                const totalDeduction = socialIns + healthIns + unemployIns;

                // 과세 대상 소득 (식대 비과세, 야근 2/3, 특근 1/2, 수당 전액 과세)
                const taxableIncome = normalPay
                                    + (overtimePay * 2/3)
                                    + nightPay
                                    + (sundayPay * 1/2)
                                    + dynamicAllowancesTotal  // 모든 수당 전액 과세
                                    - totalDeduction;
                const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
                let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

                // 소득세 계산
                let incomeTax = 0;
                let remainingBase = taxBase;
                if (remainingBase > 0) {
                    const tier1 = Math.min(remainingBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    remainingBase -= tier1;
                }
                if (remainingBase > 0) {
                    const tier2 = Math.min(remainingBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    remainingBase -= tier2;
                }
                if (remainingBase > 0) {
                    const tier3 = Math.min(remainingBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    remainingBase -= tier3;
                }
                if (remainingBase > 0) {
                    const tier4 = Math.min(remainingBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    remainingBase -= tier4;
                }
                if (remainingBase > 0) {
                    const tier5 = Math.min(remainingBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    remainingBase -= tier5;
                }
                if (remainingBase > 0) {
                    const tier6 = Math.min(remainingBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    remainingBase -= tier6;
                }
                if (remainingBase > 0) {
                    incomeTax += remainingBase * 0.35;
                }

                const netSalary = totalSalary - totalDeduction - incomeTax;

                // 데이터 행 생성 (동적 수당 포함)
                const dataRow = [
                    emp.name, emp.basicSalary, emp.dependents,
                    Math.round(hourlyRate), Math.round(normalPay), Math.round(overtimePay), Math.round(nightPay), Math.round(sundayPay),
                    Math.round(mealAllowance),
                    ...allowanceValues.map(v => Math.round(v)),  // 동적 수당들
                    Math.round(totalSalary), Math.round(socialIns), Math.round(healthIns), Math.round(unemployIns),
                    Math.round(totalDeduction), Math.round(taxableIncome), Math.round(totalFamilyDeduction), Math.round(taxBase),
                    Math.round(incomeTax), Math.round(netSalary)
                ];
                results.push(dataRow);

                // 합계 누적
                sumBasicSalary += emp.basicSalary;
                sumNormalPay += normalPay;
                sumOvertimePay += overtimePay;
                sumNightPay += nightPay;
                sumSundayPay += sundayPay;
                sumMealAllowance += mealAllowance;
                allowanceValues.forEach((val, idx) => {
                    sumAllowances[idx] += val;
                });
                sumTotalSalary += totalSalary;
                sumSocialIns += socialIns;
                sumHealthIns += healthIns;
                sumUnemployIns += unemployIns;
                sumTotalDeduction += totalDeduction;
                sumIncomeTax += incomeTax;
                sumNetSalary += netSalary;

                // 원래 직원으로 복귀
                if (tempCurrent) loadEmployee(tempCurrent);
            }

            // 합계 행 추가
            const sumRow = [
                '합계', Math.round(sumBasicSalary), '', '',
                Math.round(sumNormalPay), Math.round(sumOvertimePay), Math.round(sumNightPay), Math.round(sumSundayPay),
                Math.round(sumMealAllowance),
                ...sumAllowances.map(v => Math.round(v)),
                Math.round(sumTotalSalary), Math.round(sumSocialIns), Math.round(sumHealthIns), Math.round(sumUnemployIns),
                Math.round(sumTotalDeduction), '', '', '',
                Math.round(sumIncomeTax), Math.round(sumNetSalary)
            ];
            results.push(sumRow);

            const ws = XLSX.utils.aoa_to_sheet(results);
            XLSX.utils.book_append_sheet(wb, ws, '급여명세');

            XLSX.writeFile(wb, `급여명세_${selectedYear}_${selectedMonth}.xlsx`);
            alert('✅ 급여명세가 저장되었습니다!');
        }

        // ==================== 모달 함수 ====================

        // ========================================
        // 급여 계산 핵심 기능
        // ========================================

        // 전체 직원 급여 계산
        function calculateAllEmployeesPayroll(year, month) {
            const results = [];

            Object.keys(employees).forEach(empId => {
                const emp = employees[empId];
                const payroll = calculateEmployeePayroll(empId, year, month);

                if (payroll) {
                    // 직원 코드 포함된 이름 생성
                    let displayName = emp.name;
                    if (emp.employeeCode && !emp.name.includes(`[${emp.employeeCode}]`)) {
                        displayName = `[${emp.employeeCode}] ${emp.name}`;
                    }

                    results.push({
                        employeeId: empId,  // dashboard.js에서 사용
                        id: empId,          // 호환성 유지
                        employeeCode: emp.employeeCode || '',
                        name: displayName,
                        ...payroll
                    });
                }
            });

            return results;
        }

        // 개별 직원 급여 계산
        function calculateEmployeePayroll(employeeId, year, month) {
            const emp = employees[employeeId];
            if (!emp) return null;

            // 헬퍼 함수: dateKey가 지정된 연/월에 속하는지 확인 (구버전 호환)
            function isTargetMonth(key) {
                const parts = key.split('-');
                if (parts.length < 2) return false;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return keyYear === year && keyMonth === month;
            }

            // 해당 월의 달력 데이터 로드
            const basicSalary = emp.basicSalary || 6980000;
            const dailyMeal = emp.dailyMeal || 25000;
            const dependents = emp.dependents || 0;

            // 월별 데이터 필터링 (구버전 호환)
            const holidays = new Set((emp.holidays || []).filter(d => isTargetMonth(d)));
            const excusedAbsents = new Set((emp.excusedAbsents || []).filter(d => isTargetMonth(d)));
            const absents = new Set((emp.absents || []).filter(d => isTargetMonth(d)));
            const annualLeaveDays = new Set((emp.annualLeaveDays || []).filter(d => isTargetMonth(d)));

            const overtimeData = {};
            const nightData = {};
            const nightOTData = {};
            const sundayData = {};
            const normalHoursData = {};

            Object.keys(emp.overtimeData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    overtimeData[key] = emp.overtimeData[key];
                }
            });

            Object.keys(emp.nightData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    nightData[key] = emp.nightData[key];
                }
            });

            Object.keys(emp.nightOTData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    nightOTData[key] = emp.nightOTData[key];
                }
            });

            Object.keys(emp.sundayData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    sundayData[key] = emp.sundayData[key];
                }
            });

            Object.keys(emp.normalHoursData || {}).forEach(key => {
                if (isTargetMonth(key)) {
                    normalHoursData[key] = emp.normalHoursData[key];
                }
            });

            // 통계 계산
            const daysInMonth = new Date(year, month, 0).getDate();
            let sundays = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                if (date.getDay() === 0) sundays++;
            }

            const weekdays = daysInMonth - sundays;

            // 공휴일 중 일요일은 제외
            let holidayCount = 0;
            holidays.forEach(dateKey => {
                const parts = dateKey.split('-');
                const day = parseInt(parts[2]);
                const date = new Date(year, month - 1, day);
                if (date.getDay() !== 0) {
                    holidayCount++;
                }
            });

            const excusedAbsentCount = excusedAbsents.size;
            const unexcusedAbsentCount = absents.size;
            const annualLeaveCount = annualLeaveDays.size;
            const specialLeaveCount = specialLeaveDays.size;
            const sickLeaveCount = sickLeaveDays.size;
            const totalAbsentCount = excusedAbsentCount + unexcusedAbsentCount;

            // 일요일 특근일 수 계산 (8시간 이상 일하면 식대 지급 - 실근무일에는 포함 안됨)
            let sundayWorkDays = 0;
            Object.keys(sundayData).forEach(key => {
                if (sundayData[key] >= 8) sundayWorkDays++;
            });

            const workDays = weekdays - holidayCount - totalAbsentCount - annualLeaveCount - specialLeaveCount - sickLeaveCount;

            // 정규 근무시간 계산
            let normalHours = 0;
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const dayOfWeek = date.getDay();
                const dateKey = makeDateKey(year, month, day);
                const dateKeyOld = `${year}-${month}-${day}`;

                if (dayOfWeek === 0) continue;
                if ((holidays.has(dateKey) || holidays.has(dateKeyOld)) && dayOfWeek !== 0) continue;
                if (excusedAbsents.has(dateKey) || excusedAbsents.has(dateKeyOld)) continue;
                if (absents.has(dateKey) || absents.has(dateKeyOld)) continue;
                if (sickLeaveDays.has(dateKey) || sickLeaveDays.has(dateKeyOld)) continue;

                if (annualLeaveDays.has(dateKey) || annualLeaveDays.has(dateKeyOld)) {
                    normalHours += 8;  // 연차 = 8시간 유급
                } else if (specialLeaveDays.has(dateKey) || specialLeaveDays.has(dateKeyOld)) {
                    normalHours += 8;  // 경조사 = 8시간 유급 (베트남 노동법 제115조)
                } else {
                    normalHours += (normalHoursData[dateKey] || normalHoursData[dateKeyOld] || 8);
                }
            }

            // 시급 계산
            const monthlyHours = weekdays * 8;
            const hourlyRate = monthlyHours > 0 ? basicSalary / monthlyHours : 0;

            // 급여 계산
            const normalPay = Math.round(hourlyRate * normalHours);

            let totalOvertime = 0;
            Object.keys(overtimeData).forEach(key => {
                // 연차/공휴일/결근일 제외
                if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                    totalOvertime += overtimeData[key];
                }
            });

            let totalNight = 0;
            Object.keys(nightData).forEach(key => {
                // 연차/공휴일/결근일 제외
                if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                    totalNight += nightData[key];
                }
            });

            let totalSunday = 0;
            Object.keys(sundayData).forEach(key => {
                // 연차/공휴일/결근일 제외
                if (!annualLeaveDays.has(key) && !holidays.has(key) && !absents.has(key) && !excusedAbsents.has(key)) {
                    totalSunday += sundayData[key];
                }
            });

            const overtimePay = Math.round(hourlyRate * totalOvertime * 1.5);
            const nightPay = Math.round(hourlyRate * totalNight * 1.3);
            const sundayPay = Math.round(hourlyRate * totalSunday * 2.0);

            // 수당 계산 (식대: 실근무일 + 일요일 특근 8시간 이상)
            const mealAllowance = (workDays + sundayWorkDays) * dailyMeal;
            const totalWorkableDays = daysInMonth - sundays - holidayCount;

            // 동적 수당 시스템 (급여대장용)
            const attendanceRate = totalWorkableDays > 0 ? (totalWorkableDays - excusedAbsentCount - annualLeaveCount) / totalWorkableDays : 0;

            // 회사 설정에서 수당 목록 불러오기 (window.companySettings 사용!)
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            let dynamicAllowancesTotal = 0;

            allowances.forEach(allowance => {
                if (!allowance.enabled) return;

                let amount = 0;

                // 무단결근이 있는 경우
                if (unexcusedAbsentCount > 0) {
                    if (allowance.onAbsence === 'zero') {
                        amount = 0;
                    } else if (allowance.onAbsence === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // 사유결근이 있는 경우
                else if (excusedAbsentCount > 0) {
                    const excusedAbsenceRule = allowance.onExcusedAbsence || 'proportional';
                    if (excusedAbsenceRule === 'zero') {
                        amount = 0;
                    } else if (excusedAbsenceRule === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }
                // 정상 출근 (연차만 있거나 완전 정상)
                else {
                    if (allowance.onAnnualLeave === 'zero' && annualLeaveCount > 0) {
                        amount = 0;
                    } else if (allowance.onAnnualLeave === 'proportional') {
                        amount = Math.round(allowance.amount * attendanceRate);
                    } else {
                        amount = allowance.amount; // full
                    }
                }

                dynamicAllowancesTotal += amount;
            });

            const totalAllowances = mealAllowance + dynamicAllowancesTotal;

            // 특수수당 가져오기
            const specialAllowance = emp.specialAllowanceEnabled ? (emp.specialAllowanceAmount || 0) : 0;

            // 총 급여 (특수수당 포함)
            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + totalAllowances + specialAllowance;

            // 보험료 공제 (보험 미가입자는 0원)
            const isInsuranceExempt = emp.insuranceExempt || false;
            const socialIns = isInsuranceExempt ? 0 : Math.round(basicSalary * 0.08);
            const healthIns = isInsuranceExempt ? 0 : Math.round(basicSalary * 0.015);
            const unemployIns = isInsuranceExempt ? 0 : Math.round(basicSalary * 0.01);
            const totalDeduction = socialIns + healthIns + unemployIns;

            // 소득세 계산
            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                 + dynamicAllowancesTotal + specialAllowance - totalDeduction;

            const selfDeduction = 11000000;
            const dependentDeduction = dependents * 4400000;
            const totalFamilyDeduction = selfDeduction + dependentDeduction;

            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);
            let incomeTax = 0;

            if (taxBase > 0) {
                const originalTaxBase = taxBase;
                if (taxBase > 0) {
                    const tier1 = Math.min(taxBase, 5000000);
                    incomeTax += tier1 * 0.05;
                    taxBase -= tier1;
                }
                if (taxBase > 0) {
                    const tier2 = Math.min(taxBase, 5000000);
                    incomeTax += tier2 * 0.10;
                    taxBase -= tier2;
                }
                if (taxBase > 0) {
                    const tier3 = Math.min(taxBase, 8000000);
                    incomeTax += tier3 * 0.15;
                    taxBase -= tier3;
                }
                if (taxBase > 0) {
                    const tier4 = Math.min(taxBase, 14000000);
                    incomeTax += tier4 * 0.20;
                    taxBase -= tier4;
                }
                if (taxBase > 0) {
                    const tier5 = Math.min(taxBase, 20000000);
                    incomeTax += tier5 * 0.25;
                    taxBase -= tier5;
                }
                if (taxBase > 0) {
                    const tier6 = Math.min(taxBase, 28000000);
                    incomeTax += tier6 * 0.30;
                    taxBase -= tier6;
                }
                if (taxBase > 0) {
                    incomeTax += taxBase * 0.35;
                }
            }

            // 선금 가져오기
            const advancePayment = emp.advancePaymentEnabled ? (emp.advancePaymentAmount || 0) : 0;

            // 실수령액 (선금 차감)
            const netSalary = totalSalary - totalDeduction - incomeTax - advancePayment;

            // 직원 코드 포함된 이름 생성
            let displayName = emp.name;
            if (emp.employeeCode && !emp.name.includes(`[${emp.employeeCode}]`)) {
                displayName = `[${emp.employeeCode}] ${emp.name}`;
            }

            return {
                employeeId: employeeId,
                employeeCode: emp.employeeCode || '',
                name: displayName,
                workDays: workDays,
                normalHours: normalHours,
                overtimeHours: totalOvertime + totalSunday,  // 잔업 + 일요특근 합계
                overtimePay: overtimePay + nightPay + sundayPay,  // 잔업수당 합계 (야근+야간+일요특근)
                basicPay: normalPay,
                allowances: totalAllowances,
                specialAllowance: specialAllowance,
                totalSalary: totalSalary,
                deductions: totalDeduction,
                incomeTax: Math.round(incomeTax),
                advancePayment: advancePayment,
                netSalary: netSalary
            };
        }

        // 현재 직원의 이번 달 데이터 초기화
        function clearCurrentMonthData() {
            if (!currentEmployeeId) {
                alert('⚠️ 먼저 직원을 선택하세요!');
                return;
            }

            if (!selectedYear || !selectedMonth) {
                alert('⚠️ 년월을 선택하세요!');
                return;
            }

            const emp = employees[currentEmployeeId];
            const monthStr = `${selectedYear}년 ${selectedMonth}월`;

            if (!confirm(`⚠️ ${emp.name} 직원의 ${monthStr} 데이터를 모두 삭제하시겠습니까?\n\n삭제되는 데이터:\n- 공휴일\n- 사유결근/무단결근\n- 연차\n- 잔업/야간/일요일 특근\n- 정규 근무시간 조정\n\n⚠️ 이 작업은 되돌릴 수 없습니다!`)) {
                return;
            }

            // 해당 월의 데이터만 필터링하여 삭제 (구버전 호환)
            function isNotCurrentMonth(dateKey) {
                const parts = dateKey.split('-');
                if (parts.length < 2) return true;
                const keyYear = parseInt(parts[0]);
                const keyMonth = parseInt(parts[1]);
                return !(keyYear === selectedYear && keyMonth === selectedMonth);
            }

            // Set 타입 데이터 필터링
            const newHolidays = Array.from(holidays).filter(date => isNotCurrentMonth(date));
            const newExcusedAbsents = Array.from(excusedAbsents).filter(date => isNotCurrentMonth(date));
            const newAbsents = Array.from(absents).filter(date => isNotCurrentMonth(date));
            const newAnnualLeaveDays = Array.from(annualLeaveDays).filter(date => isNotCurrentMonth(date));

            // Object 타입 데이터 필터링
            const newOvertimeData = {};
            const newNightData = {};
            const newNightOTData = {};
            const newSundayData = {};
            const newNormalHoursData = {};

            // 야간조 날짜 필터링 (현재 월 제외)
            const newNightShiftDays = Array.from(nightShiftDays).filter(key => isNotCurrentMonth(key));

            Object.keys(overtimeData).forEach(key => {
                if (isNotCurrentMonth(key)) newOvertimeData[key] = overtimeData[key];
            });
            Object.keys(nightData).forEach(key => {
                if (isNotCurrentMonth(key)) newNightData[key] = nightData[key];
            });
            Object.keys(nightOTData).forEach(key => {
                if (isNotCurrentMonth(key)) newNightOTData[key] = nightOTData[key];
            });
            Object.keys(sundayData).forEach(key => {
                if (isNotCurrentMonth(key)) newSundayData[key] = sundayData[key];
            });
            Object.keys(normalHoursData).forEach(key => {
                if (isNotCurrentMonth(key)) newNormalHoursData[key] = normalHoursData[key];
            });

            // 전역 변수 업데이트
            holidays = new Set(newHolidays);
            excusedAbsents = new Set(newExcusedAbsents);
            absents = new Set(newAbsents);
            annualLeaveDays = new Set(newAnnualLeaveDays);
            overtimeData = newOvertimeData;
            nightData = newNightData;
            nightOTData = newNightOTData;
            nightShiftDays = new Set(newNightShiftDays);
            sundayData = newSundayData;
            normalHoursData = newNormalHoursData;

            // 직원 데이터에 저장
            employees[currentEmployeeId] = {
                ...emp,
                holidays: Array.from(holidays),
                excusedAbsents: Array.from(excusedAbsents),
                absents: Array.from(absents),
                annualLeaveDays: Array.from(annualLeaveDays),
                specialLeaveDays: Array.from(specialLeaveDays),
                sickLeaveDays: Array.from(sickLeaveDays),
                annualLeaveMemos: annualLeaveMemos,
                overtimeData: overtimeData,
                nightData: nightData,
                nightOTData: nightOTData,
                nightShiftDays: Array.from(nightShiftDays),
                sundayData: sundayData,
                normalHoursData: normalHoursData
            };

            // 저장
            saveEmployeesToStorage();

            // 급여 대장(historyData)에서도 해당 직원 데이터 삭제
            const historyKey = `payrollHistory_${selectedYear}_${selectedMonth}`;
            const historyData = JSON.parse(localStorage.getItem(historyKey) || 'null');

            if (historyData) {
                // confirmedEmployees에서 제거
                if (historyData.confirmedEmployees && Array.isArray(historyData.confirmedEmployees)) {
                    historyData.confirmedEmployees = historyData.confirmedEmployees.filter(id => id !== currentEmployeeId);
                }

                // data에서 제거
                if (historyData.data && Array.isArray(historyData.data)) {
                    historyData.data = historyData.data.filter(item => item.employeeId !== currentEmployeeId);
                }

                // 저장 또는 완전 삭제
                if (historyData.confirmedEmployees.length === 0) {
                    // 확정된 직원이 아무도 없으면 히스토리 자체 삭제
                    localStorage.removeItem(historyKey);
                } else {
                    // 남은 직원이 있으면 업데이트
                    localStorage.setItem(historyKey, JSON.stringify(historyData));
                }
            }

            // 확정 리스트(payrollConfirmed)에서도 해당 직원 제거
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
            confirmedList = confirmedList.filter(id => id !== currentEmployeeId);

            if (confirmedList.length === 0) {
                // 확정된 직원이 아무도 없으면 리스트 자체 삭제
                localStorage.removeItem(confirmKey);
            } else {
                // 남은 직원이 있으면 업데이트
                localStorage.setItem(confirmKey, JSON.stringify(confirmedList));
            }

            // 확정 상태 해제
            updateConfirmStatus();

            // 달력과 계산 갱신
            generateCalendar();
            calculate();

            alert(`✅ ${emp.name} 직원의 ${monthStr} 데이터가 초기화되었습니다!\n\n확정 상태가 해제되었습니다.`);
        }

        // 현재 직원 데이터 확정
        function confirmCurrentEmployee() {
            if (!currentEmployeeId) {
                alert('⚠️ 먼저 직원을 선택하세요!');
                return;
            }

            if (!selectedYear || !selectedMonth) {
                alert('⚠️ 년월을 선택하세요!');
                return;
            }

            const emp = employees[currentEmployeeId];
            const monthKey = `${selectedYear}_${selectedMonth}`;

            // 현재 직원 데이터 저장
            saveCurrentEmployee();

            // 확정된 직원 목록 가져오기
            const confirmKey = `payrollConfirmed_${monthKey}`;
            let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');

            // 이미 확정되어 있는지 확인
            if (!confirmedList.includes(currentEmployeeId)) {
                confirmedList.push(currentEmployeeId);
                localStorage.setItem(confirmKey, JSON.stringify(confirmedList));
            }

            // 기존 급여 이력 데이터 불러오기
            const historyKey = `payrollHistory_${monthKey}`;
            let historyData = JSON.parse(localStorage.getItem(historyKey) || '{}');

            // 최초 등록일 보존
            const firstSavedDate = historyData.firstSavedDate || new Date().toISOString();

            // 기존 데이터가 없으면 초기화
            if (!historyData.data) {
                historyData = {
                    year: selectedYear,
                    month: selectedMonth,
                    savedDate: new Date().toISOString(),
                    firstSavedDate: firstSavedDate,
                    data: [],
                    confirmedEmployees: confirmedList
                };
            }

            // 현재 직원의 급여 데이터 계산
            const currentPayroll = calculateEmployeePayroll(currentEmployeeId, selectedYear, selectedMonth);
            if (currentPayroll) {
                // 기존 데이터에서 현재 직원 제거 (중복 방지)
                historyData.data = historyData.data.filter(d => d.employeeId !== currentEmployeeId);

                // 새 데이터 추가 (currentPayroll에 이미 코드 포함된 name이 있음)
                historyData.data.push({
                    employeeId: currentEmployeeId,
                    id: currentEmployeeId,
                    employeeCode: emp.employeeCode || '',
                    ...currentPayroll
                });
            }

            // 확정 목록 업데이트
            historyData.confirmedEmployees = confirmedList;
            historyData.savedDate = new Date().toISOString();
            historyData.firstSavedDate = firstSavedDate;  // 최초 등록일 유지

            // 저장
            localStorage.setItem(historyKey, JSON.stringify(historyData));

            // payrollHistoryList에도 추가 (메인 페이지에서 인식하도록)
            let historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            const existingIndex = historyList.findIndex(h => h.year === selectedYear && h.month === selectedMonth);

            const listItem = {
                year: selectedYear,
                month: selectedMonth,
                savedDate: historyData.savedDate
            };

            if (existingIndex >= 0) {
                // 기존 항목 업데이트
                historyList[existingIndex] = listItem;
            } else {
                // 새 항목 추가
                historyList.push(listItem);
            }

            localStorage.setItem('payrollHistoryList', JSON.stringify(historyList));

            // 확정 상태 표시 업데이트
            updateConfirmStatus();

            alert(`✅ ${emp.name} 직원의 ${selectedYear}년 ${selectedMonth}월 데이터가 확정되었습니다!\n\n메인 페이지에 표시됩니다.`);
        }

        // 확정 상태 표시 업데이트
        function updateConfirmStatus() {
            const confirmStatusBox = document.getElementById('confirmStatusBox');
            const confirmDate = document.getElementById('confirmDate');
            
            if (!currentEmployeeId || !selectedYear || !selectedMonth) {
                if (confirmStatusBox) confirmStatusBox.style.display = 'none';
                return;
            }

            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            const confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
            
            if (confirmedList.includes(currentEmployeeId)) {
                // 확정됨 - 녹색 박스 표시
                confirmStatusBox.style.display = 'block';
                confirmStatusBox.style.background = 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)';
                confirmStatusBox.style.borderColor = '#4caf50';
                confirmStatusBox.innerHTML = `
                    <div style="font-size: 2.5em; margin-bottom: 5px;">✅</div>
                    <div style="font-size: 1.3em; font-weight: bold; color: #2e7d32; margin-bottom: 5px;">ĐÃ XÁC NHẬN</div>
                    <div style="font-size: 0.95em; color: #558b2f;">${selectedMonth}/${selectedYear} • ${new Date().toLocaleDateString('vi-VN')}</div>
                `;
            } else {
                // 미확정 - 주황색 박스 표시
                confirmStatusBox.style.display = 'block';
                confirmStatusBox.style.background = 'linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%)';
                confirmStatusBox.style.borderColor = '#ff9800';
                confirmStatusBox.innerHTML = `
                    <div style="font-size: 2.5em; margin-bottom: 5px;">⚠️</div>
                    <div style="font-size: 1.3em; font-weight: bold; color: #e65100; margin-bottom: 5px;">CHƯA XÁC NHẬN</div>
                    <div style="font-size: 0.95em; color: #ef6c00;">Nhấn nút "Xác nhận" để lưu dữ liệu</div>
                `;
            }
        }

        // 현재 직원 이번 달 데이터 삭제
        function deleteCurrentEmployee() {
            if (!currentEmployeeId) {
                alert('⚠️ 먼저 직원을 선택하세요!');
                return;
            }

            if (!selectedYear || !selectedMonth) {
                alert('⚠️ 년월을 선택하세요!');
                return;
            }

            const emp = employees[currentEmployeeId];
            const monthStr = `${selectedYear}년 ${selectedMonth}월`;

            if (!confirm(`⚠️ ${emp.name} 직원의 ${monthStr} 데이터를 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다!`)) {
                return;
            }

            // 1. 현재 화면 데이터 초기화
            clearCurrentMonthData();

            // 2. 확정 목록에서 제거
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            let confirmedList = JSON.parse(localStorage.getItem(confirmKey) || '[]');
            confirmedList = confirmedList.filter(id => id !== currentEmployeeId);
            localStorage.setItem(confirmKey, JSON.stringify(confirmedList));

            // 3. 급여 이력에서 제거
            const historyKey = `payrollHistory_${monthKey}`;
            let historyData = JSON.parse(localStorage.getItem(historyKey) || '{}');
            if (historyData.data) {
                historyData.data = historyData.data.filter(d => d.employeeId !== currentEmployeeId);
                historyData.confirmedEmployees = confirmedList;
                localStorage.setItem(historyKey, JSON.stringify(historyData));
            }

            // 4. 개별 직원 데이터 저장소에서도 삭제
            const employeeDataKey = `payrollData_${currentEmployeeId}_${selectedYear}_${selectedMonth}`;
            localStorage.removeItem(employeeDataKey);

            // 5. 확정 상태 표시 업데이트
            updateConfirmStatus();

            alert(`✅ ${emp.name} 직원의 ${monthStr} 데이터가 삭제되었습니다!`);
        }

        // 현재 선택된 년월의 급여를 메인 페이지에 등록 (전체 저장용)
        function saveCurrentMonthPayroll() {
            console.log('=== saveCurrentMonthPayroll 시작 ===');
            console.log('selectedYear:', selectedYear);
            console.log('selectedMonth:', selectedMonth);

            if (!selectedYear || !selectedMonth) {
                alert('⚠️ 년월을 선택하세요!');
                return;
            }

            const payrollData = calculateAllEmployeesPayroll(selectedYear, selectedMonth);
            console.log('payrollData:', payrollData);

            if (payrollData.length === 0) {
                alert('⚠️ 저장할 급여 데이터가 없습니다.\n\n직원을 선택하고 근무시간을 입력하세요.');
                return;
            }

            // 이력 데이터 저장
            const historyKey = `payrollHistory_${selectedYear}_${selectedMonth}`;

            // 기존 데이터 확인 (최초 등록일과 확정 목록 보존)
            const existingData = JSON.parse(localStorage.getItem(historyKey) || 'null');
            const firstSavedDate = existingData && existingData.firstSavedDate
                ? existingData.firstSavedDate
                : new Date().toISOString();

            // 확정 목록 가져오기
            const monthKey = `${selectedYear}_${selectedMonth}`;
            const confirmKey = `payrollConfirmed_${monthKey}`;
            const confirmedEmployees = JSON.parse(localStorage.getItem(confirmKey) || '[]');

            const historyData = {
                year: selectedYear,
                month: selectedMonth,
                savedDate: new Date().toISOString(),
                firstSavedDate: firstSavedDate,  // 최초 등록일 보존
                confirmedEmployees: confirmedEmployees,  // 확정 직원 목록 저장
                data: payrollData
            };

            console.log('historyKey:', historyKey);
            console.log('historyData:', historyData);

            localStorage.setItem(historyKey, JSON.stringify(historyData));
            console.log('localStorage에 저장됨:', localStorage.getItem(historyKey));

            // 이력 목록 업데이트
            let historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            console.log('기존 historyList:', historyList);

            const existingIndex = historyList.findIndex(h => h.year === selectedYear && h.month === selectedMonth);

            if (existingIndex >= 0) {
                historyList[existingIndex] = { year: selectedYear, month: selectedMonth, savedDate: historyData.savedDate };
            } else {
                historyList.push({ year: selectedYear, month: selectedMonth, savedDate: historyData.savedDate });
            }

            // 최신 순으로 정렬
            historyList.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year;
                return b.month - a.month;
            });

            console.log('업데이트된 historyList:', historyList);
            localStorage.setItem('payrollHistoryList', JSON.stringify(historyList));
            console.log('저장된 payrollHistoryList:', localStorage.getItem('payrollHistoryList'));

            alert(`✅ ${selectedYear}년 ${selectedMonth}월 급여가 메인 페이지에 등록되었습니다!\n\n직원 수: ${payrollData.length}명\n총급여: ${formatNumber(payrollData.reduce((sum, d) => sum + d.totalSalary, 0))}đ\n\n메인 페이지(index.html)를 새로고침하면 확인할 수 있습니다.`);

            console.log('=== saveCurrentMonthPayroll 완료 ===');
        }

        // 급여 이력 조회
        function viewPayrollHistory() {
            const historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');

            if (historyList.length === 0) {
                alert('저장된 이력이 없습니다.');
                return;
            }

            let message = '📋 급여 이력 목록\n\n';
            historyList.forEach((h, index) => {
                const savedDate = new Date(h.savedDate).toLocaleString('ko-KR');
                message += `${index + 1}. ${h.year}년 ${h.month}월 (저장: ${savedDate})\n`;
            });

            message += '\n조회할 이력 번호를 입력하세요 (취소: 0):';

            const input = prompt(message);
            if (!input || input === '0') return;

            const selectedIndex = parseInt(input) - 1;
            if (selectedIndex < 0 || selectedIndex >= historyList.length) {
                alert('잘못된 번호입니다.');
                return;
            }

            const selected = historyList[selectedIndex];
            document.getElementById('payrollYear').value = selected.year;
            document.getElementById('payrollMonth').value = selected.month;
            refreshPayrollTable();

            alert(`✅ ${selected.year}년 ${selected.month}월 이력을 불러왔습니다.`);
        }

        // 직원별 연간 누적 급여 계산
        function calculateYearlyAccumulation(employeeId) {
            const year = parseInt(document.getElementById('payrollYear').value);
            const currentMonth = parseInt(document.getElementById('payrollMonth').value);

            let yearlyTotal = {
                totalSalary: 0,
                deductions: 0,
                incomeTax: 0,
                netSalary: 0,
                months: []
            };

            // 1월부터 현재 월까지 계산
            for (let month = 1; month <= currentMonth; month++) {
                const payroll = calculateEmployeePayroll(employeeId, year, month);
                if (payroll) {
                    yearlyTotal.totalSalary += payroll.totalSalary;
                    yearlyTotal.deductions += payroll.deductions;
                    yearlyTotal.incomeTax += payroll.incomeTax;
                    yearlyTotal.netSalary += payroll.netSalary;
                    yearlyTotal.months.push({
                        month: month,
                        ...payroll
                    });
                }
            }

            return yearlyTotal;
        }

        // 연간 누적 상세 보기
        function viewYearlyAccumulation(employeeId) {
            const emp = employees[employeeId];
            if (!emp) return;

            const yearly = calculateYearlyAccumulation(employeeId);
            const year = parseInt(document.getElementById('payrollYear').value);
            const currentMonth = parseInt(document.getElementById('payrollMonth').value);

            let message = `📊 ${emp.name} - ${year}년 연간 누적 (1월~${currentMonth}월)\n`;
            message += '━'.repeat(50) + '\n\n';

            // 월별 상세
            message += '📅 월별 내역:\n';
            yearly.months.forEach(m => {
                message += `${m.month}월: ${formatNumber(m.netSalary)}đ (총급여: ${formatNumber(m.totalSalary)}đ)\n`;
            });

            message += '\n' + '━'.repeat(50) + '\n';
            message += `💰 연간 총 급여: ${formatNumber(yearly.totalSalary)}đ\n`;
            message += `🔻 연간 보험료: ${formatNumber(yearly.deductions)}đ\n`;
            message += `🔻 연간 소득세: ${formatNumber(yearly.incomeTax)}đ\n`;
            message += `✅ 연간 실수령액: ${formatNumber(yearly.netSalary)}đ\n\n`;

            // 월 평균
            const avgNet = Math.round(yearly.netSalary / yearly.months.length);
            message += `📈 월 평균 실수령액: ${formatNumber(avgNet)}đ`;

            alert(message);
        }

        // ==================== PDF 및 백업 기능 ====================

        // 개인 급여명세서 PDF 출력 (개선된 버전)
        function printCurrentEmployeePDF() {
            if (!currentEmployeeId) {
                alert('⚠️ 직원을 먼저 선택하세요!');
                return;
            }

            const emp = employees[currentEmployeeId];
            if (!emp) {
                alert('⚠️ 직원 정보를 찾을 수 없습니다!');
                return;
            }

            // 계산 결과 가져오기 (월별 근무일수 기준)
            const weekdaysText = document.getElementById('weekdays').textContent;
            const weekdays = parseFloat(weekdaysText.replace('일', '')) || 26;
            const monthlyHours = weekdays * 8;
            const hourlyRate = monthlyHours > 0 ? emp.basicSalary / monthlyHours : 0;
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const normalPay = hourlyRate * normalHours;

            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            const nightHours = parseFloat(document.getElementById('nightHours').value) || 0;
            const sundayHours = parseFloat(document.getElementById('sundayHours').value) || 0;

            const overtimePay = hourlyRate * overtimeHours * 1.5;
            const nightPay = hourlyRate * nightHours * 1.3;
            const sundayPay = hourlyRate * sundayHours * 2.0;

            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;

            // 동적 수당 시스템 사용
            const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;
            const allowances = (window.companySettings && window.companySettings.allowances) || [];

            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

            const socialIns = emp.basicSalary * 0.08;
            const healthIns = emp.basicSalary * 0.015;
            const unemployIns = emp.basicSalary * 0.01;
            const totalDeduction = socialIns + healthIns + unemployIns;

            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                + dynamicAllowancesTotal - totalDeduction;
            const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            let incomeTax = 0;
            let remainingBase = taxBase;
            const tiers = [[5000000, 0.05], [5000000, 0.10], [8000000, 0.15], [14000000, 0.20], [20000000, 0.25], [28000000, 0.30], [Infinity, 0.35]];

            for (const [limit, rate] of tiers) {
                if (remainingBase <= 0) break;
                const tier = Math.min(remainingBase, limit);
                incomeTax += tier * rate;
                remainingBase -= tier;
            }

            const netSalary = totalSalary - totalDeduction - incomeTax;

            // 비과세 금액 계산
            const taxFreeMeal = mealAllowance;
            const taxFreeOvertime = overtimePay * 1/3;
            const taxFreeSunday = sundayPay * 1/2;
            const totalTaxFree = taxFreeMeal + taxFreeOvertime + taxFreeSunday;

            // jsPDF 생성
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPos = 15;

            // ========== 0. 회사 로고 및 정보 ==========
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];

                // 회사 로고 추가 (있는 경우)
                if (company.logo) {
                    try {
                        // 로고를 PDF에 추가 (왼쪽 상단)
                        doc.addImage(company.logo, 'PNG', 15, yPos, 30, 30);
                    } catch (e) {
                        console.log('Logo could not be added to PDF:', e);
                    }
                }

                // 회사 정보 추가 (로고 오른쪽)
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(102, 126, 234);
                doc.text(company.name || 'Company Name', 50, yPos + 8);

                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                if (company.address) {
                    doc.text(company.address, 50, yPos + 15);
                }
                if (company.contact) {
                    doc.text(company.contact, 50, yPos + 20);
                }

                yPos += 35; // 회사 정보 영역 확보
            }

            // ========== 1. 실수령액 헤더 (맨 위에 크게!) ==========
            doc.setFillColor(76, 175, 80);
            doc.rect(0, yPos, 210, 28, 'F');

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            doc.text('NET SALARY / LUONG THUC LINH', 105, yPos + 8, { align: 'center' });

            doc.setFontSize(22);
            doc.setFont('helvetica', 'bold');
            doc.text(formatNumber(Math.round(netSalary)) + ' VND', 105, yPos + 18, { align: 'center' });

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${selectedYear}.${String(selectedMonth).padStart(2, '0')} | ${emp.name}`, 105, yPos + 24, { align: 'center' });

            yPos += 35;

            // ========== 2. 급여 요약 박스 ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('SUMMARY / TOM TAT', 20, yPos);

            yPos += 2;
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.rect(20, yPos, 170, 26);

            yPos += 7;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Total Salary / Tong luong', 25, yPos);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(33, 150, 243);
            doc.text('+' + formatNumber(Math.round(totalSalary)), 185, yPos, { align: 'right' });

            yPos += 8;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'normal');
            doc.text('Total Deduction / Tong tru', 25, yPos);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(244, 67, 54);
            doc.text('-' + formatNumber(Math.round(totalDeduction + incomeTax)), 185, yPos, { align: 'right' });

            yPos += 2;
            doc.setDrawColor(200, 200, 200);
            doc.line(25, yPos, 185, yPos);

            yPos += 6;
            doc.setTextColor(0, 0, 0);
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('Net Salary / Thuc linh', 25, yPos);
            doc.setTextColor(76, 175, 80);
            doc.text('=' + formatNumber(Math.round(netSalary)), 185, yPos, { align: 'right' });

            yPos += 12;

            // ========== 3. 수입 내역 (EARNINGS) ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('EARNINGS / THU NHAP', 20, yPos);

            yPos += 2;

            const earningsData = [];

            if (normalPay > 0) {
                earningsData.push(['Regular Pay / Luong co ban', normalHours + 'h', formatNumber(Math.round(normalPay))]);
            }
            if (overtimePay > 0) {
                earningsData.push(['Overtime 1.5x / Tang ca 1.5x', overtimeHours + 'h', formatNumber(Math.round(overtimePay))]);
            }
            if (nightPay > 0) {
                earningsData.push(['Night Shift 1.3x / Ca dem 1.3x', nightHours + 'h', formatNumber(Math.round(nightPay))]);
            }
            if (sundayPay > 0) {
                earningsData.push(['Sunday 2.0x / Chu nhat 2.0x', sundayHours + 'h', formatNumber(Math.round(sundayPay))]);
            }

            doc.autoTable({
                startY: yPos,
                body: earningsData,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 100, fontStyle: 'normal' },
                    1: { cellWidth: 25, halign: 'center', textColor: [100, 100, 100] },
                    2: { cellWidth: 45, halign: 'right', fontStyle: 'bold' }
                }
            });

            yPos = doc.lastAutoTable.finalY + 2;

            // 비과세 항목
            doc.setFillColor(255, 249, 196);
            doc.rect(20, yPos, 170, 6, 'F');
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(230, 126, 0);
            doc.text('Meal (Tax-Free) / Tien an (mien thue)', 25, yPos + 4);
            doc.setFont('helvetica', 'bold');
            doc.text(formatNumber(Math.round(mealAllowance)), 185, yPos + 4, { align: 'right' });

            yPos += 8;

            // 동적 수당 표시 (전역 변수 currentAllowanceDetails 사용)
            if (dynamicAllowancesTotal > 0 && typeof currentAllowanceDetails !== 'undefined') {
                const allowanceData = [];
                allowances.forEach(allowance => {
                    if (allowance.enabled) {
                        const amount = currentAllowanceDetails[allowance.id] || 0;
                        if (amount > 0) {
                            allowanceData.push([allowance.name, '', formatNumber(Math.round(amount))]);
                        }
                    }
                });

                if (allowanceData.length > 0) {
                    doc.autoTable({
                        startY: yPos,
                        body: allowanceData,
                        theme: 'plain',
                        styles: { fontSize: 9, cellPadding: 2 },
                        columnStyles: {
                            0: { cellWidth: 100, fontStyle: 'normal' },
                            1: { cellWidth: 25 },
                            2: { cellWidth: 45, halign: 'right', fontStyle: 'bold' }
                        }
                    });
                    yPos = doc.lastAutoTable.finalY + 2;
                }
            }

            yPos += 3;

            // ========== 4. 공제 내역 (DEDUCTIONS) ==========
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('DEDUCTIONS / KHAU TRU', 20, yPos);

            yPos += 2;

            const deductionsData = [
                ['Insurance / Bao hiem (8% + 1.5% + 1%)', '', formatNumber(Math.round(totalDeduction))],
                ['  - Social Insurance / BHXH (8%)', '', formatNumber(Math.round(socialIns))],
                ['  - Health Insurance / BHYT (1.5%)', '', formatNumber(Math.round(healthIns))],
                ['  - Unemployment / BHTN (1%)', '', formatNumber(Math.round(unemployIns))],
                ['Income Tax / Thue TNCN', '', formatNumber(Math.round(incomeTax))]
            ];

            doc.autoTable({
                startY: yPos,
                body: deductionsData,
                theme: 'plain',
                styles: { fontSize: 9, cellPadding: 2 },
                columnStyles: {
                    0: { cellWidth: 100, fontStyle: 'normal', textColor: [100, 100, 100] },
                    1: { cellWidth: 25 },
                    2: { cellWidth: 45, halign: 'right', fontStyle: 'bold', textColor: [244, 67, 54] }
                },
                didParseCell: function(data) {
                    if (data.row.index === 0) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [0, 0, 0];
                    }
                }
            });

            yPos = doc.lastAutoTable.finalY + 8;

            // ========== 5. 비과세 요약 ==========
            doc.setFillColor(232, 245, 233);
            doc.rect(20, yPos, 170, 16, 'F');

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.setFont('helvetica', 'bold');
            doc.text('TAX-FREE SUMMARY / TOM TAT MIEN THUE', 25, yPos + 5);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(8);
            yPos += 9;
            doc.text(`Meal 100%: ${formatNumber(Math.round(taxFreeMeal))}  |  Overtime 33%: ${formatNumber(Math.round(taxFreeOvertime))}  |  Sunday 50%: ${formatNumber(Math.round(taxFreeSunday))}`, 25, yPos);

            doc.setFont('helvetica', 'bold');
            yPos += 4;
            doc.text(`Total Tax-Free / Tong mien thue: ${formatNumber(Math.round(totalTaxFree))} VND`, 25, yPos);

            yPos += 10;

            // ========== 6. 직원 정보 ==========
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, 190, yPos);
            yPos += 6;

            doc.setTextColor(100, 100, 100);
            doc.setFontSize(8);
            doc.setFont('helvetica', 'normal');
            doc.text(`Employee / Nhan vien: ${emp.name}  |  Hire Date / Ngay vao: ${emp.hireDate || 'N/A'}  |  Dependents / Nguoi phu thuoc: ${emp.dependents || 0}`, 20, yPos);
            yPos += 4;
            doc.text(`Basic Salary / Luong co ban: ${formatNumber(emp.basicSalary)} VND  |  Hourly Rate / Gio: ${formatNumber(Math.round(hourlyRate))} VND`, 20, yPos);

            yPos += 10;

            // ========== 7. 서명란 ==========
            doc.setDrawColor(200, 200, 200);
            doc.line(20, yPos, 190, yPos);
            yPos += 8;

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(9);
            doc.text('Employee Signature / Chu ky NV', 40, yPos);
            doc.text('Manager Signature / Chu ky quan ly', 130, yPos);

            yPos += 15;
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('Issued / Ngay phat hanh: ' + new Date().toLocaleDateString('vi-VN'), 105, yPos, { align: 'center' });

            // PDF 저장
            doc.save(`PaySlip_${emp.name}_${selectedYear}_${String(selectedMonth).padStart(2, '0')}.pdf`);
            alert(`✅ ${emp.name} 급여명세서 PDF가 생성되었습니다!`);
        }

        // 개인 급여명세서 엑셀 출력
        function exportCurrentEmployeeExcel() {
            if (!currentEmployeeId) {
                alert('⚠️ 직원을 먼저 선택하세요!');
                return;
            }

            const emp = employees[currentEmployeeId];
            if (!emp) {
                alert('⚠️ 직원 정보를 찾을 수 없습니다!');
                return;
            }

            // 계산 결과 가져오기 (월별 근무일수 기준)
            const weekdaysText = document.getElementById('weekdays').textContent;
            const weekdays = parseFloat(weekdaysText.replace('일', '')) || 26;
            const monthlyHours = weekdays * 8;
            const hourlyRate = monthlyHours > 0 ? emp.basicSalary / monthlyHours : 0;
            const normalHoursText = document.getElementById('normalHours').textContent;
            const normalHours = parseFloat(normalHoursText.replace('h', '')) || 0;
            const normalPay = hourlyRate * normalHours;

            const overtimePay = hourlyRate * (parseFloat(document.getElementById('overtimeHours').value) || 0) * 1.5;
            const nightPay = hourlyRate * (parseFloat(document.getElementById('nightHours').value) || 0) * 1.3;
            const sundayPay = hourlyRate * (parseFloat(document.getElementById('sundayHours').value) || 0) * 2.0;

            const mealAllowance = parseFloat(document.getElementById('autoMeal').textContent.replace(/[^\d]/g, '')) || 0;

            // 동적 수당 총액 및 개별 수당 가져오기
            const dynamicAllowancesTotal = parseFloat(document.getElementById('totalAllowancesHidden').value) || 0;
            const allowances = (window.companySettings && window.companySettings.allowances) || [];
            const enabledAllowances = allowances.filter(a => a.enabled);

            const totalSalary = normalPay + overtimePay + nightPay + sundayPay + mealAllowance + dynamicAllowancesTotal;

            const socialIns = emp.basicSalary * 0.08;
            const healthIns = emp.basicSalary * 0.015;
            const unemployIns = emp.basicSalary * 0.01;
            const totalDeduction = socialIns + healthIns + unemployIns;

            const taxableIncome = normalPay + (overtimePay * 2/3) + nightPay + (sundayPay * 1/2)
                                + dynamicAllowancesTotal - totalDeduction;
            const totalFamilyDeduction = 11000000 + (emp.dependents * 4400000);
            let taxBase = Math.max(0, taxableIncome - totalFamilyDeduction);

            let incomeTax = 0;
            let remainingBase = taxBase;
            const tiers = [[5000000, 0.05], [5000000, 0.10], [8000000, 0.15], [14000000, 0.20], [20000000, 0.25], [28000000, 0.30], [Infinity, 0.35]];

            for (const [tier_limit, rate] of tiers) {
                if (remainingBase <= 0) break;
                const tier = Math.min(remainingBase, tier_limit);
                incomeTax += tier * rate;
                remainingBase -= tier;
            }

            const netSalary = totalSalary - totalDeduction - incomeTax;

            // 엑셀 데이터 생성
            const wb = XLSX.utils.book_new();

            const data = [
                ['급여명세서 / SALARY STATEMENT'],
                [`${selectedYear}년 ${selectedMonth}월`],
                [],
                ['직원 정보 / Employee Information'],
                ['이름 / Name', emp.name],
                ['입사일 / Hire Date', emp.hireDate || 'N/A'],
                ['부양가족 / Dependents', emp.dependents || 0],
                [],
                ['급여 내역 / Salary Details', '금액 / Amount (VND)'],
                ['기본급 / Basic Salary', Math.round(emp.basicSalary)],
                ['시급 / Hourly Rate', Math.round(hourlyRate)],
                ['정규 근무시간 / Regular Hours', normalHours + 'h'],
                ['정규 급여 / Regular Pay', Math.round(normalPay)],
                ['야근 수당 (1.5x) / Overtime Pay', Math.round(overtimePay)],
                ['야간 수당 (1.3x) / Night Pay', Math.round(nightPay)],
                ['일요일 특근 (2.0x) / Sunday Pay', Math.round(sundayPay)],
                ['식대 / Meal Allowance', Math.round(mealAllowance)]
            ];

            // 동적 수당 추가 (금액이 0보다 큰 것만)
            enabledAllowances.forEach(allowance => {
                const amount = currentAllowanceDetails[allowance.id] || 0;
                if (amount > 0) {  // 0원인 수당은 표시하지 않음
                    data.push([`${allowance.name} / ${allowance.name}`, Math.round(amount)]);
                }
            });

            data.push(
                [],
                ['총 급여 / Total Salary', Math.round(totalSalary)],
                [],
                ['공제 내역 / Deductions', '금액 / Amount (VND)'],
                ['사회보험 (8%) / Social Insurance', Math.round(socialIns)],
                ['건강보험 (1.5%) / Health Insurance', Math.round(healthIns)],
                ['실업보험 (1%) / Unemployment Insurance', Math.round(unemployIns)],
                ['총 공제액 / Total Deductions', Math.round(totalDeduction)],
                [],
                ['세금 계산 / Tax Calculation', '금액 / Amount (VND)'],
                ['과세 소득 / Taxable Income', Math.round(taxableIncome)],
                ['가족 공제 / Family Deduction', Math.round(totalFamilyDeduction)],
                ['과세 표준 / Tax Base', Math.round(taxBase)],
                ['개인소득세 / Income Tax', Math.round(incomeTax)],
                [],
                ['실수령액 / Net Salary', Math.round(netSalary)]
            );

            const ws = XLSX.utils.aoa_to_sheet(data);

            // 열 너비 설정
            ws['!cols'] = [
                { wch: 35 },
                { wch: 20 }
            ];

            XLSX.utils.book_append_sheet(wb, ws, '급여명세서');
            XLSX.writeFile(wb, `급여명세서_${emp.name}_${selectedYear}_${selectedMonth}.xlsx`);

            alert(`✅ ${emp.name} 급여명세서 엑셀이 생성되었습니다!`);
        }

        // 전체 데이터 백업
        function backupAllData() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                employees: employees,
                companySettings: companySettings,
                payrollHistoryList: JSON.parse(localStorage.getItem('payrollHistoryList') || '[]')
            };

            // 모든 급여 이력도 백업
            const historyList = JSON.parse(localStorage.getItem('payrollHistoryList') || '[]');
            const payrollHistories = {};

            historyList.forEach(h => {
                const key = `payrollHistory_${h.year}_${h.month}`;
                const data = localStorage.getItem(key);
                if (data) {
                    payrollHistories[key] = JSON.parse(data);
                }
            });

            backupData.payrollHistories = payrollHistories;

            // JSON 파일로 다운로드
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            link.download = `급여시스템_백업_${dateStr}.json`;
            link.click();

            URL.revokeObjectURL(url);

            alert(`✅ 전체 데이터 백업 완료!\n\n직원: ${Object.keys(employees).length}명\n급여 이력: ${historyList.length}개월\n\n파일명: 급여시스템_백업_${dateStr}.json`);
        }

        // 백업 파일 복원 (파일 선택 창 열기)
        function restoreAllData() {
            if (!confirm('⚠️ 백업 파일을 복원하면 현재 데이터가 모두 덮어씌워집니다.\n\n계속하시겠습니까?')) {
                return;
            }
            document.getElementById('backupFileInput').click();
        }

        // 백업 파일 복원 처리
        function handleBackupRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // 데이터 유효성 검사
                    if (!backupData.version || !backupData.employees) {
                        throw new Error('올바른 백업 파일이 아닙니다.');
                    }

                    // 직원 데이터 복원
                    employees = backupData.employees;
                    localStorage.setItem('vietnamPayrollEmployees', JSON.stringify(employees));

                    // 회사 설정 복원
                    if (backupData.companySettings) {
                        companySettings = backupData.companySettings;
                        // 모든 연도별 설정 저장
                        for (let year = 2024; year <= 2030; year++) {
                            localStorage.setItem(`vietnamPayrollSettings_${year}`, JSON.stringify(companySettings));
                        }
                    }

                    // 급여 이력 복원
                    if (backupData.payrollHistoryList) {
                        localStorage.setItem('payrollHistoryList', JSON.stringify(backupData.payrollHistoryList));
                    }

                    if (backupData.payrollHistories) {
                        for (const key in backupData.payrollHistories) {
                            localStorage.setItem(key, JSON.stringify(backupData.payrollHistories[key]));
                        }
                    }

                    // UI 업데이트
                    updateEmployeeSelect();

                    const exportDateStr = backupData.exportDate ? new Date(backupData.exportDate).toLocaleString('ko-KR') : '알 수 없음';
                    alert(`✅ 백업 데이터 복원 완료!\n\n백업 일시: ${exportDateStr}\n직원: ${Object.keys(employees).length}명\n급여 이력: ${backupData.payrollHistoryList ? backupData.payrollHistoryList.length : 0}개월\n\n페이지를 새로고침합니다.`);

                    location.reload();
                } catch (error) {
                    alert('⚠️ 백업 파일 복원 실패: ' + error.message);
                }
            };
            reader.readAsText(file);

            // 파일 선택 초기화
            event.target.value = '';
        }

        // 페이지 로드시 초기화
        window.onload = init;

        // Load and display company profile
        function loadCompanyProfile() {
            const currentCompanyId = localStorage.getItem('currentCompanyId');
            const companyProfiles = JSON.parse(localStorage.getItem('companyProfiles') || '{}');

            const companyHeaderDiv = document.getElementById('companyHeader');
            const systemSubtitle = document.getElementById('systemSubtitle');

            if (currentCompanyId && companyProfiles[currentCompanyId]) {
                const company = companyProfiles[currentCompanyId];

                // Build company header HTML
                let headerHTML = '';

                if (company.logo) {
                    headerHTML += `<img src="${company.logo}" alt="${company.name}" class="company-logo">`;
                }

                headerHTML += `
                    <div class="company-info">
                        <div class="company-name">${company.name}</div>
                        ${company.address ? `<div class="company-address">📍 ${company.address}</div>` : ''}
                    </div>
                `;

                companyHeaderDiv.innerHTML = headerHTML;

                // Update subtitle with Vietnamese name if available
                if (company.nameVN) {
                    systemSubtitle.textContent = company.nameVN + ' - 급여 계산기';
                }

                // Apply company color theme
                if (company.color) {
                    const style = document.createElement('style');
                    style.textContent = `
                        body {
                            background: linear-gradient(135deg, ${company.color} 0%, #764ba2 100%) !important;
                        }
                        .modern-header h1 {
                            color: ${company.color} !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
        }

        // Load company profile on page load
        document.addEventListener('DOMContentLoaded', loadCompanyProfile);
    </script>

    </div> <!-- modern-content-wrapper 닫기 -->
    </div> <!-- container 닫기 -->

    <!-- JavaScript 모듈 로드 (순서 중요!) -->
    <!-- data-manager.js는 settings.html에서만 사용 (변수 충돌 방지) -->
    <script src="import-from-daily-report.js"></script>
</body>
</html>